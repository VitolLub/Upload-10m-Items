"use strict";function getUserInfo(){return new Promise(function(e,n){$.ajax({type:"POST",url:URL_CONFIG.GETUSERINFO,contentType:"application/json",data:JSON.stringify({version:24}),success:function(n){e(n)},error:function(e){n(1)}})})}function updateUserBox(){getUserInfo().then(function(e){localStorage.setItem("amz_isSubscriber",e.isSubscriber?"1":"-1"),$(".amz_notSubscribe_table_data").hide(),e.isSubscriber?($(".btn-amz-upgrade").hide(),$("#check-sponsored").attr("disabled",!1),$("#check-sponsored").attr("checked",!1),$(".tips-unlogin-box").hide(),$(".tips-login-unsubscriber-box").hide(),$(".tips-login-subscriber-box").show()):($(".btn-amz-upgrade").show(),$("#check-sponsored").attr("disabled","disabled"),$("#check-sponsored").attr("checked",!1),$(".tips-unlogin-box").hide(),$(".tips-login-unsubscriber-box").show(),$(".tips-login-subscriber-box").hide()),localStorage.setItem("kw_status",e.status),$("#userinfo-box #userinfo-box-username").text(e.username),$("#userinfo-box").css("display","inline-block"),$("#login-box").hide(),1!==e.status&&$("#pay-btn").show()})["catch"](function(e){$(".btn-amz-upgrade").hide(),$("#check-sponsored").attr("disabled","disabled"),$("#check-sponsored").attr("checked",!1),$("#userinfo-box").hide(),$("#login-box").css("display","inline-block"),$(".tips-unlogin-box").show(),$(".tips-login-unsubscriber-box").hide(),$(".tips-login-subscriber-box").hide()})}function login(e){return new Promise(function(n,t){$.ajax({type:"POST",url:URL_CONFIG.LOGIN,contentType:"application/json",data:JSON.stringify(e),success:function(e){n(e)},error:function(e){t(1)}})})}function loginInGoogle(e){return new Promise(function(n,t){$.ajax({type:"POST",url:URL_CONFIG.LOGININGOOGLE,contentType:"application/json",data:JSON.stringify(e),success:function(e){n(e)},error:function(e){t(1)}})})}function logout(){return new Promise(function(e,n){$.ajax({type:"POST",url:URL_CONFIG.LOGOUT,contentType:"application/json",success:function(n){e(n)},error:function(e){n(1)}})})}var concat=function(e,n){return e.concat(n)},flatMap=function(e,n){return n.map(e).reduce(concat,[])};Array.prototype.flatMap=function(e){return flatMap(e,this)},jQuery.extend(jQuery.fn.dataTableExt.oSort,{"numeric-pre":function(e){var n=String(e).replace(/<[\s\S]*?>/g,"");return n=n.replace(/Not in top 300/g,"100000"),n=parseInt(n)||0,parseInt(n)},"numeric-asc":function(e,n){return e<n?-1:e>n?1:0},"numeric-desc":function(e,n){return e<n?1:e>n?-1:0}}),jQuery.extend(jQuery.fn.dataTableExt.oSort,{"html-percent-pre":function(e){var n=String(e).replace(/<[\s\S]*?>/g,"");if(n=n.replace(/Not in top 300/g,"100000"),n=n.replace(/ /gi,""),n.indexOf("Page")!==-1&&n.indexOf("No")!==-1){var t=n.substring(n.indexOf("Page")+4,n.indexOf("No"));t=parseInt(t)||0;var r=n.substr(n.indexOf("No")+2,2);return r=parseInt(r)||0,20*t+r}return parseInt(n)},"html-percent-asc":function(e,n){return e<n?-1:e>n?1:0},"html-percent-desc":function(e,n){return e<n?1:e>n?-1:0}});var rzButton=function(e){e.length>0?($(".ads").css("width","18rem"),e.forEach(function(e,n){var t='<a href="'+e.targetUrl+'" target="_blank" class="ad-image">\n<img src="'+e.imgUrl+'" height="250px" width="250px">\n</a>';$(".ads").append(t)})):($(".ads").css("width","0"),$(".ads").html(""))},rdTopBar=function(e){e.length>0?e.forEach(function(e,n){var t='<li class="nav-item">\n              <a class="nav-link" style="" href="'+e.targetUrl+'" target="_blank">\n                '+e.text+"\n              </a>\n            </li>";$(".ads-2").append(t)}):$(".ads-2").html("")},BASE_SERVER="https://amzdatastudio.com",BASE_API_SERVER="https://amzdatastudio.com",URL_CONFIG={LOGIN:BASE_API_SERVER+"/api/user/login",LOGININGOOGLE:BASE_API_SERVER+"/api/user/loginByGoogleInChromeExtension",LOGOUT:BASE_API_SERVER+"/api/user/logout",GETUSERINFO:BASE_API_SERVER+"/api/chrome-extension-kw-index/userinfo",SEARCHVOLUME:BASE_API_SERVER+"/api/chrome-extension-kw-index/search-volume",ADSINFO:BASE_API_SERVER+"/api/chrome-extension-kw-index/ads-info",ADSINFO2:BASE_API_SERVER+"/api/chrome-extension-kw-index/ads-info2"},GLOBAL_CONFIG={currentProcessId:0,ajaxList:[]};$("#userinfo-box-username").attr("href",BASE_SERVER+"/user/kwindex-extension-pricing"),$("a.amz-subscriber-page").attr("href",BASE_SERVER+"/user/pricing?type=subscription"),$("a.kwindex-pricing-page").attr("href",BASE_SERVER+"/user/kwindex-extension-pricing"),$("a.kwindex-intro-page").attr("href","https://amzdatastudio.com/amazon-keyword-relevance-score/"),$(document).ready(function(){function e(){GLOBAL_CONFIG.currentProcessId=0,GLOBAL_CONFIG.ajaxList.forEach(function(e,n){e.abort()}),GLOBAL_CONFIG.ajaxList=[],$("#cancel-btn").hide(),$("#reset-btn").show()}function n(){var e=(new Date).getTime();return GLOBAL_CONFIG.currentProcessId=e,GLOBAL_CONFIG.ajaxList=[],$("#cancel-btn").show(),$("#reset-btn").hide(),$("#progress-bar").css("backgroundColor","#007bff"),e}$.ajax({type:"GET",url:URL_CONFIG.ADSINFO,success:function(e){rzButton(e.content)},error:function(e){}}),$.ajax({type:"GET",url:URL_CONFIG.ADSINFO2,success:function(e){rdTopBar(e.content)},error:function(e){}}),$(function(){$('[data-toggle="tooltip"]').tooltip()}),$("#google-login").click(function(){chrome.identity.getAuthToken({interactive:!0},function(e){return chrome.runtime.lastError?void callback(chrome.runtime.lastError):void loginInGoogle({access_token:e}).then(function(e){"error"===e.result?alert(e.message):(updateUserBox(),$("#loginModal").modal("hide"))})["catch"](function(e){alert("Login failed: you have no permission for it"),console.error("failed to login, please try again")})})}),updateUserBox();var t=$("#datatable").DataTable({dom:"Bfrtip",buttons:["excelHtml5","csvHtml5"],data:[],columnDefs:[{targets:4,orderable:!1}],aoColumnDefs:[{sType:"html-percent",aTargets:[5]}],paging:!1,rowCallback:function(e){"Y"===data[2]?$(e).css("background-color","#dff0d8"):$(e).css("background-color","#f2dede")}});$("#datatable").dataTable().fnSetColumnVis(9,!1),$("#datatable").css("width","60rem");var r=$("#progress-bar"),o=$("#progress-bar-text"),a=[],i=function(e){return new Promise(function(n,t){0===e.length?n([]):$.ajax({type:"GET",url:"https://www.amazon."+$("#country").val()+"/dp/"+encodeURIComponent(e),success:function(t){var r=[];try{var o=t.match(/asinVariationValues" :(.*)\n/)[1];o=o.substring(0,o.length-1);var a=JSON.parse(o);r=Object.keys(a);var i=t.match(/parentAsin" : "(.*)",\n/)[1];i&&r.push(i)}catch(s){}r.push(e),n(r)},error:function(e){e&&e.responseText.indexOf("amazon")!==-1&&$("#search-btn").prop("disabled")&&(window.alert("Please input a valid ASIN, or leave the ASIN field empty to retrieve the keywords' data only."),$("#search-btn").prop("disabled",!1),$("#search-btn").html("Check Ranking")),t([])}})})},s=function(t){$("#kw-btn").prop("disabled",!0),getUserInfo().then(function(e){var s=n();a=[],o.html("0%"),r.width("0%"),$(".amz_notSubscribe_table_data").hide(),d([],t);var u=$("#asin").val().trim(),p=0===u.length||null!==u.match(/(?:[0-9A-Z]{10})/i),f=""!==$("#keywords").val();if(f)if(p){a=[];var h=$("#keywords").val().split(/\n/).map(function(e){return e.trim().split(/\s+/).join(" ")}).filter(function(e){return e.length>0}),g=[];if($.each(h,function(e,n){$.inArray(n,g)===-1&&g.push(n)}),!e.isSubscriber&&g.length>200)return alert("Please don’t put more that 200 lines for one search. NO LIMIT with Pro Version"),$("#kw-btn").prop("disabled",!1),void $("#kw-btn").html("Relevant KW");var b=null,m=$("#country").val();$.ajax({type:"POST",url:URL_CONFIG.SEARCHVOLUME,contentType:"application/json",data:JSON.stringify({keywords:g,region:m,asin:u}),success:function(e){b=e.result,a.forEach(function(e,n){var t=e[1],r=b[t.toLowerCase().trim()];this[n][6]=r[0],this[n][7]=r[1]},a),a.length===g.length?l(a,t):d(a,t)},error:function(e){b=null}}),$("#search-btn").prop("disabled",!0),$("#search-btn").html("Loading"),o.html("0%"),r.width("0%");var w=$("#check-rank").is(":checked"),x={};i(u).then(function(e){g.forEach(function(n,i){function p(e,n){if(GLOBAL_CONFIG.currentProcessId===s){x[e]=n;var t=0;for(var a in x)t+=x[a]||0;var i=Math.round(100*t/(g.length+1)/20);o.html(i+"%"),r.width(i+"%")}}function f(e){var t=$.ajax({type:"GET",url:"https://www.amazon."+$("#country").val()+"/s/",data:"field-keywords="+encodeURIComponent(n)+"&page=1",success:function(n){var t=$($.parseHTML(n)),r=t.find("#s-result-count").length>0?t.find("#s-result-count"):t.find(".rush-component .s-desktop-toolbar .sg-row-align-items-center .a-spacing-small SPAN"),o="0";if(r&&r.length>0){var a=r[0].innerText.toLowerCase();if($("#country").val().indexOf("jp")===-1){var i=/([\d,.\s]+) (result|résult|risult|ergebnissen|ergebnisse)/i;try{o=i.exec(a.toLowerCase())[1]}catch(s){}}else o=a.indexOf("以上")!==-1?a.substring(a.indexOf("検索結果"),a.indexOf("以上")):a.substring(a.indexOf("検索結果")===-1?parseInt(a)||0:a.indexOf("検索結果"),a.indexOf("のうち"))}o=o.replace(/[^0-9]/g,""),o=parseInt(o)||0,o>0&&o%1e3===0&&(o+="+"),e(o)}});GLOBAL_CONFIG.ajaxList.push(t)}function h(e,r,o,u,p){if(GLOBAL_CONFIG.currentProcessId===s){var f=u,h="https://www.amazon."+$("#country").val()+"/dp/"+encodeURIComponent(f),m=f?"<a href='"+h+"' target='_blank'>"+f+"</a>":"-",w=o;if(o.indexOf("Page")!==-1){var x=parseInt(o.substring(o.indexOf("page")+5,o.indexOf("<br")))||1,v="https://www.amazon."+$("#country").val()+"/s/?field-keywords="+encodeURIComponent(n)+"&page="+x;w='<a href="'+v+'" target="_blank">'+o+"</a>"}var S=c[n]||"-";S='<span style="color: #FFA500;">'+S+"</span>";var k="-",O="-";if(null!==b){if(k=b[n.toLowerCase().trim()][0],O=b[n.toLowerCase().trim()][1],k.toString().indexOf("Pro")!==-1){var I=BASE_SERVER+"/user/kwindex-extension-pricing";k="<a href='"+I+"' target='_blank'>"+k+"</a>"}if(O.toString().indexOf("Pro")!==-1){var I=BASE_SERVER+"/user/kwindex-extension-pricing";O="<a href='"+I+"' target='_blank'>"+O+"</a>"}}a.push([i+1,n,e,m,r,w,k,O,p,S]),g.length>=10?a.length%10===0&&d(a,t):d(a,t),a.length===g.length&&l(a,t)}}function m(e,t,r,o){var a="Not in top 300"!==t;a||"com"===$("#country").val()?(a=a?"Y":"N",h(a,t,r,e,o)):$.ajax({type:"GET",url:"https://www.amazon."+$("#country").val()+"/s/",data:"field-keywords="+encodeURIComponent(u)+"+"+encodeURIComponent(n),success:function(n){var i=$($.parseHTML(n)).find("[data-component-type='s-search-results']").children().children("[data-component-type='s-search-result']").get().filter(function(e){var n=0===$(e).find(".s-sponsored-header").length&&!$(e).text().toLowerCase().match(/Sponsored|スポンサー|スポンサー プロダクト|商品推广|Gesponsert|Gesponsord|Sponsorowane|Sponsorlu|Sponzorováno|Sponsorisé|Patrocinado|Sponsorizzato|Patrocinado/gi);return n}).map(function(e){return $(e).attr("data-asin")});a=i.length>0,a=a?"Y":"N",h(a,t,r,e,o)},error:function(){console.error("Server Error")}})}function v(e,n,t,r,o,a){if(GLOBAL_CONFIG.currentProcessId===s){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=$.ajax({type:"GET",url:"https://www.amazon."+$("#country").val()+"/s/",data:"field-keywords="+encodeURIComponent(n)+"&page="+t,success:function(s){if(null===i){var c=$($.parseHTML(s)),l=c.find("#s-result-count").length>0?c.find("#s-result-count"):c.find(".rush-component .s-desktop-toolbar .sg-row-align-items-center .a-spacing-small SPAN"),d="0";if(l&&l.length>0){var u=l[0].innerText.toLowerCase();if($("#country").val().indexOf("jp")===-1){var f=/([\d,.\s]+) (result|résult|risult|ergebnissen|ergebnisse)/i;try{d=f.exec(u.toLowerCase())[1]}catch(h){}}else d=u.indexOf("以上")!==-1?u.substring(u.indexOf("検索結果"),u.indexOf("以上")):u.substring(u.indexOf("検索結果")===-1?parseInt(u)||0:u.indexOf("検索結果"),u.indexOf("のうち"))}d=d.replace(/[^0-9]/g,""),d=parseInt(d)||0,d>0&&d%1e3===0&&(d+="+"),i=d}var g=!1,b=0,m=null,w=null;if($("#check-sponsored").is(":checked")){var x=$($.parseHTML(s)).find("[data-component-type='s-search-results']").find("[data-component-type='s-search-result']").get().filter(function(e){var n=$(e).find(".s-sponsored-header").length>0||$(e).text().toLowerCase().match(/Sponsored|スポンサー|スポンサー プロダクト|商品推广|Gesponsert|Gesponsord|Sponsorowane|Sponsorlu|Sponzorováno|Sponsorisé|Patrocinado|Sponsorizzato|Patrocinado/gi);return n}).map(function(e){return $(e).attr("data-asin")});x.forEach(function(n){g||(o++,b++,e.includes(n)&&(g=!0,m=n,w="Page "+t+"<br>No "+b))})}else{var x=$($.parseHTML(s)).find("[data-component-type='s-search-results']").find("[data-component-type='s-search-result']").get().filter(function(e){var n=0===$(e).find(".s-sponsored-header").length&&!$(e).text().toLowerCase().match(/Sponsored|スポンサー|スポンサー プロダクト|商品推广|Gesponsert|Gesponsord|Sponsorowane|Sponsorlu|Sponzorováno|Sponsorisé|Patrocinado|Sponsorizzato|Patrocinado/gi);return n}).map(function(e){return $(e).attr("data-asin")});x.forEach(function(n){g||(o++,b++,e.includes(n)&&(g=!0,m=n,w="Page "+t+"<br>No "+b))})}if(1===t){var c=$($.parseHTML(s));if(c.find(".a-pagination").length>0){var S=c.find(".a-pagination").find(".a-disabled").map(function(){return this.innerText}).filter(function(){return parseInt(this)>0&&parseInt(this)<=20});0===S.length&&(S=c.find(".a-pagination").find(".a-selected,.a-normal").map(function(){return this.innerText}).filter(function(){return parseInt(this)>0&&parseInt(this)<=20})),r=S.length>0?S[S.length-1]:1}else{var S=c.find(".s-pagination-strip").find(".s-pagination-item").map(function(){return this.innerText}).filter(function(){return!isNaN(parseInt(this))}).map(function(){return parseInt(this)});r=S.length>0?S[S.length-1]:1}}g?(p(n,20),a(m,o,w,i)):t>=r?(p(n,20),a(m,"Not in top 300","Not in top 300",i)):(p(n,t),v(e,n,t+1,r,o,a,i))},error:function(){console.error("Server Error")}});GLOBAL_CONFIG.ajaxList.push(c)}}function S(){if(GLOBAL_CONFIG.currentProcessId===s)if(0===u.length)f(function(e){h("","","","",e)});else{var t=w?e:[u];v(t,n,1,20,0,function(e,n,t,r){m(e,n,t,r)})}}S()})})}else window.alert("Please input a valid ASIN, or leave the ASIN field empty to retrieve the keywords' data only."),$("#kw-btn").prop("disabled",!1),$("#kw-btn").html("Relevant KW");else window.alert("Please put keywords in the keywords field."),$("#kw-btn").prop("disabled",!1),$("#kw-btn").html("Relevant KW")})["catch"](function(n){$("#loginModal").modal("show"),$("#kw-btn").prop("disabled",!1),e()})},c={};$("#logout-btn").click(function(){logout().then(function(e){updateUserBox()})}),$("#cancel-btn").click(function(){e(),$("#search-btn").prop("disabled",!1),$("#search-btn").html("Check Ranking"),$("#kw-btn").prop("disabled",!1),$("#kw-btn").html("Relevant KW"),$("#progress-bar").css("backgroundColor","red")}),$("#login-btn").click(function(){$("#form-username").val().length>0&&$("#form-password").val().length>0?login({username:$("#form-username").val(),password:$("#form-password").val()}).then(function(e){"error"===e.result?alert(e.message):(updateUserBox(),$("#loginModal").modal("hide"))})["catch"](function(e){alert("Login failed: Wrong Username or Password"),console.error("failed to login, please try again")}):alert("Invalid Username or Password")}),$("#pay-btn").click(function(){window.open(BASE_SERVER+"/user/kwindex-extension-pricing")}),$("#signup-btn").click(function(){window.open(BASE_SERVER+"/user/signup")}),$("#show-sponsor-tips").click(function(e){$("#sponsorTipsModal").modal("show")}),$(".btn-sign-in").click(function(){$("#loginTipsModal").modal("hide"),$("#reversekwTipsModal").modal("hide"),$("#sponsorTipsModal").modal("hide"),$("#loginModal").modal("show")}),$("#reset-btn").click(function(){$("#asin").val(""),$("#keywords").val(""),o.html("0%"),r.width("0%")}),$("#search-btn").click(function(){c={},s(!1)});var l=function(n,t){$("#search-btn").prop("disabled",!1),$("#search-btn").html("Check Ranking"),$("#kw-btn").prop("disabled",!1),$("#kw-btn").html("Relevant KW"),e(),"1"!==localStorage.getItem("amz_isSubscriber")&&t&&$(".amz_notSubscribe_table_data").show(),r.width("100%"),o.html("Finished!"),d(n,t)},d=function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t=$("#datatable").DataTable({destroy:!0,dom:"Bfrtip",buttons:[{extend:"excelHtml5",title:$("#asin").val()},{extend:"csvHtml5",title:$("#asin").val()}],data:e,aoColumnDefs:[{sType:"numeric",aTargets:[4]},{sType:"html-percent",aTargets:[5]},{sType:"numeric",aTargets:[7]}],paging:!1,rowCallback:function(e,n,t){"Y"===n[2]?$(e).css("background-color","#dff0d8"):"N"===n[2]&&$(e).css("background-color","#f2dede")}}),$("#datatable").dataTable().fnSetColumnVis(9,n),n?($("#mainTable").removeClass("main-container"),$("#datatable").css("width","72rem")):($("#datatable").css("width","60rem"),$("#mainTable").addClass("main-container"))}});