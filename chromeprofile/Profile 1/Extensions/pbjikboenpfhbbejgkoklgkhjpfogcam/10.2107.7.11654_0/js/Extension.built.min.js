/** vim: et:ts=4:sw=4:sts=4
 * @license RequireJS 2.3.6 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, https://github.com/requirejs/requirejs/blob/master/LICENSE
 */

/**
 * @license
 * lodash 3.10.1 (Custom Build) <https://lodash.com/>
 * Build: `lodash modern -o ./lodash.js`
 * Copyright 2012-2015 The Dojo Foundation <http://dojofoundation.org/>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright 2009-2015 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 * Available under MIT license <https://lodash.com/license>
 */

/**
 * @preserve Copyright (c) 2014 Petka Antonov
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:</p>
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 */

/**
 * Copyright (c) 2014 Petka Antonov
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:</p>
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 */

/*
 * @license Underscore.js 1.6.0
 * http://underscorejs.org
 * (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 * Underscore may be freely distributed under the MIT license.
 */

/*
 * @license parseUri 1.2.2
 * (c) Steven Levithan <stevenlevithan.com>
 * MIT License
 */

function parseUri(e){for(var t=parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=r[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,o){r&&(n[t.q.name][r]=o)}),n}var requirejs,require,define;!function(global,setTimeout){function commentReplace(e,t){return t||""}function isFunction(e){return"[object Function]"===ostring.call(e)}function isArray(e){return"[object Array]"===ostring.call(e)}function each(e,t){if(e){var r;for(r=0;r<e.length&&(!e[r]||!t(e[r],r,e));r+=1);}}function eachReverse(e,t){if(e){var r;for(r=e.length-1;r>-1&&(!e[r]||!t(e[r],r,e));r-=1);}}function hasProp(e,t){return hasOwn.call(e,t)}function getOwn(e,t){return hasProp(e,t)&&e[t]}function eachProp(e,t){var r;for(r in e)if(hasProp(e,r)&&t(e[r],r))break}function mixin(e,t,r,n){return t&&eachProp(t,function(t,o){!r&&hasProp(e,o)||(!n||"object"!=typeof t||!t||isArray(t)||isFunction(t)||t instanceof RegExp?e[o]=t:(e[o]||(e[o]={}),mixin(e[o],t,r,n)))}),e}function bind(e,t){return function(){return t.apply(e,arguments)}}function scripts(){return document.getElementsByTagName("script")}function defaultOnError(e){throw e}function getGlobal(e){if(!e)return e;var t=global;return each(e.split("."),function(e){t=t[e]}),t}function makeError(e,t,r,n){var o=new Error(t+"\nhttps://requirejs.org/docs/errors.html#"+e);return o.requireType=e,o.requireModules=n,r&&(o.originalError=r),o}function newContext(e){function t(e){var t,r;for(t=0;t<e.length;t++)if("."===(r=e[t]))e.splice(t,1),t-=1;else if(".."===r){if(0===t||1===t&&".."===e[2]||".."===e[t-1])continue;t>0&&(e.splice(t-1,2),t-=2)}}function r(e,r,n){var o,i,a,s,u,c,l,p,f,_,d,g=r&&r.split("/"),h=T.map,m=h&&h["*"];if(e&&(e=e.split("/"),c=e.length-1,T.nodeIdCompat&&jsSuffixRegExp.test(e[c])&&(e[c]=e[c].replace(jsSuffixRegExp,"")),"."===e[0].charAt(0)&&g&&(d=g.slice(0,g.length-1),e=d.concat(e)),t(e),e=e.join("/")),n&&h&&(g||m)){i=e.split("/");e:for(a=i.length;a>0;a-=1){if(u=i.slice(0,a).join("/"),g)for(s=g.length;s>0;s-=1)if((o=getOwn(h,g.slice(0,s).join("/")))&&(o=getOwn(o,u))){l=o,p=a;break e}!f&&m&&getOwn(m,u)&&(f=getOwn(m,u),_=a)}!l&&f&&(l=f,p=_),l&&(i.splice(0,p,l),e=i.join("/"))}return getOwn(T.pkgs,e)||e}function n(e){isBrowser&&each(scripts(),function(t){if(t.getAttribute("data-requiremodule")===e&&t.getAttribute("data-requirecontext")===b.contextName)return t.parentNode.removeChild(t),!0})}function o(e){var t=getOwn(T.paths,e);if(t&&isArray(t)&&t.length>1)return t.shift(),b.require.undef(e),b.makeRequire(null,{skipMap:!0})([e]),!0}function i(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function a(e,t,n,o){var a,s,u,c,l=null,p=t?t.name:null,f=e,_=!0,d="";return e||(_=!1,e="_@r"+(L+=1)),c=i(e),l=c[0],e=c[1],l&&(l=r(l,p,o),s=getOwn(C,l)),e&&(l?d=n?e:s&&s.normalize?s.normalize(e,function(e){return r(e,p,o)}):-1===e.indexOf("!")?r(e,p,o):e:(d=r(e,p,o),c=i(d),l=c[0],d=c[1],n=!0,a=b.nameToUrl(d))),u=!l||s||n?"":"_unnormalized"+(O+=1),{prefix:l,name:d,parentMap:t,unnormalized:!!u,url:a,originalName:f,isDefine:_,id:(l?l+"!"+d:d)+u}}function s(e){var t=e.id,r=getOwn(x,t);return r||(r=x[t]=new b.Module(e)),r}function u(e,t,r){var n=e.id,o=getOwn(x,n);!hasProp(C,n)||o&&!o.defineEmitComplete?(o=s(e),o.error&&"error"===t?r(o.error):o.on(t,r)):"defined"===t&&r(C[n])}function c(e,t){var r=e.requireModules,n=!1;t?t(e):(each(r,function(t){var r=getOwn(x,t);r&&(r.error=e,r.events.error&&(n=!0,r.emit("error",e)))}),n||req.onError(e))}function l(){globalDefQueue.length&&(each(globalDefQueue,function(e){var t=e[0];"string"==typeof t&&(b.defQueueMap[t]=!0),A.push(e)}),globalDefQueue=[])}function p(e){delete x[e],delete w[e]}function f(e,t,r){var n=e.map.id;e.error?e.emit("error",e.error):(t[n]=!0,each(e.depMaps,function(n,o){var i=n.id,a=getOwn(x,i);!a||e.depMatched[o]||r[i]||(getOwn(t,i)?(e.defineDep(o,C[i]),e.check()):f(a,t,r))}),r[n]=!0)}function _(){var e,t,r=1e3*T.waitSeconds,i=r&&b.startTime+r<(new Date).getTime(),a=[],s=[],u=!1,l=!0;if(!v){if(v=!0,eachProp(w,function(e){var r=e.map,c=r.id;if(e.enabled&&(r.isDefine||s.push(e),!e.error))if(!e.inited&&i)o(c)?(t=!0,u=!0):(a.push(c),n(c));else if(!e.inited&&e.fetched&&r.isDefine&&(u=!0,!r.prefix))return l=!1}),i&&a.length)return e=makeError("timeout","Load timeout for modules: "+a,null,a),e.contextName=b.contextName,c(e);l&&each(s,function(e){f(e,{},{})}),i&&!t||!u||!isBrowser&&!isWebWorker||S||(S=setTimeout(function(){S=0,_()},50)),v=!1}}function d(e){hasProp(C,e[0])||s(a(e[0],null,!0)).init(e[1],e[2])}function g(e,t,r,n){e.detachEvent&&!isOpera?n&&e.detachEvent(n,t):e.removeEventListener(r,t,!1)}function h(e){var t=e.currentTarget||e.srcElement;return g(t,b.onScriptLoad,"load","onreadystatechange"),g(t,b.onScriptError,"error"),{node:t,id:t&&t.getAttribute("data-requiremodule")}}function m(){var e;for(l();A.length;){if(e=A.shift(),null===e[0])return c(makeError("mismatch","Mismatched anonymous define() module: "+e[e.length-1]));d(e)}b.defQueueMap={}}var v,y,b,E,S,T={waitSeconds:7,baseUrl:"./",paths:{},bundles:{},pkgs:{},shim:{},config:{}},x={},w={},R={},A=[],C={},P={},I={},L=1,O=1;return E={require:function(e){return e.require?e.require:e.require=b.makeRequire(e.map)},exports:function(e){if(e.usingExports=!0,e.map.isDefine)return e.exports?C[e.map.id]=e.exports:e.exports=C[e.map.id]={}},module:function(e){return e.module?e.module:e.module={id:e.map.id,uri:e.map.url,config:function(){return getOwn(T.config,e.map.id)||{}},exports:e.exports||(e.exports={})}}},y=function(e){this.events=getOwn(R,e.id)||{},this.map=e,this.shim=getOwn(T.shim,e.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},y.prototype={init:function(e,t,r,n){n=n||{},this.inited||(this.factory=t,r?this.on("error",r):this.events.error&&(r=bind(this,function(e){this.emit("error",e)})),this.depMaps=e&&e.slice(0),this.errback=r,this.inited=!0,this.ignore=n.ignore,n.enabled||this.enabled?this.enable():this.check())},defineDep:function(e,t){this.depMatched[e]||(this.depMatched[e]=!0,this.depCount-=1,this.depExports[e]=t)},fetch:function(){if(!this.fetched){this.fetched=!0,b.startTime=(new Date).getTime();var e=this.map;if(!this.shim)return e.prefix?this.callPlugin():this.load();b.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],bind(this,function(){return e.prefix?this.callPlugin():this.load()}))}},load:function(){var e=this.map.url;P[e]||(P[e]=!0,b.load(this.map.id,e))},check:function(){if(this.enabled&&!this.enabling){var e,t,r=this.map.id,n=this.depExports,o=this.exports,i=this.factory;if(this.inited){if(this.error)this.emit("error",this.error);else if(!this.defining){if(this.defining=!0,this.depCount<1&&!this.defined){if(isFunction(i)){if(this.events.error&&this.map.isDefine||req.onError!==defaultOnError)try{o=b.execCb(r,i,n,o)}catch(t){e=t}else o=b.execCb(r,i,n,o);if(this.map.isDefine&&void 0===o&&(t=this.module,t?o=t.exports:this.usingExports&&(o=this.exports)),e)return e.requireMap=this.map,e.requireModules=this.map.isDefine?[this.map.id]:null,e.requireType=this.map.isDefine?"define":"require",c(this.error=e)}else o=i;if(this.exports=o,this.map.isDefine&&!this.ignore&&(C[r]=o,req.onResourceLoad)){var a=[];each(this.depMaps,function(e){a.push(e.normalizedMap||e)}),req.onResourceLoad(b,this.map,a)}p(r),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else hasProp(b.defQueueMap,r)||this.fetch()}},callPlugin:function(){var e=this.map,t=e.id,n=a(e.prefix);this.depMaps.push(n),u(n,"defined",bind(this,function(n){var o,i,l,f=getOwn(I,this.map.id),_=this.map.name,d=this.map.parentMap?this.map.parentMap.name:null,g=b.makeRequire(e.parentMap,{enableBuildCallback:!0});return this.map.unnormalized?(n.normalize&&(_=n.normalize(_,function(e){return r(e,d,!0)})||""),i=a(e.prefix+"!"+_,this.map.parentMap,!0),u(i,"defined",bind(this,function(e){this.map.normalizedMap=i,this.init([],function(){return e},null,{enabled:!0,ignore:!0})})),void((l=getOwn(x,i.id))&&(this.depMaps.push(i),this.events.error&&l.on("error",bind(this,function(e){this.emit("error",e)})),l.enable()))):f?(this.map.url=b.nameToUrl(f),void this.load()):(o=bind(this,function(e){this.init([],function(){return e},null,{enabled:!0})}),o.error=bind(this,function(e){this.inited=!0,this.error=e,e.requireModules=[t],eachProp(x,function(e){0===e.map.id.indexOf(t+"_unnormalized")&&p(e.map.id)}),c(e)}),o.fromText=bind(this,function(r,n){var i=e.name,u=a(i),l=useInteractive;n&&(r=n),l&&(useInteractive=!1),s(u),hasProp(T.config,t)&&(T.config[i]=T.config[t]);try{req.exec(r)}catch(e){return c(makeError("fromtexteval","fromText eval for "+t+" failed: "+e,e,[t]))}l&&(useInteractive=!0),this.depMaps.push(u),b.completeLoad(i),g([i],o)}),void n.load(e.name,g,o,T))})),b.enable(n,this),this.pluginMaps[n.id]=n},enable:function(){w[this.map.id]=this,this.enabled=!0,this.enabling=!0,each(this.depMaps,bind(this,function(e,t){var r,n,o;if("string"==typeof e){if(e=a(e,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[t]=e,o=getOwn(E,e.id))return void(this.depExports[t]=o(this));this.depCount+=1,u(e,"defined",bind(this,function(e){this.undefed||(this.defineDep(t,e),this.check())})),this.errback?u(e,"error",bind(this,this.errback)):this.events.error&&u(e,"error",bind(this,function(e){this.emit("error",e)}))}r=e.id,n=x[r],hasProp(E,r)||!n||n.enabled||b.enable(e,this)})),eachProp(this.pluginMaps,bind(this,function(e){var t=getOwn(x,e.id);t&&!t.enabled&&b.enable(e,this)})),this.enabling=!1,this.check()},on:function(e,t){var r=this.events[e];r||(r=this.events[e]=[]),r.push(t)},emit:function(e,t){each(this.events[e],function(e){e(t)}),"error"===e&&delete this.events[e]}},b={config:T,contextName:e,registry:x,defined:C,urlFetched:P,defQueue:A,defQueueMap:{},Module:y,makeModuleMap:a,nextTick:req.nextTick,onError:c,configure:function(e){if(e.baseUrl&&"/"!==e.baseUrl.charAt(e.baseUrl.length-1)&&(e.baseUrl+="/"),"string"==typeof e.urlArgs){var t=e.urlArgs;e.urlArgs=function(e,r){return(-1===r.indexOf("?")?"?":"&")+t}}var r=T.shim,n={paths:!0,bundles:!0,config:!0,map:!0};eachProp(e,function(e,t){n[t]?(T[t]||(T[t]={}),mixin(T[t],e,!0,!0)):T[t]=e}),e.bundles&&eachProp(e.bundles,function(e,t){each(e,function(e){e!==t&&(I[e]=t)})}),e.shim&&(eachProp(e.shim,function(e,t){isArray(e)&&(e={deps:e}),!e.exports&&!e.init||e.exportsFn||(e.exportsFn=b.makeShimExports(e)),r[t]=e}),T.shim=r),e.packages&&each(e.packages,function(e){var t,r;e="string"==typeof e?{name:e}:e,r=e.name,t=e.location,t&&(T.paths[r]=e.location),T.pkgs[r]=e.name+"/"+(e.main||"main").replace(currDirRegExp,"").replace(jsSuffixRegExp,"")}),eachProp(x,function(e,t){e.inited||e.map.unnormalized||(e.map=a(t,null,!0))}),(e.deps||e.callback)&&b.require(e.deps||[],e.callback)},makeShimExports:function(e){function t(){var t;return e.init&&(t=e.init.apply(global,arguments)),t||e.exports&&getGlobal(e.exports)}return t},makeRequire:function(t,o){function i(r,n,u){var l,p,f;return o.enableBuildCallback&&n&&isFunction(n)&&(n.__requireJsBuild=!0),"string"==typeof r?isFunction(n)?c(makeError("requireargs","Invalid require call"),u):t&&hasProp(E,r)?E[r](x[t.id]):req.get?req.get(b,r,t,i):(p=a(r,t,!1,!0),l=p.id,hasProp(C,l)?C[l]:c(makeError("notloaded",'Module name "'+l+'" has not been loaded yet for context: '+e+(t?"":". Use require([])")))):(m(),b.nextTick(function(){m(),f=s(a(null,t)),f.skipMap=o.skipMap,f.init(r,n,u,{enabled:!0}),_()}),i)}return o=o||{},mixin(i,{isBrowser:isBrowser,toUrl:function(e){var n,o=e.lastIndexOf("."),i=e.split("/")[0],a="."===i||".."===i;return-1!==o&&(!a||o>1)&&(n=e.substring(o,e.length),e=e.substring(0,o)),b.nameToUrl(r(e,t&&t.id,!0),n,!0)},defined:function(e){return hasProp(C,a(e,t,!1,!0).id)},specified:function(e){return e=a(e,t,!1,!0).id,hasProp(C,e)||hasProp(x,e)}}),t||(i.undef=function(e){l();var r=a(e,t,!0),o=getOwn(x,e);o.undefed=!0,n(e),delete C[e],delete P[r.url],delete R[e],eachReverse(A,function(t,r){t[0]===e&&A.splice(r,1)}),delete b.defQueueMap[e],o&&(o.events.defined&&(R[e]=o.events),p(e))}),i},enable:function(e){getOwn(x,e.id)&&s(e).enable()},completeLoad:function(e){var t,r,n,i=getOwn(T.shim,e)||{},a=i.exports;for(l();A.length;){if(r=A.shift(),null===r[0]){if(r[0]=e,t)break;t=!0}else r[0]===e&&(t=!0);d(r)}if(b.defQueueMap={},n=getOwn(x,e),!t&&!hasProp(C,e)&&n&&!n.inited){if(!(!T.enforceDefine||a&&getGlobal(a)))return o(e)?void 0:c(makeError("nodefine","No define call for "+e,null,[e]));d([e,i.deps||[],i.exportsFn])}_()},nameToUrl:function(e,t,r){var n,o,i,a,s,u,c,l=getOwn(T.pkgs,e);if(l&&(e=l),c=getOwn(I,e))return b.nameToUrl(c,t,r);if(req.jsExtRegExp.test(e))s=e+(t||"");else{for(n=T.paths,o=e.split("/"),i=o.length;i>0;i-=1)if(a=o.slice(0,i).join("/"),u=getOwn(n,a)){isArray(u)&&(u=u[0]),o.splice(0,i,u);break}s=o.join("/"),s+=t||(/^data\:|^blob\:|\?/.test(s)||r?"":".js"),s=("/"===s.charAt(0)||s.match(/^[\w\+\.\-]+:/)?"":T.baseUrl)+s}return T.urlArgs&&!/^blob\:/.test(s)?s+T.urlArgs(e,s):s},load:function(e,t){req.load(b,e,t)},execCb:function(e,t,r,n){return t.apply(n,r)},onScriptLoad:function(e){if("load"===e.type||readyRegExp.test((e.currentTarget||e.srcElement).readyState)){interactiveScript=null;var t=h(e);b.completeLoad(t.id)}},onScriptError:function(e){var t=h(e);if(!o(t.id)){var r=[];return eachProp(x,function(e,n){0!==n.indexOf("_@r")&&each(e.depMaps,function(e){if(e.id===t.id)return r.push(n),!0})}),c(makeError("scripterror",'Script error for "'+t.id+(r.length?'", needed by: '+r.join(", "):'"'),e,[t.id]))}}},b.require=b.makeRequire(),b}function getInteractiveScript(){return interactiveScript&&"interactive"===interactiveScript.readyState?interactiveScript:(eachReverse(scripts(),function(e){if("interactive"===e.readyState)return interactiveScript=e}),interactiveScript)}var req,s,head,baseElement,dataMain,src,interactiveScript,currentlyAddingScript,mainScript,subPath,version="2.3.6",commentRegExp=/\/\*[\s\S]*?\*\/|([^:"'=]|^)\/\/.*$/gm,cjsRequireRegExp=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,jsSuffixRegExp=/\.js$/,currDirRegExp=/^\.\//,op=Object.prototype,ostring=op.toString,hasOwn=op.hasOwnProperty,isBrowser=!("undefined"==typeof window||"undefined"==typeof navigator||!window.document),isWebWorker=!isBrowser&&"undefined"!=typeof importScripts,readyRegExp=isBrowser&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,defContextName="_",isOpera="undefined"!=typeof opera&&"[object Opera]"===opera.toString(),contexts={},cfg={},globalDefQueue=[],useInteractive=!1;if(void 0===define){if(void 0!==requirejs){if(isFunction(requirejs))return;cfg=requirejs,requirejs=void 0}void 0===require||isFunction(require)||(cfg=require,require=void 0),req=requirejs=function(e,t,r,n){var o,i,a=defContextName;return isArray(e)||"string"==typeof e||(i=e,isArray(t)?(e=t,t=r,r=n):e=[]),i&&i.context&&(a=i.context),o=getOwn(contexts,a),o||(o=contexts[a]=req.s.newContext(a)),i&&o.configure(i),o.require(e,t,r)},req.config=function(e){return req(e)},req.nextTick=void 0!==setTimeout?function(e){setTimeout(e,4)}:function(e){e()},require||(require=req),req.version=version,req.jsExtRegExp=/^\/|:|\?|\.js$/,req.isBrowser=isBrowser,s=req.s={contexts:contexts,newContext:newContext},req({}),each(["toUrl","undef","defined","specified"],function(e){req[e]=function(){var t=contexts[defContextName];return t.require[e].apply(t,arguments)}}),isBrowser&&(head=s.head=document.getElementsByTagName("head")[0],(baseElement=document.getElementsByTagName("base")[0])&&(head=s.head=baseElement.parentNode)),req.onError=defaultOnError,req.createNode=function(e,t,r){var n=e.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script");return n.type=e.scriptType||"text/javascript",n.charset="utf-8",n.async=!0,n},req.load=function(e,t,r){var n,o=e&&e.config||{};if(isBrowser)return n=req.createNode(o,t,r),n.setAttribute("data-requirecontext",e.contextName),n.setAttribute("data-requiremodule",t),!n.attachEvent||n.attachEvent.toString&&n.attachEvent.toString().indexOf("[native code")<0||isOpera?(n.addEventListener("load",e.onScriptLoad,!1),n.addEventListener("error",e.onScriptError,!1)):(useInteractive=!0,n.attachEvent("onreadystatechange",e.onScriptLoad)),n.src=r,o.onNodeCreated&&o.onNodeCreated(n,o,t,r),currentlyAddingScript=n,baseElement?head.insertBefore(n,baseElement):head.appendChild(n),currentlyAddingScript=null,n;if(isWebWorker)try{setTimeout(function(){},0),importScripts(r),e.completeLoad(t)}catch(n){e.onError(makeError("importscripts","importScripts failed for "+t+" at "+r,n,[t]))}},isBrowser&&!cfg.skipDataMain&&eachReverse(scripts(),function(e){if(head||(head=e.parentNode),dataMain=e.getAttribute("data-main"))return mainScript=dataMain,cfg.baseUrl||-1!==mainScript.indexOf("!")||(src=mainScript.split("/"),mainScript=src.pop(),subPath=src.length?src.join("/")+"/":"./",cfg.baseUrl=subPath),mainScript=mainScript.replace(jsSuffixRegExp,""),req.jsExtRegExp.test(mainScript)&&(mainScript=dataMain),cfg.deps=cfg.deps?cfg.deps.concat(mainScript):[mainScript],!0}),define=function(e,t,r){var n,o;"string"!=typeof e&&(r=t,t=e,e=null),isArray(t)||(r=t,t=null),!t&&isFunction(r)&&(t=[],r.length&&(r.toString().replace(commentRegExp,commentReplace).replace(cjsRequireRegExp,function(e,r){t.push(r)}),t=(1===r.length?["require"]:["require","exports","module"]).concat(t))),useInteractive&&(n=currentlyAddingScript||getInteractiveScript())&&(e||(e=n.getAttribute("data-requiremodule")),o=contexts[n.getAttribute("data-requirecontext")]),o?(o.defQueue.push([e,t,r]),o.defQueueMap[e]=!0):globalDefQueue.push([e,t,r])},define.amd={jQuery:!0},req.exec=function(text){return eval(text)},req(cfg)}}(this,"undefined"==typeof setTimeout?void 0:setTimeout),define("requirejs",function(){}),function(){function e(e,t){if(e!==t){var r=null===e,n=e===S,o=e===e,i=null===t,a=t===S,s=t===t;if(e>t&&!i||!o||r&&!a&&s||n&&s)return 1;if(e<t&&!r||!s||i&&!n&&o||a&&o)return-1}return 0}function t(e,t,r){for(var n=e.length,o=r?n:-1;r?o--:++o<n;)if(t(e[o],o,e))return o;return-1}function r(e,t,r){if(t!==t)return _(e,r);for(var n=r-1,o=e.length;++n<o;)if(e[n]===t)return n;return-1}function n(e){return"function"==typeof e||!1}function o(e){return null==e?"":e+""}function i(e,t){for(var r=-1,n=e.length;++r<n&&t.indexOf(e.charAt(r))>-1;);return r}function a(e,t){for(var r=e.length;r--&&t.indexOf(e.charAt(r))>-1;);return r}function s(t,r){return e(t.criteria,r.criteria)||t.index-r.index}function u(t,r,n){for(var o=-1,i=t.criteria,a=r.criteria,s=i.length,u=n.length;++o<s;){var c=e(i[o],a[o]);if(c){if(o>=u)return c;var l=n[o];return c*("asc"===l||!0===l?1:-1)}}return t.index-r.index}function c(e){return je[e]}function l(e){return De[e]}function p(e,t,r){return t?e=Be[e]:r&&(e=qe[e]),"\\"+e}function f(e){return"\\"+qe[e]}function _(e,t,r){for(var n=e.length,o=t+(r?0:-1);r?o--:++o<n;){var i=e[o];if(i!==i)return o}return-1}function d(e){return!!e&&"object"==typeof e}function g(e){return e<=160&&e>=9&&e<=13||32==e||160==e||5760==e||6158==e||e>=8192&&(e<=8202||8232==e||8233==e||8239==e||8287==e||12288==e||65279==e)}function h(e,t){for(var r=-1,n=e.length,o=-1,i=[];++r<n;)e[r]===t&&(e[r]=z,i[++o]=r);return i}function m(e,t){for(var r,n=-1,o=e.length,i=-1,a=[];++n<o;){var s=e[n],u=t?t(s,n,e):s;n&&r===u||(r=u,a[++i]=s)}return a}function v(e){for(var t=-1,r=e.length;++t<r&&g(e.charCodeAt(t)););return t}function y(e){for(var t=e.length;t--&&g(e.charCodeAt(t)););return t}function b(e){return Ge[e]}function E(g){function je(e){if(d(e)&&!Ps(e)&&!(e instanceof ze)){if(e instanceof Ge)return e;if(ta.call(e,"__chain__")&&ta.call(e,"__wrapped__"))return _n(e)}return new Ge(e)}function De(){}function Ge(e,t,r){this.__wrapped__=e,this.__actions__=r||[],this.__chain__=!!t}function ze(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=Ca,this.__views__=[]}function Be(){var e=new ze(this.__wrapped__);return e.__actions__=rt(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=rt(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=rt(this.__views__),e}function qe(){if(this.__filtered__){var e=new ze(this);e.__dir__=-1,e.__filtered__=!0}else e=this.clone(),e.__dir__*=-1;return e}function Ve(){var e=this.__wrapped__.value(),t=this.__dir__,r=Ps(e),n=t<0,o=r?e.length:0,i=Hr(0,o,this.__views__),a=i.start,s=i.end,u=s-a,c=n?s:a-1,l=this.__iteratees__,p=l.length,f=0,_=Ta(u,this.__takeCount__);if(!r||o<U||o==u&&_==u)return rr(e,this.__actions__);var d=[];e:for(;u--&&f<_;){c+=t;for(var g=-1,h=e[c];++g<p;){var m=l[g],v=m.iteratee,y=m.type,b=v(h);if(y==D)h=b;else if(!b){if(y==j)continue e;break e}}d[f++]=h}return d}function He(){this.__data__={}}function We(e){return this.has(e)&&delete this.__data__[e]}function Ke(e){return"__proto__"==e?S:this.__data__[e]}function Ye(e){return"__proto__"!=e&&ta.call(this.__data__,e)}function Xe(e,t){return"__proto__"!=e&&(this.__data__[e]=t),this}function Ze(e){var t=e?e.length:0;for(this.data={hash:ma(null),set:new pa};t--;)this.push(e[t])}function $e(e,t){var r=e.data;return("string"==typeof t||ko(t)?r.set.has(t):r.hash[t])?0:-1}function et(e){var t=this.data;"string"==typeof e||ko(e)?t.set.add(e):t.hash[e]=!0}function tt(e,t){for(var r=-1,n=e.length,o=-1,i=t.length,a=zi(n+i);++r<n;)a[r]=e[r];for(;++o<i;)a[r++]=t[o];return a}function rt(e,t){var r=-1,n=e.length;for(t||(t=zi(n));++r<n;)t[r]=e[r];return t}function nt(e,t){for(var r=-1,n=e.length;++r<n&&!1!==t(e[r],r,e););return e}function ot(e,t){for(var r=e.length;r--&&!1!==t(e[r],r,e););return e}function it(e,t){for(var r=-1,n=e.length;++r<n;)if(!t(e[r],r,e))return!1;return!0}function at(e,t,r,n){for(var o=-1,i=e.length,a=n,s=a;++o<i;){var u=e[o],c=+t(u);r(c,a)&&(a=c,s=u)}return s}function st(e,t){for(var r=-1,n=e.length,o=-1,i=[];++r<n;){var a=e[r];t(a,r,e)&&(i[++o]=a)}return i}function ut(e,t){for(var r=-1,n=e.length,o=zi(n);++r<n;)o[r]=t(e[r],r,e);return o}function ct(e,t){for(var r=-1,n=t.length,o=e.length;++r<n;)e[o+r]=t[r];return e}function lt(e,t,r,n){var o=-1,i=e.length;for(n&&i&&(r=e[++o]);++o<i;)r=t(r,e[o],o,e);return r}function pt(e,t,r,n){var o=e.length;for(n&&o&&(r=e[--o]);o--;)r=t(r,e[o],o,e);return r}function ft(e,t){for(var r=-1,n=e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}function _t(e,t){for(var r=e.length,n=0;r--;)n+=+t(e[r])||0;return n}function dt(e,t){return e===S?t:e}function gt(e,t,r,n){return e!==S&&ta.call(n,r)?e:t}function ht(e,t,r){for(var n=-1,o=Gs(t),i=o.length;++n<i;){var a=o[n],s=e[a],u=r(s,t[a],a,e,t);(u===u?u===s:s!==s)&&(s!==S||a in e)||(e[a]=u)}return e}function mt(e,t){return null==t?e:yt(t,Gs(t),e)}function vt(e,t){for(var r=-1,n=null==e,o=!n&&Qr(e),i=o?e.length:0,a=t.length,s=zi(a);++r<a;){var u=t[r];s[r]=o?Jr(u,i)?e[u]:S:n?S:e[u]}return s}function yt(e,t,r){r||(r={});for(var n=-1,o=t.length;++n<o;){var i=t[n];r[i]=e[i]}return r}function bt(e,t,r){var n=typeof e;return"function"==n?t===S?e:ir(e,t,r):null==e?Ci:"object"==n?Dt(e):t===S?Ni(e):Gt(e,t)}function Et(e,t,r,n,o,i,a){var s;if(r&&(s=o?r(e,n,o):r(e)),s!==S)return s;if(!ko(e))return e;var u=Ps(e);if(u){if(s=Wr(e),!t)return rt(e,s)}else{var c=na.call(e),l=c==K;if(c!=X&&c!=B&&(!l||o))return Ue[c]?Yr(e,c,t):o?e:{};if(s=Kr(l?{}:e),!t)return mt(s,e)}i||(i=[]),a||(a=[]);for(var p=i.length;p--;)if(i[p]==e)return a[p];return i.push(e),a.push(s),(u?nt:Lt)(e,function(n,o){s[o]=Et(n,t,r,o,e,i,a)}),s}function St(e,t,r){if("function"!=typeof e)throw new Qi(G);return fa(function(){e.apply(S,r)},t)}function Tt(e,t){var n=e?e.length:0,o=[];if(!n)return o;var i=-1,a=Br(),s=a===r,u=s&&t.length>=U?dr(t):null,c=t.length;u&&(a=$e,s=!1,t=u);e:for(;++i<n;){var l=e[i];if(s&&l===l){for(var p=c;p--;)if(t[p]===l)continue e;o.push(l)}else a(t,l,0)<0&&o.push(l)}return o}function xt(e,t){var r=!0;return Fa(e,function(e,n,o){return r=!!t(e,n,o)}),r}function wt(e,t,r,n){var o=n,i=o;return Fa(e,function(e,a,s){var u=+t(e,a,s);(r(u,o)||u===n&&u===i)&&(o=u,i=e)}),i}function Rt(e,t,r,n){var o=e.length;for(r=null==r?0:+r||0,r<0&&(r=-r>o?0:o+r),n=n===S||n>o?o:+n||0,n<0&&(n+=o),o=r>n?0:n>>>0,r>>>=0;r<o;)e[r++]=t;return e}function At(e,t){var r=[];return Fa(e,function(e,n,o){t(e,n,o)&&r.push(e)}),r}function Ct(e,t,r,n){var o;return r(e,function(e,r,i){if(t(e,r,i))return o=n?r:e,!1}),o}function Pt(e,t,r,n){n||(n=[]);for(var o=-1,i=e.length;++o<i;){var a=e[o];d(a)&&Qr(a)&&(r||Ps(a)||Ro(a))?t?Pt(a,t,r,n):ct(n,a):r||(n[n.length]=a)}return n}function It(e,t){return ja(e,t,ti)}function Lt(e,t){return ja(e,t,Gs)}function Ot(e,t){return Da(e,t,Gs)}function Mt(e,t){for(var r=-1,n=t.length,o=-1,i=[];++r<n;){var a=t[r];No(e[a])&&(i[++o]=a)}return i}function Nt(e,t,r){if(null!=e){r!==S&&r in pn(e)&&(t=[r]);for(var n=0,o=t.length;null!=e&&n<o;)e=e[t[n++]];return n&&n==o?e:S}}function kt(e,t,r,n,o,i){return e===t||(null==e||null==t||!ko(e)&&!d(t)?e!==e&&t!==t:Ft(e,t,kt,r,n,o,i))}function Ft(e,t,r,n,o,i,a){var s=Ps(e),u=Ps(t),c=q,l=q;s||(c=na.call(e),c==B?c=X:c!=X&&(s=Vo(e))),u||(l=na.call(t),l==B?l=X:l!=X&&(u=Vo(t)));var p=c==X,f=l==X,_=c==l;if(_&&!s&&!p)return jr(e,t,c);if(!o){var d=p&&ta.call(e,"__wrapped__"),g=f&&ta.call(t,"__wrapped__");if(d||g)return r(d?e.value():e,g?t.value():t,n,o,i,a)}if(!_)return!1;i||(i=[]),a||(a=[]);for(var h=i.length;h--;)if(i[h]==e)return a[h]==t;i.push(e),a.push(t);var m=(s?Ur:Dr)(e,t,r,n,o,i,a);return i.pop(),a.pop(),m}function Ut(e,t,r){var n=t.length,o=n,i=!r;if(null==e)return!o;for(e=pn(e);n--;){var a=t[n];if(i&&a[2]?a[1]!==e[a[0]]:!(a[0]in e))return!1}for(;++n<o;){a=t[n];var s=a[0],u=e[s],c=a[1];if(i&&a[2]){if(u===S&&!(s in e))return!1}else{var l=r?r(u,c,s):S;if(!(l===S?kt(c,u,r,!0):l))return!1}}return!0}function jt(e,t){var r=-1,n=Qr(e)?zi(e.length):[];return Fa(e,function(e,o,i){n[++r]=t(e,o,i)}),n}function Dt(e){var t=qr(e);if(1==t.length&&t[0][2]){var r=t[0][0],n=t[0][1];return function(e){return null!=e&&(e[r]===n&&(n!==S||r in pn(e)))}}return function(e){return Ut(e,t)}}function Gt(e,t){var r=Ps(e),n=$r(e)&&rn(t),o=e+"";return e=fn(e),function(i){if(null==i)return!1;var a=o;if(i=pn(i),(r||!n)&&!(a in i)){if(null==(i=1==e.length?i:Nt(i,Yt(e,0,-1))))return!1;a=Rn(e),i=pn(i)}return i[a]===t?t!==S||a in i:kt(t,i[a],S,!0)}}function zt(e,t,r,n,o){if(!ko(e))return e;var i=Qr(t)&&(Ps(t)||Vo(t)),a=i?S:Gs(t);return nt(a||t,function(s,u){if(a&&(u=s,s=t[u]),d(s))n||(n=[]),o||(o=[]),Bt(e,t,u,zt,r,n,o);else{var c=e[u],l=r?r(c,s,u,e,t):S,p=l===S;p&&(l=s),l===S&&(!i||u in e)||!p&&(l===l?l===c:c!==c)||(e[u]=l)}}),e}function Bt(e,t,r,n,o,i,a){for(var s=i.length,u=t[r];s--;)if(i[s]==u)return void(e[r]=a[s]);var c=e[r],l=o?o(c,u,r,e,t):S,p=l===S;p&&(l=u,Qr(u)&&(Ps(u)||Vo(u))?l=Ps(c)?c:Qr(c)?rt(c):[]:zo(u)||Ro(u)?l=Ro(c)?Xo(c):zo(c)?c:{}:p=!1),i.push(u),a.push(l),p?e[r]=n(l,u,o,i,a):(l===l?l!==c:c===c)&&(e[r]=l)}function qt(e){return function(t){return null==t?S:t[e]}}function Vt(e){var t=e+"";return e=fn(e),function(r){return Nt(r,e,t)}}function Ht(e,t){for(var r=e?t.length:0;r--;){var n=t[r];if(n!=o&&Jr(n)){var o=n;_a.call(e,n,1)}}return e}function Wt(e,t){return e+va(Ra()*(t-e+1))}function Kt(e,t,r,n,o){return o(e,function(e,o,i){r=n?(n=!1,e):t(r,e,o,i)}),r}function Yt(e,t,r){var n=-1,o=e.length;t=null==t?0:+t||0,t<0&&(t=-t>o?0:o+t),r=r===S||r>o?o:+r||0,r<0&&(r+=o),o=t>r?0:r-t>>>0,t>>>=0;for(var i=zi(o);++n<o;)i[n]=e[n+t];return i}function Xt(e,t){var r;return Fa(e,function(e,n,o){return!(r=t(e,n,o))}),!!r}function Qt(e,t){var r=e.length;for(e.sort(t);r--;)e[r]=e[r].value;return e}function Jt(e,t,r){var n=Gr(),o=-1;return t=ut(t,function(e){return n(e)}),Qt(jt(e,function(e){return{criteria:ut(t,function(t){return t(e)}),index:++o,value:e}}),function(e,t){return u(e,t,r)})}function Zt(e,t){var r=0;return Fa(e,function(e,n,o){r+=+t(e,n,o)||0}),r}function $t(e,t){var n=-1,o=Br(),i=e.length,a=o===r,s=a&&i>=U,u=s?dr():null,c=[];u?(o=$e,a=!1):(s=!1,u=t?[]:c);e:for(;++n<i;){var l=e[n],p=t?t(l,n,e):l;if(a&&l===l){for(var f=u.length;f--;)if(u[f]===p)continue e;t&&u.push(p),c.push(l)}else o(u,p,0)<0&&((t||s)&&u.push(p),c.push(l))}return c}function er(e,t){for(var r=-1,n=t.length,o=zi(n);++r<n;)o[r]=e[t[r]];return o}function tr(e,t,r,n){for(var o=e.length,i=n?o:-1;(n?i--:++i<o)&&t(e[i],i,e););return r?Yt(e,n?0:i,n?i+1:o):Yt(e,n?i+1:0,n?o:i)}function rr(e,t){var r=e;r instanceof ze&&(r=r.value());for(var n=-1,o=t.length;++n<o;){var i=t[n];r=i.func.apply(i.thisArg,ct([r],i.args))}return r}function nr(e,t,r){var n=0,o=e?e.length:n;if("number"==typeof t&&t===t&&o<=La){for(;n<o;){var i=n+o>>>1,a=e[i];(r?a<=t:a<t)&&null!==a?n=i+1:o=i}return o}return or(e,t,Ci,r)}function or(e,t,r,n){t=r(t);for(var o=0,i=e?e.length:0,a=t!==t,s=null===t,u=t===S;o<i;){var c=va((o+i)/2),l=r(e[c]),p=l!==S,f=l===l;if(a)var _=f||n;else _=s?f&&p&&(n||null!=l):u?f&&(n||p):null!=l&&(n?l<=t:l<t);_?o=c+1:i=c}return Ta(i,Ia)}function ir(e,t,r){if("function"!=typeof e)return Ci;if(t===S)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 3:return function(r,n,o){return e.call(t,r,n,o)};case 4:return function(r,n,o,i){return e.call(t,r,n,o,i)};case 5:return function(r,n,o,i,a){return e.call(t,r,n,o,i,a)}}return function(){return e.apply(t,arguments)}}function ar(e){var t=new aa(e.byteLength);return new da(t).set(new da(e)),t}function sr(e,t,r){for(var n=r.length,o=-1,i=Sa(e.length-n,0),a=-1,s=t.length,u=zi(s+i);++a<s;)u[a]=t[a];for(;++o<n;)u[r[o]]=e[o];for(;i--;)u[a++]=e[o++];return u}function ur(e,t,r){for(var n=-1,o=r.length,i=-1,a=Sa(e.length-o,0),s=-1,u=t.length,c=zi(a+u);++i<a;)c[i]=e[i];for(var l=i;++s<u;)c[l+s]=t[s];for(;++n<o;)c[l+r[n]]=e[i++];return c}function cr(e,t){return function(r,n,o){var i=t?t():{};if(n=Gr(n,o,3),Ps(r))for(var a=-1,s=r.length;++a<s;){var u=r[a];e(i,u,n(u,a,r),r)}else Fa(r,function(t,r,o){e(i,t,n(t,r,o),o)});return i}}function lr(e){return vo(function(t,r){var n=-1,o=null==t?0:r.length,i=o>2?r[o-2]:S,a=o>2?r[2]:S,s=o>1?r[o-1]:S;for("function"==typeof i?(i=ir(i,s,5),o-=2):(i="function"==typeof s?s:S,o-=i?1:0),a&&Zr(r[0],r[1],a)&&(i=o<3?S:i,o=1);++n<o;){var u=r[n];u&&e(t,u,i)}return t})}function pr(e,t){return function(r,n){var o=r?Ba(r):0;if(!tn(o))return e(r,n);for(var i=t?o:-1,a=pn(r);(t?i--:++i<o)&&!1!==n(a[i],i,a););return r}}function fr(e){return function(t,r,n){for(var o=pn(t),i=n(t),a=i.length,s=e?a:-1;e?s--:++s<a;){var u=i[s];if(!1===r(o[u],u,o))break}return t}}function _r(e,t){function r(){return(this&&this!==Qe&&this instanceof r?n:e).apply(t,arguments)}var n=hr(e);return r}function dr(e){return ma&&pa?new Ze(e):null}function gr(e){return function(t){for(var r=-1,n=wi(pi(t)),o=n.length,i="";++r<o;)i=e(i,n[r],r);return i}}function hr(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var r=ka(e.prototype),n=e.apply(r,t);return ko(n)?n:r}}function mr(e){function t(r,n,o){o&&Zr(r,n,o)&&(n=S);var i=Fr(r,e,S,S,S,S,S,n);return i.placeholder=t.placeholder,i}return t}function vr(e,t){return vo(function(r){var n=r[0];return null==n?n:(r.push(t),e.apply(S,r))})}function yr(e,t){return function(r,n,o){if(o&&Zr(r,n,o)&&(n=S),n=Gr(n,o,3),1==n.length){r=Ps(r)?r:ln(r);var i=at(r,n,e,t);if(!r.length||i!==t)return i}return wt(r,n,e,t)}}function br(e,r){return function(n,o,i){if(o=Gr(o,i,3),Ps(n)){var a=t(n,o,r);return a>-1?n[a]:S}return Ct(n,o,e)}}function Er(e){return function(r,n,o){return r&&r.length?(n=Gr(n,o,3),t(r,n,e)):-1}}function Sr(e){return function(t,r,n){return r=Gr(r,n,3),Ct(t,r,e,!0)}}function Tr(e){return function(){for(var t,r=arguments.length,n=e?r:-1,o=0,i=zi(r);e?n--:++n<r;){var a=i[o++]=arguments[n];if("function"!=typeof a)throw new Qi(G);!t&&Ge.prototype.thru&&"wrapper"==zr(a)&&(t=new Ge([],!0))}for(n=t?-1:r;++n<r;){a=i[n];var s=zr(a),u="wrapper"==s?za(a):S
;t=u&&en(u[0])&&u[1]==(L|A|P|O)&&!u[4].length&&1==u[9]?t[zr(u[0])].apply(t,u[3]):1==a.length&&en(a)?t[s]():t.thru(a)}return function(){var e=arguments,n=e[0];if(t&&1==e.length&&Ps(n)&&n.length>=U)return t.plant(n).value();for(var o=0,a=r?i[o].apply(this,e):n;++o<r;)a=i[o].call(this,a);return a}}}function xr(e,t){return function(r,n,o){return"function"==typeof n&&o===S&&Ps(r)?e(r,n):t(r,ir(n,o,3))}}function wr(e){return function(t,r,n){return"function"==typeof r&&n===S||(r=ir(r,n,3)),e(t,r,ti)}}function Rr(e){return function(t,r,n){return"function"==typeof r&&n===S||(r=ir(r,n,3)),e(t,r)}}function Ar(e){return function(t,r,n){var o={};return r=Gr(r,n,3),Lt(t,function(t,n,i){var a=r(t,n,i);n=e?a:n,t=e?t:a,o[n]=t}),o}}function Cr(e){return function(t,r,n){return t=o(t),(e?t:"")+Or(t,r,n)+(e?"":t)}}function Pr(e){var t=vo(function(r,n){var o=h(n,t.placeholder);return Fr(r,e,S,n,o)});return t}function Ir(e,t){return function(r,n,o,i){var a=arguments.length<3;return"function"==typeof n&&i===S&&Ps(r)?e(r,n,o,a):Kt(r,Gr(n,i,4),o,a,t)}}function Lr(e,t,r,n,o,i,a,s,u,c){function l(){for(var y=arguments.length,b=y,E=zi(y);b--;)E[b]=arguments[b];if(n&&(E=sr(E,n,o)),i&&(E=ur(E,i,a)),d||m){var T=l.placeholder,R=h(E,T);if((y-=R.length)<c){var A=s?rt(s):S,C=Sa(c-y,0),L=d?R:S,O=d?S:R,M=d?E:S,N=d?S:E;t|=d?P:I,t&=~(d?I:P),g||(t&=~(x|w));var k=[e,t,r,M,L,N,O,A,u,C],F=Lr.apply(S,k);return en(e)&&qa(F,k),F.placeholder=T,F}}var U=f?r:this,j=_?U[e]:e;return s&&(E=un(E,s)),p&&u<E.length&&(E.length=u),this&&this!==Qe&&this instanceof l&&(j=v||hr(e)),j.apply(U,E)}var p=t&L,f=t&x,_=t&w,d=t&A,g=t&R,m=t&C,v=_?S:hr(e);return l}function Or(e,t,r){var n=e.length;if(t=+t,n>=t||!ba(t))return"";var o=t-n;return r=null==r?" ":r+"",mi(r,ha(o/r.length)).slice(0,o)}function Mr(e,t,r,n){function o(){for(var t=-1,s=arguments.length,u=-1,c=n.length,l=zi(c+s);++u<c;)l[u]=n[u];for(;s--;)l[u++]=arguments[++t];return(this&&this!==Qe&&this instanceof o?a:e).apply(i?r:this,l)}var i=t&x,a=hr(e);return o}function Nr(e){var t=Hi[e];return function(e,r){return r=r===S?0:+r||0,r?(r=ca(10,r),t(e*r)/r):t(e)}}function kr(e){return function(t,r,n,o){var i=Gr(n);return null==n&&i===bt?nr(t,r,e):or(t,r,i(n,o,1),e)}}function Fr(e,t,r,n,o,i,a,s){var u=t&w;if(!u&&"function"!=typeof e)throw new Qi(G);var c=n?n.length:0;if(c||(t&=~(P|I),n=o=S),c-=o?o.length:0,t&I){var l=n,p=o;n=o=S}var f=u?S:za(e),_=[e,t,r,n,o,l,p,i,a,s];if(f&&(nn(_,f),t=_[1],s=_[9]),_[9]=null==s?u?0:e.length:Sa(s-c,0)||0,t==x)var d=_r(_[0],_[2]);else d=t!=P&&t!=(x|P)||_[4].length?Lr.apply(S,_):Mr.apply(S,_);return(f?Ga:qa)(d,_)}function Ur(e,t,r,n,o,i,a){var s=-1,u=e.length,c=t.length;if(u!=c&&!(o&&c>u))return!1;for(;++s<u;){var l=e[s],p=t[s],f=n?n(o?p:l,o?l:p,s):S;if(f!==S){if(f)continue;return!1}if(o){if(!ft(t,function(e){return l===e||r(l,e,n,o,i,a)}))return!1}else if(l!==p&&!r(l,p,n,o,i,a))return!1}return!0}function jr(e,t,r){switch(r){case V:case H:return+e==+t;case W:return e.name==t.name&&e.message==t.message;case Y:return e!=+e?t!=+t:e==+t;case Q:case J:return e==t+""}return!1}function Dr(e,t,r,n,o,i,a){var s=Gs(e),u=s.length;if(u!=Gs(t).length&&!o)return!1;for(var c=u;c--;){var l=s[c];if(!(o?l in t:ta.call(t,l)))return!1}for(var p=o;++c<u;){l=s[c];var f=e[l],_=t[l],d=n?n(o?_:f,o?f:_,l):S;if(!(d===S?r(f,_,n,o,i,a):d))return!1;p||(p="constructor"==l)}if(!p){var g=e.constructor,h=t.constructor;if(g!=h&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof h&&h instanceof h))return!1}return!0}function Gr(e,t,r){var n=je.callback||Ri;return n=n===Ri?bt:n,r?n(e,t,r):n}function zr(e){for(var t=e.name+"",r=Na[t],n=r?r.length:0;n--;){var o=r[n],i=o.func;if(null==i||i==e)return o.name}return t}function Br(e,t,n){var o=je.indexOf||xn;return o=o===xn?r:o,e?o(e,t,n):o}function qr(e){for(var t=ri(e),r=t.length;r--;)t[r][2]=rn(t[r][1]);return t}function Vr(e,t){var r=null==e?S:e[t];return jo(r)?r:S}function Hr(e,t,r){for(var n=-1,o=r.length;++n<o;){var i=r[n],a=i.size;switch(i.type){case"drop":e+=a;break;case"dropRight":t-=a;break;case"take":t=Ta(t,e+a);break;case"takeRight":e=Sa(e,t-a)}}return{start:e,end:t}}function Wr(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&ta.call(e,"index")&&(r.index=e.index,r.input=e.input),r}function Kr(e){var t=e.constructor;return"function"==typeof t&&t instanceof t||(t=Ki),new t}function Yr(e,t,r){var n=e.constructor;switch(t){case Z:return ar(e);case V:case H:return new n(+e);case $:case ee:case te:case re:case ne:case oe:case ie:case ae:case se:var o=e.buffer;return new n(r?ar(o):o,e.byteOffset,e.length);case Y:case J:return new n(e);case Q:var i=new n(e.source,Re.exec(e));i.lastIndex=e.lastIndex}return i}function Xr(e,t,r){null==e||$r(t,e)||(t=fn(t),e=1==t.length?e:Nt(e,Yt(t,0,-1)),t=Rn(t));var n=null==e?e:e[t];return null==n?S:n.apply(e,r)}function Qr(e){return null!=e&&tn(Ba(e))}function Jr(e,t){return e="number"==typeof e||Pe.test(e)?+e:-1,t=null==t?Oa:t,e>-1&&e%1==0&&e<t}function Zr(e,t,r){if(!ko(r))return!1;var n=typeof t;if("number"==n?Qr(r)&&Jr(t,r.length):"string"==n&&t in r){var o=r[t];return e===e?e===o:o!==o}return!1}function $r(e,t){var r=typeof e;return!!("string"==r&&ye.test(e)||"number"==r)||!Ps(e)&&(!ve.test(e)||null!=t&&e in pn(t))}function en(e){var t=zr(e),r=je[t];if("function"!=typeof r||!(t in ze.prototype))return!1;if(e===r)return!0;var n=za(r);return!!n&&e===n[0]}function tn(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=Oa}function rn(e){return e===e&&!ko(e)}function nn(e,t){var r=e[1],n=t[1],o=r|n,i=o<L,a=n==L&&r==A||n==L&&r==O&&e[7].length<=t[8]||n==(L|O)&&r==A;if(!i&&!a)return e;n&x&&(e[2]=t[2],o|=r&x?0:R);var s=t[3];if(s){var u=e[3];e[3]=u?sr(u,s,t[4]):rt(s),e[4]=u?h(e[3],z):rt(t[4])}return s=t[5],s&&(u=e[5],e[5]=u?ur(u,s,t[6]):rt(s),e[6]=u?h(e[5],z):rt(t[6])),s=t[7],s&&(e[7]=rt(s)),n&L&&(e[8]=null==e[8]?t[8]:Ta(e[8],t[8])),null==e[9]&&(e[9]=t[9]),e[0]=t[0],e[1]=o,e}function on(e,t){return e===S?t:Is(e,t,on)}function an(e,t){e=pn(e);for(var r=-1,n=t.length,o={};++r<n;){var i=t[r];i in e&&(o[i]=e[i])}return o}function sn(e,t){var r={};return It(e,function(e,n,o){t(e,n,o)&&(r[n]=e)}),r}function un(e,t){for(var r=e.length,n=Ta(t.length,r),o=rt(e);n--;){var i=t[n];e[n]=Jr(i,r)?o[i]:S}return e}function cn(e){for(var t=ti(e),r=t.length,n=r&&e.length,o=!!n&&tn(n)&&(Ps(e)||Ro(e)),i=-1,a=[];++i<r;){var s=t[i];(o&&Jr(s,n)||ta.call(e,s))&&a.push(s)}return a}function ln(e){return null==e?[]:Qr(e)?ko(e)?e:Ki(e):ai(e)}function pn(e){return ko(e)?e:Ki(e)}function fn(e){if(Ps(e))return e;var t=[];return o(e).replace(be,function(e,r,n,o){t.push(n?o.replace(xe,"$1"):r||e)}),t}function _n(e){return e instanceof ze?e.clone():new Ge(e.__wrapped__,e.__chain__,rt(e.__actions__))}function dn(e,t,r){t=(r?Zr(e,t,r):null==t)?1:Sa(va(t)||1,1);for(var n=0,o=e?e.length:0,i=-1,a=zi(ha(o/t));n<o;)a[++i]=Yt(e,n,n+=t);return a}function gn(e){for(var t=-1,r=e?e.length:0,n=-1,o=[];++t<r;){var i=e[t];i&&(o[++n]=i)}return o}function hn(e,t,r){return(e?e.length:0)?((r?Zr(e,t,r):null==t)&&(t=1),Yt(e,t<0?0:t)):[]}function mn(e,t,r){var n=e?e.length:0;return n?((r?Zr(e,t,r):null==t)&&(t=1),t=n-(+t||0),Yt(e,0,t<0?0:t)):[]}function vn(e,t,r){return e&&e.length?tr(e,Gr(t,r,3),!0,!0):[]}function yn(e,t,r){return e&&e.length?tr(e,Gr(t,r,3),!0):[]}function bn(e,t,r,n){var o=e?e.length:0;return o?(r&&"number"!=typeof r&&Zr(e,t,r)&&(r=0,n=o),Rt(e,t,r,n)):[]}function En(e){return e?e[0]:S}function Sn(e,t,r){var n=e?e.length:0;return r&&Zr(e,t,r)&&(t=!1),n?Pt(e,t):[]}function Tn(e){return(e?e.length:0)?Pt(e,!0):[]}function xn(e,t,n){var o=e?e.length:0;if(!o)return-1;if("number"==typeof n)n=n<0?Sa(o+n,0):n;else if(n){var i=nr(e,t);return i<o&&(t===t?t===e[i]:e[i]!==e[i])?i:-1}return r(e,t,n||0)}function wn(e){return mn(e,1)}function Rn(e){var t=e?e.length:0;return t?e[t-1]:S}function An(e,t,r){var n=e?e.length:0;if(!n)return-1;var o=n;if("number"==typeof r)o=(r<0?Sa(n+r,0):Ta(r||0,n-1))+1;else if(r){o=nr(e,t,!0)-1;var i=e[o];return(t===t?t===i:i!==i)?o:-1}if(t!==t)return _(e,o,!0);for(;o--;)if(e[o]===t)return o;return-1}function Cn(){var e=arguments,t=e[0];if(!t||!t.length)return t;for(var r=0,n=Br(),o=e.length;++r<o;)for(var i=0,a=e[r];(i=n(t,a,i))>-1;)_a.call(t,i,1);return t}function Pn(e,t,r){var n=[];if(!e||!e.length)return n;var o=-1,i=[],a=e.length;for(t=Gr(t,r,3);++o<a;){var s=e[o];t(s,o,e)&&(n.push(s),i.push(o))}return Ht(e,i),n}function In(e){return hn(e,1)}function Ln(e,t,r){var n=e?e.length:0;return n?(r&&"number"!=typeof r&&Zr(e,t,r)&&(t=0,r=n),Yt(e,t,r)):[]}function On(e,t,r){return(e?e.length:0)?((r?Zr(e,t,r):null==t)&&(t=1),Yt(e,0,t<0?0:t)):[]}function Mn(e,t,r){var n=e?e.length:0;return n?((r?Zr(e,t,r):null==t)&&(t=1),t=n-(+t||0),Yt(e,t<0?0:t)):[]}function Nn(e,t,r){return e&&e.length?tr(e,Gr(t,r,3),!1,!0):[]}function kn(e,t,r){return e&&e.length?tr(e,Gr(t,r,3)):[]}function Fn(e,t,n,o){if(!(e?e.length:0))return[];null!=t&&"boolean"!=typeof t&&(o=n,n=Zr(e,t,o)?S:t,t=!1);var i=Gr();return null==n&&i===bt||(n=i(n,o,3)),t&&Br()===r?m(e,n):$t(e,n)}function Un(e){if(!e||!e.length)return[];var t=-1,r=0;e=st(e,function(e){if(Qr(e))return r=Sa(e.length,r),!0});for(var n=zi(r);++t<r;)n[t]=ut(e,qt(t));return n}function jn(e,t,r){if(!(e?e.length:0))return[];var n=Un(e);return null==t?n:(t=ir(t,r,4),ut(n,function(e){return lt(e,t,S,!0)}))}function Dn(){for(var e=-1,t=arguments.length;++e<t;){var r=arguments[e];if(Qr(r))var n=n?ct(Tt(n,r),Tt(r,n)):r}return n?$t(n):[]}function Gn(e,t){var r=-1,n=e?e.length:0,o={};for(!n||t||Ps(e[0])||(t=[]);++r<n;){var i=e[r];t?o[i]=t[r]:i&&(o[i[0]]=i[1])}return o}function zn(e){var t=je(e);return t.__chain__=!0,t}function Bn(e,t,r){return t.call(r,e),e}function qn(e,t,r){return t.call(r,e)}function Vn(){return zn(this)}function Hn(){return new Ge(this.value(),this.__chain__)}function Wn(e){for(var t,r=this;r instanceof De;){var n=_n(r);t?o.__wrapped__=n:t=n;var o=n;r=r.__wrapped__}return o.__wrapped__=e,t}function Kn(){var e=this.__wrapped__,t=function(e){return e.reverse()};if(e instanceof ze){var r=e;return this.__actions__.length&&(r=new ze(this)),r=r.reverse(),r.__actions__.push({func:qn,args:[t],thisArg:S}),new Ge(r,this.__chain__)}return this.thru(t)}function Yn(){return this.value()+""}function Xn(){return rr(this.__wrapped__,this.__actions__)}function Qn(e,t,r){var n=Ps(e)?it:xt;return r&&Zr(e,t,r)&&(t=S),"function"==typeof t&&r===S||(t=Gr(t,r,3)),n(e,t)}function Jn(e,t,r){var n=Ps(e)?st:At;return t=Gr(t,r,3),n(e,t)}function Zn(e,t){return os(e,Dt(t))}function $n(e,t,r,n){var o=e?Ba(e):0;return tn(o)||(e=ai(e),o=e.length),r="number"!=typeof r||n&&Zr(t,r,n)?0:r<0?Sa(o+r,0):r||0,"string"==typeof e||!Ps(e)&&qo(e)?r<=o&&e.indexOf(t,r)>-1:!!o&&Br(e,t,r)>-1}function eo(e,t,r){var n=Ps(e)?ut:jt;return t=Gr(t,r,3),n(e,t)}function to(e,t){return eo(e,Ni(t))}function ro(e,t,r){var n=Ps(e)?st:At;return t=Gr(t,r,3),n(e,function(e,r,n){return!t(e,r,n)})}function no(e,t,r){if(r?Zr(e,t,r):null==t){e=ln(e);var n=e.length;return n>0?e[Wt(0,n-1)]:S}var o=-1,i=Yo(e),n=i.length,a=n-1;for(t=Ta(t<0?0:+t||0,n);++o<t;){var s=Wt(o,a),u=i[s];i[s]=i[o],i[o]=u}return i.length=t,i}function oo(e){return no(e,Ca)}function io(e){var t=e?Ba(e):0;return tn(t)?t:Gs(e).length}function ao(e,t,r){var n=Ps(e)?ft:Xt;return r&&Zr(e,t,r)&&(t=S),"function"==typeof t&&r===S||(t=Gr(t,r,3)),n(e,t)}function so(e,t,r){if(null==e)return[];r&&Zr(e,t,r)&&(t=S);var n=-1;return t=Gr(t,r,3),Qt(jt(e,function(e,r,o){return{criteria:t(e,r,o),index:++n,value:e}}),s)}function uo(e,t,r,n){return null==e?[]:(n&&Zr(t,r,n)&&(r=S),Ps(t)||(t=null==t?[]:[t]),Ps(r)||(r=null==r?[]:[r]),Jt(e,t,r))}function co(e,t){return Jn(e,Dt(t))}function lo(e,t){if("function"!=typeof t){if("function"!=typeof e)throw new Qi(G);var r=e;e=t,t=r}return e=ba(e=+e)?e:0,function(){if(--e<1)return t.apply(this,arguments)}}function po(e,t,r){return r&&Zr(e,t,r)&&(t=S),t=e&&null==t?e.length:Sa(+t||0,0),Fr(e,L,S,S,S,S,t)}function fo(e,t){var r;if("function"!=typeof t){if("function"!=typeof e)throw new Qi(G);var n=e;e=t,t=n}return function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=S),r}}function _o(e,t,r){function n(){_&&sa(_),c&&sa(c),g=0,c=_=d=S}function o(t,r){r&&sa(r),c=_=d=S,t&&(g=gs(),l=e.apply(f,u),_||c||(u=f=S))}function i(){var e=t-(gs()-p);e<=0||e>t?o(d,c):_=fa(i,e)}function a(){o(m,_)}function s(){if(u=arguments,p=gs(),f=this,d=m&&(_||!v),!1===h)var r=v&&!_;else{c||v||(g=p);var n=h-(p-g),o=n<=0||n>h;o?(c&&(c=sa(c)),g=p,l=e.apply(f,u)):c||(c=fa(a,n))}return o&&_?_=sa(_):_||t===h||(_=fa(i,t)),r&&(o=!0,l=e.apply(f,u)),!o||_||c||(u=f=S),l}var u,c,l,p,f,_,d,g=0,h=!1,m=!0;if("function"!=typeof e)throw new Qi(G);if(t=t<0?0:+t||0,!0===r){var v=!0;m=!1}else ko(r)&&(v=!!r.leading,h="maxWait"in r&&Sa(+r.maxWait||0,t),m="trailing"in r?!!r.trailing:m);return s.cancel=n,s}function go(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new Qi(G);var r=function(){var n=arguments,o=t?t.apply(this,n):n[0],i=r.cache;if(i.has(o))return i.get(o);var a=e.apply(this,n);return r.cache=i.set(o,a),a};return r.cache=new go.Cache,r}function ho(e){if("function"!=typeof e)throw new Qi(G);return function(){return!e.apply(this,arguments)}}function mo(e){return fo(2,e)}function vo(e,t){if("function"!=typeof e)throw new Qi(G);return t=Sa(t===S?e.length-1:+t||0,0),function(){for(var r=arguments,n=-1,o=Sa(r.length-t,0),i=zi(o);++n<o;)i[n]=r[t+n];switch(t){case 0:return e.call(this,i);case 1:return e.call(this,r[0],i);case 2:return e.call(this,r[0],r[1],i)}var a=zi(t+1);for(n=-1;++n<t;)a[n]=r[n];return a[t]=i,e.apply(this,a)}}function yo(e){if("function"!=typeof e)throw new Qi(G);return function(t){return e.apply(this,t)}}function bo(e,t,r){var n=!0,o=!0;if("function"!=typeof e)throw new Qi(G);return!1===r?n=!1:ko(r)&&(n="leading"in r?!!r.leading:n,o="trailing"in r?!!r.trailing:o),_o(e,t,{leading:n,maxWait:+t,trailing:o})}function Eo(e,t){return t=null==t?Ci:t,Fr(t,P,S,[e],[])}function So(e,t,r,n){return t&&"boolean"!=typeof t&&Zr(e,t,r)?t=!1:"function"==typeof t&&(n=r,r=t,t=!1),"function"==typeof r?Et(e,t,ir(r,n,3)):Et(e,t)}function To(e,t,r){return"function"==typeof t?Et(e,!0,ir(t,r,3)):Et(e,!0)}function xo(e,t){return e>t}function wo(e,t){return e>=t}function Ro(e){return d(e)&&Qr(e)&&ta.call(e,"callee")&&!la.call(e,"callee")}function Ao(e){return!0===e||!1===e||d(e)&&na.call(e)==V}function Co(e){return d(e)&&na.call(e)==H}function Po(e){return!!e&&1===e.nodeType&&d(e)&&!zo(e)}function Io(e){return null==e||(Qr(e)&&(Ps(e)||qo(e)||Ro(e)||d(e)&&No(e.splice))?!e.length:!Gs(e).length)}function Lo(e,t,r,n){r="function"==typeof r?ir(r,n,3):S;var o=r?r(e,t):S;return o===S?kt(e,t,r):!!o}function Oo(e){return d(e)&&"string"==typeof e.message&&na.call(e)==W}function Mo(e){return"number"==typeof e&&ba(e)}function No(e){return ko(e)&&na.call(e)==K}function ko(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Fo(e,t,r,n){return r="function"==typeof r?ir(r,n,3):S,Ut(e,qr(t),r)}function Uo(e){return Go(e)&&e!=+e}function jo(e){return null!=e&&(No(e)?ia.test(ea.call(e)):d(e)&&Ce.test(e))}function Do(e){return null===e}function Go(e){return"number"==typeof e||d(e)&&na.call(e)==Y}function zo(e){var t;if(!d(e)||na.call(e)!=X||Ro(e)||!ta.call(e,"constructor")&&"function"==typeof(t=e.constructor)&&!(t instanceof t))return!1;var r;return It(e,function(e,t){r=t}),r===S||ta.call(e,r)}function Bo(e){return ko(e)&&na.call(e)==Q}function qo(e){return"string"==typeof e||d(e)&&na.call(e)==J}function Vo(e){return d(e)&&tn(e.length)&&!!Fe[na.call(e)]}function Ho(e){return e===S}function Wo(e,t){return e<t}function Ko(e,t){return e<=t}function Yo(e){var t=e?Ba(e):0;return tn(t)?t?rt(e):[]:ai(e)}function Xo(e){return yt(e,ti(e))}function Qo(e,t,r){var n=ka(e);return r&&Zr(e,t,r)&&(t=S),t?mt(n,t):n}function Jo(e){return Mt(e,ti(e))}function Zo(e,t,r){var n=null==e?S:Nt(e,fn(t),t+"");return n===S?r:n}function $o(e,t){if(null==e)return!1;var r=ta.call(e,t);if(!r&&!$r(t)){if(t=fn(t),null==(e=1==t.length?e:Nt(e,Yt(t,0,-1))))return!1;t=Rn(t),r=ta.call(e,t)}return r||tn(e.length)&&Jr(t,e.length)&&(Ps(e)||Ro(e))}function ei(e,t,r){r&&Zr(e,t,r)&&(t=S);for(var n=-1,o=Gs(e),i=o.length,a={};++n<i;){var s=o[n],u=e[s];t?ta.call(a,u)?a[u].push(s):a[u]=[s]:a[u]=s}return a}function ti(e){if(null==e)return[];ko(e)||(e=Ki(e));var t=e.length;t=t&&tn(t)&&(Ps(e)||Ro(e))&&t||0;for(var r=e.constructor,n=-1,o="function"==typeof r&&r.prototype===e,i=zi(t),a=t>0;++n<t;)i[n]=n+"";for(var s in e)a&&Jr(s,t)||"constructor"==s&&(o||!ta.call(e,s))||i.push(s);return i}function ri(e){e=pn(e);for(var t=-1,r=Gs(e),n=r.length,o=zi(n);++t<n;){var i=r[t];o[t]=[i,e[i]]}return o}function ni(e,t,r){var n=null==e?S:e[t];return n===S&&(null==e||$r(t,e)||(t=fn(t),e=1==t.length?e:Nt(e,Yt(t,0,-1)),n=null==e?S:e[Rn(t)]),n=n===S?r:n),No(n)?n.call(e):n}function oi(e,t,r){if(null==e)return e;var n=t+"";t=null!=e[n]||$r(t,e)?[n]:fn(t);for(var o=-1,i=t.length,a=i-1,s=e;null!=s&&++o<i;){var u=t[o];ko(s)&&(o==a?s[u]=r:null==s[u]&&(s[u]=Jr(t[o+1])?[]:{})),s=s[u]}return e}function ii(e,t,r,n){var o=Ps(e)||Vo(e);if(t=Gr(t,n,4),null==r)if(o||ko(e)){var i=e.constructor;r=o?Ps(e)?new i:[]:ka(No(i)?i.prototype:S)}else r={};return(o?nt:Lt)(e,function(e,n,o){return t(r,e,n,o)}),r}function ai(e){return er(e,Gs(e))}function si(e){return er(e,ti(e))}function ui(e,t,r){return t=+t||0,r===S?(r=t,t=0):r=+r||0,e>=Ta(t,r)&&e<Sa(t,r)}function ci(e,t,r){r&&Zr(e,t,r)&&(t=r=S);var n=null==e,o=null==t;if(null==r&&(o&&"boolean"==typeof e?(r=e,e=1):"boolean"==typeof t&&(r=t,o=!0)),n&&o&&(t=1,o=!1),e=+e||0,o?(t=e,e=0):t=+t||0,r||e%1||t%1){var i=Ra();return Ta(e+i*(t-e+ua("1e-"+((i+"").length-1))),t)}return Wt(e,t)}function li(e){return(e=o(e))&&e.charAt(0).toUpperCase()+e.slice(1)}function pi(e){return(e=o(e))&&e.replace(Ie,c).replace(Te,"")}function fi(e,t,r){e=o(e),t+="";var n=e.length;return r=r===S?n:Ta(r<0?0:+r||0,n),(r-=t.length)>=0&&e.indexOf(t,r)==r}function _i(e){return e=o(e),e&&de.test(e)?e.replace(fe,l):e}function di(e){return e=o(e),e&&Se.test(e)?e.replace(Ee,p):e||"(?:)"}function gi(e,t,r){e=o(e),t=+t;var n=e.length;if(n>=t||!ba(t))return e;var i=(t-n)/2,a=va(i);return r=Or("",ha(i),r),r.slice(0,a)+e+r}function hi(e,t,r){return(r?Zr(e,t,r):null==t)?t=0:t&&(t=+t),e=bi(e),wa(e,t||(Ae.test(e)?16:10))}function mi(e,t){var r="";if(e=o(e),(t=+t)<1||!e||!ba(t))return r;do{t%2&&(r+=e),t=va(t/2),e+=e}while(t);return r}function vi(e,t,r){return e=o(e),r=null==r?0:Ta(r<0?0:+r||0,e.length),e.lastIndexOf(t,r)==r}function yi(e,t,r){var n=je.templateSettings;r&&Zr(e,t,r)&&(t=r=S),e=o(e),t=ht(mt({},r||t),n,gt);var i,a,s=ht(mt({},t.imports),n.imports,gt),u=Gs(s),c=er(s,u),l=0,p=t.interpolate||Le,_="__p += '",d=Yi((t.escape||Le).source+"|"+p.source+"|"+(p===me?we:Le).source+"|"+(t.evaluate||Le).source+"|$","g"),g="//# sourceURL="+("sourceURL"in t?t.sourceURL:"lodash.templateSources["+ ++ke+"]")+"\n";e.replace(d,function(t,r,n,o,s,u){return n||(n=o),_+=e.slice(l,u).replace(Oe,f),r&&(i=!0,_+="' +\n__e("+r+") +\n'"),s&&(a=!0,_+="';\n"+s+";\n__p += '"),n&&(_+="' +\n((__t = ("+n+")) == null ? '' : __t) +\n'"),l=u+t.length,t}),_+="';\n";var h=t.variable;h||(_="with (obj) {\n"+_+"\n}\n"),_=(a?_.replace(ue,""):_).replace(ce,"$1").replace(le,"$1;"),_="function("+(h||"obj")+") {\n"+(h?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(i?", __e = _.escape":"")+(a?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+_+"return __p\n}";var m=Js(function(){return Vi(u,g+"return "+_).apply(S,c)});if(m.source=_,Oo(m))throw m;return m}function bi(e,t,r){var n=e;return(e=o(e))?(r?Zr(n,t,r):null==t)?e.slice(v(e),y(e)+1):(t+="",e.slice(i(e,t),a(e,t)+1)):e}function Ei(e,t,r){var n=e;return e=o(e),e?(r?Zr(n,t,r):null==t)?e.slice(v(e)):e.slice(i(e,t+"")):e}function Si(e,t,r){var n=e;return e=o(e),e?(r?Zr(n,t,r):null==t)?e.slice(0,y(e)+1):e.slice(0,a(e,t+"")+1):e}function Ti(e,t,r){r&&Zr(e,t,r)&&(t=S);var n=M,i=N;if(null!=t)if(ko(t)){var a="separator"in t?t.separator:a;n="length"in t?+t.length||0:n,i="omission"in t?o(t.omission):i}else n=+t||0;if(e=o(e),n>=e.length)return e;var s=n-i.length;if(s<1)return i;var u=e.slice(0,s);if(null==a)return u+i;if(Bo(a)){if(e.slice(s).search(a)){var c,l,p=e.slice(0,s);for(a.global||(a=Yi(a.source,(Re.exec(a)||"")+"g")),a.lastIndex=0;c=a.exec(p);)l=c.index;u=u.slice(0,null==l?s:l)}}else if(e.indexOf(a,s)!=s){var f=u.lastIndexOf(a);f>-1&&(u=u.slice(0,f))}return u+i}function xi(e){return e=o(e),e&&_e.test(e)?e.replace(pe,b):e}function wi(e,t,r){return r&&Zr(e,t,r)&&(t=S),e=o(e),e.match(t||Me)||[]}function Ri(e,t,r){return r&&Zr(e,t,r)&&(t=S),d(e)?Pi(e):bt(e,t)}function Ai(e){return function(){return e}}function Ci(e){return e}function Pi(e){return Dt(Et(e,!0))}function Ii(e,t){return Gt(e,Et(t,!0))}function Li(e,t,r){if(null==r){var n=ko(t),o=n?Gs(t):S,i=o&&o.length?Mt(t,o):S;(i?i.length:n)||(i=!1,r=t,t=e,e=this)}i||(i=Mt(t,Gs(t)));var a=!0,s=-1,u=No(e),c=i.length;!1===r?a=!1:ko(r)&&"chain"in r&&(a=r.chain);for(;++s<c;){var l=i[s],p=t[l];e[l]=p,u&&(e.prototype[l]=function(t){return function(){var r=this.__chain__;if(a||r){var n=e(this.__wrapped__);return(n.__actions__=rt(this.__actions__)).push({func:t,args:arguments,thisArg:e}),n.__chain__=r,n}return t.apply(e,ct([this.value()],arguments))}}(p))}return e}function Oi(){return Qe._=oa,this}function Mi(){}function Ni(e){return $r(e)?qt(e):Vt(e)}function ki(e){return function(t){return Nt(e,fn(t),t+"")}}function Fi(e,t,r){r&&Zr(e,t,r)&&(t=r=S),e=+e||0,r=null==r?1:+r||0,null==t?(t=e,e=0):t=+t||0;for(var n=-1,o=Sa(ha((t-e)/(r||1)),0),i=zi(o);++n<o;)i[n]=e,e+=r;return i}function Ui(e,t,r){if((e=va(e))<1||!ba(e))return[];var n=-1,o=zi(Ta(e,Pa));for(t=ir(t,r,1);++n<e;)n<Pa?o[n]=t(n):t(n);return o}function ji(e){var t=++ra;return o(e)+t}function Di(e,t){return(+e||0)+(+t||0)}function Gi(e,t,r){return r&&Zr(e,t,r)&&(t=S),t=Gr(t,r,3),1==t.length?_t(Ps(e)?e:ln(e),t):Zt(e,t)}g=g?Je.defaults(Qe.Object(),g,Je.pick(Qe,Ne)):Qe;var zi=g.Array,Bi=g.Date,qi=g.Error,Vi=g.Function,Hi=g.Math,Wi=g.Number,Ki=g.Object,Yi=g.RegExp,Xi=g.String,Qi=g.TypeError,Ji=zi.prototype,Zi=Ki.prototype,$i=Xi.prototype,ea=Vi.prototype.toString,ta=Zi.hasOwnProperty,ra=0,na=Zi.toString,oa=Qe._,ia=Yi("^"+ea.call(ta).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),aa=g.ArrayBuffer,sa=g.clearTimeout,ua=g.parseFloat,ca=Hi.pow,la=Zi.propertyIsEnumerable,pa=Vr(g,"Set"),fa=g.setTimeout,_a=Ji.splice,da=g.Uint8Array,ga=Vr(g,"WeakMap"),ha=Hi.ceil,ma=Vr(Ki,"create"),va=Hi.floor,ya=Vr(zi,"isArray"),ba=g.isFinite,Ea=Vr(Ki,"keys"),Sa=Hi.max,Ta=Hi.min,xa=Vr(Bi,"now"),wa=g.parseInt,Ra=Hi.random,Aa=Wi.NEGATIVE_INFINITY,Ca=Wi.POSITIVE_INFINITY,Pa=4294967295,Ia=Pa-1,La=Pa>>>1,Oa=9007199254740991,Ma=ga&&new ga,Na={};je.support={};je.templateSettings={escape:ge,evaluate:he,interpolate:me,variable:"",imports:{_:je}};var ka=function(){function e(){}return function(t){if(ko(t)){e.prototype=t;var r=new e;e.prototype=S}return r||{}}}(),Fa=pr(Lt),Ua=pr(Ot,!0),ja=fr(),Da=fr(!0),Ga=Ma?function(e,t){return Ma.set(e,t),e}:Ci,za=Ma?function(e){return Ma.get(e)}:Mi,Ba=qt("length"),qa=function(){var e=0,t=0;return function(r,n){var o=gs(),i=F-(o-t);if(t=o,i>0){if(++e>=k)return r}else e=0;return Ga(r,n)}}(),Va=vo(function(e,t){return d(e)&&Qr(e)?Tt(e,Pt(t,!1,!0)):[]}),Ha=Er(),Wa=Er(!0),Ka=vo(function(e){for(var t=e.length,n=t,o=zi(p),i=Br(),a=i===r,s=[];n--;){var u=e[n]=Qr(u=e[n])?u:[];o[n]=a&&u.length>=120?dr(n&&u):null}var c=e[0],l=-1,p=c?c.length:0,f=o[0];e:for(;++l<p;)if(u=c[l],(f?$e(f,u):i(s,u,0))<0){for(var n=t;--n;){var _=o[n];if((_?$e(_,u):i(e[n],u,0))<0)continue e}f&&f.push(u),s.push(u)}return s}),Ya=vo(function(t,r){r=Pt(r);var n=vt(t,r);return Ht(t,r.sort(e)),n}),Xa=kr(),Qa=kr(!0),Ja=vo(function(e){return $t(Pt(e,!1,!0))}),Za=vo(function(e,t){return Qr(e)?Tt(e,t):[]}),$a=vo(Un),es=vo(function(e){var t=e.length,r=t>2?e[t-2]:S,n=t>1?e[t-1]:S;return t>2&&"function"==typeof r?t-=2:(r=t>1&&"function"==typeof n?(--t,n):S,n=S),e.length=t,jn(e,r,n)}),ts=vo(function(e){return e=Pt(e),this.thru(function(t){return tt(Ps(t)?t:[pn(t)],e)})}),rs=vo(function(e,t){return vt(e,Pt(t))}),ns=cr(function(e,t,r){ta.call(e,r)?++e[r]:e[r]=1}),os=br(Fa),is=br(Ua,!0),as=xr(nt,Fa),ss=xr(ot,Ua),us=cr(function(e,t,r){ta.call(e,r)?e[r].push(t):e[r]=[t]}),cs=cr(function(e,t,r){e[r]=t}),ls=vo(function(e,t,r){var n=-1,o="function"==typeof t,i=$r(t),a=Qr(e)?zi(e.length):[];return Fa(e,function(e){var s=o?t:i&&null!=e?e[t]:S;a[++n]=s?s.apply(e,r):Xr(e,t,r)}),a}),ps=cr(function(e,t,r){e[r?0:1].push(t)},function(){return[[],[]]}),fs=Ir(lt,Fa),_s=Ir(pt,Ua),ds=vo(function(e,t){if(null==e)return[];var r=t[2];return r&&Zr(t[0],t[1],r)&&(t.length=1),Jt(e,Pt(t),[])}),gs=xa||function(){return(new Bi).getTime()},hs=vo(function(e,t,r){var n=x;if(r.length){var o=h(r,hs.placeholder);n|=P}return Fr(e,n,t,r,o)}),ms=vo(function(e,t){t=t.length?Pt(t):Jo(e);for(var r=-1,n=t.length;++r<n;){var o=t[r];e[o]=Fr(e[o],x,e)}return e}),vs=vo(function(e,t,r){var n=x|w;if(r.length){var o=h(r,vs.placeholder);n|=P}return Fr(t,n,e,r,o)}),ys=mr(A),bs=mr(C),Es=vo(function(e,t){return St(e,1,t)}),Ss=vo(function(e,t,r){return St(e,t,r)}),Ts=Tr(),xs=Tr(!0),ws=vo(function(e,t){if(t=Pt(t),"function"!=typeof e||!it(t,n))throw new Qi(G);var r=t.length;return vo(function(n){for(var o=Ta(n.length,r);o--;)n[o]=t[o](n[o]);return e.apply(this,n)})}),Rs=Pr(P),As=Pr(I),Cs=vo(function(e,t){return Fr(e,O,S,S,S,Pt(t))}),Ps=ya||function(e){return d(e)&&tn(e.length)&&na.call(e)==q},Is=lr(zt),Ls=lr(function(e,t,r){return r?ht(e,t,r):mt(e,t)}),Os=vr(Ls,dt),Ms=vr(Is,on),Ns=Sr(Lt),ks=Sr(Ot),Fs=wr(ja),Us=wr(Da),js=Rr(Lt),Ds=Rr(Ot),Gs=Ea?function(e){var t=null==e?S:e.constructor;return"function"==typeof t&&t.prototype===e||"function"!=typeof e&&Qr(e)?cn(e):ko(e)?Ea(e):[]}:cn,zs=Ar(!0),Bs=Ar(),qs=vo(function(e,t){if(null==e)return{};if("function"!=typeof t[0]){var t=ut(Pt(t),Xi);return an(e,Tt(ti(e),t))}var r=ir(t[0],t[1],3);return sn(e,function(e,t,n){return!r(e,t,n)})}),Vs=vo(function(e,t){return null==e?{}:"function"==typeof t[0]?sn(e,ir(t[0],t[1],3)):an(e,Pt(t))}),Hs=gr(function(e,t,r){return t=t.toLowerCase(),e+(r?t.charAt(0).toUpperCase()+t.slice(1):t)}),Ws=gr(function(e,t,r){return e+(r?"-":"")+t.toLowerCase()}),Ks=Cr(),Ys=Cr(!0),Xs=gr(function(e,t,r){return e+(r?"_":"")+t.toLowerCase()}),Qs=gr(function(e,t,r){return e+(r?" ":"")+(t.charAt(0).toUpperCase()+t.slice(1))}),Js=vo(function(e,t){try{return e.apply(S,t)}catch(e){return Oo(e)?e:new qi(e)}}),Zs=vo(function(e,t){return function(r){return Xr(r,e,t)}}),$s=vo(function(e,t){return function(r){return Xr(e,r,t)}}),eu=Nr("ceil"),tu=Nr("floor"),ru=yr(xo,Aa),nu=yr(Wo,Ca),ou=Nr("round");return je.prototype=De.prototype,Ge.prototype=ka(De.prototype),Ge.prototype.constructor=Ge,ze.prototype=ka(De.prototype),ze.prototype.constructor=ze,He.prototype.delete=We,He.prototype.get=Ke,He.prototype.has=Ye,He.prototype.set=Xe,Ze.prototype.push=et,go.Cache=He,je.after=lo,je.ary=po,je.assign=Ls,je.at=rs,je.before=fo,je.bind=hs,je.bindAll=ms,je.bindKey=vs,je.callback=Ri,je.chain=zn,je.chunk=dn,je.compact=gn,je.constant=Ai,je.countBy=ns,je.create=Qo,je.curry=ys,je.curryRight=bs,je.debounce=_o,je.defaults=Os,je.defaultsDeep=Ms,je.defer=Es,je.delay=Ss,je.difference=Va,je.drop=hn,je.dropRight=mn,je.dropRightWhile=vn,je.dropWhile=yn,je.fill=bn,je.filter=Jn,je.flatten=Sn,je.flattenDeep=Tn,je.flow=Ts,je.flowRight=xs,je.forEach=as,je.forEachRight=ss,je.forIn=Fs,je.forInRight=Us,je.forOwn=js,je.forOwnRight=Ds,je.functions=Jo,je.groupBy=us,je.indexBy=cs,je.initial=wn,je.intersection=Ka,je.invert=ei,je.invoke=ls,je.keys=Gs,je.keysIn=ti,je.map=eo,je.mapKeys=zs,je.mapValues=Bs,je.matches=Pi,je.matchesProperty=Ii,je.memoize=go,je.merge=Is,je.method=Zs,je.methodOf=$s,je.mixin=Li,je.modArgs=ws,je.negate=ho,je.omit=qs,je.once=mo,je.pairs=ri,je.partial=Rs,je.partialRight=As,je.partition=ps,je.pick=Vs,je.pluck=to,je.property=Ni,je.propertyOf=ki,je.pull=Cn,je.pullAt=Ya,je.range=Fi,je.rearg=Cs,je.reject=ro,je.remove=Pn,je.rest=In,je.restParam=vo,je.set=oi,je.shuffle=oo,je.slice=Ln,je.sortBy=so,je.sortByAll=ds,je.sortByOrder=uo,je.spread=yo,je.take=On,je.takeRight=Mn,je.takeRightWhile=Nn,je.takeWhile=kn,je.tap=Bn,je.throttle=bo,je.thru=qn,je.times=Ui,je.toArray=Yo,je.toPlainObject=Xo,je.transform=ii,je.union=Ja,je.uniq=Fn,je.unzip=Un,je.unzipWith=jn,je.values=ai,je.valuesIn=si,je.where=co,je.without=Za,je.wrap=Eo,je.xor=Dn,je.zip=$a,je.zipObject=Gn,je.zipWith=es,je.backflow=xs,je.collect=eo,je.compose=xs,je.each=as,je.eachRight=ss,je.extend=Ls,je.iteratee=Ri,je.methods=Jo,je.object=Gn,je.select=Jn,je.tail=In,je.unique=Fn,Li(je,je),je.add=Di,je.attempt=Js,je.camelCase=Hs,je.capitalize=li,je.ceil=eu,je.clone=So,je.cloneDeep=To,je.deburr=pi,je.endsWith=fi,je.escape=_i,je.escapeRegExp=di,je.every=Qn,je.find=os,je.findIndex=Ha,je.findKey=Ns,je.findLast=is,je.findLastIndex=Wa,je.findLastKey=ks,je.findWhere=Zn,je.first=En,je.floor=tu,je.get=Zo,je.gt=xo,je.gte=wo,je.has=$o,je.identity=Ci,je.includes=$n,je.indexOf=xn,je.inRange=ui,je.isArguments=Ro,je.isArray=Ps,je.isBoolean=Ao,je.isDate=Co,je.isElement=Po,je.isEmpty=Io,je.isEqual=Lo,je.isError=Oo,je.isFinite=Mo,je.isFunction=No,je.isMatch=Fo,je.isNaN=Uo,je.isNative=jo,je.isNull=Do,je.isNumber=Go,je.isObject=ko,je.isPlainObject=zo,je.isRegExp=Bo,je.isString=qo,je.isTypedArray=Vo,je.isUndefined=Ho,je.kebabCase=Ws,je.last=Rn,je.lastIndexOf=An,je.lt=Wo,je.lte=Ko,je.max=ru,je.min=nu,je.noConflict=Oi,je.noop=Mi,je.now=gs,je.pad=gi,je.padLeft=Ks,je.padRight=Ys,je.parseInt=hi,je.random=ci,je.reduce=fs,je.reduceRight=_s,je.repeat=mi,je.result=ni,je.round=ou,je.runInContext=E,je.size=io,je.snakeCase=Xs,je.some=ao,je.sortedIndex=Xa,je.sortedLastIndex=Qa,je.startCase=Qs,je.startsWith=vi,je.sum=Gi,je.template=yi,je.trim=bi,je.trimLeft=Ei,je.trimRight=Si,je.trunc=Ti,je.unescape=xi,je.uniqueId=ji,je.words=wi,je.all=Qn,je.any=ao,je.contains=$n,je.eq=Lo,je.detect=os,je.foldl=fs,je.foldr=_s,je.head=En,je.include=$n,je.inject=fs,Li(je,function(){var e={};return Lt(je,function(t,r){je.prototype[r]||(e[r]=t)}),e}(),!1),je.sample=no,je.prototype.sample=function(e){return this.__chain__||null!=e?this.thru(function(t){return no(t,e)}):no(this.value())},je.VERSION=T,nt(["bind","bindKey","curry","curryRight","partial","partialRight"],function(e){je[e].placeholder=je}),nt(["drop","take"],function(e,t){ze.prototype[e]=function(r){var n=this.__filtered__;if(n&&!t)return new ze(this);r=null==r?1:Sa(va(r)||0,0);var o=this.clone();return n?o.__takeCount__=Ta(o.__takeCount__,r):o.__views__.push({size:r,type:e+(o.__dir__<0?"Right":"")}),o},ze.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}}),nt(["filter","map","takeWhile"],function(e,t){var r=t+1,n=r!=D;ze.prototype[e]=function(e,t){var o=this.clone();return o.__iteratees__.push({iteratee:Gr(e,t,1),type:r}),o.__filtered__=o.__filtered__||n,o}}),nt(["first","last"],function(e,t){var r="take"+(t?"Right":"");ze.prototype[e]=function(){return this[r](1).value()[0]}}),nt(["initial","rest"],function(e,t){var r="drop"+(t?"":"Right");ze.prototype[e]=function(){return this.__filtered__?new ze(this):this[r](1)}}),nt(["pluck","where"],function(e,t){var r=t?"filter":"map",n=t?Dt:Ni;ze.prototype[e]=function(e){return this[r](n(e))}}),ze.prototype.compact=function(){return this.filter(Ci)},ze.prototype.reject=function(e,t){return e=Gr(e,t,1),this.filter(function(t){return!e(t)})},ze.prototype.slice=function(e,t){e=null==e?0:+e||0;var r=this;return r.__filtered__&&(e>0||t<0)?new ze(r):(e<0?r=r.takeRight(-e):e&&(r=r.drop(e)),t!==S&&(t=+t||0,r=t<0?r.dropRight(-t):r.take(t-e)),r)},ze.prototype.takeRightWhile=function(e,t){return this.reverse().takeWhile(e,t).reverse()},ze.prototype.toArray=function(){return this.take(Ca)},Lt(ze.prototype,function(e,t){var r=/^(?:filter|map|reject)|While$/.test(t),n=/^(?:first|last)$/.test(t),o=je[n?"take"+("last"==t?"Right":""):t];o&&(je.prototype[t]=function(){var t=n?[1]:arguments,i=this.__chain__,a=this.__wrapped__,s=!!this.__actions__.length,u=a instanceof ze,c=t[0],l=u||Ps(a);l&&r&&"function"==typeof c&&1!=c.length&&(u=l=!1)
;var p=function(e){return n&&i?o(e,1)[0]:o.apply(S,ct([e],t))},f={func:qn,args:[p],thisArg:S},_=u&&!s;if(n&&!i)return _?(a=a.clone(),a.__actions__.push(f),e.call(a)):o.call(S,this.value())[0];if(!n&&l){a=_?a:new ze(this);var d=e.apply(a,t);return d.__actions__.push(f),new Ge(d,i)}return this.thru(p)})}),nt(["join","pop","push","replace","shift","sort","splice","split","unshift"],function(e){var t=(/^(?:replace|split)$/.test(e)?$i:Ji)[e],r=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",n=/^(?:join|pop|replace|shift)$/.test(e);je.prototype[e]=function(){var e=arguments;return n&&!this.__chain__?t.apply(this.value(),e):this[r](function(r){return t.apply(r,e)})}}),Lt(ze.prototype,function(e,t){var r=je[t];if(r){var n=r.name+"";(Na[n]||(Na[n]=[])).push({name:t,func:r})}}),Na[Lr(S,w).name]=[{name:"wrapper",func:S}],ze.prototype.clone=Be,ze.prototype.reverse=qe,ze.prototype.value=Ve,je.prototype.chain=Vn,je.prototype.commit=Hn,je.prototype.concat=ts,je.prototype.plant=Wn,je.prototype.reverse=Kn,je.prototype.toString=Yn,je.prototype.run=je.prototype.toJSON=je.prototype.valueOf=je.prototype.value=Xn,je.prototype.collect=je.prototype.map,je.prototype.head=je.prototype.first,je.prototype.select=je.prototype.filter,je.prototype.tail=je.prototype.rest,je}var S,T="3.10.1",x=1,w=2,R=4,A=8,C=16,P=32,I=64,L=128,O=256,M=30,N="...",k=150,F=16,U=200,j=1,D=2,G="Expected a function",z="__lodash_placeholder__",B="[object Arguments]",q="[object Array]",V="[object Boolean]",H="[object Date]",W="[object Error]",K="[object Function]",Y="[object Number]",X="[object Object]",Q="[object RegExp]",J="[object String]",Z="[object ArrayBuffer]",$="[object Float32Array]",ee="[object Float64Array]",te="[object Int8Array]",re="[object Int16Array]",ne="[object Int32Array]",oe="[object Uint8Array]",ie="[object Uint8ClampedArray]",ae="[object Uint16Array]",se="[object Uint32Array]",ue=/\b__p \+= '';/g,ce=/\b(__p \+=) '' \+/g,le=/(__e\(.*?\)|\b__t\)) \+\n'';/g,pe=/&(?:amp|lt|gt|quot|#39|#96);/g,fe=/[&<>"'`]/g,_e=RegExp(pe.source),de=RegExp(fe.source),ge=/<%-([\s\S]+?)%>/g,he=/<%([\s\S]+?)%>/g,me=/<%=([\s\S]+?)%>/g,ve=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\n\\]|\\.)*?\1)\]/,ye=/^\w*$/,be=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\n\\]|\\.)*?)\2)\]/g,Ee=/^[:!,]|[\\^$.*+?()[\]{}|\/]|(^[0-9a-fA-Fnrtuvx])|([\n\r\u2028\u2029])/g,Se=RegExp(Ee.source),Te=/[\u0300-\u036f\ufe20-\ufe23]/g,xe=/\\(\\)?/g,we=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Re=/\w*$/,Ae=/^0[xX]/,Ce=/^\[object .+?Constructor\]$/,Pe=/^\d+$/,Ie=/[\xc0-\xd6\xd8-\xde\xdf-\xf6\xf8-\xff]/g,Le=/($^)/,Oe=/['\n\r\u2028\u2029\\]/g,Me=function(){var e="[A-Z\\xc0-\\xd6\\xd8-\\xde]",t="[a-z\\xdf-\\xf6\\xf8-\\xff]+";return RegExp(e+"+(?="+e+t+")|"+e+"?"+t+"|"+e+"+|[0-9]+","g")}(),Ne=["Array","ArrayBuffer","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Math","Number","Object","RegExp","Set","String","_","clearTimeout","isFinite","parseFloat","parseInt","setTimeout","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap"],ke=-1,Fe={};Fe[$]=Fe[ee]=Fe[te]=Fe[re]=Fe[ne]=Fe[oe]=Fe[ie]=Fe[ae]=Fe[se]=!0,Fe[B]=Fe[q]=Fe[Z]=Fe[V]=Fe[H]=Fe[W]=Fe[K]=Fe["[object Map]"]=Fe[Y]=Fe[X]=Fe[Q]=Fe["[object Set]"]=Fe[J]=Fe["[object WeakMap]"]=!1;var Ue={};Ue[B]=Ue[q]=Ue[Z]=Ue[V]=Ue[H]=Ue[$]=Ue[ee]=Ue[te]=Ue[re]=Ue[ne]=Ue[Y]=Ue[X]=Ue[Q]=Ue[J]=Ue[oe]=Ue[ie]=Ue[ae]=Ue[se]=!0,Ue[W]=Ue[K]=Ue["[object Map]"]=Ue["[object Set]"]=Ue["[object WeakMap]"]=!1;var je={"":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"a","":"a","":"a","":"a","":"a","":"C","":"c","":"D","":"d","":"E","":"E","":"E","":"E","":"e","":"e","":"e","":"e","":"I","":"I","":"I","":"I","":"i","":"i","":"i","":"i","":"N","":"n","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"U","":"U","":"U","":"U","":"u","":"u","":"u","":"u","":"Y","":"y","":"y","":"Ae","":"ae","":"Th","":"th","":"ss"},De={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},Ge={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},ze={function:!0,object:!0},Be={0:"x30",1:"x31",2:"x32",3:"x33",4:"x34",5:"x35",6:"x36",7:"x37",8:"x38",9:"x39",A:"x41",B:"x42",C:"x43",D:"x44",E:"x45",F:"x46",a:"x61",b:"x62",c:"x63",d:"x64",e:"x65",f:"x66",n:"x6e",r:"x72",t:"x74",u:"x75",v:"x76",x:"x78"},qe={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},Ve=ze[typeof exports]&&exports&&!exports.nodeType&&exports,He=ze[typeof module]&&module&&!module.nodeType&&module,We=Ve&&He&&"object"==typeof global&&global&&global.Object&&global,Ke=ze[typeof self]&&self&&self.Object&&self,Ye=ze[typeof window]&&window&&window.Object&&window,Xe=He&&He.exports===Ve&&Ve,Qe=We||Ye!==(this&&this.window)&&Ye||Ke||this,Je=E();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(Qe._=Je,define("lib/lodash",[],function(){return Je})):Ve&&He?Xe?(He.exports=Je)._=Je:Ve._=Je:Qe._=Je}.call(this),function(e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define("lib/bluebird",e):"undefined"!=typeof window?window.Promise=e():"undefined"!=typeof global?global.Promise=e():"undefined"!=typeof self&&(self.Promise=e())}(function(){var e,t,r;return function e(t,r,n){function o(a,s){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(i)return i(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=r[a]={exports:{}};t[a][0].call(c.exports,function(e){var r=t[a][1][e];return o(r||e)},c,c.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,t,r){t.exports=function(t,r,n){function o(e,t){var n=r(e,i,!0===t&&e._isBound()?e._boundTo:void 0),o=n.promise();return o.isRejected()?o:(n.setHowMany(1),n.setUnwrap(),n.init(),o)}var i=e("./some_promise_array.js")(n);t.any=function(e){return o(e,!1)},t.prototype.any=function(){return o(this,!0)}}},{"./some_promise_array.js":33}],2:[function(e,t,r){function n(){this._isTickUsed=!1,this._length=0,this._lateBuffer=new i,this._functionBuffer=new i(75e3);var e=this;this.consumeFunctionBuffer=function(){e._consumeFunctionBuffer()}}var o=e("./schedule.js"),i=e("./queue.js"),a=e("./util.js").errorObj,s=e("./util.js").tryCatch1,u=e("./global.js").process;n.prototype.haveItemsQueued=function(){return this._length>0},n.prototype.invokeLater=function(e,t,r){void 0===u||null==u.domain||e.domain||(e=u.domain.bind(e)),this._lateBuffer.push(e,t,r),this._queueTick()},n.prototype.invoke=function(e,t,r){void 0===u||null==u.domain||e.domain||(e=u.domain.bind(e));var n=this._functionBuffer;n.push(e,t,r),this._length=n.length(),this._queueTick()},n.prototype._consumeFunctionBuffer=function(){for(var e=this._functionBuffer;e.length()>0;){var t=e.shift(),r=e.shift(),n=e.shift();t.call(r,n)}this._reset(),this._consumeLateBuffer()},n.prototype._consumeLateBuffer=function(){for(var e=this._lateBuffer;e.length()>0;){var t=e.shift(),r=e.shift(),n=e.shift(),o=s(t,r,n);if(o===a){if(this._queueTick(),null==t.domain)throw o.e;t.domain.emit("error",o.e)}}},n.prototype._queueTick=function(){this._isTickUsed||(o(this.consumeFunctionBuffer),this._isTickUsed=!0)},n.prototype._reset=function(){this._isTickUsed=!1,this._length=0},t.exports=new n},{"./global.js":15,"./queue.js":26,"./schedule.js":29,"./util.js":37}],3:[function(e,t,r){var n=e("./promise.js")();t.exports=n},{"./promise.js":19}],4:[function(e,t,r){t.exports=function(e){function t(e){return e["string"==typeof this?this:""+this]}e.prototype.call=function(e){for(var t=arguments.length,r=new Array(t-1),n=1;n<t;++n)r[n-1]=arguments[n];return this._then(function(t){return t[e].apply(t,r)},void 0,void 0,void 0,void 0)},e.prototype.get=function(e){return this._then(t,void 0,void 0,e,void 0)}}},{}],5:[function(e,t,r){t.exports=function(t,r){var n=e("./errors.js"),o=e("./async.js"),i=n.CancellationError;t.prototype._cancel=function(){if(!this.isCancellable())return this;for(var e,t=this;void 0!==(e=t._cancellationParent)&&e.isCancellable();)t=e;var r=new i;t._attachExtraTrace(r),t._rejectUnchecked(r)},t.prototype.cancel=function(){return this.isCancellable()?(o.invokeLater(this._cancel,this,void 0),this):this},t.prototype.cancellable=function(){return this._cancellable()?this:(this._setCancellable(),this._cancellationParent=void 0,this)},t.prototype.uncancellable=function(){var e=new t(r);return e._setTrace(this),e._follow(this),e._unsetCancellable(),this._isBound()&&e._setBoundTo(this._boundTo),e},t.prototype.fork=function(e,t,r){var n=this._then(e,t,r,void 0,void 0);return n._setCancellable(),n._cancellationParent=void 0,n}}},{"./async.js":2,"./errors.js":9}],6:[function(e,t,r){t.exports=function(){function t(e){var t;if("function"==typeof e)t="[function "+(e.name||"anonymous")+"]";else{t=e.toString();if(/\[object [a-zA-Z0-9$_]+\]/.test(t))try{t=JSON.stringify(e)}catch(e){}0===t.length&&(t="(empty array)")}return"(<"+r(t)+">, no stack trace)"}function r(e){return e.length<41?e:e.substr(0,38)+"..."}function n(e,t){this.captureStackTrace(n,t)}var o=e("./util.js").inherits,i=e("./es5.js").defineProperty,a=new RegExp("\\b(?:[a-zA-Z0-9.]+\\$_\\w+|tryCatch(?:1|2|Apply)|new \\w*PromiseArray|\\w*PromiseArray\\.\\w*PromiseArray|setTimeout|CatchFilter\\$_\\w+|makeNodePromisified|processImmediate|process._tickCallback|nextTick|Async\\$\\w+)\\b"),s=null,u=null;o(n,Error),n.prototype.captureStackTrace=function(e,t){c(this,e,t)},n.possiblyUnhandledRejection=function(e){if("object"==typeof console){var t;if("object"==typeof e||"function"==typeof e){var r=e.stack;t="Possibly unhandled "+u(r,e)}else t="Possibly unhandled "+String(e);"function"==typeof console.error||"object"==typeof console.error?console.error(t):"function"!=typeof console.log&&"object"!=typeof console.log||console.log(t)}},n.combine=function(e,t){for(var r=e.length-1,n=t.length-1;n>=0;--n){var o=t[n];if(e[r]!==o)break;e.pop(),r--}e.push("From previous event:");for(var i=e.concat(t),u=[],n=0,c=i.length;n<c;++n)a.test(i[n])||n>0&&!s.test(i[n])&&"From previous event:"!==i[n]||u.push(i[n]);return u},n.isSupported=function(){return"function"==typeof c};var c=function e(){if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){s=/^\s*at\s*/,u=function(e,r){return"string"==typeof e?e:void 0!==r.name&&void 0!==r.message?r.name+". "+r.message:t(r)};var r=Error.captureStackTrace;return function(e,t){r(e,t)}}var n=new Error;if("string"==typeof n.stack&&"function"==typeof"".startsWith&&n.stack.startsWith("stackDetection@")&&"stackDetection"===e.name){i(Error,"stackTraceLimit",{writable:!0,enumerable:!1,configurable:!1,value:25}),s=/@/;var o=/[@\n]/;return u=function(e,r){return"string"==typeof e?r.name+". "+r.message+"\n"+e:void 0!==r.name&&void 0!==r.message?r.name+". "+r.message:t(r)},function(e){for(var t=(new Error).stack,r=t.split(o),n=r.length,i="",a=0;a<n;a+=2)i+=r[a],i+="@",i+=r[a+1],i+="\n";e.stack=i}}return u=function(e,r){return"string"==typeof e?e:"object"!=typeof r&&"function"!=typeof r||void 0===r.name||void 0===r.message?t(r):r.name+". "+r.message},null}();return n}},{"./es5.js":11,"./util.js":37}],7:[function(e,t,r){t.exports=function(t){function r(e,t,r){this._instances=e,this._callback=t,this._promise=r}function n(e,t){var r={},n=a(e,r,t);return n===s?n:u(r).length?(s.e=new c("Catch filter must inherit from Error or be a simple predicate function"),s):n}var o=e("./util.js"),i=e("./errors.js"),a=o.tryCatch1,s=o.errorObj,u=e("./es5.js").keys,c=i.TypeError;return r.prototype.doFilter=function(e){for(var r=this._callback,o=this._promise,u=o._isBound()?o._boundTo:void 0,c=0,l=this._instances.length;c<l;++c){var p=this._instances[c],f=p===Error||null!=p&&p.prototype instanceof Error;if(f&&e instanceof p){var _=a(r,u,e);return _===s?(t.e=_.e,t):_}if("function"==typeof p&&!f){var d=n(p,e);if(d===s){var g=i.canAttach(s.e)?s.e:new Error(s.e+"");this._promise._attachExtraTrace(g),e=s.e;break}if(d){var _=a(r,u,e);return _===s?(t.e=_.e,t):_}}}return t.e=e,t},r}},{"./errors.js":9,"./es5.js":11,"./util.js":37}],8:[function(e,t,r){var n=e("./util.js"),o=n.isPrimitive,i=n.wrapsPrimitiveReceiver;t.exports=function(e){var t=function(){return this},r=function(){throw this},n=function(e,t){return 1===t?function(){throw e}:2===t?function(){return e}:void 0};e.prototype.return=e.prototype.thenReturn=function(e){return i&&o(e)?this._then(n(e,2),void 0,void 0,void 0,void 0):this._then(t,void 0,void 0,e,void 0)},e.prototype.throw=e.prototype.thenThrow=function(e){return i&&o(e)?this._then(n(e,1),void 0,void 0,void 0,void 0):this._then(r,void 0,void 0,e,void 0)}}},{"./util.js":37}],9:[function(e,t,r){function n(e){try{_(e,"isAsync",!0)}catch(e){}}function o(e){return null!=e&&(e instanceof u||!0===e.isAsync)}function i(e){return e instanceof d}function a(e){return i(e)}function s(e,t){function r(n){if(!(this instanceof r))return new r(n);this.message="string"==typeof n?n:t,this.name=e,d.captureStackTrace&&d.captureStackTrace(this,this.constructor)}return f(r,d),r}function u(e){this.name="RejectionError",this.message=e,this.cause=e,this.isAsync=!0,e instanceof d?(this.message=e.message,this.stack=e.stack):d.captureStackTrace&&d.captureStackTrace(this,this.constructor)}var c=e("./global.js"),l=e("./es5.js").freeze,p=e("./util.js"),f=p.inherits,_=p.notEnumerableProp,d=c.Error,g=c.TypeError;"function"!=typeof g&&(g=s("TypeError","type error"));var h=c.RangeError;"function"!=typeof h&&(h=s("RangeError","range error"));var m=s("CancellationError","cancellation error"),v=s("TimeoutError","timeout error");f(u,d);var y="__BluebirdErrorTypes__",b=c[y];b||(b=l({CancellationError:m,TimeoutError:v,RejectionError:u}),_(c,y,b)),t.exports={Error:d,TypeError:g,RangeError:h,CancellationError:b.CancellationError,RejectionError:b.RejectionError,TimeoutError:b.TimeoutError,originatesFromRejection:o,markAsOriginatingFromRejection:n,canAttach:a}},{"./es5.js":11,"./global.js":15,"./util.js":37}],10:[function(e,t,r){t.exports=function(t){function r(e){var r=new n(e),o=t.rejected(r),i=o._peekContext();return null!=i&&i._attachExtraTrace(r),o}var n=e("./errors.js").TypeError;return r}},{"./errors.js":9}],11:[function(e,t,r){var n=function(){"use strict";return void 0===this}();if(n)t.exports={freeze:Object.freeze,defineProperty:Object.defineProperty,keys:Object.keys,getPrototypeOf:Object.getPrototypeOf,isArray:Array.isArray,isES5:n};else{var o={}.hasOwnProperty,i={}.toString,a={}.constructor.prototype,s=function(e){var t=[];for(var r in e)o.call(e,r)&&t.push(r);return t},u=function(e,t,r){return e[t]=r.value,e},c=function(e){return e},l=function(e){try{return Object(e).constructor.prototype}catch(e){return a}},p=function(e){try{return"[object Array]"===i.call(e)}catch(e){return!1}};t.exports={isArray:p,keys:s,defineProperty:u,freeze:c,getPrototypeOf:l,isES5:n}}},{}],12:[function(e,t,r){t.exports=function(t){function r(e){for(var r=this instanceof t?this._settledValue:this,n=r.length,o=new Array(n),i=0,a=0;a<n;++a)e[a]&&(o[i++]=r[a]);return o.length=i,o}var n=(e("./util.js").isArray,{ref:null});t.filter=function(e,o){return t.map(e,o,n)._then(r,void 0,void 0,n.ref,void 0)},t.prototype.filter=function(e){return this.map(e,n)._then(r,void 0,void 0,n.ref,void 0)}}},{"./util.js":37}],13:[function(e,t,r){t.exports=function(t,r){function n(){return this}function o(){throw this}function i(e){return function(){return e}}function a(e){return function(){throw e}}function s(e,t,r){var s;return s=p&&f(t)?r?i(t):a(t):r?n:o,e._then(s,_,void 0,t,void 0)}function u(e){var n=this.promise,o=this.handler,i=n._isBound()?o.call(n._boundTo):o();if(void 0!==i){var a=t._cast(i,void 0);if(a instanceof t)return s(a,e,n.isFulfilled())}return n.isRejected()?(r.e=e,r):e}function c(e){var r=this.promise,n=this.handler,o=r._isBound()?n.call(r._boundTo,e):n(e);if(void 0!==o){var i=t._cast(o,void 0);if(i instanceof t)return s(i,e,!0)}return e}var l=e("./util.js"),p=l.wrapsPrimitiveReceiver,f=l.isPrimitive,_=l.thrower;t.prototype._passThroughHandler=function(e,t){if("function"!=typeof e)return this.then();var r={promise:this,handler:e};return this._then(t?u:c,t?u:void 0,void 0,r,void 0)},t.prototype.lastly=t.prototype.finally=function(e){return this._passThroughHandler(e,!0)},t.prototype.tap=function(e){return this._passThroughHandler(e,!1)}}},{"./util.js":37}],14:[function(e,t,r){t.exports=function(t,r,n){var o=e("./promise_spawn.js")(t,n),i=e("./errors.js"),a=i.TypeError,s=e("./util.js").deprecated;t.coroutine=function(e){if("function"!=typeof e)throw new a("generatorFunction must be a function");var t=o;return function(){var r=e.apply(this,arguments),n=new t(void 0,void 0);return n._generator=r,n._next(void 0),n.promise()}},t.coroutine.addYieldHandler=o.addYieldHandler,t.spawn=function(e){if(s("Promise.spawn is deprecated. Use Promise.coroutine instead."),"function"!=typeof e)return r("generatorFunction must be a function");var n=new o(e,this),i=n.promise();return n._run(t.spawn),i}}},{"./errors.js":9,"./promise_spawn.js":22,"./util.js":37}],15:[function(e,t,r){t.exports=function(){if(void 0!==this)return this;try{return global}catch(e){}try{return window}catch(e){}try{return self}catch(e){}}()},{}],16:[function(e,t,r){t.exports=function(t,r,n,o){function i(e){return a(e,this[0],this[1],this[2])}function a(e,r,a,u){if("function"!=typeof r)return o("fn must be a function");var c=void 0;!0===a?e._isBound()&&(c=e._boundTo):!1!==a&&(c=a);var l=void 0!==u;if(l&&(u.ref=e),e instanceof t){var f=[r,c,u];return e._then(i,void 0,void 0,f,void 0)}if(!p(e))return o("expecting an array, a promise or a thenable");var _=new t(n);return void 0!==c&&_._setBoundTo(c),_._setTrace(void 0),new s(_,r,e,c,l).init(),_}function s(e,t,r,n,o){this.shouldUnwrapItems=o,this.index=0,this.items=r,this.callback=t,this.receiver=n,this.promise=e,this.result=new Array(r.length)}var u=t.all,c=e("./util.js"),l=e("./errors.js").canAttach,p=c.isArray,f=t._cast,_={};c.inherits(s,r),s.prototype.init=function(){for(var e=this.items,r=e.length,n=this.result,o=!1,i=0;i<r;++i){var a=f(e[i],void 0);a instanceof t?a.isPending()?(n[i]=_,a._proxyPromiseArray(this,i)):a.isFulfilled()?n[i]=a.value():(a._unsetRejectionIsUnhandled(),o||(this.reject(a.reason()),o=!0)):n[i]=a}o||this.iterate()},s.prototype.isResolved=function(){return null===this.promise},s.prototype._promiseProgressed=function(e){this.isResolved()||this.promise._progress(e)},s.prototype._promiseFulfilled=function(e,t){this.isResolved()||(this.result[t]=e,this.shouldUnwrapItems&&(this.items[t]=e),this.index===t&&this.iterate())},s.prototype._promiseRejected=function(e){this.reject(e)},s.prototype.reject=function(e){if(!this.isResolved()){var t=l(e)?e:new Error(e+"");this.promise._attachExtraTrace(t),this.promise._reject(e,t)}},s.prototype.iterate=function(){for(var e=this.index,t=this.items,r=this.result,n=t.length,r=this.result,o=this.receiver,i=this.callback;e<n;++e){var a=r[e];if(a===_)return void(this.index=e);try{r[e]=i.call(o,a,e,n)}catch(e){return this.reject(e)}}this.promise._follow(u(r)),this.items=this.result=this.callback=this.promise=null},t.prototype.map=function(e,t){return a(this,e,!0,t)},t.map=function(e,t,r){return a(e,t,!1,r)}}},{"./errors.js":9,"./util.js":37}],17:[function(e,t,r){t.exports=function(t){function r(e){throw e}function n(e,t){var n=this,o=void 0===e?u(n,t,null):s(n,t,null,e);o===c&&a.invokeLater(r,void 0,o.e)}function o(e,t){var n=this,o=u(n,t,e);o===c&&a.invokeLater(r,void 0,o.e)}var i=e("./util.js"),a=e("./async.js"),s=i.tryCatch2,u=i.tryCatch1,c=i.errorObj;t.prototype.nodeify=function(e){return"function"==typeof e&&this._then(n,o,void 0,e,this._isBound()?this._boundTo:null),this}}},{"./async.js":2,"./util.js":37}],18:[function(e,t,r){t.exports=function(t,r){var n=e("./util.js"),o=e("./async.js"),i=e("./errors.js"),a=n.tryCatch1,s=n.errorObj;t.prototype.progressed=function(e){return this._then(void 0,void 0,e,void 0,void 0)},t.prototype._progress=function(e){this._isFollowingOrFulfilledOrRejected()||this._progressUnchecked(e)},t.prototype._progressHandlerAt=function(e){return 0===e?this._progressHandler0:this[e+2-5]},t.prototype._doProgressWith=function(e){var r=e.value,n=e.handler,o=e.promise,u=e.receiver;this._pushContext();var c=a(n,u,r);if(this._popContext(),c===s){if(null!=c.e&&"StopProgressPropagation"!==c.e.name){var l=i.canAttach(c.e)?c.e:new Error(c.e+"");o._attachExtraTrace(l),o._progress(c.e)}}else c instanceof t?c._then(o._progress,null,null,o,void 0):o._progress(c)},t.prototype._progressUnchecked=function(e){if(this.isPending())for(var n=this._length(),i=this._progress,a=0;a<n;a+=5){var s=this._progressHandlerAt(a),u=this._promiseAt(a);if(u instanceof t)"function"==typeof s?o.invoke(this._doProgressWith,this,{handler:s,promise:u,receiver:this._receiverAt(a),value:e}):o.invoke(i,u,e);else{var c=this._receiverAt(a);"function"==typeof s?s.call(c,e,u):c instanceof t&&c._isProxied()?c._progressUnchecked(e):r(c,u)&&c._promiseProgressed(e,u)}}}}},{"./async.js":2,"./errors.js":9,"./util.js":37}],19:[function(e,t,r){t.exports=function(){function t(e){return void 0!==e&&e instanceof n}function r(e,t){return e instanceof _&&t>=0}function n(e){if("function"!=typeof e)throw new T("the promise constructor requires a resolver function");if(this.constructor!==n)throw new T("the promise constructor cannot be invoked directly");this._bitField=0,this._fulfillmentHandler0=void 0,this._rejectionHandler0=void 0,this._promise0=void 0,this._receiver0=void 0,this._settledValue=void 0,this._boundTo=void 0,e!==l&&this._resolveFromResolver(e)}function o(e,t){return i(e,_,!0===t&&e._isBound()?e._boundTo:void 0).promise()}function i(e,r,o){var i=null;return m(e)?i=e:(i=n._cast(e,void 0),i!==e?i._setBoundTo(o):t(i)||(i=null)),null!==i?new r(i,o):{promise:function(){return L("expecting an array, a promise or a thenable")}}}var a=e("./global.js"),s=e("./util.js"),u=e("./async.js"),c=e("./errors.js"),l=function(){},p={},f={e:null},_=e("./promise_array.js")(n,l),d=e("./captured_trace.js")(),g=e("./catch_filter.js")(f),h=e("./promise_resolver.js"),m=s.isArray,v=s.errorObj,y=s.tryCatch1,b=s.tryCatch2,E=s.tryCatchApply,S=c.RangeError,T=c.TypeError,x=c.CancellationError,w=c.TimeoutError,R=c.RejectionError,A=c.originatesFromRejection,C=c.markAsOriginatingFromRejection,P=c.canAttach,I=s.thrower,L=e("./errors_api_rejection")(n),O=function(){return new T("circular promise resolution chain")};n.prototype.bind=function(e){var t=new n(l);return t._setTrace(this),t._follow(this),t._setBoundTo(e),this._cancellable()&&(t._setCancellable(),t._cancellationParent=this),t},n.prototype.toString=function(){return"[object Promise]"},n.prototype.caught=n.prototype.catch=function(e){var t=arguments.length;if(t>1){var r,n=new Array(t-1),o=0;for(r=0;r<t-1;++r){var i=arguments[r];if("function"!=typeof i){var a=new T("A catch filter must be an error constructor or a filter function");return this._attachExtraTrace(a),void u.invoke(this._reject,this,a)}n[o++]=i}n.length=o,e=arguments[r],this._resetTrace();var s=new g(n,e,this);return this._then(void 0,s.doFilter,void 0,s,void 0)}return this._then(void 0,e,void 0,void 0,void 0)},n.prototype.then=function(e,t,r){return this._then(e,t,r,void 0,void 0)},n.prototype.done=function(e,t,r){this._then(e,t,r,void 0,void 0)._setIsFinal()},n.prototype.spread=function(e,t){return this._then(e,t,void 0,p,void 0)},n.prototype.isCancellable=function(){return!this.isResolved()&&this._cancellable()},n.prototype.toJSON=function(){var e={isFulfilled:!1,isRejected:!1,fulfillmentValue:void 0,rejectionReason:void 0};return this.isFulfilled()?(e.fulfillmentValue=this._settledValue,e.isFulfilled=!0):this.isRejected()&&(e.rejectionReason=this._settledValue,e.isRejected=!0),e},n.prototype.all=function(){return o(this,!0)},n.is=t,n.all=function(e){return o(e,!1)},n.join=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;++r)t[r]=arguments[r];return i(t,_,void 0).promise()},n.resolve=n.fulfilled=function(e){var t=new n(l);return t._setTrace(void 0),t._tryFollow(e)?t:(t._cleanValues(),t._setFulfilled(),t._settledValue=e,t)},n.reject=n.rejected=function(e){var t=new n(l);if(t._setTrace(void 0),C(e),t._cleanValues(),t._setRejected(),t._settledValue=e,!P(e)){var r=new Error(e+"");t._setCarriedStackTrace(r)}return t._ensurePossibleRejectionHandled(),t},n.prototype.error=function(e){return this.caught(A,e)},n.prototype._resolveFromSyncValue=function(e){if(e===v)this._cleanValues(),this._setRejected(),this._settledValue=e.e,this._ensurePossibleRejectionHandled();else{var t=n._cast(e,void 0);t instanceof n?this._follow(t):(this._cleanValues(),this._setFulfilled(),this._settledValue=e)}},n.method=function(e){if("function"!=typeof e)throw new T("fn must be a function");return function(){var t;switch(arguments.length){case 0:t=y(e,this,void 0);break;case 1:t=y(e,this,arguments[0]);break;case 2:t=b(e,this,arguments[0],arguments[1]);break;default:for(var r=arguments.length,o=new Array(r),i=0;i<r;++i)o[i]=arguments[i];t=E(e,o,this)}var a=new n(l);return a._setTrace(void 0),a._resolveFromSyncValue(t),a}},n.attempt=n.try=function(e,t,r){if("function"!=typeof e)return L("fn must be a function");var o=m(t)?E(e,t,r):y(e,r,t),i=new n(l);return i._setTrace(void 0),i._resolveFromSyncValue(o),i},n.defer=n.pending=function(){var e=new n(l);return e._setTrace(void 0),new h(e)},n.bind=function(e){var t=new n(l);return t._setTrace(void 0),t._setFulfilled(),t._setBoundTo(e),t},n.cast=function(e){var t=n._cast(e,void 0);return t instanceof n?t:n.resolve(t)},n.onPossiblyUnhandledRejection=function(e){d.possiblyUnhandledRejection="function"==typeof e?e:void 0};var M;n.onUnhandledRejectionHandled=function(e){M="function"==typeof e?e:void 0};var N=!("undefined"==typeof process||"string"!=typeof process.execPath||"object"!=typeof process.env||!process.env.BLUEBIRD_DEBUG&&"development"!==process.env.NODE_ENV);n.longStackTraces=function(){if(u.haveItemsQueued()&&!1===N)throw new Error("cannot enable long stack traces after promises have been created");N=d.isSupported()},n.hasLongStackTraces=function(){return N&&d.isSupported()},n.prototype._setProxyHandlers=function(e,t){var r=this._length();if(r>=524282&&(r=0,this._setLength(0)),0===r)this._promise0=t,this._receiver0=e;else{var n=r-5;this[n+3]=t,this[n+4]=e,this[n+0]=this[n+1]=this[n+2]=void 0}this._setLength(r+5)},n.prototype._proxyPromiseArray=function(e,t){this._setProxyHandlers(e,t)},n.prototype._proxyPromise=function(e){e._setProxied(),this._setProxyHandlers(e,-1)},n.prototype._then=function(e,t,r,o,i){var a=void 0!==i,s=a?i:new n(l);if(N&&!a){var c=this._peekContext()===this._traceParent;s._traceParent=c?this._traceParent:this,s._setTrace(this)}!a&&this._isBound()&&s._setBoundTo(this._boundTo);var p=this._addCallbacks(e,t,r,s,o);return!a&&this._cancellable()&&(s._setCancellable(),s._cancellationParent=this),this.isResolved()&&u.invoke(this._queueSettleAt,this,p),s},n.prototype._length=function(){return 524287&this._bitField},n.prototype._isFollowingOrFulfilledOrRejected=function(){return(939524096&this._bitField)>0},n.prototype._isFollowing=function(){return 536870912==(536870912&this._bitField)},n.prototype._setLength=function(e){this._bitField=-524288&this._bitField|524287&e},n.prototype._setFulfilled=function(){this._bitField=268435456|this._bitField},n.prototype._setRejected=function(){this._bitField=134217728|this._bitField},n.prototype._setFollowing=function(){this._bitField=536870912|this._bitField},n.prototype._setIsFinal=function(){this._bitField=33554432|this._bitField},n.prototype._isFinal=function(){return(33554432&this._bitField)>0},n.prototype._cancellable=function(){return(67108864&this._bitField)>0},n.prototype._setCancellable=function(){this._bitField=67108864|this._bitField},n.prototype._unsetCancellable=function(){this._bitField=-67108865&this._bitField},n.prototype._setRejectionIsUnhandled=function(){this._bitField=2097152|this._bitField},n.prototype._unsetRejectionIsUnhandled=function(){this._bitField=-2097153&this._bitField,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},n.prototype._isRejectionUnhandled=function(){return(2097152&this._bitField)>0},n.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=524288|this._bitField},n.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=-524289&this._bitField},n.prototype._isUnhandledRejectionNotified=function(){return(524288&this._bitField)>0},n.prototype._setCarriedStackTrace=function(e){this._bitField=1048576|this._bitField,this._fulfillmentHandler0=e},n.prototype._unsetCarriedStackTrace=function(){this._bitField=-1048577&this._bitField,this._fulfillmentHandler0=void 0},n.prototype._isCarryingStackTrace=function(){return(1048576&this._bitField)>0},n.prototype._getCarriedStackTrace=function(){return this._isCarryingStackTrace()?this._fulfillmentHandler0:void 0},n.prototype._receiverAt=function(e){var t;return t=0===e?this._receiver0:this[e+4-5],this._isBound()&&void 0===t?this._boundTo:t},n.prototype._promiseAt=function(e){return 0===e?this._promise0:this[e+3-5]},n.prototype._fulfillmentHandlerAt=function(e){return 0===e?this._fulfillmentHandler0:this[e+0-5]},n.prototype._rejectionHandlerAt=function(e){return 0===e?this._rejectionHandler0:this[e+1-5]},n.prototype._unsetAt=function(e){0===e?(this._rejectionHandler0=this._progressHandler0=this._promise0=this._receiver0=void 0,this._isCarryingStackTrace()||(this._fulfillmentHandler0=void 0)):this[e-5+0]=this[e-5+1]=this[e-5+2]=this[e-5+3]=this[e-5+4]=void 0},n.prototype._resolveFromResolver=function(e){function t(e){n._tryFollow(e)||n._fulfill(e)}function r(e){var t=P(e)?e:new Error(e+"");n._attachExtraTrace(t),C(e),n._reject(e,t===e?void 0:t)}var n=this;this._setTrace(void 0),this._pushContext();var o=b(e,void 0,t,r);if(this._popContext(),void 0!==o&&o===v){var i=o.e,a=P(i)?i:new Error(i+"");n._reject(i,a)}},n.prototype._addCallbacks=function(e,t,r,n,o){var i=this._length();if(i>=524282&&(i=0,this._setLength(0)),0===i)this._promise0=n,void 0!==o&&(this._receiver0=o),"function"!=typeof e||this._isCarryingStackTrace()||(this._fulfillmentHandler0=e),"function"==typeof t&&(this._rejectionHandler0=t),"function"==typeof r&&(this._progressHandler0=r);else{var a=i-5;this[a+3]=n,this[a+4]=o,this[a+0]="function"==typeof e?e:void 0,this[a+1]="function"==typeof t?t:void 0,this[a+2]="function"==typeof r?r:void 0}return this._setLength(i+5),i},n.prototype._setBoundTo=function(e){void 0!==e?(this._bitField=8388608|this._bitField,this._boundTo=e):this._bitField=-8388609&this._bitField},n.prototype._isBound=function(){return 8388608==(8388608&this._bitField)},n.prototype._spreadSlowCase=function(e,t,r,n){var o=i(r,_,n).promise()._then(function(){return e.apply(n,arguments)},void 0,void 0,p,void 0);t._follow(o)},n.prototype._callSpread=function(e,r,o,i){var a=this._isBound()?this._boundTo:void 0;if(m(o))for(var s=0,u=o.length;s<u;++s)if(t(n._cast(o[s],void 0)))return void this._spreadSlowCase(e,r,o,a);return i&&r._pushContext(),E(e,o,a)},n.prototype._callHandler=function(e,t,r,n,o){var i;return t!==p||this.isRejected()?(o&&r._pushContext(),i=y(e,t,n)):i=this._callSpread(e,r,n,o),o&&r._popContext(),i},n.prototype._settlePromiseFromHandler=function(e,r,o,i){if(!t(i))return void e.call(r,o,i);var a=N,s=this._callHandler(e,r,i,o,a);if(!i._isFollowing())if(s===v||s===i||s===f){var u=s===i?O():s.e,c=P(u)?u:new Error(u+"");s!==f&&i._attachExtraTrace(c),i._rejectUnchecked(u,c)}else{var l=n._cast(s,i);if(t(l)){if(l.isRejected()&&!l._isCarryingStackTrace()&&!P(l._settledValue)){var c=new Error(l._settledValue+"");i._attachExtraTrace(c),l._setCarriedStackTrace(c)}i._follow(l),l._cancellable()&&(i._cancellationParent=l,i._setCancellable())}else i._fulfillUnchecked(s)}},n.prototype._follow=function(e){this._setFollowing(),e.isPending()?(e._cancellable()&&(this._cancellationParent=e,this._setCancellable()),
e._proxyPromise(this)):e.isFulfilled()?this._fulfillUnchecked(e._settledValue):this._rejectUnchecked(e._settledValue,e._getCarriedStackTrace()),e._isRejectionUnhandled()&&e._unsetRejectionIsUnhandled(),N&&null==e._traceParent&&(e._traceParent=this)},n.prototype._tryFollow=function(e){if(this._isFollowingOrFulfilledOrRejected()||e===this)return!1;var r=n._cast(e,void 0);return!!t(r)&&(this._follow(r),!0)},n.prototype._resetTrace=function(){N&&(this._trace=new d(void 0===this._peekContext()))},n.prototype._setTrace=function(e){if(N){var t=this._peekContext();this._traceParent=t;var r=void 0===t;void 0!==e&&e._traceParent===t?this._trace=e._trace:this._trace=new d(r)}return this},n.prototype._attachExtraTrace=function(e){if(N){var t=this,r=e.stack;r="string"==typeof r?r.split("\n"):[];for(;null!=t&&null!=t._trace;)r=d.combine(r,t._trace.stack.split("\n")),t=t._traceParent;var n=Error.stackTraceLimit+1;r.length>n&&(r.length=n),r.length<=1?e.stack="(No stack trace)":e.stack=r.join("\n")}},n.prototype._cleanValues=function(){this._cancellable()&&(this._cancellationParent=void 0)},n.prototype._fulfill=function(e){this._isFollowingOrFulfilledOrRejected()||this._fulfillUnchecked(e)},n.prototype._reject=function(e,t){this._isFollowingOrFulfilledOrRejected()||this._rejectUnchecked(e,t)},n.prototype._settlePromiseAt=function(e){var t=this.isFulfilled()?this._fulfillmentHandlerAt(e):this._rejectionHandlerAt(e),o=this._settledValue,i=this._receiverAt(e),a=this._promiseAt(e);if("function"==typeof t)this._settlePromiseFromHandler(t,i,o,a);else{var s=!1,u=this.isFulfilled();void 0!==i&&(i instanceof n&&i._isProxied()?(i._unsetProxied(),u?i._fulfillUnchecked(o):i._rejectUnchecked(o,this._getCarriedStackTrace()),s=!0):r(i,a)&&(u?i._promiseFulfilled(o,a):i._promiseRejected(o,a),s=!0)),s||(u?a._fulfill(o):a._reject(o,this._getCarriedStackTrace()))}e>=256&&this._queueGC()},n.prototype._isProxied=function(){return 4194304==(4194304&this._bitField)},n.prototype._setProxied=function(){this._bitField=4194304|this._bitField},n.prototype._unsetProxied=function(){this._bitField=-4194305&this._bitField},n.prototype._isGcQueued=function(){return-1073741824==(-1073741824&this._bitField)},n.prototype._setGcQueued=function(){this._bitField=-1073741824|this._bitField},n.prototype._unsetGcQueued=function(){this._bitField=1073741823&this._bitField},n.prototype._queueGC=function(){this._isGcQueued()||(this._setGcQueued(),u.invokeLater(this._gc,this,void 0))},n.prototype._gc=function(){var e=this._length();this._unsetAt(0);for(var t=0;t<e;t++)delete this[t];this._setLength(0),this._unsetGcQueued()},n.prototype._queueSettleAt=function(e){this._isRejectionUnhandled()&&this._unsetRejectionIsUnhandled(),u.invoke(this._settlePromiseAt,this,e)},n.prototype._fulfillUnchecked=function(e){if(this.isPending()){if(e===this){var t=O();return this._attachExtraTrace(t),this._rejectUnchecked(t,void 0)}this._cleanValues(),this._setFulfilled(),this._settledValue=e;var r=this._length();r>0&&u.invoke(this._settlePromises,this,r)}},n.prototype._rejectUncheckedCheckError=function(e){var t=P(e)?e:new Error(e+"");this._rejectUnchecked(e,t===e?void 0:t)},n.prototype._rejectUnchecked=function(e,t){if(this.isPending()){if(e===this){var r=O();return this._attachExtraTrace(r),this._rejectUnchecked(r)}if(this._cleanValues(),this._setRejected(),this._settledValue=e,this._isFinal())return void u.invokeLater(I,void 0,void 0===t?e:t);var n=this._length();void 0!==t&&this._setCarriedStackTrace(t),n>0?u.invoke(this._rejectPromises,this,null):this._ensurePossibleRejectionHandled()}},n.prototype._rejectPromises=function(){this._settlePromises(),this._unsetCarriedStackTrace()},n.prototype._settlePromises=function(){for(var e=this._length(),t=0;t<e;t+=5)this._settlePromiseAt(t)},n.prototype._ensurePossibleRejectionHandled=function(){this._setRejectionIsUnhandled(),void 0!==d.possiblyUnhandledRejection&&u.invokeLater(this._notifyUnhandledRejection,this,void 0)},n.prototype._notifyUnhandledRejectionIsHandled=function(){"function"==typeof M&&u.invokeLater(M,void 0,this)},n.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var e=this._settledValue,t=this._getCarriedStackTrace();this._setUnhandledRejectionIsNotified(),void 0!==t&&(this._unsetCarriedStackTrace(),e=t),"function"==typeof d.possiblyUnhandledRejection&&d.possiblyUnhandledRejection(e,this)}};var k=[];n.prototype._peekContext=function(){var e=k.length-1;if(e>=0)return k[e]},n.prototype._pushContext=function(){N&&k.push(this)},n.prototype._popContext=function(){N&&k.pop()};var F=a.Promise;return n.noConflict=function(){return a.Promise===n&&(a.Promise=F),n},d.isSupported()||(n.longStackTraces=function(){},N=!1),n._makeSelfResolutionError=O,e("./finally.js")(n,f),e("./direct_resolve.js")(n),e("./thenables.js")(n,l),e("./synchronous_inspection.js")(n),n.RangeError=S,n.CancellationError=x,n.TimeoutError=w,n.TypeError=T,n.RejectionError=R,s.toFastProperties(n),s.toFastProperties(n.prototype),e("./timers.js")(n,l),e("./any.js")(n,i,_),e("./race.js")(n,l),e("./call_get.js")(n),e("./filter.js")(n,i,_,L),e("./generators.js")(n,L,l),e("./map.js")(n,_,l,L),e("./nodeify.js")(n),e("./promisify.js")(n,l),e("./props.js")(n,_),e("./reduce.js")(n,i,_,L,l),e("./settle.js")(n,i,_),e("./some.js")(n,i,_,L),e("./progress.js")(n,r),e("./cancel.js")(n,l),n.prototype=n.prototype,n}},{"./any.js":1,"./async.js":2,"./call_get.js":4,"./cancel.js":5,"./captured_trace.js":6,"./catch_filter.js":7,"./direct_resolve.js":8,"./errors.js":9,"./errors_api_rejection":10,"./filter.js":12,"./finally.js":13,"./generators.js":14,"./global.js":15,"./map.js":16,"./nodeify.js":17,"./progress.js":18,"./promise_array.js":20,"./promise_resolver.js":21,"./promisify.js":23,"./props.js":25,"./race.js":27,"./reduce.js":28,"./settle.js":30,"./some.js":32,"./synchronous_inspection.js":34,"./thenables.js":35,"./timers.js":36,"./util.js":37}],20:[function(e,t,r){t.exports=function(t,r){function n(e){switch(e){case-1:return;case-2:return[];case-3:return{}}}function o(e,n){var o=this._promise=new t(r),i=void 0;e instanceof t&&(i=e,e._cancellable()&&(o._setCancellable(),o._cancellationParent=e),e._isBound()&&o._setBoundTo(n)),o._setTrace(i),this._values=e,this._length=0,this._totalResolved=0,this._init(void 0,-2)}var i=e("./errors.js").canAttach,a=e("./util.js"),s=e("./async.js"),u={}.hasOwnProperty,c=a.isArray;return o.PropertiesPromiseArray=function(){},o.prototype.length=function(){return this._length},o.prototype.promise=function(){return this._promise},o.prototype._init=function(e,r){var i=this._values;if(i instanceof t){if(!i.isFulfilled())return i.isPending()?void i._then(this._init,this._reject,void 0,this,r):(i._unsetRejectionIsUnhandled(),void this._reject(i._settledValue));if(i=i._settledValue,!c(i)){var a=new t.TypeError("expecting an array, a promise or a thenable");return void this.__hardReject__(a)}this._values=i}if(0===i.length)return void this._resolve(n(r));var l,p=i.length,f=p;l=this instanceof o.PropertiesPromiseArray?this._values:new Array(p);for(var _=!1,d=0;d<p;++d){var g=i[d];if(void 0!==g||u.call(i,d)){var h=t._cast(g,void 0);h instanceof t?h.isPending()?h._proxyPromiseArray(this,d):(h._unsetRejectionIsUnhandled(),_=!0):_=!0,l[d]=h}else f--}if(0===f)return void(-2===r?this._resolve(l):this._resolve(n(r)));if(this._values=l,this._length=f,_){var m=f===p?this._scanDirectValues:this._scanDirectValuesHoled;s.invoke(m,this,p)}},o.prototype._settlePromiseAt=function(e){var r=this._values[e];r instanceof t?r.isFulfilled()?this._promiseFulfilled(r._settledValue,e):r.isRejected()&&this._promiseRejected(r._settledValue,e):this._promiseFulfilled(r,e)},o.prototype._scanDirectValuesHoled=function(e){for(var t=0;t<e&&!this._isResolved();++t)u.call(this._values,t)&&this._settlePromiseAt(t)},o.prototype._scanDirectValues=function(e){for(var t=0;t<e&&!this._isResolved();++t)this._settlePromiseAt(t)},o.prototype._isResolved=function(){return null===this._values},o.prototype._resolve=function(e){this._values=null,this._promise._fulfill(e)},o.prototype.__hardReject__=o.prototype._reject=function(e){this._values=null;var t=i(e)?e:new Error(e+"");this._promise._attachExtraTrace(t),this._promise._reject(e,t)},o.prototype._promiseProgressed=function(e,t){this._isResolved()||this._promise._progress({index:t,value:e})},o.prototype._promiseFulfilled=function(e,t){if(!this._isResolved()){this._values[t]=e;++this._totalResolved>=this._length&&this._resolve(this._values)}},o.prototype._promiseRejected=function(e,t){this._isResolved()||(this._totalResolved++,this._reject(e))},o}},{"./async.js":2,"./errors.js":9,"./util.js":37}],21:[function(e,t,r){function n(e){return e instanceof Error&&d.getPrototypeOf(e)===Error.prototype}function o(e){var t;return t=n(e)?new p(e):e,c.markAsOriginatingFromRejection(t),t}function i(e){function t(t,r){if(null!==e){if(t){var n=o(u(t));e._attachExtraTrace(n),e._reject(n)}else if(arguments.length>2){for(var i=arguments.length,a=new Array(i-1),s=1;s<i;++s)a[s-1]=arguments[s];e._fulfill(a)}else e._fulfill(r);e=null}}return t}var a,s=e("./util.js"),u=s.maybeWrapAsError,c=e("./errors.js"),l=c.TimeoutError,p=c.RejectionError,f=e("./async.js"),_=s.haveGetters,d=e("./es5.js");if(a=_?function(e){this.promise=e}:function(e){this.promise=e,this.asCallback=i(e),this.callback=this.asCallback},_){var g={get:function(){return i(this.promise)}};d.defineProperty(a.prototype,"asCallback",g),d.defineProperty(a.prototype,"callback",g)}a._nodebackForPromise=i,a.prototype.toString=function(){return"[object PromiseResolver]"},a.prototype.resolve=a.prototype.fulfill=function(e){var t=this.promise;if(void 0===t||void 0===t._tryFollow)throw new TypeError("Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.");t._tryFollow(e)||f.invoke(t._fulfill,t,e)},a.prototype.reject=function(e){var t=this.promise;if(void 0===t||void 0===t._attachExtraTrace)throw new TypeError("Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.");c.markAsOriginatingFromRejection(e);var r=c.canAttach(e)?e:new Error(e+"");t._attachExtraTrace(r),f.invoke(t._reject,t,e),r!==e&&f.invoke(this._setCarriedStackTrace,this,r)},a.prototype.progress=function(e){f.invoke(this.promise._progress,this.promise,e)},a.prototype.cancel=function(){f.invoke(this.promise.cancel,this.promise,void 0)},a.prototype.timeout=function(){this.reject(new l("timeout"))},a.prototype.isResolved=function(){return this.promise.isResolved()},a.prototype.toJSON=function(){return this.promise.toJSON()},a.prototype._setCarriedStackTrace=function(e){this.promise.isRejected()&&this.promise._setCarriedStackTrace(e)},t.exports=a},{"./async.js":2,"./errors.js":9,"./es5.js":11,"./util.js":37}],22:[function(e,t,r){t.exports=function(t,r){function n(e){for(var r=p,o=c,i=t,a=r.length,s=0;s<a;++s){var u=l(r[s],void 0,e);if(u===o)return i.reject(o.e);var f=i._cast(u,n,void 0);if(f instanceof i)return f}return null}function o(e,n){(this._promise=new t(r))._setTrace(void 0),this._generatorFunction=e,this._receiver=n,this._generator=void 0}var i=e("./errors.js"),a=i.TypeError,s=e("./util.js"),u=s.isArray,c=s.errorObj,l=s.tryCatch1,p=[];return o.prototype.promise=function(){return this._promise},o.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver),this._receiver=this._generatorFunction=void 0,this._next(void 0)},o.prototype._continue=function e(r){if(r===c){this._generator=void 0;var o=i.canAttach(r.e)?r.e:new Error(r.e+"");return this._promise._attachExtraTrace(o),void this._promise._reject(r.e,o)}var s=r.value;if(!0===r.done)this._generator=void 0,this._promise._tryFollow(s)||this._promise._fulfill(s);else{var l=t._cast(s,e,void 0);if(!(l instanceof t)&&null===(l=u(l)?t.all(l):n(l)))return void this._throw(new a("A value was yielded that could not be treated as a promise"));l._then(this._next,this._throw,void 0,this,null)}},o.prototype._throw=function(e){i.canAttach(e)&&this._promise._attachExtraTrace(e),this._continue(l(this._generator.throw,this._generator,e))},o.prototype._next=function(e){this._continue(l(this._generator.next,this._generator,e))},o.addYieldHandler=function(e){if("function"!=typeof e)throw new a("fn must be a function");p.push(e)},o}},{"./errors.js":9,"./util.js":37}],23:[function(e,t,r){t.exports=function(t,r){function n(e){return!0===e.__isPromisified__}function o(e,t){return!!(t+"Async"in e)&&n(e[t+"Async"])}function i(e){for(var t=0;t<e.length;t+=2){var r=e[t];if(S.test(r))for(var n=r.replace(S,""),o=0;o<e.length;o+=2)if(e[o]===n)throw new E("Cannot promisify an API that has normal methods with Async-suffix")}}function a(e){for(var t=[e],r=Math.max(0,e-1-5),n=e-1;n>=r;--n)n!==e&&t.push(n);for(var n=e+1;n<=5;++n)t.push(n);return t}function s(e){for(var t=new Array(e),r=0;r<t.length;++r)t[r]="_arg"+r;return t.join(", ")}function u(e){return"number"==typeof e.length?Math.max(Math.min(e.length,1024),0):0}function c(e){return x.test(e)?"."+e:"['"+e.replace(/(['\\])/g,"\\$1")+"']"}function l(e,n,o,i){function l(t){for(var r=new Array(t),o=0,i=r.length;o<i;++o)r[o]="arguments["+o+"]";var a=t>0?",":"";return"string"==typeof e&&n===_?"this"+c(e)+"("+r.join(",")+a+" fn);break;":(void 0===n?"callback("+r.join(",")+a+" fn);":"callback.call("+(n===_?"this":"receiver")+", "+r.join(",")+a+" fn);")+"break;"}var p=Math.max(0,u(i)-1),f=a(p),d="string"==typeof o?o+"Async":"promisified";return x.test(d)||(d="promisified"),new Function("Promise","callback","receiver","withAppended","maybeWrapAsError","nodebackForPromise","INTERNAL","var ret = function "+d+"("+s(p)+') {"use strict";var len = arguments.length;var promise = new Promise(INTERNAL);promise._setTrace(void 0);var fn = nodebackForPromise(promise);try {switch(len) {'+function(){for(var t="",r=0;r<f.length;++r)t+="case "+f[r]+":"+l(f[r]);return t+="default: var args = new Array(len + 1);var i = 0;for (var i = 0; i < len; ++i) {    args[i] = arguments[i];}args[i] = fn;"+("string"==typeof e?"this"+c(e)+".apply(":"callback.apply(")+(n===_?"this":"receiver")+", args); break;"}()+"}}catch(e){ var wrapped = maybeWrapAsError(e);promise._attachExtraTrace(wrapped);promise._reject(wrapped);}return promise;}; ret.__isPromisified__ = true; return ret;")(t,e,n,m,v,h,r)}function p(e,n){function o(){var o=n;n===_&&(o=this),"string"==typeof e&&(e=o[e]);var i=new t(r);i._setTrace(void 0);var a=h(i);try{e.apply(o,m(arguments,a))}catch(e){var s=v(e);i._attachExtraTrace(s),i._reject(s)}return i}return o.__isPromisified__=!0,o}function f(e,t,r){if(r){for(var n=T(e),o=0,i=n.length;o<i;o+=2){var a=n[o],s=n[o+1];e[a+"Async"]=w(a,_,a,s)}return d.toFastProperties(e),e}return w(e,t,void 0,e)}var _={},d=e("./util.js"),g=e("./es5.js"),h=e("./promise_resolver.js")._nodebackForPromise,m=d.withAppended,v=d.maybeWrapAsError,y=d.canEvaluate,b=d.deprecated,E=e("./errors").TypeError,S=new RegExp("Async$"),T=function(){if(g.isES5){var e=Object.create,t=Object.getOwnPropertyDescriptor;return function(r){for(var a=[],s=e(null),u=r;null!==r;){for(var c=g.keys(r),l=0,p=c.length;l<p;++l){var f=c[l];if(!s[f]){s[f]=!0;var _=t(r,f);null==_||"function"!=typeof _.value||n(_.value)||o(u,f)||a.push(f,_.value)}}r=g.getPrototypeOf(r)}return i(a),a}}return function(e){var t=[];for(var r in e){var a=e[r];"function"!=typeof a||n(a)||o(e,r)||t.push(r,a)}return i(t),t}}(),x=/^[a-z$_][a-z$_0-9]*$/i,w=y?l:p;t.promisify=function(e,t){if("object"==typeof e&&null!==e)return b("Promise.promisify for promisifying entire objects is deprecated. Use Promise.promisifyAll instead."),f(e,t,!0);if("function"!=typeof e)throw new E("fn must be a function");return n(e)?e:f(e,arguments.length<2?_:t,!1)},t.promisifyAll=function(e){if("function"!=typeof e&&"object"!=typeof e)throw new E("the target of promisifyAll must be an object or a function");return f(e,void 0,!0)}}},{"./errors":9,"./es5.js":11,"./promise_resolver.js":21,"./util.js":37}],24:[function(e,t,r){t.exports=function(t,r){function n(e,t){for(var r=a.keys(e),n=new Array(r.length),o=0,i=n.length;o<i;++o)n[o]=e[r[o]];if(this.constructor$(n,t),!this._isResolved())for(var o=0,i=r.length;o<i;++o)n.push(r[o])}var o=e("./util.js"),i=o.inherits,a=e("./es5.js");return i(n,r),n.prototype._init=function(){this._init$(void 0,-3)},n.prototype._promiseFulfilled=function(e,t){if(!this._isResolved()){this._values[t]=e;if(++this._totalResolved>=this._length){for(var r={},n=this.length(),o=0,i=this.length();o<i;++o)r[this._values[o+n]]=this._values[o];this._resolve(r)}}},n.prototype._promiseProgressed=function(e,t){this._isResolved()||this._promise._progress({key:this._values[t+this.length()],value:e})},r.PropertiesPromiseArray=n,n}},{"./es5.js":11,"./util.js":37}],25:[function(e,t,r){t.exports=function(t,r){function n(e,r){var n,i=t._cast(e,void 0);return s(i)?(i instanceof t?n=i._then(t.props,void 0,void 0,void 0,void 0):(n=new o(i,!0===r&&i._isBound()?i._boundTo:void 0).promise(),r=!1),!0===r&&i._isBound()&&n._setBoundTo(i._boundTo),n):a("cannot await properties of a non-object")}var o=e("./properties_promise_array.js")(t,r),i=e("./util.js"),a=e("./errors_api_rejection")(t),s=i.isObject;t.prototype.props=function(){return n(this,!0)},t.props=function(e){return n(e,!1)}}},{"./errors_api_rejection":10,"./properties_promise_array.js":24,"./util.js":37}],26:[function(e,t,r){function n(e,t,r,n,o){for(var i=0;i<o;++i)r[i+n]=e[i+t]}function o(e){return e>>>=0,e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function i(e){return"number"!=typeof e?16:o(Math.min(Math.max(16,e),1073741824))}function a(e){this._capacity=i(e),this._length=0,this._front=0,this._makeCapacity()}a.prototype._willBeOverCapacity=function(e){return this._capacity<e},a.prototype._pushOne=function(e){var t=this.length();this._checkCapacity(t+1),this[this._front+t&this._capacity-1]=e,this._length=t+1},a.prototype.push=function(e,t,r){var n=this.length()+3;if(this._willBeOverCapacity(n))return this._pushOne(e),this._pushOne(t),void this._pushOne(r);var o=this._front+n-3;this._checkCapacity(n);var i=this._capacity-1;this[o+0&i]=e,this[o+1&i]=t,this[o+2&i]=r,this._length=n},a.prototype.shift=function(){var e=this._front,t=this[e];return this[e]=void 0,this._front=e+1&this._capacity-1,this._length--,t},a.prototype.length=function(){return this._length},a.prototype._makeCapacity=function(){for(var e=this._capacity,t=0;t<e;++t)this[t]=void 0},a.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(this._capacity<<3)},a.prototype._resizeTo=function(e){var t=this._front,r=this._capacity,o=new Array(r),i=this.length();if(n(this,0,o,0,r),this._capacity=e,this._makeCapacity(),this._front=0,t+i<=r)n(o,t,this,0,i);else{var a=i-(t+i&r-1);n(o,t,this,0,a),n(o,0,this,a,i-a)}},t.exports=a},{}],27:[function(e,t,r){t.exports=function(t,r){function n(e,n){var u=t._cast(e,void 0);if(u instanceof t)return a(u);if(!i(e))return o("expecting an array, a promise or a thenable");var c=new t(r);c._setTrace(n),void 0!==n&&(n._isBound()&&c._setBoundTo(n._boundTo),n._cancellable()&&(c._setCancellable(),c._cancellationParent=n));for(var l=c._fulfill,p=c._reject,f=0,_=e.length;f<_;++f){var d=e[f];(void 0!==d||s.call(e,f))&&t.cast(d)._then(l,p,void 0,c,null)}return c}var o=e("./errors_api_rejection.js")(t),i=e("./util.js").isArray,a=function(e){return e.then(function(t){return n(t,e)})},s={}.hasOwnProperty;t.race=function(e){return n(e,void 0)},t.prototype.race=function(){return n(this,void 0)}}},{"./errors_api_rejection.js":10,"./util.js":37}],28:[function(e,t,r){t.exports=function(e,t,r,n,o){function i(t,r,n,i,a){this.promise=new e(o),this.index=r,this.length=i.length,this.items=i,this.callback=t,this.receiver=a,this.accum=n}function a(e,t){var r=this,n=void 0;"function"!=typeof r&&(n=r.receiver,r=r.fn);var o=e.length,a=void 0,s=0;void 0!==t?(a=t,s=0):(s=1,o>0&&(a=e[0]));var u=s;if(u>=o)return a;var c=new i(r,u,a,e,n);return c.iterate(),c.promise}function s(e){var t=this.fn,r=this.initialValue;return a.call(t,e,r)}function u(e,t,r,n){return r._then(function(r){return c(e,t,r,n)},void 0,void 0,void 0,void 0)}function c(o,i,c,l){if("function"!=typeof i)return n("fn must be a function");if(!0===l&&o._isBound()&&(i={fn:i,receiver:o._boundTo}),void 0!==c){if(c instanceof e){if(!c.isFulfilled())return u(o,i,c,l);c=c._settledValue}return t(o,r,!0===l&&o._isBound()?o._boundTo:void 0).promise()._then(s,void 0,void 0,{fn:i,initialValue:c},void 0)}return t(o,r,!0===l&&o._isBound()?o._boundTo:void 0).promise()._then(a,void 0,void 0,i,void 0)}i.prototype.reject=function(e){this.promise._reject(e)},i.prototype.fulfill=function(e,t){this.accum=e,this.index=t+1,this.iterate()},i.prototype.iterate=function(){for(var t=this.index,r=this.length,n=this.items,o=this.accum,i=this.receiver,a=this.callback;t<r;++t)if(o=a.call(i,o,n[t],t,r),(o=e._cast(o,void 0))instanceof e)return void o._then(this.fulfill,this.reject,void 0,this,t);this.promise._fulfill(o)},e.reduce=function(e,t,r){return c(e,t,r,!1)},e.prototype.reduce=function(e,t){return c(this,e,t,!0)}}},{}],29:[function(e,t,r){var n,o=e("./global.js");if("undefined"!=typeof process&&null!==process&&"function"==typeof process.cwd&&"function"==typeof process.nextTick&&"string"==typeof process.version)n=function(e){process.nextTick(e)};else if("function"!=typeof o.MutationObserver&&"function"!=typeof o.WebkitMutationObserver&&"function"!=typeof o.WebKitMutationObserver||"undefined"==typeof document||"function"!=typeof document.createElement)if("function"==typeof o.postMessage&&"function"!=typeof o.importScripts&&"function"==typeof o.addEventListener&&"function"==typeof o.removeEventListener){var i="bluebird_message_key_"+Math.random();n=function(){function e(e){if(e.source===o&&e.data===i){var r=t;t=void 0,r()}}var t=void 0;return o.addEventListener("message",e,!1),function(e){t=e,o.postMessage(i,"*")}}()}else n="function"==typeof o.MessageChannel?function(){var e=void 0,t=new o.MessageChannel;return t.port1.onmessage=function(){var t=e;e=void 0,t()},function(r){e=r,t.port2.postMessage(null)}}():o.setTimeout?function(e){setTimeout(e,4)}:function(e){e()};else n=function(){var e=o.MutationObserver||o.WebkitMutationObserver||o.WebKitMutationObserver,t=document.createElement("div"),r=void 0;return new e(function(){var e=r;r=void 0,e()}).observe(t,{attributes:!0}),function(e){r=e,t.setAttribute("class","foo")}}();t.exports=n},{"./global.js":15}],30:[function(e,t,r){t.exports=function(t,r,n){function o(e,t){return r(e,i,!0===t&&e._isBound()?e._boundTo:void 0).promise()}var i=e("./settled_promise_array.js")(t,n);t.settle=function(e){return o(e,!1)},t.prototype.settle=function(){return o(this,!0)}}},{"./settled_promise_array.js":31}],31:[function(e,t,r){t.exports=function(t,r){function n(e,t){this.constructor$(e,t)}var o=t.PromiseInspection;return(0,e("./util.js").inherits)(n,r),n.prototype._promiseResolved=function(e,t){this._values[e]=t,++this._totalResolved>=this._length&&this._resolve(this._values)},n.prototype._promiseFulfilled=function(e,t){if(!this._isResolved()){var r=new o;r._bitField=268435456,r._settledValue=e,this._promiseResolved(t,r)}},n.prototype._promiseRejected=function(e,t){if(!this._isResolved()){var r=new o;r._bitField=134217728,r._settledValue=e,this._promiseResolved(t,r)}},n}},{"./util.js":37}],32:[function(e,t,r){t.exports=function(t,r,n,o){function i(e,t,n){if((0|t)!==t||t<0)return o("expecting a positive integer");var i=r(e,a,!0===n&&e._isBound()?e._boundTo:void 0),s=i.promise();return s.isRejected()?s:(i.setHowMany(t),i.init(),s)}var a=e("./some_promise_array.js")(n);t.some=function(e,t){return i(e,t,!1)},t.prototype.some=function(e){return i(this,e,!0)}}},{"./some_promise_array.js":33}],33:[function(e,t,r){t.exports=function(t){function r(e,t){this.constructor$(e,t),this._howMany=0,this._unwrap=!1,this._initialized=!1}var n=e("./util.js"),o=e("./errors.js").RangeError,i=n.inherits,a=n.isArray;return i(r,t),r.prototype._init=function(){if(this._initialized){if(0===this._howMany)return void this._resolve([]);this._init$(void 0,-2);var e=a(this._values);if(this._holes=e?this._values.length-this.length():0,!this._isResolved()&&e&&this._howMany>this._canPossiblyFulfill()){var t="(Promise.some) input array contains less than "+this._howMany+" promises";this._reject(new o(t))}}},r.prototype.init=function(){this._initialized=!0,this._init()},r.prototype.setUnwrap=function(){this._unwrap=!0},r.prototype.howMany=function(){return this._howMany},r.prototype.setHowMany=function(e){this._isResolved()||(this._howMany=e)},r.prototype._promiseFulfilled=function(e){this._isResolved()||(this._addFulfilled(e),this._fulfilled()===this.howMany()&&(this._values.length=this.howMany(),1===this.howMany()&&this._unwrap?this._resolve(this._values[0]):this._resolve(this._values)))},r.prototype._promiseRejected=function(e){this._isResolved()||(this._addRejected(e),this.howMany()>this._canPossiblyFulfill()&&(this._values.length===this.length()?this._reject([]):this._reject(this._values.slice(this.length()+this._holes))))},r.prototype._fulfilled=function(){return this._totalResolved},r.prototype._rejected=function(){return this._values.length-this.length()-this._holes},r.prototype._addRejected=function(e){this._values.push(e)},r.prototype._addFulfilled=function(e){this._values[this._totalResolved++]=e},r.prototype._canPossiblyFulfill=function(){return this.length()-this._rejected()},r}},{"./errors.js":9,"./util.js":37}],34:[function(e,t,r){t.exports=function(e){function t(e){void 0!==e?(this._bitField=e._bitField,this._settledValue=e.isResolved()?e._settledValue:void 0):(this._bitField=0,this._settledValue=void 0)}t.prototype.isFulfilled=e.prototype.isFulfilled=function(){return(268435456&this._bitField)>0},t.prototype.isRejected=e.prototype.isRejected=function(){return(134217728&this._bitField)>0},t.prototype.isPending=e.prototype.isPending=function(){return 0==(402653184&this._bitField)},t.prototype.value=e.prototype.value=function(){if(!this.isFulfilled())throw new TypeError("cannot get fulfillment value of a non-fulfilled promise");return this._settledValue},t.prototype.error=e.prototype.reason=function(){if(!this.isRejected())throw new TypeError("cannot get rejection reason of a non-rejected promise");return this._settledValue},t.prototype.isResolved=e.prototype.isResolved=function(){return(402653184&this._bitField)>0},e.prototype.inspect=function(){return new t(this)},e.PromiseInspection=t}},{}],35:[function(e,t,r){t.exports=function(t,r){function n(e){try{return e.then}catch(e){return c.e=e,c}}function o(e,o){if(l(e)){if(e instanceof t)return e;if(i(e)){var s=new t(r);return s._setTrace(void 0),e._then(s._fulfillUnchecked,s._rejectUncheckedCheckError,s._progressUnchecked,s,null),s._setFollowing(),s}var p=n(e);if(p===c)return void 0!==o&&u(p.e)&&o._attachExtraTrace(p.e),t.reject(p.e);if("function"==typeof p)return a(e,p,o)}return e}function i(e){return p.call(e,"_promise0")}function a(e,r,n){function o(r){if(!c){if(c=!0,e===r){var o=t._makeSelfResolutionError();return void 0!==n&&n._attachExtraTrace(o),void s.promise._reject(o,void 0)}s.resolve(r)}}function i(e){if(!c){c=!0;var t=u(e)?e:new Error(e+"");void 0!==n&&n._attachExtraTrace(t),s.promise._reject(e,t)}}function a(e){if(!c){var t=s.promise;"function"==typeof t._progress&&t._progress(e)}}var s=t.defer(),c=!1;try{r.call(e,o,i,a)}catch(e){if(!c){c=!0;var l=u(e)?e:new Error(e+"");void 0!==n&&n._attachExtraTrace(l),s.promise._reject(e,l)}}return s.promise}var s=e("./util.js"),u=e("./errors.js").canAttach,c=s.errorObj,l=s.isObject,p={}.hasOwnProperty;t._cast=o}},{"./errors.js":9,"./util.js":37}],36:[function(e,t,r){var n=e("./global.js"),o=function(e,t){for(var r=arguments.length,o=new Array(r-2),i=2;i<r;++i)o[i-2]=arguments[i];n.setTimeout(function(){e.apply(void 0,o)},t)};t.exports=function(t,r){var n=(e("./util.js"),e("./errors.js")),i=(e("./errors_api_rejection")(t),t.TimeoutError),a=function(e,t,r){if(e.isPending()){"string"!=typeof t&&(t="operation timed out after "+r+" ms");var o=new i(t);n.markAsOriginatingFromRejection(o),e._attachExtraTrace(o),e._rejectUnchecked(o)}},s=function(e,t){t._fulfill(e)},u=t.delay=function(e,n){void 0===n&&(n=e,e=void 0),n=+n;var i=t._cast(e,void 0),a=new t(r);return i instanceof t?(i._isBound()&&a._setBoundTo(i._boundTo),i._cancellable()&&(a._setCancellable(),a._cancellationParent=i),a._setTrace(i),a._follow(i),a.then(function(e){return t.delay(e,n)})):(a._setTrace(void 0),o(s,n,e,a),a)};t.prototype.delay=function(e){return u(this,e)},t.prototype.timeout=function(e,n){e=+e;var i=new t(r);return i._setTrace(this),this._isBound()&&i._setBoundTo(this._boundTo),this._cancellable()&&(i._setCancellable(),i._cancellationParent=this),i._follow(this),o(a,e,i,n,e),i}}},{"./errors.js":9,"./errors_api_rejection":10,"./global.js":15,"./util.js":37}],37:[function(e,t,r){function n(e){"undefined"!=typeof console&&null!==console&&"function"==typeof console.warn&&console.warn("Bluebird: "+e)}function o(e,t,r){try{return e.call(t,r)}catch(e){return y.e=e,y}}function i(e,t,r,n){try{return e.call(t,r,n)}catch(e){return y.e=e,y}}function a(e,t,r){try{return e.apply(r,t)}catch(e){return y.e=e,y}}function s(e){return"string"==typeof e?e:""+e}function u(e){return null==e||!0===e||!1===e||"string"==typeof e||"number"==typeof e}function c(e){return!u(e)}function l(e){return u(e)?new Error(s(e)):e}function p(e,t){var r,n=e.length,o=new Array(n+1);for(r=0;r<n;++r)o[r]=e[r];return o[r]=t,o}function f(e,t,r){if(u(e))return e;var n={value:r,configurable:!0,enumerable:!1,writable:!0};return h.defineProperty(e,t,n),e}function _(e){throw e}function d(e){function t(){}return t.prototype=e,t}var g=e("./global.js"),h=e("./es5.js"),m=function(){try{var e={};return h.defineProperty(e,"f",{get:function(){return 3}}),3===e.f}catch(e){return!1}}(),v=function(){return"undefined"==typeof window||null===window||void 0===window.document||"undefined"==typeof navigator||null===navigator||"string"!=typeof navigator.appName||window!==g}(),y={e:{}},b=function(e,t){function r(){this.constructor=e,this.constructor$=t;for(var r in t.prototype)n.call(t.prototype,r)&&"$"!==r.charAt(r.length-1)&&(this[r+"$"]=t.prototype[r])}var n={}.hasOwnProperty;return r.prototype=t.prototype,e.prototype=new r,e.prototype},E=function(){return"string"!==this}.call("string"),S={thrower:_,isArray:h.isArray,haveGetters:m,notEnumerableProp:f,isPrimitive:u,isObject:c,canEvaluate:v,deprecated:n,errorObj:y,tryCatch1:o,tryCatch2:i,tryCatchApply:a,inherits:b,withAppended:p,asString:s,maybeWrapAsError:l,wrapsPrimitiveReceiver:E,toFastProperties:d};t.exports=S},{"./es5.js":11,"./global.js":15}]},{},[3])(3)}),define("ubp/commons/utilities/UUID",["require","exports"],function(e,t){"use strict";var r;return function(e){function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}e.v4=t}(r||(r={})),r}),define("ubp/commons/logging/LogLevel",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.OFF=0]="OFF",e[e.FATAL=1]="FATAL",e[e.ERROR=2]="ERROR",e[e.WARN=3]="WARN",e[e.INFO=4]="INFO",e[e.DEBUG=5]="DEBUG",e[e.ALL=6]="ALL"}(r||(r={})),r}),define("ubp/commons/logging/Logger",["require","exports","lib/lodash","./LogLevel"],function(e,t,r,n){"use strict";return function(){function e(t,r){this._appenders={},this._universalContext=[],this._name=t,this._appenders=r||this._appenders,e.root?this._logLevel=e.root._logLevel:this._logLevel=n.ERROR}return e.getLogger=function(t){return new e(t)},e.isMuted=function(t){return e.muted[t]},e.mute=function(t){e.muted[t]=!0},e.unmute=function(t){delete e.muted[t]},e.prototype.setUniversalContext=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._universalContext=e},e.prototype.setLogLevel=function(e){this._logLevel=e},e.prototype.addAppender=function(e,t){this._appenders[e]=t},e.prototype.removeAppender=function(e){delete this._appenders[e]},
e.prototype.clearAppenders=function(){this._appenders={}},e.prototype._log=function(t,n,o,i){var a=this;if(this._isLevelEnabled(t)&&!e.isMuted(this._name)){var s=JSON.stringify(i),u=JSON.stringify(r.union(e.root._universalContext,this._universalContext)),c=r.extend({},this._appenders,e.root._appenders);r.each(c,function(e,i){r.isFunction(e.log)&&e.log(t,a._name,n,o,s,u)})}},e.prototype._isLevelEnabled=function(t){return t<=(this._logLevel>e.root._logLevel?this._logLevel:e.root._logLevel)&&e.root._logLevel!==n.OFF&&this._logLevel!==n.OFF},e.prototype.fatal=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];this._log(n.FATAL,e,t,r)},e.prototype.error=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];this._log(n.ERROR,e,t,r)},e.prototype.warn=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];this._log(n.WARN,e,t,r)},e.prototype.info=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];this._log(n.INFO,e,t,r)},e.prototype.debug=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];this._log(n.DEBUG,e,t,r)},e.root=new e("Root"),e.muted={},e}()}),define("ubp/commons/localization/Locale",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.US=1]="US",e[e.CA=2]="CA",e[e.CN=3]="CN",e[e.JP=4]="JP",e[e.ES=5]="ES",e[e.IT=6]="IT",e[e.FR=7]="FR",e[e.DE=8]="DE",e[e.UK=9]="UK",e[e.IN=10]="IN",e[e.MX=11]="MX",e[e.BR=12]="BR",e[e.AU=13]="AU",e[e.AE=14]="AE",e[e.TR=15]="TR"}(r||(r={})),r}),define("ubp/commons/Events/Subscription",["require","exports","../logging/Logger"],function(e,t,r){"use strict";return function(){function e(t,n){this.callback=t,this.context=n,this.disposed=!1,e._Logger=e._Logger||r.getLogger("Subscription")}return e.prototype.matches=function(e,t){return this.callback===e&&this.context===t},e.prototype.notify=function(t){try{this.disposed||this.callback.apply(this.context,t)}catch(t){e._Logger.error("notify","error thrown in callback",t.message)}},e.prototype.dispose=function(){this.disposed=!0},e}()}),define("ubp/commons/Events/EventBucket",["require","exports","lib/lodash","./Subscription"],function(e,t,r,n){"use strict";return function(){function e(){this.subscriptions=[]}return e.prototype.subscriptionExists=function(e,t){return!!r.find(this.subscriptions,function(r){return r.matches(e,t)},this)},e.prototype.subscribe=function(e,t){this.subscriptions.push(new n(e,t))},e.prototype.unsubscribeAll=function(){r.invoke(this.subscriptions,"dispose"),this.subscriptions=[]},e.prototype.unsubscribe=function(e,t){var n=null,o=r.find(this.subscriptions,function(r,o){return!!r.matches(e,t)&&(n=o,!0)},this);o&&(o.dispose(),this.subscriptions.splice(n,1))},e.prototype.notify=function(e){r.invoke(r.clone(this.subscriptions),"notify",e)},e}()}),define("ubp/commons/Events/Events",["require","exports","lib/lodash","./EventBucket"],function(e,t,r,n){"use strict";return function(){function e(){this.eventBuckets={}}return e.prototype.on=function(e,t,r){var n=this.getEventBucket(e);if(n.subscriptionExists(t,r))throw new Error("Cannot register duplicate subscription.");n.subscribe(t,r)},e.prototype.off=function(e,t,r){switch(arguments.length){case 0:this.removeAllSubscriptions();break;case 1:this.getEventBucket(e).unsubscribeAll();break;default:this.getEventBucket(e).unsubscribe(t,r)}},e.prototype.notify=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.getEventBucket(e).notify(t)},e.prototype.getEventBucket=function(e){return this.eventBuckets[e]=this.eventBuckets[e]||new n},e.prototype.removeAllSubscriptions=function(){r.invoke(this.eventBuckets,"unsubscribeAll")},e}()}),define("ubp/commons/error/BaseError",["require","exports"],function(e,t){"use strict";return function(){function e(e,t,r,n){this._name=e,this._message=t,this._status=r,this._cause=n||""}return e.prototype.getStatus=function(){return this._status},e.prototype.setStatus=function(e){this._status=e},e.prototype.getMessage=function(){return this._message},e.prototype.setMessage=function(e){this._message=e},e.prototype.getName=function(){return this._name},e.prototype.setName=function(e){this._name=e},e.prototype.getCause=function(){return this._cause},e.prototype.setCause=function(e){this._cause=e},e.prototype.toString=function(){var e=""+this._cause;if("object"==typeof this._cause&&this._cause.toString===Object.prototype.toString)try{e=JSON.stringify(this._cause)}catch(e){}return this._name+": "+this._message+" Status: "+this._status+"; Cause: "+e},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/ConflictError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"ConflictError","There was a conflict with the state of the resource.","409",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/BadRequestError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"BadRequestError","The request was somehow malformed or missing required arguments.","400",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/configuration/ConfigurationManager",["require","exports","lib/bluebird","lib/lodash","../../commons/Events/Events","../../commons/logging/Logger","../../commons/localization/Locale","../../commons/error/ConflictError","../../commons/error/BadRequestError"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(e){function t(r,n,o){var i=e.call(this)||this;return i.configurationPullerError=null,i._isStarted=!1,i._configurationPuller=r,i._manifestConfiguration=n,i._localeManager=o,i._locale=a.US,i._refreshRate=t.MIN_CONFIGURATION_REFRESH_INTERVAL,i}return __extends(t,e),t.prototype.start=function(){var e=this;if(this._isStarted){var o=new s("This ConfigurationManager has already been started and can only be started once.");return t.logger.error("start",o.toString()),r.reject(o)}var i;return r.bind(this).then(function(){return e._localeManager.getLocale()}).then(function(t){return e._locale=t,i=e._getConfigEndpoint(),e._configurationPuller.start(i)}).then(function(r){e._featureManifestList=r,e._configurationPuller.registerOnFeatureManifestListUpdatedHandler(n.bind(e._onFeatureManifestListUpdated,e)),"remote"===e._configEndpointType&&e._startConfigurationPullerLooper(i,e._refreshRate),e._isStarted=!0,t.logger.info("start","ConfigurationManager started")})},t.prototype.stop=function(){var e=this;return r.bind(this).then(function(){return e.off(),e._configurationPuller.stop()}).then(function(){e._featureManifestList=void 0,e._locale=a.US,e._isStarted=!1})},t.prototype._getConfigEndpoint=function(){var e;if(!this._manifestConfiguration.configuration||!this._manifestConfiguration.version){var r=new u("The manifest configuration is not correct, check the configuration!");throw t.logger.error("_getConfigEndpoint",r.toString()),r}this._refreshRate=this._computeJitteredRate(this._manifestConfiguration.refreshRateRange)||this._manifestConfiguration.refreshRate||this._refreshRate;var n=a[this._locale];t.logger.debug("_getConfigEndpoint","Using locale: "+n);var o;if(o=this._manifestConfiguration.configuration[n],t.logger.debug("_getConfigEndpoint","Using locale specific config: "+JSON.stringify(o)),!o){var i=new s("Feature manifest config does not have configuration for "+n+" locale");throw t.logger.error("_getConfigEndpoint",i.toString()),i}switch(this._configEndpointType=o.endPointType,this._configEndpointType){case"local":o.manifest&&(e=o.manifest);break;case"remote":if(!o.endPoint){var i=new s("Feature manifest config does not define remote endPoint.");throw t.logger.error("_getConfigEndpoint",i.toString()),i}e=o.endPoint;break;default:var i=new s("Feature manifest config has endPointType "+this._configEndpointType+", valid values are local, remote");throw t.logger.error("_getConfigEndpoint",i.toString()),i}return e},t.prototype.getLocale=function(){var e=this;if(!this._isStarted){var n=new Error("You must start this ConfigurationManager before making any method calls.");return t.logger.error("getLocale",n.toString()),r.reject(n)}return r.bind(this).then(function(){return e._locale})},t.prototype.setLocale=function(e){var n=this;if(!this._isStarted){var o=new Error("You must start this ConfigurationManager before making any method calls.");return t.logger.error("setLocale",o.toString()),r.reject(o)}if(this._locale===e)return r.resolve();var i;return r.bind(this).then(function(){return n._localeManager.setLocale(e)}).then(function(){return n._locale=e,n._configurationPuller.stopPullFeatureManifestListLooper()}).catch(function(e){t.logger.debug("setLocale",JSON.stringify(e))}).then(function(){if(i=n._getConfigEndpoint())return t.logger.debug("setLocale","Restarting configuration puller with new endpoint: "+i),n._startConfigurationPullerLooper(i),n._configurationPuller.pullFeatureManifestList(i)}).then(function(){n.notify("ExtensionLocaleUpdated",e)})},t.prototype.getFeatureManifestList=function(){var e=this;if(!this._isStarted){var n=new Error("You must start this ConfigurationManager before making any method calls.");return t.logger.error("getFeatureManifestList",n.toString()),r.reject(n)}return r.bind(this).then(function(){return e._configurationPuller.getFeatureManifestList()})},t.prototype.registerOnFeatureManifestListUpdatedHandler=function(e){this.on("FeatureManifestListUpdated",e)},t.prototype._startConfigurationPullerLooper=function(e,n){var o=this;return void 0===n&&(n=t.MIN_CONFIGURATION_REFRESH_INTERVAL),this.configurationPullerError=null,r.bind(this).then(function(){return o._configurationPuller.startPullFeatureManifestListLooper(e,n)}).catch(function(e){t.logger.error("_startConfigurationPullerLooper","Configuration Puller failed with error: "+e.message),o.configurationPullerError=e})},t.prototype._onFeatureManifestListUpdated=function(){var e=null;try{e=this._getFeatureManifestListDiff(this._featureManifestList,this._configurationPuller.getFeatureManifestList())}catch(e){t.logger.error("_onFeatureManifestListUpdated","Couldn't get FeatureManifestListDiff! : "+e.message)}this._featureManifestList=this._configurationPuller.getFeatureManifestList(),this.notify("FeatureManifestListUpdated",e)},t.prototype._getFeatureManifestListDiff=function(e,r){var o={version:r.version,data:{layers:{kernel:{},core:{},feature:{},UI:{}}}};return e=n.cloneDeep(e),n.each(r.data.layers,function(r,i){if(o.data.layers[i]=o.data.layers[i]||{},!e.data.layers[i])return void(o.data.layers[i]=r);n.each(r,function(r,n){t.isFeatureManifestTheSame(r,e.data.layers[i][n])||(o.data.layers[i][n]=r),delete e.data.layers[i][n]})}),n.each(e.data.layers,function(e,t){o.data.layers[t]=o.data.layers[t]||{},n.each(e,function(e,r){o.data.layers[t][r]=null})}),o},t.isFeatureManifestTheSame=function(e,t){return n.isEqual(e,t)},t.prototype._computeJitteredRate=function(e){if(n.isArray(e)){var t=e[0],r=e[1];if(this._isValidRefreshRate(t)&&this._isValidRefreshRate(r)&&t<r)return Math.floor(n.random(t,r))}},t.prototype._isValidRefreshRate=function(e){return e>=t.MIN_CONFIGURATION_REFRESH_INTERVAL&&e<=t.MAX_CONFIGURATION_REFRESH_INTERVAL},t.logger=i.getLogger("ConfigurationManager"),t.TEST_ENDPOINT="testsomething",t.MIN_CONFIGURATION_REFRESH_INTERVAL=18e5,t.MAX_CONFIGURATION_REFRESH_INTERVAL=864e5,t}(o)}),define("ubp/extension/configuration/features/DefaultFeatureManifestList",["require","exports"],function(e,t){"use strict";var r;return function(e){e.Development={version:"11-10-14",data:{layers:{kernel:{Platform:{manifestVersion:"11-10-14",manifest:{name:"Platform",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Pseudo",consumedAPIs:{},providedAPIs:{Platform:["openNewTab","removeTab","renderButtonCounter","getPlatformInfo","setPlatformCoreInfo","createSandbox","createSandboxById","createSandboxByIdPost","createLocalSandbox","modifySandbox","showSandbox","sendMessageToSandbox","instrumentSandbox","getSandboxAttribute","instrumentWebpage","destroySandbox","scrape","listenerSpecificationScrape","getActiveTabInfo","getUWLItem","publish","subscribe","unsubscribe","getStorageValue","putStorageValue","deleteStorageValue","getPageDimensionData","getPageLocationData","getPagePerformanceTimingData","getPageReferrer","isTOUAccepted","registerWhitelist","createContextMenuItem","deleteAllContextMenuItems","deleteContextMenuItemById"]},consumedEvents:[],providedEvents:["Tabs.PageTurn","Tabs.onRemoved","Sandbox.Message.*","Action.Message","Platform.PlatformDataUpdate","Contextmenu.ItemClicked.*","WebRequest.onBeforeRequest","WebRequest.onBeforeSendHeaders","WebRequest.onCompleted"],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:""}}}},core:{Storage:{manifestVersion:"11-10-14",manifest:{name:"Storage",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Platform:["getPlatformInfo","publish","getStorageValue","putStorageValue","deleteStorageValue"],Reporter:["appendMetricData"]},providedAPIs:{Storage:["get","put","putIfAbsent","delete"]},consumedEvents:["Platform.PlatformDataUpdate"],providedEvents:["Storage.onChange.*","Storage.onChange.*.*","Storage.onChange.*.*.*","Storage.onChange.*.*.*.*","Storage.onChange.*.*.*.*.*","Storage.onDelete.*","Storage.onDelete.*.*","Storage.onDelete.*.*.*","Storage.onDelete.*.*.*.*","Storage.onDelete.*.*.*.*.*"],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://localhost:8000/assets/storage-process.html"}}},Identity:{manifestVersion:"11-10-14",manifest:{name:"Identity",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Storage:["get","put","putIfAbsent","delete"],Platform:["getPlatformInfo","setPlatformCoreInfo","getStorageValue","putStorageValue"]},providedAPIs:{Identity:["getInstallationId","getInstallationLocale","getInstallationToken","getCustomerToken","getAllWeblabTreatments"]},consumedEvents:["TestProcess.Test.Event","Platform.PlatformDataUpdate"],providedEvents:["Identity.Test.Event","Identity.InstallationLocaleUpdate"],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://localhost:8000/assets/identity-process.html"}}},Reporter:{manifestVersion:"11-10-14",manifest:{name:"Reporter",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Identity:["getInstallationId","getInstallationToken","getCustomerToken"],Storage:["get","put","putIfAbsent","delete"],Platform:["getPlatformInfo","isTOUAccepted"]},providedAPIs:{Reporter:["appendMetricData"]},consumedEvents:["Platform.PlatformDataUpdate","Gateway.panel.connect","Gateway.panel.disconnect"],providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://localhost:8000/assets/reporter-process.html"}}},Dossier:{manifestVersion:"11-10-14",manifest:{name:"Dossier",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Platform:["getPlatformInfo"],Identity:["getInstallationId","getInstallationToken","getInstallationLocale"],Reporter:["appendMetricData"],Storage:["get","put","putIfAbsent","delete"]},providedAPIs:{Dossier:["buildURLs"]},consumedEvents:["Platform.PlatformDataUpdate","Identity.InstallationLocaleUpdate"],providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://localhost:8000/assets/dossier-process.html"}}},Gateway:{manifestVersion:"11-10-14",manifest:{name:"Gateway",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Pseudo",consumedAPIs:{Reporter:["appendMetricData"],Dossier:["buildURLs"],Identity:["getCustomerToken","getInstallationId","getInstallationToken"],Feed:["getFeedData","logFeedItemInteractions"],Platform:["getPlatformInfo","openNewTab","getActiveTabInfo","getUWLItem","getFeatureList","setLocale","acceptTermsOfUse"],Storage:["get","put","putIfAbsent","delete"]},providedAPIs:{Gateway:["instrumentGateway"]},consumedEvents:["Platform.PlatformDataUpdate"],providedEvents:["Gateway.UIMetric","Gateway.panel.connect","Gateway.panel.disconnect"],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:""}}}},feature:{FirstRun:{manifestVersion:"11-10-14",manifest:{name:"FirstRun",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Pseudo",consumedAPIs:{Dossier:["buildURLs"],Platform:["openNewTab"]},providedAPIs:{FirstRun:[]},consumedEvents:["Platform.PlatformDataUpdate"],providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:""}}},TutorialProcess:{manifestVersion:"11-10-14",manifest:{name:"TutorialProcess",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Identity:["getCustomerToken","getInstallationToken"]},providedAPIs:{},consumedEvents:["Identity.Test.Event","Platform.PlatformDataUpdate"],providedEvents:["TestProcess.Test.Event"],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://localhost:8000/assets/tutorial-process.html"}}},Feed:{manifestVersion:"11-10-14",manifest:{name:"Feed",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Dossier:["buildURLs"],Platform:["getPlatformInfo","renderButtonText"],Reporter:["appendMetricData"]},providedAPIs:{Feed:["getFeedData","logFeedItemInteractions"]},consumedEvents:["Gateway.UIMetric","Gateway.panel.connect","Gateway.panel.disconnect","Platform.PlatformDataUpdate"],providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://localhost:8000/assets/feed-process.html"}}},Titan:{manifestVersion:"11-10-14",manifest:{name:"Titan",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Platform:["getPageDimensionData","getPageLocationData","getPagePerformanceTimingData","getPageReferrer","scrape"],Reporter:["appendMetricData"]},providedAPIs:{},consumedEvents:["Tabs.PageTurn","Platform.PlatformDataUpdate"],providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"BrowserIntegration"},configuration:{url:"http://localhost:8000/assets/titan-process.html"}}},TitanClient:{manifestVersion:"2015-03-26",manifest:{name:"TitanClient",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",configuration:{url:"https://bit-titan-service-gamma-iad.iad.proxy.amazon.com/Gamma/NAAmazon/TitanClient/titan-client.html",assetTag:'define({\n  "eTag" : "949c0655c5737f8bd4728de50d508c11",\n  "lastUpdated" : "2016-10-04T23:52:20.292Z[UTC]"\n});'},consumedAPIs:{Platform:["getPageDimensionData","getPageLocationData","getPagePerformanceTimingData","getPageReferrer","scrape","listenerSpecificationScrape","getPlatformInfo"],Reporter:["appendMetricData"],Storage:["get","put","delete"]},consumedEvents:["Tabs.PageTurn","Platform.PlatformDataUpdate"],providedAPIs:{},providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"BrowserIntegration"}}},Integration:{manifestVersion:"2015-03-26",manifest:{name:"Integration",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",configuration:{url:"https://aa-qa-automation.s3.amazonaws.com/integration.html",assetTag:""},consumedAPIs:{Identity:["getAllWeblabTreatments","getCohortToken","getCustomerToken","getInstallationId","getInstallationLocale","getInstallationToken"],Dossier:["buildURLs"],Platform:["openNewTab","removeTab","renderButtonCounter","getPlatformInfo","setPlatformCoreInfo","createSandbox","createSandboxById","createSandboxByIdPost","createLocalSandbox","modifySandbox","showSandbox","sendMessageToSandbox","destroySandbox","scrape","listenerSpecificationScrape","getActiveTabInfo","getUWLItem","publish","subscribe","unsubscribe","getStorageValue","putStorageValue","deleteStorageValue","getPageDimensionData","getPageLocationData","getPagePerformanceTimingData","getPageReferrer","isTOUAccepted","registerWhitelist","instrumentSandbox","getSandboxAttribute","instrumentWebpage","createContextMenuItem","deleteAllContextMenuItems","deleteContextMenuItemById"],Gateway:["instrumentGateway"],Reporter:["appendMetricData"],Storage:["get","put","putIfAbsent","delete"],Feed:["getFeedData","getFeedDataV2","logFeedItemInteractions"]},consumedEvents:["Tabs.PageTurn","Tabs.onRemoved","Sandbox.Message.UBPSandboxMessage","Action.Message","Platform.PlatformDataUpdate","Contextmenu.ItemClicked.PComp","WebRequest.onBeforeRequest","WebRequest.onBeforeSendHeaders","WebRequest.onCompleted"],providedAPIs:{},providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"BrowserIntegration"}}},PComp:{manifestVersion:"11-10-14",manifest:{name:"PComp",version:{major:1,minor:1,build:1,revision:1},enabled:!0,processType:"Remote",consumedAPIs:{Identity:["getAllWeblabTreatments","getCustomerToken"],Platform:["getPlatformInfo","createSandbox","createSandboxById","createSandboxByIdPost","createLocalSandbox","modifySandbox","showSandbox","destroySandbox","sendMessageToSandbox","scrape","listenerSpecificationScrape","applyStyle","resetStyle","registerAction","deregisterAction","createContextMenuItem","deleteAllContextMenuItems","deleteContextMenuItemById"],Storage:["get","put","putIfAbsent","delete"],Reporter:["appendMetricData"],Dossier:["buildURLs"]},providedAPIs:{},consumedEvents:["Tabs.PageTurn","Tabs.onRemoved","Sandbox.Message.UBPSandboxMessage","Action.Message","Platform.PlatformDataUpdate","Contextmenu.ItemClicked.PComp"],providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://match-browserapp.integ.amazon.com/pcomp/dev/pcomp-process.html"}}},BenchmarkingHarness:{manifestVersion:"11-10-14",manifest:{name:"BenchmarkingHarness",version:{major:1,minor:1,build:1,revision:1},enabled:!1,processType:"Remote",consumedAPIs:{Dossier:["buildURLs"],Platform:["openNewTab","getPlatformInfo","createSandbox","modifySandbox","destroySandbox","applyStyle"],Reporter:["appendMetricData"]},providedAPIs:{},consumedEvents:["Tabs.PageTurn","Sandbox.Message.Harness","Platform.PlatformDataUpdate"],providedEvents:[],CTI:{category:"Company-wide Services",type:"Traffic Systems",item:"Browser Integration"},configuration:{url:"http://localhost:8000/assets/harness-process.html"}}}},UI:{}}}}}(r||(r={})),r}),define("ubp/commons/messaging/clients/network/HTTPMethod",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.GET=1]="GET",e[e.HEAD=2]="HEAD",e[e.POST=3]="POST",e[e.PUT=4]="PUT"}(r||(r={})),r});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/configuration/ConfigurationPuller",["require","exports","lib/bluebird","lib/lodash","../../commons/Events/Events","./features/DefaultFeatureManifestList","../../commons/messaging/clients/network/HTTPMethod","../../commons/error/ConflictError","../../commons/logging/Logger"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(e){function t(r,n){var o=e.call(this)||this;return o.networkClient=r,o.runtime=n,o.currentFeatureManifestList=null,o._isStarted=!1,o._currentETag=null,o._looperResolver=null,o._looperPromise=null,t.logger=t.logger||u.getLogger("ConfigurationPuller"),o}return __extends(t,e),t.prototype.start=function(e){var n=this;return void 0===e&&(e=i.Development),r.bind(this).then(function(){if(n._isStarted){var o=new s("This ConfigurationPuller has already been started and can only be started once.");throw t.logger.error("start",o.toString()),o}return"string"==typeof e?n.pullFeatureManifestList(e):(t.logger.debug("start","using local feature manifest list"),n.currentFeatureManifestList=e,r.resolve())}).then(function(){return n._isStarted=!0,t.logger.info("start","ConfigurationPuller started"),n.getFeatureManifestList()})},t.prototype.stop=function(){var e=this;return r.bind(this).then(function(){return e.off(),e.stopPullFeatureManifestListLooper()}).catch(function(e){}).then(function(){e.currentFeatureManifestList=null,e._currentETag=null,e._looperPromise=null,e._looperResolver=null,e._looperTimeoutId=void 0,e._isStarted=!1})},t.prototype.registerOnFeatureManifestListUpdatedHandler=function(e){this.on("FeatureManifestListUpdated",e)},t.prototype.getFeatureManifestList=function(){if(null===this.currentFeatureManifestList){var e=new s("Must call pullFeatureManifestList once successfully before using this method");throw t.logger.error("getFeatureManifestList",e.toString()),e}return n.cloneDeep(this.currentFeatureManifestList)},t.prototype.startPullFeatureManifestListLooper=function(e,n){var o=this;return r.bind(this).then(function(){if(!o._looperResolver||o._looperResolver.promise.isResolved())return t.logger.debug("startPullFeatureManifestListLooper","Starting feature manifest list looper"),o._looperResolver=r.defer(),o._scheduleLooper(e,n),o._looperResolver.promise;var i=new Error("Feature manifest list looper is already started or looper has stopped");throw t.logger.error("startPullFeatureManifestListLooper",i.toString()),i})},t.prototype.stopPullFeatureManifestListLooper=function(){var e=this;return r.bind(this).then(function(){if(!e._looperResolver||!e._looperResolver.promise.isPending()){var r=new Error("Attempting to stop looper which is already stopped, never started, or not cancellable.");throw t.logger.error("stopPullFeatureManifestListLooper",r.toString()),r}if(e._looperPromise&&e._looperPromise.isPending()&&e._looperPromise.isCancellable())return t.logger.debug("stopPullFeatureManifestListLooper","Attempting to cancel looper"),e._looperPromise.cancel()}).then(function(){return e.runtime.clearTimeout(e._looperTimeoutId),e._looperResolver.resolve(),e._looperResolver.promise})},t.prototype.pullFeatureManifestList=function(e){var n=this;return"testsomething"===e?(this.currentFeatureManifestList=i.Development,r.resolve()):r.bind(this).then(function(){return n.networkClient.request(e,t.NetworkRequestConfiguration)}).then(function(e){var r=n._getValueFromResponseHeader(e.headers,t.ETAG_KEY);if(void 0===r){var o=new Error("No ETag was found for the request");throw t.logger.error("pullFeatureManifestList",o.toString(),"Response headers: "+JSON.stringify(e.headers)),o}r!==n._currentETag&&(t.logger.debug("pullFeatureManifestList","Feature Manifest List has been Updated"),n.currentFeatureManifestList=e.data,n._currentETag=r,n.notify("FeatureManifestListUpdated"))})},t.prototype._pullFeatureManifestListLooper=function(e,n){this._looperPromise=r.bind(this).cancellable().then(function(){return this.pullFeatureManifestList(e)}).then(function(){this._scheduleLooper(e,n)}).catch(function(r){"CancellationError"===r.name?this._looperResolver.resolve():(t.logger.error("_pullFeatureManifestListLooper","pullFeatureManifests threw an error, rescheduling: "+r.message),this._scheduleLooper(e,n))})},t.prototype._scheduleLooper=function(e,t){this.runtime.clearTimeout(this._looperTimeoutId),this._looperTimeoutId=this.runtime.setTimeout(n.bind(function(){this._pullFeatureManifestListLooper(e,t)},this),t,"PullFeatureManifestListLooper.MainLooperTimeout")},t.prototype._getValueFromResponseHeader=function(e,t){var r;return n.forEach(e,function(e,n){if(n.toLowerCase()===t.toLowerCase())return r=e,!1}),r},t.ETAG_KEY="etag",t.NETWORK_TIMEOUT=3e4,t.MAX_ATTEMPTS=10,t.BACKOFF_FACTOR=2,t.INITIAL_RETRY_INTERVAL=1e3,t.NetworkRequestConfiguration={httpMethod:a.GET,responseType:"json",timeout:t.NETWORK_TIMEOUT,maxAttempts:t.MAX_ATTEMPTS,backoffFactor:t.BACKOFF_FACTOR,initialRetryInterval:t.INITIAL_RETRY_INTERVAL},t}(o)});var factory=function(){"use strict";var e=function(){};return e.getGlobalParameters=function(){return{browser:"chrome",partner:"",programCode:"",extensionStage:"prod",partnersRequiringTermsOfUse:["acer1","avast1","dell1","lenovo1","mozilla1","msi1","opera1","pokki1","toshiba1","samsung1","sleipnir1","hp1"],isTOURequired:function(){return this.partnersRequiringTermsOfUse.indexOf(this.partner)>=0},isTOURequiredForPartner:function(e){return this.partnersRequiringTermsOfUse.indexOf(e)>=0},pageMessagingDriverIncludePatterns:["*.amazon.com","*.amazon.ca","*.amazon.co.uk","*.amazon.de","*.amazon.es","*.amazon.it","*.amazon.fr","*.amazon.in","*.amazon.co.jp","*.amazon.cn","*.amazon.in","*.amazon.com.mx","*.amazon.ae","*.amazon.com.br","*.amazon.com.tr","*.amazon.com.au"],safariPageMessagingDriverIncludePatterns:["http://*.amazon.com/*","http://*.amazon.ca/*","http://*.amazon.co.uk/*","http://*.amazon.de/*","http://*.amazon.es/*","http://*.amazon.it/*","http://*.amazon.fr/*","http://*.amazon.co.jp/*","http://*.amazon.cn/*","http://*.amazon.in/*","http://*.amazon.com.mx/*","http://*.amazon.ae/*","http://*.amazon.com.tr/*","http://*.amazon.com.br/*","http://*.amazon.com.au/*","https://*.amazon.com/*","https://*.amazon.ca/*","https://*.amazon.co.uk/*","https://*.amazon.de/*","https://*.amazon.es/*","https://*.amazon.it/*","https://*.amazon.fr/*","https://*.amazon.co.jp/*","https://*.amazon.cn/*","https://*.amazon.in/*","https://*.amazon.com.mx/*","https://*.amazon.ae/*","https://*.amazon.com.tr/*","https://*.amazon.com.br/*","https://*.amazon.com.au/*"],setLocaleTimeout:2e4}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/GlobalParameters",[],factory),define("ubp/extension/process/ProcessState",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.NEW=1]="NEW",e[e.STARTING=2]="STARTING",e[e.STABLE=3]="STABLE",e[e.UNRESPONSIVE=4]="UNRESPONSIVE",e[e.TERMINATING=5]="TERMINATING",e[e.TERMINATED=6]="TERMINATED"}(r||(r={})),r}),define("ubp/commons/specification/message/MessageType",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.API=1]="API",e[e.EVENT=2]="EVENT",e[e.SIGNAL=3]="SIGNAL",e[e.HANDSHAKE=4]="HANDSHAKE",e[e.HEALTHCHECK=5]="HEALTHCHECK"}(r||(r={})),r}),define("ubp/extension/process/HealthChecker",["require","exports","lib/bluebird","./ProcessState","../../commons/logging/Logger","../../commons/specification/message/MessageType"],function(e,t,r,n,o,i){"use strict";return function(){function e(t,r,n,i){if(void 0===n&&(n=e.DEFAULT_INTERVAL),void 0===i&&(i=e.DEFAULT_TIMEOUT),e.logger=e.logger||o.getLogger("HealthChecker"),this._process=t,this._interval=n,this._runtime=r,this._timeout=i,this._terminated=!1,
this._interval<this._timeout)throw new Error("Interval cannot be less than the timeout")}return e.prototype.start=function(){var e=this;return this._process.getManifest().then(function(t){e._processName=t.name}).then(function(){e._timeoutID=e._runtime.setTimeout(e._healthCheck.bind(e),e._jitteredInterval())})},e.prototype.terminate=function(){var e=this;return r.bind(this).then(function(){e._terminated=!0,e._runtime.clearTimeout(e._timeoutID),e._process=null})},e.prototype._healthCheck=function(){var t=this,r={header:{messageType:i.HEALTHCHECK,name:"healthcheck",namespace:this._processName},data:{args:{namespace:this._processName}}};return this._process.sendAndReceive(r,this._timeout).then(function(e){e.UBPHealthCheckResponse.namespace===t._processName&&t._process.setState(n.STABLE)}).catch(function(r){e.logger.error("_healthCheck","Health Check failed for process: "+t._processName),e.logger.error("_healthCheck",r.message),t._process.setState(n.UNRESPONSIVE)}).finally(function(){t._terminated||(t._timeoutID=t._runtime.setTimeout(t._healthCheck.bind(t),t._jitteredInterval()))})},e.prototype._jitteredInterval=function(){var e=this._interval/10;return this._interval-Math.random()*e},e.DEFAULT_INTERVAL=5e4,e.DEFAULT_TIMEOUT=4e4,e}()}),define("ubp/extension/process/ProcessType",["require","exports"],function(e,t){"use strict";return function(){function e(){}return e.Pseudo="Pseudo",e.Remote="Remote",e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/FeatureUnavailableError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"FeatureUnavailableError","The resource is known, but has become unavailable, check if process is still running","503",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/ForbiddenError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"ForbiddenError","The calling process does not have permission to access to this API","403",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/InternalError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"InternalError","Something unexpected went wrong while processing the request.","500",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/NotFoundError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"NotFoundError","The API was never registered by the Platform or any remote process.","404",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/OutOfMemoryError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"OutOfMemoryError","Not enough memory to support this operation","521",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/RequestTimeoutError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"RequestTimeoutError","A response was not received before the (specified or default) timeout.","408",t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/error/NoNetworkConnectivityError",["require","exports","./BaseError"],function(e,t,r){"use strict";return function(e){function t(t){return e.call(this,"NoNetworkConnectivityError","There was an error with network connectivity.","470",t)||this}return __extends(t,e),t}(r)}),define("ubp/commons/error/Errors",["require","exports","./BaseError","./BadRequestError","./ConflictError","./FeatureUnavailableError","./ForbiddenError","./InternalError","./NotFoundError","./OutOfMemoryError","./RequestTimeoutError","./NoNetworkConnectivityError"],function(e,t,r,n,o,i,a,s,u,c,l,p){"use strict";var f;return function(e){function t(e,t,r,n){var o;switch(r){case"400":o=this.BadRequest(n);break;case"409":o=this.Conflict(n);break;case"503":o=this.FeatureUnavailable(n);break;case"403":o=this.Forbidden(n);break;case"500":o=this.Internal(n);break;case"404":o=this.NotFound(n);break;case"521":o=this.OutOfMemory(n);break;case"408":o=this.RequestTimeout(n);break;case"470":o=this.NoNetworkConnectivity(n);break;default:o=this.Base(e,t,r,n)}return e&&o.setName(e),t&&o.setMessage(t),o}function f(e,t,n,o){return new r(e,t,n,o)}function _(e){return new n(e)}function d(e){return new o(e)}function g(e){return new i(e)}function h(e){return new a(e)}function m(e){return new s(e)}function v(e){return new u(e)}function y(e){return new c(e)}function b(e){return new l(e)}function E(e){return new p(e)}e.Auto=t,e.Base=f,e.BadRequest=_,e.Conflict=d,e.FeatureUnavailable=g,e.Forbidden=h,e.Internal=m,e.NotFound=v,e.OutOfMemory=y,e.RequestTimeout=b,e.NoNetworkConnectivity=E}(f||(f={})),f}),define("ubp/commons/utilities/PromiseRegistry",["require","exports"],function(e,t){"use strict";return function(){function e(){this._registry={}}return e.prototype.register=function(e,t){if(!e||!t)throw new Error("A name and promise must both be provided in order to register; name: "+e+"; promise: "+t);this._registry[e]=t},e.prototype.get=function(e){return this._registry[e]},e.prototype.isRegistered=function(e){return!!this._registry[e]},e.prototype.deregister=function(e,t){return(!t||t===this._registry[e])&&(delete this._registry[e],!0)},e.prototype.getPromiseNames=function(){return Object.getOwnPropertyNames(this._registry)},e.prototype.clean=function(){this._registry={}},e}()}),function(){var e=this,t=e._,r={},n=Array.prototype,o=Object.prototype,i=Function.prototype,a=n.push,s=n.slice,u=n.concat,c=o.toString,l=o.hasOwnProperty,p=n.forEach,f=n.map,_=n.reduce,d=n.reduceRight,g=n.filter,h=n.every,m=n.some,v=n.indexOf,y=n.lastIndexOf,b=Array.isArray,E=Object.keys,S=i.bind,T=function(e){return e instanceof T?e:this instanceof T?void(this._wrapped=e):new T(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=T),exports._=T):e._=T,T.VERSION="1.6.0";var x=T.each=T.forEach=function(e,t,n){if(null==e)return e;if(p&&e.forEach===p)e.forEach(t,n);else if(e.length===+e.length){for(var o=0,i=e.length;i>o;o++)if(t.call(n,e[o],o,e)===r)return}else for(var a=T.keys(e),o=0,i=a.length;i>o;o++)if(t.call(n,e[a[o]],a[o],e)===r)return;return e};T.map=T.collect=function(e,t,r){var n=[];return null==e?n:f&&e.map===f?e.map(t,r):(x(e,function(e,o,i){n.push(t.call(r,e,o,i))}),n)};var w="Reduce of empty array with no initial value";T.reduce=T.foldl=T.inject=function(e,t,r,n){var o=arguments.length>2;if(null==e&&(e=[]),_&&e.reduce===_)return n&&(t=T.bind(t,n)),o?e.reduce(t,r):e.reduce(t);if(x(e,function(e,i,a){o?r=t.call(n,r,e,i,a):(r=e,o=!0)}),!o)throw new TypeError(w);return r},T.reduceRight=T.foldr=function(e,t,r,n){var o=arguments.length>2;if(null==e&&(e=[]),d&&e.reduceRight===d)return n&&(t=T.bind(t,n)),o?e.reduceRight(t,r):e.reduceRight(t);var i=e.length;if(i!==+i){var a=T.keys(e);i=a.length}if(x(e,function(s,u,c){u=a?a[--i]:--i,o?r=t.call(n,r,e[u],u,c):(r=e[u],o=!0)}),!o)throw new TypeError(w);return r},T.find=T.detect=function(e,t,r){var n;return R(e,function(e,o,i){return t.call(r,e,o,i)?(n=e,!0):void 0}),n},T.filter=T.select=function(e,t,r){var n=[];return null==e?n:g&&e.filter===g?e.filter(t,r):(x(e,function(e,o,i){t.call(r,e,o,i)&&n.push(e)}),n)},T.reject=function(e,t,r){return T.filter(e,function(e,n,o){return!t.call(r,e,n,o)},r)},T.every=T.all=function(e,t,n){t||(t=T.identity);var o=!0;return null==e?o:h&&e.every===h?e.every(t,n):(x(e,function(e,i,a){return(o=o&&t.call(n,e,i,a))?void 0:r}),!!o)};var R=T.some=T.any=function(e,t,n){t||(t=T.identity);var o=!1;return null==e?o:m&&e.some===m?e.some(t,n):(x(e,function(e,i,a){return o||(o=t.call(n,e,i,a))?r:void 0}),!!o)};T.contains=T.include=function(e,t){return null!=e&&(v&&e.indexOf===v?-1!=e.indexOf(t):R(e,function(e){return e===t}))},T.invoke=function(e,t){var r=s.call(arguments,2),n=T.isFunction(t);return T.map(e,function(e){return(n?t:e[t]).apply(e,r)})},T.pluck=function(e,t){return T.map(e,T.property(t))},T.where=function(e,t){return T.filter(e,T.matches(t))},T.findWhere=function(e,t){return T.find(e,T.matches(t))},T.max=function(e,t,r){if(!t&&T.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);var n=-1/0,o=-1/0;return x(e,function(e,i,a){var s=t?t.call(r,e,i,a):e;s>o&&(n=e,o=s)}),n},T.min=function(e,t,r){if(!t&&T.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);var n=1/0,o=1/0;return x(e,function(e,i,a){var s=t?t.call(r,e,i,a):e;o>s&&(n=e,o=s)}),n},T.shuffle=function(e){var t,r=0,n=[];return x(e,function(e){t=T.random(r++),n[r-1]=n[t],n[t]=e}),n},T.sample=function(e,t,r){return null==t||r?(e.length!==+e.length&&(e=T.values(e)),e[T.random(e.length-1)]):T.shuffle(e).slice(0,Math.max(0,t))};var A=function(e){return null==e?T.identity:T.isFunction(e)?e:T.property(e)};T.sortBy=function(e,t,r){return t=A(t),T.pluck(T.map(e,function(e,n,o){return{value:e,index:n,criteria:t.call(r,e,n,o)}}).sort(function(e,t){var r=e.criteria,n=t.criteria;if(r!==n){if(r>n||void 0===r)return 1;if(n>r||void 0===n)return-1}return e.index-t.index}),"value")};var C=function(e){return function(t,r,n){var o={};return r=A(r),x(t,function(i,a){var s=r.call(n,i,a,t);e(o,s,i)}),o}};T.groupBy=C(function(e,t,r){T.has(e,t)?e[t].push(r):e[t]=[r]}),T.indexBy=C(function(e,t,r){e[t]=r}),T.countBy=C(function(e,t){T.has(e,t)?e[t]++:e[t]=1}),T.sortedIndex=function(e,t,r,n){r=A(r);for(var o=r.call(n,t),i=0,a=e.length;a>i;){var s=i+a>>>1;r.call(n,e[s])<o?i=s+1:a=s}return i},T.toArray=function(e){return e?T.isArray(e)?s.call(e):e.length===+e.length?T.map(e,T.identity):T.values(e):[]},T.size=function(e){return null==e?0:e.length===+e.length?e.length:T.keys(e).length},T.first=T.head=T.take=function(e,t,r){return null==e?void 0:null==t||r?e[0]:0>t?[]:s.call(e,0,t)},T.initial=function(e,t,r){return s.call(e,0,e.length-(null==t||r?1:t))},T.last=function(e,t,r){return null==e?void 0:null==t||r?e[e.length-1]:s.call(e,Math.max(e.length-t,0))},T.rest=T.tail=T.drop=function(e,t,r){return s.call(e,null==t||r?1:t)},T.compact=function(e){return T.filter(e,T.identity)};var P=function(e,t,r){return t&&T.every(e,T.isArray)?u.apply(r,e):(x(e,function(e){T.isArray(e)||T.isArguments(e)?t?a.apply(r,e):P(e,t,r):r.push(e)}),r)};T.flatten=function(e,t){return P(e,t,[])},T.without=function(e){return T.difference(e,s.call(arguments,1))},T.partition=function(e,t){var r=[],n=[];return x(e,function(e){(t(e)?r:n).push(e)}),[r,n]},T.uniq=T.unique=function(e,t,r,n){T.isFunction(t)&&(n=r,r=t,t=!1);var o=r?T.map(e,r,n):e,i=[],a=[];return x(o,function(r,n){(t?n&&a[a.length-1]===r:T.contains(a,r))||(a.push(r),i.push(e[n]))}),i},T.union=function(){return T.uniq(T.flatten(arguments,!0))},T.intersection=function(e){var t=s.call(arguments,1);return T.filter(T.uniq(e),function(e){return T.every(t,function(t){return T.contains(t,e)})})},T.difference=function(e){var t=u.apply(n,s.call(arguments,1));return T.filter(e,function(e){return!T.contains(t,e)})},T.zip=function(){for(var e=T.max(T.pluck(arguments,"length").concat(0)),t=new Array(e),r=0;e>r;r++)t[r]=T.pluck(arguments,""+r);return t},T.object=function(e,t){if(null==e)return{};for(var r={},n=0,o=e.length;o>n;n++)t?r[e[n]]=t[n]:r[e[n][0]]=e[n][1];return r},T.indexOf=function(e,t,r){if(null==e)return-1;var n=0,o=e.length;if(r){if("number"!=typeof r)return n=T.sortedIndex(e,t),e[n]===t?n:-1;n=0>r?Math.max(0,o+r):r}if(v&&e.indexOf===v)return e.indexOf(t,r);for(;o>n;n++)if(e[n]===t)return n;return-1},T.lastIndexOf=function(e,t,r){if(null==e)return-1;var n=null!=r;if(y&&e.lastIndexOf===y)return n?e.lastIndexOf(t,r):e.lastIndexOf(t);for(var o=n?r:e.length;o--;)if(e[o]===t)return o;return-1},T.range=function(e,t,r){arguments.length<=1&&(t=e||0,e=0),r=arguments[2]||1;for(var n=Math.max(Math.ceil((t-e)/r),0),o=0,i=new Array(n);n>o;)i[o++]=e,e+=r;return i};var I=function(){};T.bind=function(e,t){var r,n;if(S&&e.bind===S)return S.apply(e,s.call(arguments,1));if(!T.isFunction(e))throw new TypeError;return r=s.call(arguments,2),n=function(){if(!(this instanceof n))return e.apply(t,r.concat(s.call(arguments)));I.prototype=e.prototype;var o=new I;I.prototype=null;var i=e.apply(o,r.concat(s.call(arguments)));return Object(i)===i?i:o}},T.partial=function(e){var t=s.call(arguments,1);return function(){for(var r=0,n=t.slice(),o=0,i=n.length;i>o;o++)n[o]===T&&(n[o]=arguments[r++]);for(;r<arguments.length;)n.push(arguments[r++]);return e.apply(this,n)}},T.bindAll=function(e){var t=s.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return x(t,function(t){e[t]=T.bind(e[t],e)}),e},T.memoize=function(e,t){var r={};return t||(t=T.identity),function(){var n=t.apply(this,arguments);return T.has(r,n)?r[n]:r[n]=e.apply(this,arguments)}},T.delay=function(e,t){var r=s.call(arguments,2);return setTimeout(function(){return e.apply(null,r)},t)},T.defer=function(e){return T.delay.apply(T,[e,1].concat(s.call(arguments,1)))},T.throttle=function(e,t,r){var n,o,i,a=null,s=0;r||(r={});var u=function(){s=!1===r.leading?0:T.now(),a=null,i=e.apply(n,o),n=o=null};return function(){var c=T.now();s||!1!==r.leading||(s=c);var l=t-(c-s);return n=this,o=arguments,0>=l?(clearTimeout(a),a=null,s=c,i=e.apply(n,o),n=o=null):a||!1===r.trailing||(a=setTimeout(u,l)),i}},T.debounce=function(e,t,r){var n,o,i,a,s,u=function(){var c=T.now()-a;t>c?n=setTimeout(u,t-c):(n=null,r||(s=e.apply(i,o),i=o=null))};return function(){i=this,o=arguments,a=T.now();var c=r&&!n;return n||(n=setTimeout(u,t)),c&&(s=e.apply(i,o),i=o=null),s}},T.once=function(e){var t,r=!1;return function(){return r?t:(r=!0,t=e.apply(this,arguments),e=null,t)}},T.wrap=function(e,t){return T.partial(t,e)},T.compose=function(){var e=arguments;return function(){for(var t=arguments,r=e.length-1;r>=0;r--)t=[e[r].apply(this,t)];return t[0]}},T.after=function(e,t){return function(){return--e<1?t.apply(this,arguments):void 0}},T.keys=function(e){if(!T.isObject(e))return[];if(E)return E(e);var t=[];for(var r in e)T.has(e,r)&&t.push(r);return t},T.values=function(e){for(var t=T.keys(e),r=t.length,n=new Array(r),o=0;r>o;o++)n[o]=e[t[o]];return n},T.pairs=function(e){for(var t=T.keys(e),r=t.length,n=new Array(r),o=0;r>o;o++)n[o]=[t[o],e[t[o]]];return n},T.invert=function(e){for(var t={},r=T.keys(e),n=0,o=r.length;o>n;n++)t[e[r[n]]]=r[n];return t},T.functions=T.methods=function(e){var t=[];for(var r in e)T.isFunction(e[r])&&t.push(r);return t.sort()},T.extend=function(e){return x(s.call(arguments,1),function(t){if(t)for(var r in t)e[r]=t[r]}),e},T.pick=function(e){var t={},r=u.apply(n,s.call(arguments,1));return x(r,function(r){r in e&&(t[r]=e[r])}),t},T.omit=function(e){var t={},r=u.apply(n,s.call(arguments,1));for(var o in e)T.contains(r,o)||(t[o]=e[o]);return t},T.defaults=function(e){return x(s.call(arguments,1),function(t){if(t)for(var r in t)void 0===e[r]&&(e[r]=t[r])}),e},T.clone=function(e){return T.isObject(e)?T.isArray(e)?e.slice():T.extend({},e):e},T.tap=function(e,t){return t(e),e};var L=function(e,t,r,n){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof T&&(e=e._wrapped),t instanceof T&&(t=t._wrapped);var o=c.call(e);if(o!=c.call(t))return!1;switch(o){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==e)return n[i]==t;var a=e.constructor,s=t.constructor;if(a!==s&&!(T.isFunction(a)&&a instanceof a&&T.isFunction(s)&&s instanceof s)&&"constructor"in e&&"constructor"in t)return!1;r.push(e),n.push(t);var u=0,l=!0;if("[object Array]"==o){if(u=e.length,l=u==t.length)for(;u--&&(l=L(e[u],t[u],r,n)););}else{for(var p in e)if(T.has(e,p)&&(u++,!(l=T.has(t,p)&&L(e[p],t[p],r,n))))break;if(l){for(p in t)if(T.has(t,p)&&!u--)break;l=!u}}return r.pop(),n.pop(),l};T.isEqual=function(e,t){return L(e,t,[],[])},T.isEmpty=function(e){if(null==e)return!0;if(T.isArray(e)||T.isString(e))return 0===e.length;for(var t in e)if(T.has(e,t))return!1;return!0},T.isElement=function(e){return!(!e||1!==e.nodeType)},T.isArray=b||function(e){return"[object Array]"==c.call(e)},T.isObject=function(e){return e===Object(e)},x(["Arguments","Function","String","Number","Date","RegExp"],function(e){T["is"+e]=function(t){return c.call(t)=="[object "+e+"]"}}),T.isArguments(arguments)||(T.isArguments=function(e){return!(!e||!T.has(e,"callee"))}),"function"!=typeof/./&&(T.isFunction=function(e){return"function"==typeof e}),T.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},T.isNaN=function(e){return T.isNumber(e)&&e!=+e},T.isBoolean=function(e){return!0===e||!1===e||"[object Boolean]"==c.call(e)},T.isNull=function(e){return null===e},T.isUndefined=function(e){return void 0===e},T.has=function(e,t){return l.call(e,t)},T.noConflict=function(){return e._=t,this},T.identity=function(e){return e},T.constant=function(e){return function(){return e}},T.property=function(e){return function(t){return t[e]}},T.matches=function(e){return function(t){if(t===e)return!0;for(var r in e)if(e[r]!==t[r])return!1;return!0}},T.times=function(e,t,r){for(var n=Array(Math.max(0,e)),o=0;e>o;o++)n[o]=t.call(r,o);return n},T.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},T.now=Date.now||function(){return(new Date).getTime()};var O={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};O.unescape=T.invert(O.escape);var M={escape:new RegExp("["+T.keys(O.escape).join("")+"]","g"),unescape:new RegExp("("+T.keys(O.unescape).join("|")+")","g")};T.each(["escape","unescape"],function(e){T[e]=function(t){return null==t?"":(""+t).replace(M[e],function(t){return O[e][t]})}}),T.result=function(e,t){if(null!=e){var r=e[t];return T.isFunction(r)?r.call(e):r}},T.mixin=function(e){x(T.functions(e),function(t){var r=T[t]=e[t];T.prototype[t]=function(){var e=[this._wrapped];return a.apply(e,arguments),j.call(this,r.apply(T,e))}})};var N=0;T.uniqueId=function(e){var t=++N+"";return e?e+t:t},T.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var k=/(.)^/,F={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},U=/\\|'|\r|\n|\t|\u2028|\u2029/g;T.template=function(e,t,r){var n;r=T.defaults({},r,T.templateSettings);var o=new RegExp([(r.escape||k).source,(r.interpolate||k).source,(r.evaluate||k).source].join("|")+"|$","g"),i=0,a="__p+='";e.replace(o,function(t,r,n,o,s){return a+=e.slice(i,s).replace(U,function(e){return"\\"+F[e]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),n&&(a+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),o&&(a+="';\n"+o+"\n__p+='"),i=s+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{n=new Function(r.variable||"obj","_",a)}catch(e){throw e.source=a,e}if(t)return n(t,T);var s=function(e){return n.call(this,e,T)};return s.source="function("+(r.variable||"obj")+"){\n"+a+"}",s},T.chain=function(e){return T(e).chain()};var j=function(e){return this._chain?T(e).chain():e};T.mixin(T),x(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=n[e];T.prototype[e]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=e&&"splice"!=e||0!==r.length||delete r[0],j.call(this,r)}}),x(["concat","join","slice"],function(e){var t=n[e];T.prototype[e]=function(){return j.call(this,t.apply(this._wrapped,arguments))}}),T.extend(T.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return T})}.call(this);var factory=function(e){var t=function(){};return e.extend(t.prototype,{parse:function(e){return parseUri(e)}}),new t};parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore")):void 0!==define&&define("bit/commons/uri",["underscore"],factory),define("ubp/commons/utilities/URI",["require","exports","bit/commons/uri","../../commons/error/BadRequestError"],function(e,t,r,n){"use strict";var o;return function(e){function t(e){if(!e||!e.domain||!e.scheme)throw new n("Invalid arguments received: "+JSON.stringify(e));var t=e.port?":"+e.port:"";return e.scheme+"://"+e.domain+t}function o(e){if(!e)throw new n("Invalid arguments received: "+e);var o=r.parse(e),i={path:o.path};return o.host&&(i.origin=t({scheme:o.protocol,domain:o.host,port:o.port})),o.query&&(i.queryString=o.query),o.anchor&&(i.fragment=o.anchor),i}function i(e,t){void 0===t&&(t=!0);var r="";if(!e||!e.path||!e.origin&&t)throw new n("Invalid arguments received: "+JSON.stringify(e));var o=e.queryString&&"?"!==e.queryString[0]?"?"+e.queryString:e.queryString||"",i=e.fragment&&"#"!==e.fragment[0]?"#"+e.fragment:e.fragment||"";return r=t?e.origin:"",r+=e.path+o+i}function a(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}function s(e){if(void 0===e&&(e=""),!(e=e.length&&"?"===e[0]?e.substr(1):e))return{};var t={},r=e.split("&");return _.each(r,function(e){var r=e.split("=");t[decodeURIComponent(r[0])]=r[1]?decodeURIComponent(r[1]):""}),t}function u(e,t,r){if(!t)return e;e||(e="");var n=encodeURIComponent(t)+"="+encodeURIComponent(r||"");return e.indexOf("?")<0?e+="?"+n:e.indexOf("?")>=0&&(e+="&"+n),e}function c(e){return e&&e.split("/").length<3&&"/"!==e[0]?e:e.replace(/^(?:\/\/|[^\/]+)*\//,"/")}function l(e,t){return t?(e||(e=""),"string"!=typeof t&&(t=JSON.stringify(t)),e.indexOf("#")>0?e.replace(/(#).+/,"$1"+t):e+"#"+t):e}e.getOrigin=t,e.getURLComponents=o,e.getURL=i,e.getQueryParameterString=a,e.getQueryParamsObject=s,e.appendInURLParameter=u,e.getRelativePath=c,e.putHash=l}(o||(o={})),o}),define("ubp/commons/localization/Marketplace",["require","exports","./Locale"],function(e,t,r){"use strict";return function(){function e(){this.marketplaceIdMap={ATVPDKIKX0DER:r[r.US],A2EUQ1WTGCTBG2:r[r.CA],A1VC38T7YXB528:r[r.JP],AAHKV2X7AFYLW:r[r.CN],A1F83G8C2ARO7P:r[r.UK],A1PA6795UKMFR9:r[r.DE],A13V1IB3VIYZZH:r[r.FR],APJ6JRA9NG5V4:r[r.IT],A3HOBANJMCMD83:r[r.IT],A1RKKUPIHCS9HS:r[r.ES],AJZF8LZ1EJVJN:r[r.ES],A21TJRUUN4KGV:r[r.IN],A2XZLSVIQ0F4JT:r[r.IN],A1AM78C64UM0Y8:r[r.MX],A3P3J5A7D2ZVXI:r[r.MX],A2Q3Y263D00KWC:r[r.BR],AZXD3QD5B39HD:r[r.BR],A39IBJ37TRP1C6:r[r.AU],A1RNPCQ4K8U27I:r[r.AU],A2VIGQ35RCS4UG:r[r.AE],A34GYYCZVDBSIK:r[r.AE],A33AVAJ2PDY3EV:r[r.TR],A3CQBQD3RGPJR8:r[r.TR]}}return e.prototype.getMarketplaceById=function(e){return this.marketplaceIdMap[e]},e}()}),define("ubp/commons/messaging/clients/network/HTTPStatus",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.OK=200]="OK",e[e.CREATED=201]="CREATED",e[e.ACCEPTED=202]="ACCEPTED",e[e.NO_CONTENT=204]="NO_CONTENT",e[e.BAD_REQUEST=400]="BAD_REQUEST",e[e.FORBIDDEN=403]="FORBIDDEN",e[e.NOTFOUND=404]="NOTFOUND",e[e.INTERNAL_ERROR=500]="INTERNAL_ERROR"}(r||(r={})),r}),define("ubp/metrics/anonymous/ForesterMetricsLogger",["require","exports","lib/lodash","lib/bluebird","../../commons/utilities/URI","../../commons/localization/Marketplace","../../commons/messaging/clients/network/HTTPMethod","../../commons/messaging/clients/network/HTTPStatus","../../commons/error/InternalError","../../commons/error/ForbiddenError","../../commons/error/NotFoundError","../../commons/error/BadRequestError"],function(e,t,r,n,o,i,a,s,u,c,l,p){"use strict";return function(){function e(e,t,r){this._client=e,this._endpoint=t,this._marketplaceId=r}return e.prototype.report=function(e){var t=this;return n.bind(this).then(function(){if(e.userIdentifiable)throw new p("User identifiable metrics must not be reported through the the ForesterMetricsLogger");return e.realTimeTimers&&0!==r.size(e.realTimeTimers)||e.realTimeCounters&&0!==r.size(e.realTimeCounters)?t._formatAndSendRequestToForester(e):n.resolve()})},e.prototype._formatAndSendRequestToForester=function(t){var i=this;return n.bind(this).then(function(){var n=o.getURLComponents(i._endpoint);r.endsWith(n.path,e._URIPathDelimiter)||(n.path+=e._URIPathDelimiter),n.path+=i.buildMetricsPath(t),null!=n.queryString&&void 0!=n.queryString||(n.queryString=""),n.queryString.length>0&&(n.queryString+=e._URIQueryStringDelimiter),n.queryString+=i.buildQueryParameters(t);var a=o.getURL(n);return i._client.request(a,e._ForesterRequestConfig)}).then(function(e){switch(e.status){case s.OK:case s.ACCEPTED:case s.NO_CONTENT:case s.CREATED:return;case s.FORBIDDEN:throw new c(e.statusText);case s.NOTFOUND:throw new l(e.statusText);case s.INTERNAL_ERROR:throw new u(e.statusText);default:throw new u("Received an unexpected response from Forester ["+JSON.stringify(e)+"]")}})},e.prototype.buildMetricsPath=function(t){var n=this.formatResources(t.realTimeCounters,r.bind(this.formatCounterValue,this)),o=this.formatResources(t.realTimeTimers,r.bind(this.formatTimerValue,this)),i="prod"===t.extensionStage.toLowerCase()?t.operationName:"Test_"+t.operationName,a=i+"_:";return n&&(a+=n),n&&o&&(a+=e._ResourceDelimiter),o&&(a+=o),a},e.prototype.formatResources=function(t,n){return r.reduce(t,function(t,r,o){return t.push(o+e._ResourceKeyValueSeparator+n(r)),t},[]).join(e._ResourceDelimiter)},e.prototype.formatCounterValue=function(e){return"v="+e},e.prototype.formatTimerValue=function(t){return"v="+r.reduce(t,function(e,t){return e+t})+e._ResourceMetadataDelimiter+"u=ms"},e.prototype.buildQueryParameters=function(t){var r=new i,n={marketplaceId:this._marketplaceId,marketplace:r.getMarketplaceById(this._marketplaceId),requestId:t.requestId,service:e._ServiceNamePrefix+t.featureName,method:t.operationName,session:e._AnonymousSessionId};return o.getQueryParameterString(n)},e._ServiceNamePrefix="AmazonAssistant.",e._AnonymousSessionId="",e._ResourceDelimiter=",",e._ResourceMetadataDelimiter="|",e._ResourceKeyValueSeparator="@",e._URIPathDelimiter="/",e._URIQueryStringDelimiter="&",e._RequestTimeout=3e4,e._MaxAttempts=1,e._BackoffFactor=2,e._InitialRetryInterval=200,e._ForesterRequestConfig={httpMethod:a.GET,headers:{},timeout:e._RequestTimeout,initialRetryInterval:e._InitialRetryInterval,backoffFactor:e._BackoffFactor,maxAttempts:e._MaxAttempts,withCredentials:!1},e}()}),define("ubp/metrics/sentry/SentryWhiteList",["require","exports","lib/lodash","lib/bluebird"],function(e,t,r,n){"use strict";return function(){function e(){}return e.purge=function(e,t){var r=this;return e?n.bind(this).then(function(){return r._hasAllowedFeature(e,t)&&r._hasAllowedOperation(e,t)?(r._purgeMetricsMap(e,t.realTimeCounters,t.featureName,t.operationName),r._purgeMetricsMap(e,t.realTimeTimers,t.featureName,t.operationName),n.resolve(t)):n.resolve(void 0)}):n.resolve(t)},e._hasAllowedFeature=function(e,t){return null!=e[t.featureName]},e._hasAllowedOperation=function(e,t){return null!=e[t.featureName][t.operationName]},e._purgeMetricsMap=function(e,t,n,o){r.filter(Object.keys(t),function(t){return-1==r.indexOf(e[n][o],t)}).forEach(function(e){delete t[e]})},e}()}),define("ubp/metrics/sentry/Sentry",["require","exports","lib/lodash","lib/bluebird","../anonymous/ForesterMetricsLogger","../../commons/localization/Locale","../../commons/messaging/clients/network/HTTPMethod","./SentryWhiteList"],function(e,t,r,n,o,i,a,s){"use strict";return function(){function e(){if(this._configuration=null,this._networkClient=null,this._timer=null,this._refreshTimerId=null,this._refreshInterval=null,this._metricsLogger=null,this._locale=null,e._instance)throw new Error("Error: Instantiation failed: Use Sentry.getInstance() instead of new.");e._instance=this}return e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.init=function(e,t){this._networkClient=e,this._timer=t},e.prototype.getTimer=function(){return this._timer},e.prototype.configure=function(t,n,o){return this._configuration=t,this._locale=n,this._refreshInterval=o||e.DEFAULT_CONFIGURATION_REFRESH_INTERVAL,this._refreshTimerId&&this._timer.clearTimeout(this._refreshTimerId),r.isEmpty(this._configuration.remoteConfigurationEndpoint)?this._configureLocal():this._configureRemote()},e.prototype._configureRemote=function(){var t=this;return n.bind(this).then(function(){return t._networkClient.request(t._configuration.remoteConfigurationEndpoint,e.NETWORK_REQUEST_CONFIGURATION)}).then(function(e){var o=r.extend({merged:!0},t._configuration,e.data);return r.isEqual(o,t._configuration)?n.resolve():(t._configuration=o,t._configureLocal())}).finally(function(){t._refreshTimerId=t._timer.setTimeout(r.bind(function(){t._configureRemote()},t),t._refreshInterval)})},e.prototype._configureLocal=function(){
return this._metricsLogger=new o(this._networkClient,this._configuration.foresterEndpoint,this._configuration.marketplaceId),n.resolve()},e.prototype.report=function(e){var t=this;return this._configuration&&this._configuration.isEnabled?n.bind(this).then(function(){var r={platformData:{locale:i[t._locale]},extensionStage:t._configuration.envStage,requestId:e.requestId,operationName:e.operationName,featureName:e.featureName,realTimeCounters:e.realTimeCounters,realTimeTimers:e.latenciesMapForRealTimeTimers};return s.purge(t._configuration.metricsWhiteList,r)}).then(function(e){return e?t._metricsLogger.report(e):n.resolve()}):n.resolve()},e.DEFAULT_CONFIGURATION_REFRESH_INTERVAL=216e5,e.RESPONSE_TYPE="json",e.MAX_ATTEMPTS=2,e.BACKOFF_FACTOR=2,e.NETWORK_TIMEOUT=3e4,e.INITIAL_RETRY_INTERVAL=1e3,e.NETWORK_REQUEST_CONFIGURATION={httpMethod:a.GET,maxAttempts:e.MAX_ATTEMPTS,responseType:e.RESPONSE_TYPE,backoffFactor:e.BACKOFF_FACTOR,timeout:e.NETWORK_TIMEOUT,initialRetryInterval:e.INITIAL_RETRY_INTERVAL},e._instance=null,e}()}),define("ubp/metrics/sentry/SentryReport",["require","exports","lib/lodash","lib/bluebird","../../commons/error/ConflictError","../../commons/error/BadRequestError","./Sentry"],function(e,t,r,n,o,i,a){"use strict";return function(){function e(e,t,n,o){this._realTimeCounters={},this._realTimeTimers={},this._timerTrackMap={},this._featureName=e,this._operationName=t,this._requestId=n,this._isValid=!0,r.isUndefined(o)?this._globalWindow="object"!=typeof window||r.isNull(window)?void 0:window:this._globalWindow=o}return Object.defineProperty(e.prototype,"requestId",{get:function(){return this._requestId},set:function(e){this._checkPublished(),this._requestId=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"operationName",{get:function(){return this._operationName},set:function(e){this._checkPublished(),this._operationName=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"featureName",{get:function(){return this._featureName},set:function(e){this._checkPublished(),this._featureName=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"realTimeTimers",{get:function(){return this._realTimeTimers},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"latenciesMapForRealTimeTimers",{get:function(){var e={};return r.forEach(this._realTimeTimers,function(t,r){e[r]=t.latencies}),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"realTimeCounters",{get:function(){return this._realTimeCounters},enumerable:!0,configurable:!0}),e.prototype.startRealTimeTimer=function(t,n){return this._checkPublished(),r.isUndefined(n)&&(n=this._getElapsedTimeSinceBrowserPageLoad()||e._getCurrentTime()),this._startTimer(t,n)},e.prototype.clearStartedRealTimeTimers=function(){var e=this._timerTrackMap;return this._timerTrackMap={},e},e.prototype._startTimer=function(e,t){if(this._timerTrackMap[e])throw new o("Timer already exists");this._timerTrackMap[e]=t},e.prototype._stopTimer=function(e,t,n){try{var i=this._timerTrackMap[e];if(!i){throw new o("Error! Trying to stop the timer that has not started yet")}var a=t-i;if(n[e]){var s=n[e];n[e].latencies.push(a);n[e].totalLatency=r.reduce(s.latencies,function(e,t){return e+t},0),n[e].numberOfInstances=s.latencies.length}else n[e]={},n[e].latencies=[],n[e].latencies.push(a),n[e].totalLatency=a,n[e].numberOfInstances=1}finally{delete this._timerTrackMap[e]}},e.prototype._setTimer=function(e,t,r,n){if(t<0||r<=0){throw new i("Error! The number of instances and/or latency of the timer ["+e+"] is invalid")}n[e]&&n[e].latencies&&n[e].latencies.splice(0,n[e].latencies.length),n[e]={},n[e].latencies=[],n[e].totalLatency=t,n[e].numberOfInstances=r,delete this._timerTrackMap[e]},e.prototype.setRealTimeTimer=function(e,t,r){return this._checkPublished(),r=r||1,this._setTimer(e,t,r,this._realTimeTimers)},e.prototype.stopRealTimeTimer=function(t,n){return this._checkPublished(),r.isUndefined(n)&&(n=this._getElapsedTimeSinceBrowserPageLoad()||e._getCurrentTime()),this._stopTimer(t,n,this._realTimeTimers)},e._getCurrentTime=function(){return(new Date).getTime()},e.prototype._incrementCounter=function(e,t,r){r[e]=(r[e]||0)+t},e.prototype.incrementRealTimeCounter=function(e,t){return void 0===t&&(t=1),this._checkPublished(),this._incrementCounter(e,t,this._realTimeCounters)},e.prototype._getElapsedTimeSinceBrowserPageLoad=function(){return this._globalWindow&&this._globalWindow.performance&&"function"==typeof this._globalWindow.performance.now?this._globalWindow.performance.now():null},e.prototype.isValid=function(){return this._isValid},e.prototype._checkPublished=function(){if(!this._isValid)throw new i("This object has already been published.")},e.prototype.publishAsync=function(){var e=this;return n.bind(this).then(function(){return e._checkPublished(),e._isValid=!1,a.getInstance().report(e)}).catch(function(t){return e._isValid=!0,n.reject(t)})},e.prototype.publish=function(){var e=this,t=a.getInstance().getTimer();if(!t&&this._globalWindow)t=this._globalWindow;else if(!t)throw new Error("Runtime doesn't support global window object and Sentry wasn't configured with Timer; unable to publish");t.setTimeout(r.bind(function(){e.publishAsync()},this),0)},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/process/ProcessManager",["require","exports","lib/lodash","lib/bluebird","../../commons/logging/Logger","../../commons/Events/Events","./HealthChecker","./ProcessState","./ProcessType","../../commons/utilities/UUID","../../commons/error/Errors","../../commons/utilities/PromiseRegistry","../../commons/specification/message/MessageType","configuration/GlobalParameters","../../metrics/sentry/SentryReport"],function(e,t,r,n,o,i,a,s,u,c,l,p,f,_,d){"use strict";return function(e){function t(r,n,i,a){void 0===a&&(a=new p);var s=e.call(this)||this;return s._processes={},s._healthCheckers={},s._killList={},s._isStarted=!1,s._hasFeatureLayerStarted=!1,s._isTOURequired=!1,t.logger=t.logger||o.getLogger("ProcessManager"),s._configurationManager=r,s._factory=n,s._runtime=i,s._creationRegistry=a,s}return __extends(t,e),t.prototype.start=function(){var e=this;if(this._isStarted){var o=new Error("This ProcessManager has already been started and can only be started once.");return t.logger.error("start",o.toString()),n.reject(o)}var i=new d("Extension","ProcessManager",c.v4()),a=new d("Extension","ProcessManagerV2",c.v4());this._isStarted=!0;var s;return n.bind(this).then(function(){return n.all([e._configurationManager.getFeatureManifestList(),e._checkIfTOUIsRequired()])}).spread(function(n,o){return s=n,e._configurationManager.registerOnFeatureManifestListUpdatedHandler(r.bind(e.onFeatureManifestListUpdated,e)),e._setupBrowserOnlineHandler(),e._runtime.putInExtensionStorage(t.TOU_REQUIRED_KEY,o.toString())}).then(function(){return t.logger.info("start","Starting Kernel layer"),e._startLayer(s.data.layers.kernel,"Kernel")}).then(function(){return t.logger.info("start","Kernel layer is stable"),e._startLayer(s.data.layers.core,"Core")}).then(function(){return t.logger.info("start","Core layer is stable"),e._runtime.getFromExtensionStorage(t.TOU_STORAGE_KEY)}).then(function(r){if(!e._isTOURequired||"true"===r)return t.logger.info("start","Starting feature layer"),e.startFeatureLayer();t.logger.info("start","User has not accepted terms of use, not starting feature layer")}).then(function(){i.incrementRealTimeCounter("Success"),a.incrementRealTimeCounter("Success"),t.logger.info("start","Process Manager completed startup")}).catch(function(e){throw i.incrementRealTimeCounter("Failure"),a.incrementRealTimeCounter("Failure"),t.logger.error("start","Process Manager encountered an error [ "+e.message+"]"),e}).finally(function(){i.publishAsync().catch(function(){t.logger.error("start","Fail to publish ProcessManager start metrics")}),a.publishAsync().catch(function(){t.logger.error("start","Fail to publish ProcessManagerV2 start metrics")})})},t.prototype.stop=function(){var e=this;return n.bind(this).then(function(){e.off(),r.each(e._creationRegistry.getPromiseNames(),function(t){e._creationRegistry.get(t).cancel()}),e._creationRegistry.clean();var t=[];return r.each(e._processes,function(r,n){t.push(e._terminateProcess(n))}),n.all(t)}).then(function(){var t=[];return r.each(e._killList,function(r,n){t.push(e._terminateProcess(n))}),e._killList={},n.all(t)}).then(function(){e._isTOURequired=!1,e._hasFeatureLayerStarted=!1,e._isStarted=!1})},t.prototype._checkIfTOUIsRequired=function(){var e=this;return n.bind(this).then(function(){return e._runtime.getFromExtensionStorage(t.TOU_REQUIRED_KEY)}).then(function(t){return e._isTOURequired="true"===t||"false"!==t&&_.getGlobalParameters().isTOURequired(),e._isTOURequired})},t.prototype.startFeatureLayer=function(){var e=this;if(!this._isStarted){var r=new Error("This ProcessManager has not been started yet.");return t.logger.error("start",r.toString()),n.reject(r)}return this._hasFeatureLayerStarted?n.reject("The feature layer has already started"):this._runtime.getFromExtensionStorage(t.TOU_STORAGE_KEY).then(function(r){if(e._isTOURequired&&"true"!==r){var n=new Error("The feature layer cannot be started because the customer hasn't accepted the terms of use.");throw t.logger.error("startFeatureLayer",n.toString()),n}return e._configurationManager.getFeatureManifestList()}).then(function(t){return e._startLayer(t.data.layers.feature,"Feature")}).then(function(){e._hasFeatureLayerStarted=!0})},t.prototype.onFeatureManifestListUpdated=function(e){var r=this;t.logger.debug("onFeatureManifestListUpdated","Got a featureManifestListDiff: "+JSON.stringify(e)),n.bind(this).then(function(){return r._updateLayerPerNewFeatureManifestListDiff(e.data.layers.kernel)}).then(function(){return r._updateLayerPerNewFeatureManifestListDiff(e.data.layers.core)}).then(function(){return r._runtime.getFromExtensionStorage(t.TOU_STORAGE_KEY)}).then(function(o){return r._isTOURequired&&"true"!==o?(t.logger.info("onFeatureManifestListUpdated","TOU is not accepted by user yet, not starting feature layer"),n.resolve()):r._updateLayerPerNewFeatureManifestListDiff(e.data.layers.feature)}).then(function(){t.logger.info("onFeatureManifestListUpdated","Updated all processes per new manifest list"),r.notify(t.PROCESSES_UPDATED_EVENT_NAME)}).catch(function(e){throw t.logger.error("onFeatureManifestListUpdated","Failed to update some or all processes with the new feature manifest changes, error: ["+e.message),e})},t.prototype._updateLayerPerNewFeatureManifestListDiff=function(e){var o=this,i=[];return r.each(e,function(e,r){try{var n=e&&e.manifest;if(n&&n.processType===u.Pseudo)return void t.logger.warn("onFeatureManifestListUpdated","Warning! Pseudo process will not get updated with the new manifest changes");if(!n||!1===n.enabled)return void i.push(o._terminateProcess(r));if(!o._processes[n.name]&&!0===n.enabled)return void i.push(o._createProcess(n.name,n));i.push(o._restartProcess(n))}catch(e){t.logger.error("onFeatureManifestListUpdated",e.message)}}),n.all(i)},t.prototype._startLayer=function(e,r){var o=this,i=new d("Extension","ProcessManagerV2.startLayer."+r,c.v4());i.startRealTimeTimer("RequestTimeSuccess"),i.startRealTimeTimer("RequestTimeFailure");var a=[];for(var s in e){var u=e[s].manifest;u.enabled&&(t.logger.info("_startLayer","Starting process '"+u.name+"' from URL: "+u.configuration.url),a.push(this._createProcess(u.name,u)))}return n.all(a).then(function(){n.bind(o).then(function(){return i.stopRealTimeTimer("RequestTimeSuccess"),i.incrementRealTimeCounter("Success"),i.incrementRealTimeCounter("Success."+_.getGlobalParameters().browser),i.publishAsync()}).catch(function(e){t.logger.error("_startLayer","Failed to publish ProcessManager success metrics: "+e.message)})}).catch(function(e){i.stopRealTimeTimer("RequestTimeFailure"),i.incrementRealTimeCounter("Failure"),i.incrementRealTimeCounter("Failure."+_.getGlobalParameters().browser),i.publishAsync().catch(function(e){t.logger.error("_startLayer","Failed to publish ProcessManager failure metrics: "+e.message)});var r=new Error("Unable to start up layer: "+e.message);throw t.logger.error("_startLayer",r.toString()),r})},t.prototype._getProcessOptions=function(){var e=this;return n.bind(this).then(function(){return e._configurationManager.getLocale()}).then(function(e){var t={locale:e};return n.resolve(t)})},t.prototype._createProcess=function(e,r,o,i){var s=this;void 0===o&&(o=t.CREATE_PROCESS_DEFAULT_DELAY),void 0===i&&(i=0);var u,l,p=new d("Extension","ProcessManager.createProcess."+r.name,c.v4()),f=new d("Extension","ProcessManagerV2.createProcess."+r.name,c.v4());p.startRealTimeTimer("RequestTimeSuccess"),p.startRealTimeTimer("RequestTimeFailure"),f.startRealTimeTimer("RequestTimeSuccess"),f.startRealTimeTimer("RequestTimeFailure");var g=n.bind(this).cancellable().then(function(){s._creationRegistry.isRegistered(r.name)&&(t.logger.debug("_createProcess","Cancelling in-progress process creation for "+r.name),s._creationRegistry.get(r.name).cancel()),t.logger.debug("_createProcess","Registering creation promise for "+r.name),s._creationRegistry.register(r.name,g)}).then(function(){return s._getProcessOptions()}).then(function(n){return t.logger.debug("_createProcess","Creating the process instance"),s._processes[e]=u=s._factory.fabricate(r,s._messageReceiver.bind(s),n),t.logger.debug("_createProcess","Setting up process event listeners"),s._processes[e].on("StateChange",s._onProcessStateChange,s),t.logger.debug("_createProcess","Starting the process"),s._processes[e].start()}).then(function(){return t.logger.debug("_createProcess","Creating a health checker for "+e),s._healthCheckers[e]=l=new a(s._processes[e],s._runtime),t.logger.debug("_createProcess","Starting the health checker for "+e),s._healthCheckers[e].start()}).then(function(){t.logger.debug("_createProcess","Deregistering the creation promise for "+r.name),s._creationRegistry.deregister(r.name,g),p.stopRealTimeTimer("RequestTimeSuccess"),p.incrementRealTimeCounter("RetryCount",i),p.incrementRealTimeCounter("Success"),p.incrementRealTimeCounter("Success."+_.getGlobalParameters().browser),f.stopRealTimeTimer("RequestTimeSuccess"),f.incrementRealTimeCounter("RetryCount",i),f.incrementRealTimeCounter("Success"),f.incrementRealTimeCounter("Success."+_.getGlobalParameters().browser)}).catch(function(n){if(s._runtime.getBrowserVersion().then(function(o){r&&r.version&&r.version&&t.logger.error("_createProcess","Failed to start process "+r.name+" "+_.getGlobalParameters().browser+o+" "+JSON.stringify(r.version)+" ("+e+"): "+n.message)}),p.stopRealTimeTimer("RequestTimeFailure"),p.incrementRealTimeCounter("Failure"),f.stopRealTimeTimer("RequestTimeFailure"),f.incrementRealTimeCounter("Failure"),r&&r.version&&r.version.revision&&(p.incrementRealTimeCounter("Failure."+r.version.revision),f.incrementRealTimeCounter("Failure."+r.version.revision)),p.incrementRealTimeCounter("Failure."+_.getGlobalParameters().browser),f.incrementRealTimeCounter("Failure."+_.getGlobalParameters().browser),s._creationRegistry.deregister(r.name,g),t._isCancellationError(n)){var a=c.v4();return s._healthCheckers[a]=l,s._processes[a]=u,s._healthCheckers[e]===l&&delete s._healthCheckers[e],s._processes[e]===u&&delete s._processes[e],s._terminateProcess(a).finally(function(){throw n})}return i++,t.logger.info("_createProcess","Retrying with retryDelay "+o),s._terminateAndStartProcess(e,r,o,i)}).finally(function(){p.publishAsync().catch(function(){t.logger.error("_createProcess","Fail to publish ProcessManager bootstrapping metrics")}),f.publishAsync().catch(function(){t.logger.error("_createProcess","Fail to publish ProcessManager bootstrapping metrics")})});return g},t.prototype._terminateAllRemoteProcesses=function(){var e=this;return t.logger.debug("_terminateAllRemoteProcesses","Terminating all remote processes"),n.bind(this).then(function(){return e._configurationManager.getFeatureManifestList()}).then(function(t){var o=[];return r.each(t.data.layers,function(t){r.each(t,function(t,r){t.manifest.processType===u.Remote&&o.push(e._terminateProcess(r))})}),n.all(o)}).then(function(){t.logger.debug("_terminateAllRemoteProcesses","Successfully terminated all remote processes")})},t.prototype._terminateProcess=function(e){var r=this;return this._processes[e]||this._healthCheckers[e]?n.bind(this).then(function(){return r._processes[e]?(delete r._killList[e],r._processes[e].setState(s.TERMINATING)):n.resolve()}).then(function(){return r._processes[e]&&r._processes[e].off(),r._healthCheckers[e]?(t.logger.debug("_terminateProcess","Terminating the healthchecker for the process "+e),r._healthCheckers[e].terminate()):n.resolve()}).then(function(){return delete r._healthCheckers[e],r._processes[e]?(t.logger.debug("_terminateProcess","Destroying the runtime process instance for "+e),r._runtime.destroyProcessInstance(r._processes[e])):n.resolve()}).catch(function(n){throw t.logger.error("_terminateProcess","Error terminating process, adding it to the kill list: "+n),r._killList[e]=r._processes[e],n}).then(function(){t.logger.debug("_terminateProcess","Deleting the final traces of "+e),delete r._processes[e]}):n.resolve()},t.prototype._restartProcess=function(e){var r,o=this;return n.bind(this).then(function(){return r=c.v4(),o._createProcess(r,e)}).then(function(){t.logger.debug("_restartProcess","Performing the hot-swap of the new process instance with the old");var n=o._processes[e.name],i=o._healthCheckers[e.name];o._processes[e.name]=o._processes[r],o._healthCheckers[e.name]=o._healthCheckers[r],o._processes[r]=n,o._healthCheckers[r]=i}).then(function(){return t.logger.debug("_restartProcess","Terminating the old process"),o._terminateProcess(r)})},t.prototype._terminateAndStartProcess=function(e,r,o,i){var a=this;void 0===i&&(i=0);var s=n.bind(this).cancellable().then(function(){a._creationRegistry.isRegistered(r.name)&&a._creationRegistry.get(r.name).cancel(),a._creationRegistry.register(r.name,s)}).then(function(){return a._terminateProcess(e)}).catch(function(r){if(t._isCancellationError(r))throw r;t.logger.error("_terminateAndStartProcess","ProcessManager._terminateAndStartProcess: Error terminating process; processName: "+e+"; error: "+r.message)}).then(function(){return a._runtime.delay(o)}).catch(function(n){throw t._isCancellationError(n)&&a._creationRegistry.deregister(r.name,s),t.logger.error("_terminateAndStartProcess","Error terminating process; processName: "+e+"; error: "+n.message),n}).then(function(){return a._creationRegistry.deregister(r.name,s),o*=2,o=o>t.CREATE_PROCESS_MAX_DELAY?t.CREATE_PROCESS_MAX_DELAY:o,a._createProcess(e,r,o,i)});return s},t.prototype._onProcessStateChange=function(e,r){var n=this;return r.getManifest().then(function(r){if(t.logger.debug("_onProcessStateChange","ProcessState changed to "+s[e]+" for process: "+r.name),e===s.UNRESPONSIVE)return n._restartProcess(r)})},t.prototype.getProcessByName=function(e){var r=this;if(!this._isStarted){var o=new Error("You must start this ProcessManager before making any method calls.");return t.logger.error("getProcessByName",o.toString()),n.reject(o)}return n.bind(this).then(function(){if(!r._processes[e])throw t.logger.error("getProcessByName","Could not find process name: "+e),l.NotFound();return r._processes[e].getState()}).then(function(n){if(n!==s.STABLE)throw t.logger.error("getProcessByName","Feature "+e+" it not in STABLE status, but is: "+s[n]),l.FeatureUnavailable("Feature it not in STABLE status, but is: "+s[n]);return r._processes[e]})},t.prototype._messageReceiver=function(e,r){var o=this;return n.bind(this).then(function(){if(!e||!e.payload)return t.logger.error("_messageReceiver","Message was malformed"),n.reject(l.BadRequest("Message was malformed"))}).then(function(){return r.getManifest()}).then(function(i){var a=e.payload,u=a.header;if(!u)return t.logger.error("_messageReceiver","Message was malformed, no header in message"),n.reject(l.BadRequest("Message was malformed, no header in message"));var c=!1;switch(u.messageType){case f.HANDSHAKE:var p=a.data,d=p.args;d&&d.namespace===i.name&&(e.replyCallback(null,{UBPHandshakeResponse:{namespace:i.name}}),r.setState(s.STABLE),c=!0);break;case f.SIGNAL:switch(u.name){case"restart":return c=!0,o._handleProcessRestartSignal(e,r,i)}}c||(e.payload.header.sourceProcessName=i.name,e.payload.header.extensionStage=_.getGlobalParameters().extensionStage,o.notify("message",e,r))})},t.prototype._handleProcessRestartSignal=function(e,r,o){var i=this;return n.bind(this).then(function(){var n=e.payload,a=n.data,s=a.args;if(!s||!s.namespace||!s.reason||void 0==s.delay||null==s.delay){var u="Could not retrieve a process-restart signal from the message; message.payload: "+e.payload;throw t.logger.error("_handleProcessRestartSignal",u),l.BadRequest(u)}if(s.namespace!==o.name){var u="A process is only allowed to restart itself; sourceProcess: "+o.name+"; requested: "+s.namespace;throw t.logger.error("_handleProcessRestartSignal",u),l.Forbidden(u)}if(i._processes[s.namespace]!==r){var u="Cannot restart the process. The process must be registered as the primary for its namespace. sourceProcess: "+o.name;throw t.logger.error("_handleProcessRestartSignal",u),l.Forbidden(u)}if(i._creationRegistry.isRegistered(o.name)){var u="Cannot restart process because a conflicting createProcess operation is currently in progress; processName: "+o.name;throw t.logger.error("_handleProcessRestartSignal",u),l.Conflict(u)}return s}).then(function(e){return t.logger.info("_handleProcessRestartSignal","Initiating process restart; processName: "+o.name+"; delay: "+e.delay+"; reason: "+e.reason),0===e.delay?i._restartProcess(o):i._terminateAndStartProcess(o.name,o,e.delay)}).then(function(){t.logger.info("_handleProcessRestartSignal","Successfully restarted process: "+o.name)}).catch(function(r){t.logger.error("_handleProcessRestartSignal","Error restarting process; process: "+o.name+"; error: "+r.message),e.replyCallback(r)})},t._isCancellationError=function(e){return"CancellationError"==e.name},t.prototype._setupBrowserOnlineHandler=function(){var e=this;this._runtime.unsubscribeBrowserOnlineEvents(),this._runtime.onBrowserOnline(function(){n.bind(e).then(function(){return e._configurationManager.getFeatureManifestList()}).then(function(t){r.each(t.data.layers,function(t){r.each(t,function(t,r){e._creationRegistry.isRegistered(r)&&(e._creationRegistry.get(r).cancel(),e._createProcess(r,t.manifest))})})})})},t.CREATE_PROCESS_DEFAULT_DELAY=5e3,t.CREATE_PROCESS_MAX_DELAY=864e5,t.PROCESSES_UPDATED_EVENT_NAME="ProcessesUpdatedPerNewManifestList",t.TOU_STORAGE_KEY="ubpv2.extension.tou.acceptedTermsOfUse",t.TOU_REQUIRED_KEY="ubpv2.extension.tou.isTOURequired",t}(i)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/hub/PlatformHub",["require","exports","lib/bluebird","lib/lodash","../../commons/Events/Events","../../commons/error/Errors","../../commons/error/BaseError","../../commons/logging/Logger","../../commons/localization/Locale","../../commons/specification/message/MessageType"],function(e,t,r,n,o,i,a,s,u,c){"use strict";return function(e){function t(t,r,n,o){var i=e.call(this)||this;return i._isStarted=!1,i._configurationManager=t,i._remoteConfigurationManager=n,i._processManager=r,i._runtime=o,i._eventHandlers={},i}return __extends(t,e),t.prototype.start=function(){var e=this;if(this._isStarted){var n=new Error("This PlatformHub has already been started and can only be started once.");return t.logger.error("start",n.message),r.reject(n)}return r.bind(this).then(function(){e._processManager.on("message",e._messageReceiver,e),e._isStarted=!0}).then(function(){return e._enableExtensionFeatureIfTOUNotRequiredOrTOUAccepted()}).then(function(e){return r.resolve()})},t.prototype.stop=function(){this.off(),this._processManager.off(),this._eventHandlers={},this._isStarted=!1},t.prototype._messageReceiver=function(e,t){var n,o=this;return r.bind(this).then(function(){return t.getManifest()}).then(function(t){return n=t,o._validateMessageType(e)}).then(function(e){if(!e)throw i.BadRequest("Basic message structure was invalid")}).then(function(){return o._validatePermissions(e,t,n)}).then(function(e){if(!e)throw i.Forbidden()}).then(function(){return o._determineRouteAndDeliver(e,t,n)}).catch(function(t){o._handleMessageProcessingError(e,t)})},t.prototype._handleMessageProcessingError=function(e,r){r instanceof a?t.logger.debug("_handleMessageProcessingError","PlatformHub caught a custom error: "+JSON.stringify(r),JSON.stringify(e)):(t.logger.error("_handleMessageProcessingError","PlatformHub threw an internal error: "+JSON.stringify(r),JSON.stringify(e)),r=i.Internal(r.message||r)),e&&e.replyCallback&&e.replyCallback({name:r.getName(),message:r.getMessage(),status:r.getStatus(),cause:r.getCause()},null)},t.prototype._validateMessage=function(e){return e&&e.payload?!!e.payload.header||(t.logger.info("_validateMessage","PlatformHub received message without message header"),!1):(t.logger.info("_validateMessage","PlatformHub received message without message payload"),!1)},t.prototype._validateMessageType=function(e){var n=this;return r.bind(this).then(function(){if(!1===n._validateMessage(e))return t.logger.error("_validateMessageType","PlatformHub received malformed message"),!1;var r=e.payload,o=r.header;switch(o.messageType){case c.API:case c.EVENT:return!0;default:return t.logger.info("_validateMessageType","PlatformHub does not handle  message type [ "+o.messageType+"]"),!1}})},t.prototype._validatePermissions=function(e,n,o){var i=this;return r.bind(this).then(function(){if(!1===i._validateMessage(e))return t.logger.error("_validatePermissions","Message was malformed"),!1;var r=e.payload,n=r.header;switch(n.messageType){case c.API:var a=o.consumedAPIs,s=n.namespace,u=n.name,l=a[s].indexOf(u);if(a[s]&&l>=0)return!0;t.logger.error("_validatePermissions","Calling process does not have permissions to call "+s+"."+u,JSON.stringify(e));break;case c.EVENT:switch(n.name){case"publish":var p=r.data,f=o.providedEvents,_=p.args,d=_.eventName;if(i._isEventAllowed(d,f))return!0;t.logger.error("_validatePermissions","Calling process does not have permissions to publish event  "+d,JSON.stringify(e));break;case"subscribe":var p=r.data,g=o.consumedEvents,h=p.args,d=h.eventName;if(i._isEventAllowed(d,g))return!0;t.logger.error("_validatePermissions","Calling process does not have permissions to subscribe event  "+d,JSON.stringify(e));break;case"unsubscribe":return!0}}return t.logger.error("_validatePermissions",JSON.stringify(e)),!1}).catch(function(e){return t.logger.error("_validatePermissions","PlatformHub threw an error while validating permissions: "+JSON.stringify(e)),!1})},t.prototype._isEventAllowed=function(e,t){if(n.contains(t,e))return!0;var r=e.split("."),o=n.filter(t,function(e){return e.split(".").length===r.length});return!!n.find(o,function(e){var t=e.split(".");return void 0===n.find(t,function(e,t){return!("*"===e||e===r[t])})})},t.prototype._eventNotifyHandler=function(e){this._send(e,this._subscriberProcessName)},t.prototype._determineRouteAndDeliver=function(e,o,a){var s=this;return r.bind(this).then(function(){if(!1===s._validateMessage(e))throw t.logger.error("_determineRouteAndDeliver","Message was malformed"),i.BadRequest("Message was malformed");var r=e.payload,o=r.header;switch(o.messageType){case c.API:if(o.namespace&&"Platform"===o.namespace&&o.name&&"setLocale"===o.name)return t.logger.debug("_determineRouteAndDeliver","Got a Platform.setLocale request, calling _handleSetLocaleMessage"),s._handleSetLocaleMessage(e);if(o.namespace&&"Platform"===o.namespace&&o.name&&"getFeatureList"===o.name)return t.logger.debug("_determineRouteAndDeliver","Got a Platform.getFeatureList request, calling _handleGetFeatureListMessage"),s._handleGetFeatureListMessage(e);if(o.namespace&&"Platform"===o.namespace&&o.name&&"acceptTermsOfUse"===o.name)return t.logger.debug("_determineRouteAndDeliver","Got a Platform.acceptTermsOfUse request, calling _handleAcceptTermsOfUseMessage"),s._handleAcceptTermsOfUseMessage(e);var u=o.namespace;return s._sendAndReceive(r,u).then(function(t){e.replyCallback(null,t)});case c.EVENT:switch(o.name){case"publish":var l=r.data,p=l.args,f=p.eventName;s.notify(f,r),e.replyCallback(null,{});break;case"subscribe":var l=r.data,_=l.args,f=_.eventName;s._eventHandlers[f]=s._eventHandlers[f]||{},s._eventHandlers[f][a.name]?s.off(f,s._eventHandlers[f][a.name].eventHandler,s._eventHandlers[f][a.name].eventContext):s._eventHandlers[f][a.name]={eventHandler:n.bind(function(e){this._send(e,a.name)},s),eventContext:{_subscriberProcessName:a.name}},s.on(f,s._eventHandlers[f][a.name].eventHandler,s._eventHandlers[f][a.name].eventContext),e.replyCallback(null,{});break;case"unsubscribe":var l=r.data,d=l.args,f=d.eventName;n.isUndefined(s._eventHandlers[f])||n.isUndefined(s._eventHandlers[f][a.name])||(s.off(f,s._eventHandlers[f][a.name].eventHandler,s._eventHandlers[f][a.name].eventContext),delete s._eventHandlers[f][a.name]),e.replyCallback(null,{});break;default:throw t.logger.error("_validatePermissions","Unrecognized message name"),i.BadRequest("Unrecognized message name")}break;default:throw t.logger.error("_validatePermissions","Unrecognized message type"),i.BadRequest("Unrecognized message type")}})},t.prototype._handleGetFeatureListMessage=function(e){var t=this;return r.bind(this).then(function(){return t._configurationManager.getFeatureManifestList()}).then(function(t){var r={features:[]};n.each(t.data.layers,function(e){n.each(e,function(e,t){e.manifest.enabled&&r.features.push({name:t,providedAPIs:e.manifest.providedAPIs,providedEvents:e.manifest.providedEvents})})}),e.replyCallback(null,r)})},t.prototype._handleSetLocaleMessage=function(e){var n=this;if(!(e&&e.payload&&e.payload.data&&e.payload.data.args))throw t.logger.error("_handleSetLocaleMessage","message is malformed, unable to get locale from the message"),i.BadRequest("message is malformed, unable to get locale from the message");var o=e.payload.data.args,a=!0;return r.bind(this).then(function(){if(!u[o.locale])throw i.BadRequest("Unrecognized locale");return n._configurationManager.getLocale()}).then(function(e){if(e===o.locale)return a=!1,r.resolve();n._remoteConfigurationManager.setLocale(o.locale)}).catch(function(e){throw t.logger.error("_handleSetLocaleMessage",JSON.stringify(e)),e}).then(function(){var e={header:{messageType:c.API,name:"updatePlatformLocale",namespace:"Platform"},data:{args:{locale:o.locale}}};return n._sendAndReceive(e,"Platform")}).then(function(){return a?n._processManager._terminateAllRemoteProcesses():r.resolve()}).then(function(){return a?(n._configurationManager.setLocale(o.locale),t.logger.debug("_handleSetLocaleMessage","Updated new locale, responding to Platform.setLocale request message."),e.replyCallback(null,{}),new r(function(e){t.logger.debug("_handleSetLocaleMessage","Waiting for Process Manager to start all processes from new locale"),n._processManager.on("ProcessesUpdatedPerNewManifestList",function(){e()},n)})):(t.logger.debug("_handleSetLocaleMessage","Locale change not needed, responding to Platform.setLocale request message."),e.replyCallback(null,{}),r.resolve())}).then(function(){
t.logger.debug("_handleSetLocaleMessage","Successfully completed locale change")})},t.prototype._handleAcceptTermsOfUseMessage=function(e){var t=this;return r.bind(this).then(function(){return t._runtime.putInExtensionStorage("ubpv2.extension.tou.acceptedTermsOfUse","true")}).then(function(){return t._runtime.enableExtensionFeature()}).then(function(r){return e.replyCallback(null,{}),t._processManager.startFeatureLayer()})},t.prototype._send=function(e,t){var n=this;return r.bind(this).then(function(){return n._processManager.getProcessByName(t)}).then(function(t){return t.send(e)})},t.prototype._sendAndReceive=function(e,t){var n=this;return r.bind(this).then(function(){return n._processManager.getProcessByName(t)}).then(function(t){return t.sendAndReceive(e)})},t.prototype._enableExtensionFeatureIfTOUNotRequiredOrTOUAccepted=function(){var e=this;return r.bind(this).then(function(){return e._runtime.bulkGetFromExtensionStorage([t.IS_TOU_REQUIRED_KEY,t.ACCEPTED_TERMS_OF_USES])}).then(function(r){if(r&&("false"==r[t.IS_TOU_REQUIRED_KEY]||"true"==r[t.ACCEPTED_TERMS_OF_USES]))return e._runtime.enableExtensionFeature()})},t.IS_TOU_REQUIRED_KEY="ubpv2.extension.tou.isTOURequired",t.ACCEPTED_TERMS_OF_USES="ubpv2.extension.tou.acceptedTermsOfUse",t.logger=s.getLogger("PlatformHub"),t}(o)});var factory=function(e){var t=function(){this.initialize.apply(this,arguments)};return e.extend(t.prototype,{initialize:function(e,t){this._opts=e,this.errorDescription=t},get:function(e){if(this._opts.hasOwnProperty(e))return this._opts[e]},getOrError:function(e){if(void 0===this._opts[e]||null===this._opts[e])throw new Error("Option required but not found: "+e+"\n From: "+this.errorDescription);return this._opts[e]},getOrElse:function(e,t){return void 0===this._opts[e]||null===this._opts[e]?t:this._opts[e]},getOrElseFn:function(e,t){return void 0===this._opts[e]||null===this._opts[e]?t():this._opts[e]}}),t.fromObject=function(e,r){return new t(e||{},r||"")},t};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore")):void 0!==define&&define("bit/commons/options",["underscore"],factory);var factory=function(e,t){"use strict";var r=function(){this.initialize.apply(this,arguments)};return e.extend(r.prototype,{initialize:function(e){e=t.fromObject(e),this._handler=e.getOrError("handler")},matches:function(e){return this._handler===e},notify:function(e){this._handler(e)},dispose:function(){this._handler=null}}),r};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore"),require("bit/commons/options")):void 0!==define&&define("bit/messaging/internals/message-subscriber",["underscore","bit/commons/options"],factory);var factory=function(e,t,r){"use strict";var n=function(){this.initialize.apply(this,arguments)};return e.extend(n.prototype,{initialize:function(e){e=t.fromObject(e),this._sentinel=e.getOrError("sentinel"),this._subscribers=[]},publish:function(t,r){if(this._sentinel!==t)throw new Error("Invalid sentinel provided; cannot publish message.");e.invoke(this._subscribers,"notify",r)},subscribe:function(t){if(t){if(e.any(this._subscribers,function(e){return e.matches(t)}))throw new Error("Cannot double-subscribe to a channel.");this._subscribers.push(new r({handler:t}))}},unsubscribe:function(t){var r=0,n=e.find(this._subscribers,function(e){if(e.matches(t))return!0;r+=1});n&&(this._subscribers.splice(r,1),n.dispose())},dispose:function(){e.invoke(this._subscribers,"dispose"),this._subscribers=[]}}),n};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore"),require("bit/commons/options"),require("bit/messaging/internals/message-subscriber")):void 0!==define&&define("bit/messaging/message-channel",["underscore","bit/commons/options","bit/messaging/internals/message-subscriber"],factory);var factory=function(){return{v4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}}};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("bit/commons/uuid",[],factory);var factory=function(e,t,r){"use strict";var n={Message:function(e){return{msgId:r.v4(),mType:e.getOrError("mType"),payload:e.getOrElse("msg",null),t:Date.now()}},rpcSend:function(e){return this.Message(e)},rpcSendAndReceive:function(e){return this.Message(e)},rpcReply:function(t){return e.extend(this.Message(t),{rMsgId:t.getOrError("inReplyTo"),error:t.getOrElse("error",null)})},localDispatch:function(t){return e.extend(this.Message(t),{oMsgId:t.getOrError("originalMsgId"),replyCallback:t.getOrError("replyCallback")})}},o=function(){this.initialize.apply(this,arguments)};return e.extend(o.prototype,{initialize:function(e){}}),o.createMessage=function(e){return e=t.fromObject(e),n[e.getOrError("mType")](e)},o};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore"),require("bit/commons/options"),require("bit/commons/uuid")):void 0!==define&&define("bit/messaging/message-factory",["underscore","bit/commons/options","bit/commons/uuid"],factory);var factory=function(e){var t=function(){this.initialize.apply(this,arguments)};return e.extend(t.prototype,{initialize:function(e){this._isSet=!1,this._val=null,void 0!==e&&this._set(e)},get:function(){if(!this._isSet)throw new Error("Requested future before underlying value was set.");return this._val},getOrElse:function(e){return this._isSet?this._val:e},set:function(e){this._set(e)},isSet:function(){return this._isSet},_set:function(e){this._isSet=!0,this._val=e}}),t};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore")):void 0!==define&&define("bit/commons/simple-future",["underscore"],factory);var factory=function(e,t){var r=function(){};r.prototype={noop:function(){},partiallyApply:function(){var t=e.toArray(arguments),r=t.shift();return function(){var n=e.toArray(arguments);return r.apply(null,t.concat(n))}},params:function(e){return new n(e)},returns:function(e,t){return function(r){if(r)return void t(r);t(null,e)}},cbOnErr:function(e,t){return e=e||this.noop,!!t&&(e(t),!0)},doThrow:function(e){throw e},future:function(e){return new t(e)},pojoKlass:function(t,r){t=t||[],r=r||{};var n=function(){this.initialize.apply(this,arguments)},o=function(){var r=e.toArray(arguments);e.each(t,e.bind(function(e,t){this["_"+e]=r[t]},this))};return n.prototype.initialize=o,e.each(t,function(e){var t="_"+e,r=function(){return this[t]};n.prototype[e]=r}),r.setters&&e.each(t,function(e){var t="_"+e,r="set"+e.charAt(0).toUpperCase()+e.substr(1),o=function(e){this[t]=e};n.prototype[r]=o}),n}};var n=function(){this.initialize.apply(this,arguments)};return e.extend(n.prototype,{initialize:function(e){if(!e)throw new Error("Invalid target provided for scoped require");this._target=e},req:function(e,t){if(!e)throw new Error("Invalid attribute provided");if(t=t||"Attribute required but missing: `"+e+"'",void 0===this._target[e]||null===this._target[e])throw new Error(t);return this}}),new r};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore"),require("bit/commons/simple-future")):void 0!==define&&define("bit/commons/lang",["underscore","bit/commons/simple-future"],factory);var factory=function(e,t){"use strict";return{scheduleTask:function(e,r){if(e=e||t.noop,r=r||1,"undefined"!=typeof setTimeout)return setTimeout(e,r);throw new Error("Don't know who to delegate task to!")},cancelTask:function(e){if("undefined"!=typeof setTimeout)return clearTimeout(e);throw new Error("Don't know who to delegate cancel to!")}}};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore"),require("bit/commons/lang")):void 0!==define&&define("bit/commons/task-manager",["underscore","bit/commons/lang"],factory);var factory=function(e,t,r){"use strict";var n=function(){this.initialize.apply(this,arguments)};e.extend(n.prototype,{initialize:function(r){r=t.fromObject(r),this._owner=r.getOrError("owner"),this._key=r.getOrError("key"),this._timeout=r.getOrError("timeout"),this._lastAccess=null,this._expiryRequested=!1,this._disposed=!1,this.touch(),e.bindAll(this,"_checkExpired"),this._scheduleExpiryCheck()},setValue:function(e){this.touch(),this._value=e},value:function(){return this.touch(),this._value},touchlessValue:function(){return this._value},touch:function(){this._lastAccess=Date.now()},dispose:function(){this._disposed=!0,this._value=null,this._owner=null,this._key=null},isExpired:function(){return this._expiryRequested||Date.now()-this._lastAccess>this._timeout},_requestExpiry:function(){this._expiryRequested=!0,this._key&&this._owner._requestExpiry(this._key,this)},_scheduleExpiryCheck:function(){r.scheduleTask(this._checkExpired,850)},_checkExpired:function(){this._disposed||(this.isExpired()?this._requestExpiry():r.scheduleTask(this._checkExpired,850))}});var o=function(){this.initialize.apply(this,arguments)};return e.extend(o.prototype,{initialize:function(e){e=t.fromObject(e),this._timeout=e.getOrElse("timeout",5e3),this._onTimeout=e.getOrElse("onTimeout",function(){}),this._hash={},this._disposed=!1},dispose:function(){this._disposed||(this._hash&&(e.each(this._hash,function(e){e.dispose()}),this._hash=null),this._disposed=!0)},_checkNotDisposed:function(){if(this._disposed)throw new Error("Tried to modify disposed TimeoutHash")},put:function(e,t,r){this._checkNotDisposed();var o=this._hash[e];o||(o=new n({owner:this,key:e,timeout:r||this._timeout}),this._hash[e]=o),o.setValue(t)},get:function(e){this._checkNotDisposed();var t=this._hash[e];return t?t.value():void 0},getAndRemove:function(e){this._checkNotDisposed();var t,r=this._hash[e];return r?(t=r.value(),this.remove(e),t):void 0},remove:function(e){this._checkNotDisposed();var t=this._hash[e];t&&(delete this._hash[e],t.dispose())},_requestExpiry:function(e,t){var r=t.touchlessValue();delete this._hash[e],t.dispose(),this._onTimeout(e,r)}}),o};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore"),require("bit/commons/options"),require("bit/commons/task-manager")):void 0!==define&&define("bit/commons/timeout-hash",["underscore","bit/commons/options","bit/commons/task-manager"],factory);var factory=function(e,t){"use strict";var r=function(){this.initialize.apply(this,arguments)};return e.extend(r.prototype,t.prototype),e.extend(r.prototype,{initialize:function(){t.prototype.initialize.apply(this,arguments),this._joinedChannels=[],e.bindAll(this,"_forwardDispatcher")},join:function(e){e.subscribe(this._forwardDispatcher),this._joinedChannels.push(e)},leave:function(e){var t,r=this._joinedChannels.indexOf(e);-1!==r&&(t=this._joinedChannels[r],this._joinedChannels.splice(r,1)),t&&e.unsubscribe(this._forwardDispatcher)},_forwardDispatcher:function(e){this.publish(this._sentinel,e)}}),r};"undefined"!=typeof module&&module.exports?module.exports=factory(require("underscore"),require("bit/messaging/message-channel")):void 0!==define&&define("bit/messaging/composite-message-channel",["underscore","bit/messaging/message-channel"],factory),define("ubp/commons/messaging/MessageExchange",["require","exports","lib/lodash","lib/bluebird","bit/messaging/message-channel","bit/messaging/message-factory","bit/commons/timeout-hash","bit/messaging/composite-message-channel","../error/Errors","../error/BaseError"],function(e,t,r,n,o,i,a,s,u,c){"use strict";return function(){function e(e){if(!r.isNumber(e)||r.isNaN(e))throw new Error("MessageExchange.constructor: 'timeout' argument is not a valid number.");this._ingressBus=new s({sentinel:this}),this._egressBus=new o({sentinel:this}),this._dispatchBus=new o({sentinel:this}),r.bindAll(this,"_onReplyTimeout","_receive"),this._pendingRemoteReplies=new a({timeout:e,onTimeout:this._onReplyTimeout}),this._ingressBus.subscribe(this._receive),this._disposed=!1}return e.prototype.dispose=function(){var e=this;return n.bind(this).then(function(){e._disposed||(e._ingressBus&&(e._ingressBus.dispose(),e._ingressBus=null),e._egressBus&&(e._egressBus.dispose(),e._egressBus=null),e._dispatchBus&&(e._dispatchBus.dispose(),e._dispatchBus=null),e._pendingRemoteReplies&&(e._pendingRemoteReplies.dispose(),e._pendingRemoteReplies=null),e._disposed=!0)})},e.prototype.dispatchBus=function(){return this._dispatchBus},e.prototype.egressBus=function(){return this._egressBus},e.prototype.listen=function(e){var t=this;return n.bind(this).then(function(){t._ingressBus.join(e)})},e.prototype.leave=function(e){var t=this;return n.bind(this).then(function(){t._ingressBus.leave(e)})},e.prototype.twine=function(e){var t=this;return n.bind(this).then(function(){return e.listen(t.egressBus())}).then(function(){return t.listen(e.egressBus())})},e.prototype.untwine=function(e){var t=this;return n.bind(this).then(function(){return e.leave(t.egressBus())}).then(function(){return t.leave(e.egressBus())})},e.prototype.send=function(e){var t=this;return n.bind(this).then(function(){var r=i.createMessage({mType:"rpcSend",msg:e});t._egressBus.publish(t,r)})},e.prototype.sendAndReceive=function(e,t){var o=this;return new n(function(n,a){r.isUndefined(t)||r.isNumber(t)&&!r.isNaN(t)||a(new Error("MessageExchange.sendAndReceive: 'timeout' argument is not a valid number."));var s=i.createMessage({mType:"rpcSendAndReceive",msg:e});o._pendingRemoteReplies.put(s.msgId,function(e,t){e?a(e instanceof Error||e instanceof c?e:new Error(e)):n(t)},t),o._egressBus.publish(o,s)})},e.prototype._reply=function(e,t,r){var n=i.createMessage({mType:"rpcReply",msg:r,rMsgId:e,error:t});this._egressBus.publish(this,n)},e.prototype._receive=function(e){var t="_receive_"+e.mType;this[t]&&this[t](e)},e.prototype._receive_rpcReply=function(e){var t=e.rMsgId,r=e.payload,n=e.error,o=this._pendingRemoteReplies.getAndRemove(t);if(o)if(n)if(n.status){var i=u.Auto(n.name,n.message,n.status,n.cause);o(i)}else o(u.Internal(n.message||n));else o(null,r)},e.prototype._receive_rpcSend=function(e){var t=e.payload,r=e.msgId;this._dispatchBus.publish(this,i.createMessage({mType:"localDispatch",msg:t,originalMsgId:r,replyCallback:function(){}}))},e.prototype._receive_rpcSendAndReceive=function(e){var t=this,n=e.payload,o=e.msgId,a=r.bind(function(e,r){e&&(n=null);var a=i.createMessage({mType:"rpcReply",msg:r,inReplyTo:o,error:e});t._egressBus.publish(t,a)},this);this._dispatchBus.publish(this,i.createMessage({mType:"localDispatch",msg:n,originalMsgId:o,replyCallback:a}))},e.prototype._onReplyTimeout=function(e,t){t(u.RequestTimeout())},e}()}),define("ubp/commons/messaging/BaseTransportStrategy",["require","exports","lib/bluebird","bit/messaging/message-channel","bit/messaging/composite-message-channel"],function(e,t,r,n,o){"use strict";return function(){function e(e){this._identity=e.identity,this._dispatchBus=new n({sentinel:this}),this._egressBus=new o({sentinel:this}),this._validSources=e.validSources,this._validOrigins=e.validOrigins}return e.prototype.dispatchBus=function(){return this._dispatchBus},e.prototype.forward=function(e){var t=this;return r.bind(this).then(function(){t._egressBus.join(e)})},e.prototype.bind=function(e,t){return r.resolve()},e.prototype.unbind=function(){return r.resolve()},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/messaging/PseudoTransportStrategy",["require","exports","lib/bluebird","../../commons/messaging/BaseTransportStrategy","../../commons/logging/Logger"],function(e,t,r,n,o){"use strict";return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.twine=function(e){return r.bind(this).then(function(){this._cross(e),e._cross(this)})},t.prototype._cross=function(e){if(this._twined){var r=new Error("This transport is already twined with another");throw t.logger.error("_cross",r.toString()),r}this._twined=!0,this._egressBus.subscribe(function(t){e._dispatchBus.publish(e,t)})},t.logger=o.getLogger("PseudoTransportStrategy"),t}(n)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/process/PseudoProcess",["require","exports","lib/bluebird","./ProcessState","../../commons/Events/Events","../../commons/logging/Logger","../../commons/messaging/MessageExchange","../messaging/PseudoTransportStrategy"],function(e,t,r,n,o,i,a,s){"use strict";return function(e){function t(r,o,a,s){var u=e.call(this)||this;return u._isStarted=!1,u._timeout=1e4,u._state=n.NEW,t.logger=t.logger||i.getLogger("PseudoProcess"),u._manifest=r,u._messageReceiver=o,u._frame=a,u}return __extends(t,e),t.prototype.start=function(){var e=this;if(this._isStarted){var n=new Error("This PseudoProcess has already been started and can only be started once.");throw t.logger.error("start",n.toString()),n}return r.bind(this).then(function(){return e._setupMessagingInfrastructure()}).then(function(){return e._frame.start()}).then(function(){e._isStarted=!0})},t.prototype.terminate=function(){return r.bind(this).then(function(){var e=new Error("A PseudoProcess cannot be terminated.");throw t.logger.error("terminate",e.toString()),e})},t.prototype._setupMessagingInfrastructure=function(){var e=this,t={identity:"PseudoProcess",validOrigins:["*"],validSources:["PlatformHub"]};return r.bind(this).then(function(){e._transport=new s(t),e._transport.twine(e._frame.transport())}).then(function(){return e._exchange=new a(e._timeout),e._transport.forward(e._exchange.egressBus())}).then(function(){return e._exchange.listen(e._transport.dispatchBus())}).then(function(){return e._exchange.dispatchBus().subscribe(function(t){e._messageReceiver(t,e)})})},t.prototype.send=function(e){if(!this._isStarted){var r=new Error("You must start this PseudoProcess before making any method calls.");throw t.logger.error("send",r.toString()),r}return"Gateway"===this._manifest.name&&this._frame.sendMessageToGatewayPanel(e),this._exchange.send(e)},t.prototype.sendAndReceive=function(e,r){if(!this._isStarted){var n=new Error("You must start this PseudoProcess before making any method calls.");throw t.logger.error("sendAndReceive",n.toString()),n}return this._exchange.sendAndReceive(e,r)},t.prototype.getManifest=function(){var e=this;return r.bind(this).then(function(){return e._manifest})},t.prototype.getState=function(){return r.cast(this._state)},t.prototype.setState=function(e){var t=this;return r.bind(this).then(function(){t._state!==e&&(t._state=e,t.notify("StateChange",t._state,t))})},t}(o)}),define("ubp/commons/platform/IPlatformCoreProperty",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.partner=1]="partner",e[e.programCode=2]="programCode",e[e.installationLocale=3]="installationLocale"}(r||(r={})),r}),define("ubp/extension/platform/api/BaseApiStrategy",["require","exports","lib/lodash","lib/bluebird","../../../commons/logging/Logger"],function(e,t,r,n,o){"use strict";return function(){function e(t){e._logger=e._logger||o.getLogger("BaseApiStrategy"),this._runtime=t,r.bindAll(this,"setMessageClient","execute")}return e.prototype.setMessageClient=function(e){this._client=e},e.prototype.execute=function(t){var r=new Error("exeucte() was not implemented");return e._logger.error("execute",r.message),n.reject(r)},e}()}),define("ubp/extension/storage/StorageType",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.EXTENSION_STORAGE=1]="EXTENSION_STORAGE",e[e.LOCAL_STORAGE=2]="LOCAL_STORAGE",e[e.PREFERENCES_STORAGE=3]="PREFERENCES_STORAGE",e[e.AMAZON_COM_LOCAL_STORAGE=4]="AMAZON_COM_LOCAL_STORAGE"}(r||(r={})),r}),define("ubp/extension/storage/ExtensionStorage",["require","exports","lib/bluebird","../../commons/logging/Logger","../../commons/error/BadRequestError","../../commons/error/ConflictError"],function(e,t,r,n,o,i){"use strict";return function(){function e(t){this._runtime=t,this._isStarted=!1,e.logger=e.logger||n.getLogger("ExtensionStorage")}return e.prototype.start=function(){var t=this;if(this._isStarted){var n=new i("ExtensionStorage has already started");return e.logger.error("start",n.toString()),r.reject(n)}return r.bind(this).then(function(){t._isStarted=!0})},e.prototype.get=function(t){if(!this._isStarted){var n=new i("ExtensionStorage has not started yet");return e.logger.error("get",n.toString()),r.reject(n)}if(!t){var n=new o("key is not valid or undefined");return e.logger.error("get",n.toString()),r.reject(n)}return e.logger.debug("get","Retrieving value for extension storage for key ["+t+"]"),this._runtime.getFromExtensionStorage(t)},e.prototype.bulkGet=function(t){if(!this._isStarted){var n=new i("ExtensionStorage has not started yet");return e.logger.error("bulkGet",n.toString()),r.reject(n)}if(!t){var n=new o("keys are not valid or undefined");return e.logger.error("bulkGet",n.toString()),r.reject(n)}return e.logger.debug("bulkGet","Retrieving value for extension storage for keys ["+JSON.stringify(t)+"]"),this._runtime.bulkGetFromExtensionStorage(t)},e.prototype.set=function(t,n){var a=this;if(!this._isStarted){var s=new i("ExtensionStorage has not started yet");return e.logger.error("start",s.toString()),r.reject(s)}if(!t){var s=new o("key is not valid or undefined");return e.logger.error("set",s.toString()),r.reject(s)}var u=void 0;return r.bind(this).then(function(){return a._runtime.getFromExtensionStorage(t)}).then(function(r){return u=r,e.logger.debug("set","Setting value in extension storage for key ["+t+"] and value ["+n+"]"),a._runtime.putInExtensionStorage(t,n)}).then(function(){return u})},e.prototype.remove=function(t){var n=this;if(!this._isStarted){var a=new i("ExtensionStorage has not started yet");return e.logger.error("start",a.toString()),r.reject(a)}if(!t){var a=new o("key is not valid or undefined");return e.logger.error("set",a.toString()),r.reject(a)}e.logger.debug("remove","Deleting value from extension storage for key ["+t+"]");var s=void 0;return r.bind(this).then(function(){return n._runtime.getFromExtensionStorage(t)}).then(function(r){return s=r,e.logger.debug("remove","Deleting value from extension storage for key ["+t+"]"),n._runtime.removeFromExtensionStorage(t)}).then(function(){return s})},e}()}),define("ubp/extension/storage/LocalStorage",["require","exports","lib/bluebird","../../commons/logging/Logger","../../commons/error/BadRequestError","../../commons/error/ConflictError"],function(e,t,r,n,o,i){"use strict";return function(){function e(t){this._runtime=t,this._isStarted=!1,e.logger=e.logger||n.getLogger("LocalStorage")}return e.prototype.start=function(){var t=this;if(this._isStarted){var n=new i("LocalStorage has already started");return e.logger.error("start",n.toString()),r.reject(n)}return r.bind(this).then(function(){t._isStarted=!0})},e.prototype.get=function(t){if(!this._isStarted){var n=new i("LocalStorage has not started yet");return e.logger.error("get",n.toString()),r.reject(n)}if(!t){var n=new o("key is not valid or is undefined");return e.logger.error("get",n.toString()),r.reject(n)}return e.logger.debug("get","Retrieving value for local storage for key ["+t+"]"),this._runtime.getValueFromLocalStorage(t)},e.prototype.bulkGet=function(t){if(!this._isStarted){var n=new i("LocalStorage has not started yet");return e.logger.error("bulkGet",n.toString()),r.reject(n)}if(!t){var n=new o("keys are not valid or is undefined");return e.logger.error("bulkGet",n.toString()),r.reject(n)}return e.logger.debug("bulkGet","Retrieving values for local storage keys ["+JSON.stringify(t)+"]"),this._runtime.bulkGetFromLocalStorage(t)},e.prototype.set=function(t,n){var a=this;if(!this._isStarted){var s=new i("LocalStorage has not started yet");return e.logger.error("start",s.toString()),r.reject(s)}if(!t){var s=new o("key is not valid or is undefined");return e.logger.error("set",s.toString()),r.reject(s)}e.logger.debug("set","Setting value in local storage for key ["+t+"] and value ["+n+"]");var u=void 0;return r.bind(this).then(function(){return a._runtime.getValueFromLocalStorage(t)}).then(function(r){return u=r,e.logger.debug("remove","Storing value in local storage for key ["+t+"]"),a._runtime.setValueInLocalStorage(t,n)}).then(function(){return u})},e.prototype.remove=function(t){var n=this;if(!this._isStarted){var a=new i("LocalStorage has not started yet");return e.logger.error("start",a.toString()),r.reject(a)}if(!t){var a=new o("key is not valid or is undefined");return e.logger.error("set",a.toString()),r.reject(a)}e.logger.debug("remove","Deleting value from local storage for key ["+t+"]");var s=void 0;return r.bind(this).then(function(){return n._runtime.getValueFromLocalStorage(t)}).then(function(r){return s=r,e.logger.debug("remove","Deleting value from local storage for key ["+t+"]"),n._runtime.removeValueFromLocalStorage(t)}).then(function(){return s})},e}()}),define("ubp/extension/storage/PreferencesStorage",["require","exports","lib/bluebird","../../commons/logging/Logger","../../commons/error/BadRequestError","../../commons/error/ConflictError"],function(e,t,r,n,o,i){"use strict";return function(){function e(t){this._runtime=t,this._isStarted=!1,e.logger=e.logger||n.getLogger("PreferencesStorage")}return e.prototype.start=function(){var t=this;if(this._isStarted){var n=new i("PreferencesStorage has already started");return e.logger.error("start",n.toString()),r.reject(n)}return r.bind(this).then(function(){t._isStarted=!0})},e.prototype.get=function(t){if(!this._isStarted){var n=new i("PreferencesStorage has not started yet");return e.logger.error("get",n.toString()),r.reject(n)}if(!t){var n=new o("key is not valid or undefined");return e.logger.error("get",n.toString()),r.reject(n)}return e.logger.debug("get","Retrieving value for preference storage for key ["+t+"]"),this._runtime.getFromPreferencesStorage(t)},e.prototype.bulkGet=function(t){if(!this._isStarted){var n=new i("PreferencesStorage has not started yet");return e.logger.error("bulkGet",n.toString()),r.reject(n)}if(!t){var n=new o("keys are not valid or undefined");return e.logger.error("bulkGet",n.toString()),r.reject(n)}return e.logger.debug("bulkGet","Retrieving values for preference storage keys ["+JSON.stringify(t)+"]"),this._runtime.bulkGetFromPreferencesStorage(t)},e.prototype.set=function(t,n){var a=this;if(!this._isStarted){var s=new i("PreferencesStorage has not started yet");return e.logger.error("start",s.toString()),r.reject(s)}if(!t){var s=new o("key is not valid or undefined");return e.logger.error("set",s.toString()),r.reject(s)}var u=void 0;return r.bind(this).then(function(){return a._runtime.getFromPreferencesStorage(t)}).then(function(r){return u=r,e.logger.debug("set","Setting value in preference storage for key ["+t+"] and value ["+n+"]"),a._runtime.putInPreferencesStorage(t,n)}).then(function(){return u})},e.prototype.remove=function(t){var n=this;if(!this._isStarted){var a=new i("PreferencesStorage has not started yet");return e.logger.error("start",a.toString()),r.reject(a)}if(!t){var a=new o("key is not valid or undefined");return e.logger.error("set",a.toString()),r.reject(a)}e.logger.debug("remove","Deleting value from preference storage for key ["+t+"]");var s=void 0;return r.bind(this).then(function(){return n._runtime.getFromPreferencesStorage(t)}).then(function(r){return s=r,e.logger.debug("remove","Deleting value from preference storage for key ["+t+"]"),n._runtime.removeFromPreferencesStorage(t)}).then(function(){return s})},e}()}),define("ubp/extension/storage/AmazonComLocalStorage",["require","exports","lib/bluebird","../../commons/logging/Logger","../../commons/error/BadRequestError","../../commons/error/ConflictError"],function(e,t,r,n,o,i){"use strict";return function(){function e(t){this._runtime=t,this._isStarted=!1,e.logger=e.logger||n.getLogger("AmazonComLocalStorage")}return e.prototype.start=function(){var t=this;if(this._isStarted){var n=new i("AmazonComLocalStorage has already started");return e.logger.error("start",n.toString()),r.reject(n)}return r.bind(this).then(function(){t._isStarted=!0})},e.prototype.get=function(t){var n=this;if(!this._isStarted){var a=new i("AmazonComLocalStorage has not started yet");return e.logger.error("get",a.toString()),r.reject(a)}if(!t){var a=new o("key is not valid or is undefined");return e.logger.error("get",a.toString()),r.reject(a)}e.logger.debug("get","Retrieving value for amazon.com local storage for key ["+t+"]");var s=[];return s.push(t),r.bind(this).then(function(){return n._runtime.getFromAmazonLocalStorage(s)}).then(function(e){return e[t]})},e.prototype.bulkGet=function(t){if(!this._isStarted){var n=new i("AmazonComLocalStorage has not started yet");return e.logger.error("bulkGet",n.toString()),r.reject(n)}if(!t){var n=new o("keys are not valid or is undefined");return e.logger.error("bulkGet",n.toString()),r.reject(n)}return t.length<=0?r.resolve({}):(e.logger.debug("bulkGet","Retrieving value for amazon.com local storage for keys ["+JSON.stringify(t)+"]"),this._runtime.getFromAmazonLocalStorage(t))},e.prototype.set=function(t,n){if(!this._isStarted){var o=new i("AmazonComLocalStorage has not started yet");return e.logger.error("set",o.toString()),r.reject(o)}return e.logger.debug("set","set operation is not supported on amazon.com local storage"),r.reject("set operation is not supported on amazon.com local storage")},e.prototype.remove=function(t){if(!this._isStarted){var n=new i("AmazonComLocalStorage has not started yet");return e.logger.error("remove",n.toString()),r.reject(n)}return e.logger.debug("remove","remove operation is not supported on amazon.com local storage"),r.reject("remove operation is not supported on amazon.com local storage")},e}()}),define("ubp/extension/storage/StorageManager",["require","exports","lib/bluebird","./StorageType","../../commons/logging/Logger","../../commons/error/BadRequestError","../../commons/error/ConflictError","./ExtensionStorage","./LocalStorage","./PreferencesStorage","./AmazonComLocalStorage"],function(e,t,r,n,o,i,a,s,u,c,l){"use strict";return function(){function e(){if(e._instance)throw new Error("Error: Instantiation failed: Use StorageManager.getInstance() instead of new.");e._instance=this,this._isStarted=!1,this._isInitialized=!1}return e.prototype.init=function(t){if(this._isInitialized)throw e.logger.error("init","StorageManager has already been initialized."),new a("StorageManager has already been initialized");this._isInitialized=!0,this._runtime=t,this._extensionStorage=new s(this._runtime),this._localStorage=new u(this._runtime),this._preferencesStorage=new c(this._runtime),this._amazonComLocalStorage=new l(this._runtime),e.logger=e.logger||o.getLogger("StorageManager")},e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.start=function(){var t=this;if(this._isStarted){var n=new a("StorageManger has already started");return e.logger.error("start",n.toString()),r.reject(n)}var o=[];return r.bind(this).then(function(){return o.push(t._extensionStorage.start()),o.push(t._localStorage.start()),o.push(t._amazonComLocalStorage.start()),o.push(t._preferencesStorage.start()),r.all(o)}).then(function(e){t._isStarted=!0})},e.prototype.get=function(t,o){var s=this;if(!this._isStarted){var u=new a("StorageManger has not started yet");return e.logger.error("get",u.toString()),r.reject(u)}if(!o){var u=new i("key is not valid or undefined");return e.logger.error("get",u.toString()),r.reject(u)}
return r.bind(this).then(function(){switch(t){case n.LOCAL_STORAGE:return s._localStorage.get(o);case n.EXTENSION_STORAGE:return s._extensionStorage.get(o);case n.PREFERENCES_STORAGE:return s._preferencesStorage.get(o);case n.AMAZON_COM_LOCAL_STORAGE:return s._amazonComLocalStorage.get(o);default:var r=new i("storage type is not recognized");throw e.logger.error("get",r.toString()),r}})},e.prototype.bulkGet=function(t,o){var s=this;if(!this._isStarted){var u=new a("StorageManger has not started yet");return e.logger.error("bulkGet",u.toString()),r.reject(u)}if(!o){var u=new i("keys are not valid or undefined");return e.logger.error("bulkGet",u.toString()),r.reject(u)}return r.bind(this).then(function(){switch(t){case n.LOCAL_STORAGE:return s._localStorage.bulkGet(o);case n.EXTENSION_STORAGE:return s._extensionStorage.bulkGet(o);case n.PREFERENCES_STORAGE:return s._preferencesStorage.bulkGet(o);case n.AMAZON_COM_LOCAL_STORAGE:return s._amazonComLocalStorage.bulkGet(o);default:var r=new i("storage type is not recognized");throw e.logger.error("bulkGet",r.toString()),r}})},e.prototype.set=function(t,o,s){var u=this;if(!this._isStarted){var c=new a("StorageManger has not started yet");return e.logger.error("set",c.toString()),r.reject(c)}if(!o){var c=new i("key is not valid or undefined");return e.logger.error("set",c.toString()),r.reject(c)}return r.bind(this).then(function(){switch(t){case n.LOCAL_STORAGE:return u._localStorage.set(o,s);case n.EXTENSION_STORAGE:return u._extensionStorage.set(o,s);case n.PREFERENCES_STORAGE:return u._preferencesStorage.set(o,s);case n.AMAZON_COM_LOCAL_STORAGE:return u._amazonComLocalStorage.set(o,s);default:var r=new i("storage type is not recognized");throw e.logger.error("set",r.toString()),r}})},e.prototype.remove=function(t,o){var s=this;if(!this._isStarted){var u=new a("StorageManger has not started yet");return e.logger.error("remove",u.toString()),r.reject(u)}if(!o){var u=new i("key is not valid or undefined");return e.logger.error("set",u.toString()),r.reject(u)}return r.bind(this).then(function(){switch(t){case n.LOCAL_STORAGE:return s._localStorage.remove(o);case n.EXTENSION_STORAGE:return s._extensionStorage.remove(o);case n.PREFERENCES_STORAGE:return s._preferencesStorage.remove(o);case n.AMAZON_COM_LOCAL_STORAGE:return s._amazonComLocalStorage.remove(o);default:var r=new i("storage type is not recognized");throw e.logger.error("set",r.toString()),r}})},e.prototype.stop=function(){this._runtime=void 0,this._extensionStorage=void 0,this._localStorage=void 0,this._preferencesStorage=void 0,this._amazonComLocalStorage=void 0,this._isInitialized=!1,this._isStarted=!1},e._instance=null,e}()}),define("ubp/commons/stage/ExtensionStage",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.DEV=1]="DEV",e[e.BETA=2]="BETA",e[e.GAMMA=3]="GAMMA",e[e.PROD=4]="PROD"}(r||(r={})),r}),define("ubp/commons/i18n/LanguageTag",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.en_US=1]="en_US",e[e.en_CA=2]="en_CA",e[e.en_GB=3]="en_GB",e[e.ja_JP=4]="ja_JP",e[e.zh_CN=5]="zh_CN",e[e.de_DE=6]="de_DE",e[e.it_IT=7]="it_IT",e[e.fr_FR=8]="fr_FR",e[e.es_ES=9]="es_ES",e[e.en_IN=10]="en_IN",e[e.es_MX=11]="es_MX",e[e.pt_BR=12]="pt_BR",e[e.en_AU=13]="en_AU",e[e.en_AE=14]="en_AE",e[e.tr_TR=15]="tr_TR"}(r||(r={})),r}),define("ubp/commons/i18n/CurrencyCode",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.USD=1]="USD",e[e.CAD=2]="CAD",e[e.GBP=3]="GBP",e[e.JPY=4]="JPY",e[e.CNY=5]="CNY",e[e.EUR=6]="EUR",e[e.INR=7]="INR",e[e.MXN=8]="MXN",e[e.BRL=9]="BRL",e[e.AUD=10]="AUD",e[e.AED=11]="AED",e[e.TRY=12]="TRY"}(r||(r={})),r}),define("ubp/commons/i18n/I18NPreferences",["require","exports","../localization/Locale","../stage/ExtensionStage","./LanguageTag","./CurrencyCode","../logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(){function e(){this._defaultLanguageTagMap={US:o.en_US,CA:o.en_CA,UK:o.en_GB,JP:o.ja_JP,CN:o.zh_CN,DE:o.de_DE,IT:o.it_IT,FR:o.fr_FR,ES:o.es_ES,IN:o.en_IN,MX:o.es_MX,BR:o.pt_BR,AU:o.en_AU,AE:o.en_AE,TR:o.tr_TR},this._defaultCurrencyCodeMap={US:i.USD,CA:i.CAD,UK:i.GBP,JP:i.JPY,CN:i.CNY,DE:i.EUR,IT:i.EUR,FR:i.EUR,ES:i.EUR,IN:i.INR,MX:i.MXN,BR:i.BRL,AU:i.AUD,AE:i.AED,TR:i.TRY},this._logger=a.getLogger("I18NPreferences")}return e.prototype.getDefaultLanguageTag=function(e){var t=this._defaultLanguageTagMap[r[e]];return t||(t=o.en_US,this._logger.error("getDefaultLanguageTag","Unable to get default language tag, invalid locale provided: "+r[e])),t},e.prototype.getDefaultCurrencyCode=function(e){var t=this._defaultCurrencyCodeMap[r[e]];return t||(t=i.USD,this._logger.error("getDefaultCurrencyCode","Unable to get default currency code, invalid locale provided: "+r[e])),t},e.prototype.getLanguageTagCookieName=function(t,o){return o&&n[o]||(o=n.PROD),t===r.US?e.LANGUAGE_TAG_COOKIE_NAME_US[n[o].toLowerCase()]:(e.LANGUAGE_TAG_COOKIE_PREFIX+r[t]).toLowerCase()},e.prototype.getCurrencyCodeCookieName=function(){return e.CURRENCY_CODE_COOKIE_NAME},e.prototype.getI18NCookieNames=function(e,t){var r=[];return r.push(this.getLanguageTagCookieName(e,t)),r.push(this.getCurrencyCodeCookieName()),r},e.CURRENCY_CODE_COOKIE_NAME="i18n-prefs",e.LANGUAGE_TAG_COOKIE_NAME_US={dev:"lc-tacbus",beta:"lc-tacbus",gamma:"lc-main",prod:"lc-main"},e.LANGUAGE_TAG_COOKIE_PREFIX="lc-acb",e}()});var factory=function(){"use strict";var e=function(){};return e.getSiteConfiguration=function(){return{version:"6-20-15",configuration:{US:{site:"https://www.amazon.com",tag:"amz-failure-catch-us-20",topLevelDomain:"amazon.com"},CA:{site:"https://www.amazon.ca",tag:"amz-failure-catch-ca-20",topLevelDomain:"amazon.ca"},UK:{site:"https://www.amazon.co.uk",tag:"amz-failure-catch-uk-21",topLevelDomain:"amazon.co.uk"},DE:{site:"https://www.amazon.de",tag:"amz-failure-catch-de-21",topLevelDomain:"amazon.de"},FR:{site:"https://www.amazon.fr",tag:"amz-failure-catch-fr-21",topLevelDomain:"amazon.fr"},IT:{site:"https://www.amazon.it",tag:"amz-failure-catch-it-21",topLevelDomain:"amazon.it"},JP:{site:"https://www.amazon.co.jp",tag:"amz-failure-catch-jp-22",topLevelDomain:"amazon.co.jp"},CN:{site:"https://www.amazon.cn",tag:"amz-failure-catch-cn-23",topLevelDomain:"amazon.cn"},ES:{site:"https://www.amazon.es",tag:"amz-failure-catch-es-21",topLevelDomain:"amazon.es"},IN:{site:"https://www.amazon.in",tag:"amz-failure-catch-in-21",topLevelDomain:"amazon.in"},MX:{site:"https://www.amazon.com.mx",tag:"amz-failure-catch-mx-20",topLevelDomain:"amazon.com.mx"},AE:{site:"https://www.amazon.ae",tag:"amz-failure-catch-ae-21",topLevelDomain:"amazon.ae"},TR:{site:"https://www.amazon.com.tr",tag:"amz-failure-catch-tr-21",topLevelDomain:"amazon.com.tr"},BR:{site:"https://www.amazon.com.br",tag:"amz-failure-catch-br-20",topLevelDomain:"amazon.com.br"},AU:{site:"https://www.amazon.com.au",tag:"amz-failure-catch-au-22",topLevelDomain:"amazon.com.au"}}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/SiteConfiguration",[],factory);var factory=function(){"use strict";var e=function(){};return e.getContextMenuConfiguration=function(){return{createContextMenu:{maxContextMenuItemsPerExtension:3,maxContextMenuItemsPerProcess:1}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/ContextMenuConfiguration",[],factory),define("ubp/extension/platform/api/platform/PlatformApiQuery",["require","exports","lib/lodash","../../../../commons/logging/Logger"],function(e,t,r,n){"use strict";return function(){function e(e){this._runtime=e}return e.prototype.getSupportedApiList=function(t,n,o){var i=this;this._platformApiConfig=this._runtime.getRemoteConfigurationRawData(e._PLATFORM_API_CONFIG_KEY);var a={};return r.forEach(e._REMOTE_CONFIGURATION_SUPPORTED_API,function(e){a[e]=i._isApiSupported(e,t,n,o)}),r.assign(a,e._DEFAULT_PLATFORM_API_LIST),a},e.prototype._isApiSupported=function(e,t,r,n){if(t&&r&&n&&this._platformApiConfig&&this._platformApiConfig[e]){var o=this._platformApiConfig[e];return!!o.isSupported&&this._isVersion1GreaterThanVersion2(r,o.minBrowserVersion)&&this._isVersion1GreaterThanVersion2(n,o.minExtensionVersion)}return!1},e.prototype._isVersion1GreaterThanVersion2=function(e,t){var r,n,o=/[\d\.]*\d/;if(!o.test(e)||!o.test(t))return!1;var i=/(\.[0]+)+$/,a=e.replace(i,"").split("."),s=t.replace(i,"").split("."),u=Math.min(a.length,s.length);for(r=0;r<u;r++)if(0!==(n=parseInt(a[r],10)-parseInt(s[r],10)))return n>0;return a.length-s.length>=0},e.logger=n.getLogger("PlatformApiQuery"),e._DEFAULT_PLATFORM_API_LIST={openNewTab:!0,renderButtonText:!0,getPlatformInfo:!0,setPlatformCoreInfo:!0,clearPlatformInfoCache:!0,updatePlatformLocale:!0,handleLegacyExternalMessage:!0,getActiveTabInfo:!0,isTOUAccepted:!0,createSandbox:!0,createLocalSandbox:!0,modifySandbox:!0,sendMessageToSandbox:!0,destroySandbox:!0,scrape:!0,listenerSpecificationScrape:!0,registerAction:!0,deregisterAction:!0,applyStyle:!0,resetStyle:!0,getStorageValue:!0,putStorageValue:!0,deleteStorageValue:!0,getPageReferrer:!0,getPagePerformanceTimingData:!0,getPageLocationData:!0,getPageDimensionData:!0,getUWLItem:!0,closePanel:!0,reloadExtension:!0,setLocale:!0,getFeatureList:!0,acceptTermsOfUse:!0,setSmileMode:!0,getCookieInfo:!0,bulkGetCookieInfo:!0},e._REMOTE_CONFIGURATION_SUPPORTED_API=["createDesktopNotification","getBrowserRecSettings","registerWhitelist","updateBrowserRecSettings","createContextMenuItem","deleteAllContextMenuItems","deleteContextMenuItemById"],e._PLATFORM_API_CONFIG_KEY="PlatformApiConfiguration",e}()}),define("ubp/commons/contextmenu/ContextmenuTypes",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.normal="normal"]="normal",e[e.checkbox="checkbox"]="checkbox",e[e.radio="radio"]="radio",e[e.separator="separator"]="separator"}(r||(r={})),r}),define("ubp/commons/contextmenu/ContextmenuContentTypes",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.all="all"]="all",e[e.page="page"]="page",e[e.frame="frame"]="frame",e[e.selection="selection"]="selection",e[e.link="link"]="link",e[e.editable="editable"]="editable",e[e.image="image"]="image",e[e.video="video"]="video",e[e.audio="audio"]="audio",e[e.launcher="launcher"]="launcher",e[e.browser_action="browser_action"]="browser_action",e[e.page_action="page_action"]="page_action"}(r||(r={})),r}),define("ubp/extension/platform/api/ContextMenuValidator",["require","exports","lib/lodash","../../../commons/contextmenu/ContextmenuTypes","../../../commons/contextmenu/ContextmenuContentTypes","../../../commons/error/Errors","../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(){function e(t){this.contextMenuLimitPerProcess=t,e.contextMenuValidationLogger=e.contextMenuValidationLogger||a.getLogger("ContextMenuValidator")}return e.prototype.validateMessageInput=function(e){e&&e.data&&e.data.args&&!r.isEmpty(e)||this._throwBadRequestError("validateMessageInput","message is invalid")},e.prototype.validateContextMenuProperties=function(t,a,s,u,c){var l;if(t.data.args.createContextMenuProperties&&t.data.args.processNamespace||this._throwBadRequestError("CreateContextMenuItem","Request to createContextMenu is not valid"),l=t.data.args.createContextMenuProperties,r.each(l.contexts,function(e){r.isUndefined(o[e])&&this._throwBadRequestError("CreateContextMenuItem","Provided contexts to create ContextMenu are incorrect")}),a&&r.isEqual(this.contextMenuLimitPerProcess,a.length)){var p=i.Internal("Platform.createContextMenuItem: Trying to create Multiple ContextMenus but only one contextMenu per Process is allowed.");throw e.contextMenuValidationLogger.error("trying to create Multiple ContextMenus but only one contextMenu per Process is allowed.",p.toString()),p}if(!c){var p=i.Internal("Platform.createContextMenuItem: DeleteAll is unsuccessful during Bootstrap");throw e.contextMenuValidationLogger.error("DeleteAll is unsuccessful during Bootstrap",p.toString()),p}if(l.type&&r.isUndefined(n[l.type])&&this._throwBadRequestError("CreateContextMenuItem","Provided type to create ContextMenu is in correct"),l.id||this._throwBadRequestError("CreateContextMenuItem","Required Id to create ContextMenu is Missing or Undefined or Empty"),l.title||this._throwBadRequestError("CreateContextMenuItem","Required Title to create ContextMenu is Missing or Undefined or Empty"),l.contexts&&!r.isEmpty(l.contexts)||this._throwBadRequestError("CreateContextMenuItem","Required contexts to create ContextMenu is empty"),u===s){var p=i.Internal("Platform.createContextMenuItem: Max contextMenuItems limit reached");throw e.contextMenuValidationLogger.error("Max contextMenuItems limit reached",p.toString()),p}},e.prototype.validateDeleteAllContextMenuArguments=function(e){e||this._throwBadRequestError("DeleteAllContextMenuArguments","processName received in DeleteAllContextMenu Items is null or empty or undefined")},e.prototype.validateDeleteContextMenuItemByIdArguments=function(e,t){t||this._throwBadRequestError("DeleteContextMenuById","received ContextmenuItemId in DeleteContexMenuById is null or empty or undefined"),e||this._throwBadRequestError("DeleteContextMenuById","received processName by DeleteContexMenuById is null or empty or undefined")},e.prototype._throwBadRequestError=function(t,r){var n="Platform : "+t+":- "+r,o=i.BadRequest(n);throw e.contextMenuValidationLogger.error(t,o.toString()),o},e}()}),define("ubp/commons/specification/primitives/Platform/Notification/DesktopNotificationType",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.Basic=1]="Basic",e[e.Image=2]="Image",e[e.Action=3]="Action",e[e.Interaction=4]="Interaction"}(r||(r={})),r}),define("ubp/extension/desktopNotification/DesktopNotificationScheduler",["require","exports","lib/lodash","lib/bluebird","../../commons/error/Errors"],function(e,t,r,n,o){"use strict";return function(){function e(e,t,r){this.POLLING_TIMER_DELAY=6e5,this.DESKTOP_NOTIFICATION_EVENT="DesktopNotificationEvent",this._notificationListController=t,this._runtime=e,this._events=r}return e.prototype._poll=function(){this.trigger(),this._pollingTimeOutHandle=this._runtime.setTimeout(r.bind(this._poll,this),this.POLLING_TIMER_DELAY)},e.prototype.start=function(){this._poll()},e.prototype.stop=function(){if(r.isUndefined(this._pollingTimeOutHandle))throw o.NotFound("Timeout handle not found");this._runtime.clearTimeout(this._pollingTimeOutHandle)},e.prototype.trigger=function(){var e=this;return n.bind(this).then(function(){for(var t;!e._notificationListController.isNotificationQueueEmpty()&&!e._notificationListController.isActiveNotificationListFull();)if(t=e._retrieveNotification(),!r.isNull(t))return e._displayNotification(t)})},e.prototype._retrieveNotification=function(){var e;return e=this._notificationListController.getNextAvailableNotification(),r.isNull(e)||this._isValidTimestamp(e.notificationSpecification)?!r.isNull(e)&&this._notificationListController.isNotificationShown(e.notificationSpecification.id)?null:e:(this._publishNotificationEvent("DesktopNotification.Error",e.notificationSpecification,"Expired"),null)},e.prototype._displayNotification=function(e){var t=this;return n.bind(this).then(function(){return t._notificationListController.makeNotificationActive(e),t._runtime.createDesktopNotification(e.notificationType,e.notificationSpecification)}).then(function(){this._publishNotificationEvent("DesktopNotification.Success",e.notificationSpecification,"Shown")}).catch(function(){this._notificationListController.removeActiveNotification(e.notificationSpecification.id),this._publishNotificationEvent("DesktopNotification.Error",e.notificationSpecification,"RuntimeError")})},e.prototype._isValidTimestamp=function(e){if(r.isUndefined(e.expiryTimestamp))return!0;var t=(new Date).getTime();return e.expiryTimestamp>t},e.prototype._publishNotificationEvent=function(e,t,r){this._events.notify(this.DESKTOP_NOTIFICATION_EVENT,{name:e,eventArgs:{notificationId:t.id,status:r,contentType:t.contentType?t.contentType:"Default"}})},e}()}),define("ubp/commons/specification/primitives/Platform/Notification/NotificationStatus",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.Created=1]="Created",e[e.Expired=2]="Expired",e[e.Queued=3]="Queued",e[e.Shown=4]="Shown"}(r||(r={})),r}),define("ubp/extension/desktopNotification/DesktopNotificationManager",["require","exports","lib/lodash","lib/bluebird","../../commons/logging/Logger","../../commons/error/Errors","../../commons/error/ConflictError","../../commons/specification/primitives/Platform/Notification/DesktopNotificationType","./DesktopNotificationScheduler","../../commons/specification/primitives/Platform/Notification/NotificationStatus"],function(e,t,r,n,o,i,a,s,u,c){"use strict";return function(){function e(e,t,n){this._isStarted=!1,this._validatorMap={Basic:this._basicNotificationValidator,Image:this._imageNotificationValidator,Action:this._actionNotificationValidator,Interaction:this._interactNotificationValidator},this._runtime=e,this._events=n,this._notificationListController=t,this._notificationScheduler=new u(e,t,n),this._runtime.registerNotificationHandler(r.bind(this._notificationCloseHandler,this)),this.start()}return e.prototype._notificationCloseHandler=function(t){this._notificationListController.markNotificationAsShown(t.eventArgs.notificationId),this._runtime.setTimeout(r.bind(this._notificationScheduler.trigger,this._notificationScheduler),e.NOTIFICATION_DELAY)},e.prototype.start=function(){if(this._isStarted){var t=new a("This DesktopNotificationManager has already been started and can only be started once.");throw e.logger.error("start",t.toString()),t}this._isStarted=!0,e.logger.info("start","DesktopNotificationManager started")},e.prototype.stop=function(){this._isStarted=!1},e.prototype.createDesktopNotification=function(e,t){var r=this;return n.bind(this).then(function(){var n={notificationType:e,notificationSpecification:t};return r._notificationListController.isNotificationQueued(n)?{id:t.id,status:c.Queued}:r._isValidNotification(e,t)?(r._notificationListController.enqueueNotification(n),r._notificationScheduler.trigger(),{id:t.id,status:c.Queued}):{id:t.id,status:c.Expired}})},e.prototype._isValidNotification=function(e,t){if(!this._isValidTimestamp(t))return this._events.notify("DesktopNotificationEvent",{name:"DesktopNotification.Error",eventArgs:{notificationId:t.id,status:"Expired",contentType:t.contentType?t.contentType:"Default"}}),!1;if(!this._validatorMap[s[e]].call(this,t))throw i.BadRequest("Notification options are invalid");return!0},e.prototype._isValidTimestamp=function(e){if(r.isUndefined(e.expiryTimestamp))return!0;var t=(new Date).getTime();return e.expiryTimestamp>t},e.prototype._basicNotificationValidator=function(e){return!!(e&&e.id&&e.title&&e.text)},e.prototype._imageNotificationValidator=function(e){return this._basicNotificationValidator(e)&&!!e.imageURL},e.prototype._actionNotificationValidator=function(e){return this._basicNotificationValidator(e)&&!!e.actions},e.prototype._interactNotificationValidator=function(e){return this._basicNotificationValidator(e)&&!!e.requireInteraction},e.NOTIFICATION_DELAY=250,e.logger=o.getLogger("DesktopNotificationManager"),e}()}),define("ubp/extension/desktopNotification/NotificationQueue",["require","exports","lib/lodash","../../commons/error/Errors"],function(e,t,r,n){"use strict";return function(){function e(t){this._queue=[],this._maxQueueSize=t&&t>0?t:e.DEFAULT_QUEUE_SIZE,this._headIndex=0,this._tailIndex=0}return e.prototype.enqueue=function(e){if((this._tailIndex+1)%this._maxQueueSize==this._headIndex)throw n.Internal("Notification Queue is full");this._queue[this._tailIndex]=e,this._tailIndex=(this._tailIndex+1)%this._maxQueueSize},e.prototype.dequeue=function(){var e;return this._headIndex==this._tailIndex?null:(e=this._queue[this._headIndex],this._headIndex=(this._headIndex+1)%this._maxQueueSize,e)},e.prototype.getQueueSize=function(){return(this._tailIndex-this._headIndex+this._maxQueueSize)%this._maxQueueSize},e.prototype.getMaxQueueSize=function(){return this._maxQueueSize},e.prototype.isQueueEmpty=function(){return this._headIndex==this._tailIndex},e.prototype.isQueued=function(e){for(var t,n=this._headIndex,o=this._tailIndex;n!==o;){if(t=this._queue[n],r.isEqual(e,t))return!0;n=(n+1)%this._maxQueueSize}return!1},e.DEFAULT_QUEUE_SIZE=100,e}()}),define("ubp/extension/desktopNotification/NotificationListController",["require","exports","lib/lodash","./NotificationQueue"],function(e,t,r,n){"use strict";return function(){function e(){this.notificationQueue=new n,this.activeNotificationList=[],this.shownNotificationList=[]}return e.prototype.isActiveNotificationListEmpty=function(){return r.isEmpty(this.activeNotificationList)},e.prototype.isActiveNotificationListFull=function(){return!(this.activeNotificationList.length<e.MAX_ACTIVE_NOTIFICATIONS)},e.prototype.isNotificationQueueEmpty=function(){return this.notificationQueue.isQueueEmpty()},e.prototype.isNotificationQueued=function(e){return this.notificationQueue.isQueued(e)},e.prototype.enqueueNotification=function(e){this.notificationQueue.enqueue(e)},e.prototype.dequeueNotification=function(){return this.notificationQueue.dequeue()},e.prototype.makeNotificationActive=function(e){return!this.isActiveNotificationListFull()&&(this.activeNotificationList.push(e.notificationSpecification.id),!0)},e.prototype.getNextAvailableNotification=function(){return this.notificationQueue.dequeue()},e.prototype.markNotificationAsShown=function(e){return!!r.contains(this.activeNotificationList,e)&&(this.shownNotificationList.push(e),this.activeNotificationList=r.without(this.activeNotificationList,e),!0)},e.prototype.isNotificationShown=function(e){return r.contains(this.shownNotificationList,e)},e.prototype.removeActiveNotification=function(e){this.activeNotificationList=r.without(this.activeNotificationList,e)},e.MAX_ACTIVE_NOTIFICATIONS=1,e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/platform/PlatformApiStrategy",["require","exports","lib/lodash","lib/bluebird","../../../../commons/platform/IPlatformCoreProperty","../BaseApiStrategy","../../../../commons/logging/Logger","../../../../commons/error/Errors","configuration/GlobalParameters","../../../storage/StorageManager","../../../storage/StorageType","../../../../commons/error/BadRequestError","../../../../commons/localization/Locale","../../../../commons/i18n/I18NPreferences","../../../../commons/i18n/LanguageTag","../../../../commons/i18n/CurrencyCode","../../../../commons/Events/Events","configuration/SiteConfiguration","configuration/ContextMenuConfiguration","./PlatformApiQuery","../../../../commons/error/InternalError","../ContextMenuValidator","../../../desktopNotification/DesktopNotificationManager","../../../desktopNotification/NotificationListController"],function(e,t,r,n,o,i,a,s,u,c,l,p,f,_,d,g,h,m,v,y,b,E,S,T){"use strict";return function(e){function t(r,n,i,s){var u=e.call(this,r)||this;return u._corePropertyToStorageKeyMap={},u._processToContextMenuItemMap={},u._contextMenuItemCount=0,u._isContextMenuItemsDeleted=!1,u._platformExposedAPIs={getPlatformInfo:u._getPlatformData,updatePlatformLocale:u._updatePlatformLocale,getActiveTabInfo:u._getActiveTabInfo,openNewTab:u._openNewTab,removeTab:u._removeTab,createDesktopNotification:u._createDesktopNotification,getCookieInfo:u._getCookieInfo,bulkGetCookieInfo:u._bulkGetCookieInfo,renderButtonText:u._renderButtonText,handleLegacyExternalMessage:u._handleLegacyExternalMessage,isTOUAccepted:u._isTOUAccepted,setPlatformCoreInfo:u._setPlatformCoreInfo,getBrowserRecSettings:u._getBrowserRecSettings,updateBrowserRecSettings:u._updateBrowserRecSettings,registerWhitelist:u._registerWhitelist,createContextMenuItem:u._createContextMenuItem,deleteAllContextMenuItems:u._deleteAllContextMenuItems,deleteContextMenuItemById:u._deleteContextMenuItemById,clearPlatformInfoCache:u._clearPlatformInfoCache,setSmileMode:u._setSmileMode},u._platformInfoRefreshFlag=!0,u._maxretries=2,u._ubpRoot="true",u._storageManager=n||c.getInstance(),u._notificationEvents=new h,u._desktopNotificationListController=new T,u._desktopNotificationManager=s||new S(r,u._desktopNotificationListController,u._notificationEvents),u._platformApiQuery=i||new y(r),t.platformApiLogger=t.platformApiLogger||a.getLogger("PlatformApiStrategy"),u._uaParser=r.getUAParser(),u._platformData=null,u._corePropertyToStorageKeyMap[o[o.partner]]=t.PARTNER_ID_STORAGE_KEY,u._corePropertyToStorageKeyMap[o[o.programCode]]=t.PROGRAM_CODE_STORAGE_KEY,u._events=new h,u._processToContextMenuItemMap={},u._contextMenuConfiguration=v.getContextMenuConfiguration(),u._maxContextMenuItems=u._contextMenuConfiguration.createContextMenu.maxContextMenuItemsPerExtension,u._contextMenuValidator=new E(u._contextMenuConfiguration.createContextMenu.maxContextMenuItemsPerProcess),u._i18nPreferences=new _,r.isContextMenuApiSupported()&&u._removeExistingContextMenus(r),u}return __extends(t,e),t.prototype.execute=function(e){var r=this;return n.bind(this).then(function(){try{return r._platformExposedAPIs[e.header.name].call(r,e)}catch(e){var n=new Error("Platform: Unable to process message, error: "+e.message);throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",n.toString()),n}})},t.prototype.registerOnPlatformDataChangeHandler=function(e){this._events.on(t._PLATFORM_DATA_CHANGE_EVENT,e)},t.prototype.registerNotificationEventHandler=function(e){this._notificationEvents.on("DesktopNotificationEvent",e)},t.prototype._getPlatformData=function(e){var r=this;return this._platformData&&!1===this._platformInfoRefreshFlag?n.resolve(this._platformData):n.bind(this).then(function(){return n.all([r._uaParser.parse(r._runtime.getUserAgent()),r._storageManager.get(l.EXTENSION_STORAGE,t.SMILE_MODE_STORAGE_KEY),r._storageManager.get(l.EXTENSION_STORAGE,t.PROGRAM_CODE_STORAGE_KEY),r._storageManager.get(l.EXTENSION_STORAGE,t.PARTNER_ID_STORAGE_KEY),r._storageManager.get(l.EXTENSION_STORAGE,t.LOCALE_STORAGE_KEY),r._storageManager.get(l.EXTENSION_STORAGE,t.LANGUAGE_TAG_STORAGE_KEY),r._storageManager.get(l.EXTENSION_STORAGE,t.CURRENCY_CODE_STORAGE_KEY),r._storageManager.get(l.EXTENSION_STORAGE,t.THIRD_PARTY_ID_STORAGE_KEY)])}).spread(function(e,n,o,i,a,s,u,c){if(n="true"===n?"Smile":"",!e){var l=new Error("Unable to parse runtime info from userAgent.");throw t.platformApiLogger.error("PlatformApiStrategy::_getPlatformData, error: ",l.toString()),l}return r._platformInfoRefreshFlag=!1,r._platformData=r._constructPlatformData(e,n,o,i,a,s,u,c)})},t.prototype._setPlatformCoreInfo=function(e){var i=this;if(e.data&&e.data.args&&e.data.args&&e.data.args&&e.data.args.hasOwnProperty("corePropertyToValueMap")&&"object"==typeof e.data.args.corePropertyToValueMap){var a=e.data.args.corePropertyToValueMap;return n.bind(this).then(function(){if(!r.every(a,function(e,t){return void 0!==o[t]})){var e=new p("Invalid arguments, one or more properties do not belong to core properties, argumens "+JSON.stringify(a));throw t.platformApiLogger.error("_setPlatformCoreInfo",e.getMessage()),e}var s=[];return r.each(a,function(e,t){s.push(i._storageManager.set(l.EXTENSION_STORAGE,i._corePropertyToStorageKeyMap[t],e))}),n.all(s)}).then(function(e){i._events.notify(t._PLATFORM_DATA_CHANGE_EVENT,t._PLATFORM_CORE_DATA_CHANGED),i._platformInfoRefreshFlag=!0,t.platformApiLogger.info("_setPlatformCoreInfo","Successfully saved core platform properties: "+JSON.stringify(a))})}var s=new p("Invalid arguments, can not update the core platform info");return t.platformApiLogger.error("_setPlatformCoreInfo",s.getMessage()),n.reject(s)},t.prototype._updatePlatformLocale=function(e){if(e.data&&e.data.args&&e.data.args.locale&&f[e.data.args.locale]){e.data.args.locale;return n.bind(this).then(function(){null===this._platformData&&(this._platformData={}),this._platformData.locale=f[e.data.args.locale],this._platformInfoRefreshFlag=!0})}var r=new p("Invalid arguments, can not update the locale");return t.platformApiLogger.error("_updatePlatformLocale",r.getMessage()),n.reject(r)},t.prototype._clearPlatformInfoCache=function(){return this._platformInfoRefreshFlag=!0,n.resolve()},t.prototype._getActiveTabInfo=function(e){return this._runtime.getActiveTabInfo()},t.prototype._createContextMenuItem=function(e){var r;return n.bind(this).then(function(){this._contextMenuValidator.validateMessageInput(e),r=e.data.args.processNamespace;var t=e.data.args.createContextMenuProperties,n=this._processToContextMenuItemMap[r];return this._contextMenuValidator.validateContextMenuProperties(e,n,this._maxContextMenuItems,this._contextMenuItemCount,this._isContextMenuItemsDeleted),this._retrieveContextMenuItemId(n,t,r)}).then(function(e){if(!e)throw t.platformApiLogger.error("_createContextMenuItem","Could not create context menu "),s.Internal("Could not create context menu ");return e}).catch(function(e){throw t.platformApiLogger.error("_createContextMenuItem","Error while creating Context Menu Item "),new b("Platform execute: Error creating ContextMenuItem "+e.toString())})},t.prototype._deleteAllContextMenuItems=function(e){return n.bind(this).then(function(){var t=this;this._contextMenuValidator.validateMessageInput(e);var o=e.data.args.processNamespace;if(this._contextMenuValidator.validateDeleteAllContextMenuArguments(o),!this._processToContextMenuItemMap[o])return n.resolve();var i=new Array;return r.each(this._processToContextMenuItemMap[o],function(e){i.push(t._deleteExistingContextMenuItem(e,o))}),n.all(i)}).catch(function(e){throw t.platformApiLogger.error("_deleteAllContextMenuItems","Error deleting one or more context menu items "),new b("Platform execute: Error deleting one or more ContextMenuItems created by this process "+e.toString())})},t.prototype._deleteContextMenuItemById=function(e){return n.bind(this).then(function(){this._contextMenuValidator.validateMessageInput(e);var t=e.data.args.processNamespace,o=e.data.args.contextMenuItemId;this._contextMenuValidator.validateDeleteContextMenuItemByIdArguments(t,o);var i=this._processToContextMenuItemMap[t];return r.include(i,o)?this._deleteExistingContextMenuItem(o,t):n.resolve()}).catch(function(e){throw t.platformApiLogger.error("_deleteContextMenuItemById","Error deleting context menu item "),new b("Platform execute: Error deleting ContextMenuItem by Id "+e.toString())})},t.prototype._openNewTab=function(e){if(e.data&&e.data.args&&e.data.args.url)return this._runtime.openNewTab(e.data.args.url).error(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",e.message||e.toString()),e});var r=new Error("Platform.openNewTab: Missed the required parameter 'url'.");throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",r.message),r},t.prototype._removeTab=function(e){if(e.data&&e.data.args&&e.data.args.tabIds){var r=e.data.args.tabIds;if("string"==typeof r)r=this._parseStringToNumber(r);else{if(!Array.isArray(r))throw"Parameter TabId should be String or Array of Strings";r=r.map(this._parseStringToNumber)}return this._runtime.removeTab(r).catch(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::removeTab, error: ",e.message||e.toString()),e})}var n=new Error("Platform.removeTab: Missed the required parameter 'tabIds'.");throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",n.message),n},t.prototype._createDesktopNotification=function(e){var r=this;return n.bind(this).then(function(){
if(e&&e.data&&e.data.args&&e.data.args.notificationSpecification&&e.data.args.notificationType)return r._desktopNotificationManager.createDesktopNotification(e.data.args.notificationType,e.data.args.notificationSpecification);throw s.BadRequest("Platform.createDesktopNotification: Missed the required parameters 'notificationSpecification & notificationType'.")}).catch(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::_createDesktopNotification",e.toString()),e})},t.prototype._getCookieInfo=function(e){var r=this;return n.bind(this).then(function(){if(e&&e.data&&e.data.args&&e.data.args.cookieName&&e.data.args.url)return r._runtime.getCookieInfo(e.data.args.cookieName,e.data.args.url);throw s.BadRequest("Platform.getCookieInfo: Missed the required parameters 'name' and/or 'url. Input - "+JSON.stringify(e))}).catch(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::getCookieInfo",e.toString()),e})},t.prototype._bulkGetCookieInfo=function(e){var r=this;return n.bind(this).then(function(){if(e&&e.data&&e.data.args&&e.data.args.cookieNames&&e.data.args.url)return r._runtime.bulkGetCookieInfo(e.data.args.cookieNames,e.data.args.url);throw s.BadRequest("Platform.bulkGetCookieInfo: Missed the required parameters 'cookieNames' and/or 'url. Input - "+JSON.stringify(e))}).catch(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::bulkGetCookieInfo",e.toString()),e})},t.prototype._registerWhitelist=function(e){var r=this;return n.bind(this).then(function(){if(e&&e.data&&e.data.args&&e.data.args.domains)return r._runtime.registerWhitelist(e.data.args.domains);throw s.BadRequest("Platform.registerWhitelist: Missed the required parameters 'domains'.")}).catch(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::_registerWhitelist",e.toString()),e})},t.prototype._renderButtonText=function(e){return n.bind(this).then(function(){if(e.data&&e.data.args&&e.data.args&&e.data.args&&e.data.args.hasOwnProperty("value"))return this._runtime.renderButtonText(e.data.args.value).error(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",e.message||e.toString()),e});var r=new Error("Platform.renderButtonCounter: Missed the required parameter 'value'.");throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",r.message),r})},t.prototype._constructPlatformData=function(e,n,o,i,a,s,c,l){var p=u.getGlobalParameters(),_=a||"us";_=_.toUpperCase();var h=m.getSiteConfiguration().configuration;(r.isUndefined(h[_])||r.isUndefined(h[_].site))&&(_="US");var v,y=h[_].site,b=h[_].tag,E=d[this._i18nPreferences.getDefaultLanguageTag(f[_])],S=g[this._i18nPreferences.getDefaultCurrencyCode(f[_])],T=p.browser||e.browser||"DEFAULT",x=e.browserVersion||"DEFAULT";try{v=this._platformApiQuery.getSupportedApiList(T,x,this._runtime.getExtensionVersion())}catch(e){v=t._DEFAULT_SUPPORTED_API_LIST,t.platformApiLogger.error("PlatformApiStrategy::_constructPlatformData, error: ",e.toString())}return{browserVersion:x,partner:i||p.partner||"amazon1",programCode:o||"org",operatingSystem:e.operatingSystem||"DEFAULT",device:e.device||"DEFAULT",browser:T,locale:a||"us",languageTag:s||E,currencyCode:c||S,modes:n||"NoMode",extensionVersion:this._runtime.getExtensionVersion(),extensionResourceURL:this._runtime.getExtensionResourceURL(),extensionGeneration:"1",userAgent:e.userAgent,extensionStage:p.extensionStage||"DEFAULT",fallbackSite:y,fallbackTag:b,thirdPartyId:l||"",supportedFeatureList:v}},t.prototype._handleLegacyExternalMessage=function(e){var r=this,o=t._SMILE_MODE_NO_CHANGE;return n.bind(this).then(function(){if("Sandbox.Message.Options_getOption"===e.name&&e.eventArgs.data&&e.eventArgs.data.options&&"ubp_root"===e.eventArgs.data.options.name)return n.cast(r._ubpRoot);if("Sandbox.Message.Mode_isModeEnabled"===e.name&&e.eventArgs.data&&e.eventArgs.data.options&&"smile"===e.eventArgs.data.options.mode)return r._retrieveSmileModeFromStorage();if("Sandbox.Message.Mode_enable"===e.name&&e.eventArgs.data&&e.eventArgs.data.options&&"smile"===e.eventArgs.data.options.mode)return r._platformInfoRefreshFlag=!0,o=t._SMILE_MODE_ENABLED,r._storeSmileModeInStorage(!0);if("Sandbox.Message.Mode_disable"===e.name&&e.eventArgs.data&&e.eventArgs.data.options&&"smile"===e.eventArgs.data.options.mode)return r._platformInfoRefreshFlag=!0,o=t._SMILE_MODE_DISABLED,r._storeSmileModeInStorage(!1);throw s.BadRequest("Unsupported legacy message type")}).then(function(n){o!==t._SMILE_MODE_NO_CHANGE&&r._events.notify(t._PLATFORM_DATA_CHANGE_EVENT,o);var i={UBPMessageType:"UBPMessageResponse",id:e.eventArgs.data&&e.eventArgs.data.id};return i.value=n,r._runtime.sendMessage(e.eventArgs.tabId,e.eventArgs.workerId,i)})},t.prototype._storeSmileModeInStorage=function(e){var r=this,o=e?"true":"false";return n.bind(this).then(function(){return r._storageManager.set(l.EXTENSION_STORAGE,t.SMILE_MODE_STORAGE_KEY,o)}).then(function(e){return o})},t.prototype._retrieveSmileModeFromStorage=function(){var e=this;return n.bind(this).then(function(){return e._storageManager.get(l.EXTENSION_STORAGE,t.SMILE_MODE_STORAGE_KEY)}).then(function(e){return"true"===e?"true":"false"})},t.prototype._isTOUAccepted=function(){var e=this;return n.bind(this).then(function(){return e._storageManager.get(l.EXTENSION_STORAGE,t._TOU_STORAGE_KEY)}).then(function(e){return!("false"===e)})},t.prototype._setSmileMode=function(e){return n.bind(this).then(function(){var r=this;if(e.data&&e.data.args&&void 0!=e.data.args.mode&&"boolean"==typeof e.data.args.mode)return this._storeSmileModeInStorage(e.data.args.mode).then(function(o){return r._platformInfoRefreshFlag=!0,r._events.notify(t._PLATFORM_DATA_CHANGE_EVENT,e.data.args.mode?t._SMILE_MODE_ENABLED:t._SMILE_MODE_DISABLED),n.resolve()});var o=new Error("Platform.setSmileMode: Missed the required parameter 'mode'.");throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",o.message),o})},t.prototype._getBrowserRecSettings=function(){var e=this;return n.bind(this).then(function(){return e._buildRecSettingsDependencies()}).then(function(t){return e._runtime.getBrowserRecSettings(t)})},t.prototype._updateBrowserRecSettings=function(e){var r=this;return n.bind(this).then(function(){return r._buildRecSettingsDependencies()}).then(function(n){if(e&&e.data&&e.data.args&&e.data.args.settingsMap)return r._runtime.updateBrowserRecSettings(e.data.args.settingsMap,n).catch(function(e){throw t.platformApiLogger.error("PlatformApiStrategy::updateBrowserRecSettings, error: ",e.toString()),e});var o=new b("Platform.updateBrowserRecSettings: Missed the required parameter settingsList.");throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",o.toString()),o})},t.prototype._storeContextMenuId=function(e,t){try{r.isUndefined(this._processToContextMenuItemMap[e])&&(this._processToContextMenuItemMap[e]=new Array),this._processToContextMenuItemMap[e].push(t)}catch(e){this._runtime.deleteContextMenuItemById(t)}},t.prototype._retrieveContextMenuItemId=function(e,t,o){var i=this;return n.bind(this).then(function(){return r.include(e,t.id)?n.resolve(t.id):i._createNewContextMenuItem(t,o)})},t.prototype._buildRecSettingsDependencies=function(){var e=this;return n.bind(this).then(function(){return e._getPlatformData()}).then(function(e){return{locale:e.locale}})},t.prototype._createNewContextMenuItem=function(e,t){var r=this;return n.bind(this).then(function(){return r._runtime.createContextMenuItem(e)}).then(function(e){return r._storeContextMenuId(t,e),r._contextMenuItemCount++,e})},t.prototype._deleteExistingContextMenuItem=function(e,t){var n=this,o=this._processToContextMenuItemMap[t];return this._runtime.deleteContextMenuItemById(e).then(function(){r.pull(o,e),n._contextMenuItemCount--})},t.prototype._removeExistingContextMenus=function(e){var r=this,n=t.RETRY_REMOVE_CONTEXTMENU_DELAY;e.deleteAllContextMenuItems().then(function(){r._isContextMenuItemsDeleted=!0}).catch(function(o){if(!(--r._maxretries>0))throw t.platformApiLogger.error("Error deleting existing context Menus",o.message),s.Internal("Error deleting existing context Menus "+o.toString());e.setTimeout(r._removeExistingContextMenus(e),n,"deleteAllContextMenus")})},t.prototype._parseStringToNumber=function(e){if("string"!=typeof e){var n=new Error("Platform.removeTab: Parameter TabIds should be String or Array of Strings.");throw t.platformApiLogger.error("PlatformApiStrategy::execute, error: ",n.message),n}var o=Number(e);if(r.isNaN(o))throw Error("Platform.removeTab: Error Parsing String to Number");return o},t.SMILE_MODE_STORAGE_KEY="ubpv2.extension.smile.mode",t.PROGRAM_CODE_STORAGE_KEY="ubpv2.extension.programCode",t.PARTNER_ID_STORAGE_KEY="ubpv2.extension.partnerId",t.LOCALE_STORAGE_KEY="ubpv2.extension.installation.locale",t.LANGUAGE_TAG_STORAGE_KEY="ubpv2.Identity.installation.languageTag",t.CURRENCY_CODE_STORAGE_KEY="ubpv2.Identity.installation.currencyCode",t.THIRD_PARTY_ID_STORAGE_KEY="ubpv2.extension.thirdPartyId",t._TOU_STORAGE_KEY="ubpv2.extension.tou.acceptedTermsOfUse",t._PLATFORM_DATA_CHANGE_EVENT="platformDataChanged",t._PLATFORM_CORE_DATA_CHANGED="platformCoreDataChanged",t._SMILE_MODE_ENABLED="smile.enable",t._SMILE_MODE_DISABLED="smile.disable",t._SMILE_MODE_NO_CHANGE="smile.none",t._DEFAULT_SUPPORTED_API_LIST={},t.RETRY_REMOVE_CONTEXTMENU_DELAY=6e5,t}(i)}),define("ubp/extension/contextual/peer-controllers/ContextualPeerController",["require","exports","lib/lodash","lib/bluebird","../../../commons/logging/Logger"],function(e,t,r,n,o){"use strict";return function(){function e(t,n,i){var a=this;this._runtime=t,this._feature=n,this.contentScripts=i,this._prepareGates={},this._pageLoadingStatusMap={},e._logger=e._logger||o.getLogger("ContextualPeerController"),this._runtime.onRuntimeEvent(r.bind(function(e){if("Tabs.PageTurn"===e.name){var t=e.eventArgs;"loading"===t.status?(a._setPageLoadingStatusMap(t.tabId,t.url),a._deletePrepareGates(t.tabId)):"complete"===t.status&&(a._pageLoadingStatusMap[t.tabId]?(t.url!==a._pageLoadingStatusMap[t.tabId]&&a._deletePrepareGates(t.tabId),a._deletePageLoadingStatus(t.tabId)):a._deletePrepareGates(t.tabId))}},this))}return e.prototype.start=function(){return n.resolve()},e.prototype.callAPI=function(t,r,o){var i=this;return n.bind(this).then(function(){return i._sendMessage(t,{type:r,payload:o})}).then(function(t){if(t.error)throw"function"!=typeof t.error.toString&&(t.error=new Error("ContextualPeerController received  an error object with no toString method")),e._logger.error("callAPI",t.error.toString()),t.error;return t.payload})},e.prototype._sendMessage=function(e,t){return n.bind(this).then(function(){return this._getPrepareGate(e)}).then(function(r){return this._runtime.sendMessage(e,r,t)})},e.prototype._getPrepareGate=function(e){return this._prepareGates[e]?this._prepareGates[e]:this._prepareGates[e]=this._enableContextualFeature(e,this._feature)},e.prototype._enableContextualFeature=function(t,r){try{return this._runtime.executeScripts(t,this.contentScripts.get(r))}catch(t){return e._logger.error("_enableContextualFeature",t.message),n.reject(t)}},e.prototype._setPageLoadingStatusMap=function(e,t){this._pageLoadingStatusMap[e]=t},e.prototype._deletePrepareGates=function(e){delete this._prepareGates[e]},e.prototype._deletePageLoadingStatus=function(e){delete this._pageLoadingStatusMap[e]},e}()}),define("ubp/extension/contextual/ContextualFeature",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.Sandbox=1]="Sandbox",e[e.Scrape=2]="Scrape",e[e.Action=3]="Action",e[e.Style=4]="Style",e[e.MetaData=5]="MetaData",e[e.GetUWLItem=6]="GetUWLItem",e[e.Webpage=7]="Webpage",e[e.InlineWidget=8]="InlineWidget"}(r||(r={})),r});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/SandboxPeerController",["require","exports","lib/lodash","lib/bluebird","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n,o,i){"use strict";return function(e){function t(t){var r=e.call(this,t,i.Sandbox,t.getContentScripts())||this;return r.sandboxMessagePrefix="UBPSandboxer",r}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.createSandbox=function(e){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("CreateSandbox"),{tabId:e.tabId,sandboxSpecification:e.sandboxSpecification})},t.prototype.createLocalSandbox=function(e){var t;try{t=this._runtime.getLocalProxyUrl()}catch(e){return n.reject(e)}return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("CreateSandbox"),{tabId:e.tabId,sandboxSpecification:r.extend(e.sandboxSpecification,{proxy:t})})},t.prototype.createSandboxById=function(e){try{var t=void 0;return t=e.sandboxSpecification.staticProxy?this._runtime.getStaticAssetProxy(e.sandboxSpecification.staticProxyType):e.sandboxSpecification&&e.sandboxSpecification.proxy?e.sandboxSpecification.proxy:this._runtime.getLocalProxyUrl(),r.isString(e.sourceProcessName)&&r.isString(e.sandboxSpecification.identifier)&&(e.sandboxSpecification.sandboxId=[e.sourceProcessName,e.sandboxSpecification.identifier].join("-")),this._createSandboxByIdHelper(e,t)}catch(e){return n.reject(e)}},t.prototype._createSandboxByIdHelper=function(e,t){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("CreateSandboxById"),{tabId:e.tabId,sandboxSpecification:r.extend(e.sandboxSpecification,{proxy:t})})},t.prototype.createSandboxByIdPost=function(e){try{var t=void 0;return t=e.sandboxSpecification.staticProxy?this._runtime.getStaticAssetProxy(e.sandboxSpecification.staticProxyType):e.sandboxSpecification&&e.sandboxSpecification.proxy?e.sandboxSpecification.proxy:this._runtime.getLocalProxyUrl(),"string"==typeof e.sourceProcessName&&"string"==typeof e.sandboxSpecification.identifier&&(e.sandboxSpecification.sandboxId=[e.sourceProcessName,e.sandboxSpecification.identifier].join("-")),this._createSandboxByIdPostAPICall(e,t)}catch(e){return n.reject(e)}},t.prototype._createSandboxByIdPostAPICall=function(e,t){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("CreateSandboxByIdPost"),{tabId:e.tabId,sandboxSpecification:r.extend(e.sandboxSpecification,{proxy:t})})},t.prototype.modifySandbox=function(e){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("ModifySandbox"),{sandboxId:e.sandboxId,sandboxCSSSpecification:e.sandboxCSSSpecification})},t.prototype.showSandbox=function(e){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("ShowSandbox"),{sandboxId:e.sandboxId,sandboxCSSSpecification:e.sandboxCSSSpecification,pageStyleSpecification:e.pageStyleSpecification})},t.prototype.destroySandbox=function(e){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("DestroySandbox"),{sandboxId:e.sandboxId})},t.prototype.sendMessageToSandbox=function(e){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("SendMessageToSandbox"),{sandboxId:e.sandboxId,message:e.message})},t.prototype.instrumentSandbox=function(e){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("InstrumentSandbox"),{tabId:e.tabId,sandboxSelector:e.sandboxSelector,message:e.message})},t.prototype.getSandboxAttribute=function(e){return this.callAPI(e.tabId,this.sandboxMessagePrefix.concat("GetSandboxAttribute"),{tabId:e.tabId,sandboxSelector:e.sandboxSelector,message:e.message})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/sandbox/SandboxApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/SandboxPeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("SandboxApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return e.data.args&&(e.data.args.sourceProcessName=e.header.sourceProcessName),o._controller[e.header.name](e.data.args);var n=new Error("SandboxApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/ScrapePeerController",["require","exports","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(t){var r=e.call(this,t,n.Scrape,t.getContentScripts())||this;return r.scrapeMessagePrefix="UBPScraper",r}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.scrape=function(e){return this.callAPI(e.tabId,this.scrapeMessagePrefix.concat("Scrape"),e.specification)},t.prototype.listenerSpecificationScrape=function(e){return this.callAPI(e.tabId,this.scrapeMessagePrefix.concat("Listeners"),e.specification)},t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/scrape/ScrapeApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/ScrapePeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("ScrapeApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return o._controller[e.header.name](e.data.args);var n=new Error("ScrapeApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/ActionPeerController",["require","exports","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(t){var r=e.call(this,t,n.Action,t.getContentScripts())||this;return r.actionMessagePrefix="UBPAction",r}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.registerAction=function(e){return this.callAPI(e.tabId,this.actionMessagePrefix.concat("Register"),e.specification)},t.prototype.deregisterAction=function(e){return this.callAPI(e.tabId,this.actionMessagePrefix.concat("Deregister"),e.actionListenerId)},t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/action/ActionApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/ActionPeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("ActionApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return o._controller[e.header.name](e.data.args);var n=new Error("ActionApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/StylePeerController",["require","exports","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(t){var r=e.call(this,t,n.Style,t.getContentScripts())||this;return r.actionMessagePrefix="UBPStyle",r}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.applyStyle=function(e){return this.callAPI(e.tabId,this.actionMessagePrefix.concat("Apply"),e.specification)},t.prototype.resetStyle=function(e){return this.callAPI(e.tabId,this.actionMessagePrefix.concat("Reset"),e.styleHandle)},t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/style/StyleApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/StylePeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("StyleApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return o._controller[e.header.name](e.data.args);var n=new Error("StyleApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/WebpagePeerController",["require","exports","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(t){var r=e.call(this,t,n.Webpage,t.getContentScripts())||this;return r.webpageMessagePrefix="UBPWebpage",r}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.instrumentWebpage=function(e){return this.callAPI(e.tabId,this.webpageMessagePrefix.concat("InstrumentWebpage"),{action:e.action,targetFrame:e.targetFrame})},t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/webpage/WebpageApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/WebpagePeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("WebpageApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return o._controller[e.header.name](e.data.args);var n=new Error("WebpageApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/runtimeStorage/RuntimeStorageApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../../commons/logging/Logger","../../../../commons/error/Errors","../../../storage/StorageManager","../../../storage/StorageType"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(e){function t(n,o){var a=e.call(this,n)||this;return a._runtimeStorageExposedAPIs={getStorageValue:r.bind(a._getStorageValue,a),bulkGetStorageValues:r.bind(a._bulkGetStorageValues,a),putStorageValue:r.bind(a._putStorageValue,a),deleteStorageValue:r.bind(a._deleteStorageValue,a)},t.runtimeStorageApiLogger=t.runtimeStorageApiLogger||i.getLogger("RuntimeStorageApiStrategy"),a._storageManager=o||s.getInstance(),a}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(e&&e.header&&e.header.name&&r.isFunction(o._runtimeStorageExposedAPIs[e.header.name]))return o._runtimeStorageExposedAPIs[e.header.name](e);var n=new Error("RuntimeStorageApiStrategy.execute: API "+e.header.name+" is not available.");throw t.runtimeStorageApiLogger.error("execute",n.message),n})},t._validateMessage=function(e){if(!(e&&e.header&&e.header.name&&e.data&&e.data.args)){var r=a.BadRequest("received message is in invalid format.");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_validateMessage, error: ",r.toString()),!1}switch(e.header.name){case"getStorageValue":if(!e.data.args.key){var r=a.BadRequest("getStorageValue message is missing 'key' argument");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_validateMessage, error: ",r.toString()),!1}return!0;case"bulkGetStorageValues":if(!e.data.args.keys||!Array.isArray(e.data.args.keys)){var r=a.BadRequest("bulkGetStorageValues message is missing 'keys' argument");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_validateMessage, error: ",r.toString()),!1}return!0;case"putStorageValue":if(!e.data.args.key||!e.data.args.value){var r=a.BadRequest("putStorageValue message is missing 'key' or 'value' argument");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_validateMessage, error: ",r.toString()),!1}return!0;case"deleteStorageValue":if(!e.data.args.key){var r=a.BadRequest("deleteStorageValue message is missing 'key' argument");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_validateMessage, error: ",r.toString()),!1}return!0;default:var r=a.BadRequest("message does not contain correct API name");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_validateMessage, error: ",r.toString()),!1}},t.prototype._getStorageValue=function(e){var r=this;if(!t._validateMessage(e)){var o=a.BadRequest("received message is in invalid format.");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_getStorageValue, error: ",o.toString()),n.reject(o)}return n.bind(this).then(function(){var t=e.data.args.key;return r._storageManager.get(u.EXTENSION_STORAGE,t)})},t.prototype._bulkGetStorageValues=function(e){var o=this;return n.bind(this).then(function(){if(!t._validateMessage(e)){var i=a.BadRequest("received message is in invalid format.");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_bulkGetStorageValues, error: ",i.toString()),n.reject(i)}return r.isEmpty(e.data.args.keys)?n.resolve({}):o._storageManager.bulkGet(u.EXTENSION_STORAGE,e.data.args.keys)}).catch(function(e){return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_bulkGetStorageValues, error: ",e.toString()),n.reject(e)})},t.prototype._putStorageValue=function(e){var r=this;if(!t._validateMessage(e)){var o=a.BadRequest("received message is in invalid format.");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_putStorageValue, error: ",o.toString()),n.reject(o)}return n.bind(this).then(function(){var t=e.data.args.key,n=e.data.args.value;return r._storageManager.set(u.EXTENSION_STORAGE,t,n)})},t.prototype._deleteStorageValue=function(e){var r=this;if(!t._validateMessage(e)){var o=a.BadRequest("received message is in invalid format.");return t.runtimeStorageApiLogger.error("RuntimeStorageApiStrategy::_deleteStorageValue, error: ",o.toString()),n.reject(o)}return n.bind(this).then(function(){var t=e.data.args.key;return r._storageManager.remove(u.EXTENSION_STORAGE,t)})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/MetaDataPeerController",["require","exports","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(t){var r=e.call(this,t,n.MetaData,t.getContentScripts())||this;return r.metaDataMessagePrefix="UBPMetaData",r}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.getPageReferrer=function(e){return this.callAPI(e.tabId,this.metaDataMessagePrefix.concat("GetPageReferrer"),{})},t.prototype.getPageLocationData=function(e){return this.callAPI(e.tabId,this.metaDataMessagePrefix.concat("GetPageLocationData"),{})},t.prototype.getPagePerformanceTimingData=function(e){return this.callAPI(e.tabId,this.metaDataMessagePrefix.concat("GetPagePerformanceTimingData"),{})},t.prototype.getPageDimensionData=function(e){return this.callAPI(e.tabId,this.metaDataMessagePrefix.concat("GetPageDimensionData"),{})},t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}()
;define("ubp/extension/platform/api/metadata/MetaDataApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/MetaDataPeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("MetaDataApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return o._controller[e.header.name](e.data.args);var n=new Error("MetaDataApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/GetUWLItemPeerController",["require","exports","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(t){return e.call(this,t,n.GetUWLItem,t.getContentScripts())||this}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.getUWLItem=function(e){return this.callAPI(e.tabId,t.UWLItemMessagePrefix.concat("GetUWLItem"),null)},t.UWLItemMessagePrefix="UBPUWLItem",t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/uwlitem/GetUWLItemApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/GetUWLItemPeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("GetUWLItemApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return o._controller[e.header.name](e.data.args);var n=new Error("GetUWLItemApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/gateway/api/GatewayApiStrategy",["require","exports","lib/bluebird","../../platform/api/BaseApiStrategy","../../../commons/logging/Logger","../../../commons/error/BadRequestError"],function(e,t,r,n,o,i){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return n._gatewayExposedAPIs={closePanel:n._closePanel,reloadExtension:n._reloadExtension,instrumentGateway:n._instrumentGateway},t.gatewayApiLogger=t.gatewayApiLogger||o.getLogger("GatewayApiStrategy"),n}return __extends(t,e),t.prototype._closePanel=function(){return this._runtime.panelRuntime.destroyPanel()},t.prototype._reloadExtension=function(){return r.resolve()},t.prototype._instrumentGateway=function(e){var n=this;return r.bind(this).then(function(){if(!n._exchange)throw"MessageExchange not found to send message to panel/gateway!";return n._exchange.sendAndReceive(e,t.DEFAULT_MESSAGE_TIMEOUT)}).catch(function(e){throw"Error while instrumenting gateway: "+e})},t.prototype.setMessageExchange=function(e){this._exchange=e},t.prototype.execute=function(e){if(!e||!e.header||!e.header.name)return t.gatewayApiLogger.error("execute","message is malformed"),r.reject(new i("message is malformed"));if(!this._gatewayExposedAPIs[e.header.name]){var n=new i("Gateway: Unable to process message, "+e.header.name+" API not supported");return t.gatewayApiLogger.error("execute","Gateway: Unable to process message, "+e.header.name+" API not supported"),r.reject(n)}return this._gatewayExposedAPIs[e.header.name].call(this,e)},t.DEFAULT_MESSAGE_TIMEOUT=1e4,t}(n)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/contextual/peer-controllers/InlineWidgetPeerController",["require","exports","./ContextualPeerController","../ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(t){var r=e.call(this,t,n.InlineWidget,t.getContentScripts())||this;return r.inlineWidgetMessagePrefix="UBPInlineWidget",r}return __extends(t,e),t.prototype.start=function(){return e.prototype.start.call(this)},t.prototype.createElement=function(e){return this.callAPI(e.tabId,this.inlineWidgetMessagePrefix.concat("createElement"),{id:e.id,tag:e.tag,style:e.style})},t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/api/inlinewidget/InlineWidgetApiStrategy",["require","exports","lib/lodash","lib/bluebird","../BaseApiStrategy","../../../contextual/peer-controllers/InlineWidgetPeerController","../../../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return t._logger=t._logger||a.getLogger("InlineWidgetApiStrategy"),n._controller=new i(r),n}return __extends(t,e),t.prototype.execute=function(e){var o=this;return n.bind(this).then(function(){if(r.isFunction(o._controller[e.header.name]))return e.data.args&&(e.data.args.sourceProcessName=e.header.sourceProcessName),o._controller[e.header.name](e.data.args);var n=new Error("InlineWidgetApiStrategy.execute: API "+e.header.name+" is not available.");throw t._logger.error("execute",n.message),n})},t}(o)}),define("ubp/extension/platform/PlatformCore",["require","exports","lib/lodash","lib/bluebird","../../commons/logging/Logger","./api/platform/PlatformApiStrategy","./api/sandbox/SandboxApiStrategy","./api/scrape/ScrapeApiStrategy","./api/action/ActionApiStrategy","./api/style/StyleApiStrategy","./api/webpage/WebpageApiStrategy","./api/runtimeStorage/RuntimeStorageApiStrategy","./api/metadata/MetaDataApiStrategy","./api/uwlitem/GetUWLItemApiStrategy","../gateway/api/GatewayApiStrategy","./api/inlinewidget/InlineWidgetApiStrategy","../../commons/specification/message/MessageType"],function(e,t,r,n,o,i,a,s,u,c,l,p,f,_,d,g,h){"use strict";return function(){function e(t,r){this._runtime=t,this._clientFactory=r,e.logger=e.logger||o.getLogger("PlatformCore"),this._runtime.unsubscribeRuntimeEvents(),this._apiStrategies={Platform:new i(this._runtime),Sandbox:new a(this._runtime),Scrape:new s(this._runtime),Action:new u(this._runtime),Style:new c(this._runtime),Webpage:new l(this._runtime),RuntimeStorage:new p(this._runtime),MetaData:new f(this._runtime),GetUWLItem:new _(this._runtime),Gateway:new d(this._runtime),InlineWidget:new g(this._runtime)}}return e.prototype.start=function(){if(this._isStarted){var t=new Error("PlatformCore already started");return e.logger.error("start",t.message),n.reject(t)}return this._isStarted=!0,n.bind(this).then(function(){this._handlers={openNewTab:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),createDesktopNotification:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),renderButtonText:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),getPlatformInfo:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),setPlatformCoreInfo:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),clearPlatformInfoCache:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),updatePlatformLocale:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),handleLegacyExternalMessage:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),getActiveTabInfo:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),isTOUAccepted:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),getBrowserRecSettings:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),registerWhitelist:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),updateBrowserRecSettings:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),createContextMenuItem:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),deleteAllContextMenuItems:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),deleteContextMenuItemById:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),removeTab:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),setSmileMode:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),getCookieInfo:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),bulkGetCookieInfo:r.bind(this._apiStrategies.Platform.execute,this._apiStrategies.Platform),createSandbox:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),createLocalSandbox:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),createSandboxById:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),createSandboxByIdPost:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),modifySandbox:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),showSandbox:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),sendMessageToSandbox:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),instrumentSandbox:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),getSandboxAttribute:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),instrumentWebpage:r.bind(this._apiStrategies.Webpage.execute,this._apiStrategies.Webpage),destroySandbox:r.bind(this._apiStrategies.Sandbox.execute,this._apiStrategies.Sandbox),scrape:r.bind(this._apiStrategies.Scrape.execute,this._apiStrategies.Scrape),listenerSpecificationScrape:r.bind(this._apiStrategies.Scrape.execute,this._apiStrategies.Scrape),registerAction:r.bind(this._apiStrategies.Action.execute,this._apiStrategies.Action),deregisterAction:r.bind(this._apiStrategies.Action.execute,this._apiStrategies.Action),applyStyle:r.bind(this._apiStrategies.Style.execute,this._apiStrategies.Style),resetStyle:r.bind(this._apiStrategies.Style.execute,this._apiStrategies.Style),getStorageValue:r.bind(this._apiStrategies.RuntimeStorage.execute,this._apiStrategies.RuntimeStorage),putStorageValue:r.bind(this._apiStrategies.RuntimeStorage.execute,this._apiStrategies.RuntimeStorage),deleteStorageValue:r.bind(this._apiStrategies.RuntimeStorage.execute,this._apiStrategies.RuntimeStorage),getPageReferrer:r.bind(this._apiStrategies.MetaData.execute,this._apiStrategies.MetaData),getPagePerformanceTimingData:r.bind(this._apiStrategies.MetaData.execute,this._apiStrategies.MetaData),getPageLocationData:r.bind(this._apiStrategies.MetaData.execute,this._apiStrategies.MetaData),getPageDimensionData:r.bind(this._apiStrategies.MetaData.execute,this._apiStrategies.MetaData),getUWLItem:r.bind(this._apiStrategies.GetUWLItem.execute,this._apiStrategies.GetUWLItem),closePanel:r.bind(this._apiStrategies.Gateway.execute,this._apiStrategies.Gateway),reloadExtension:r.bind(this._apiStrategies.Gateway.execute,this._apiStrategies.Gateway),createElement:r.bind(this._apiStrategies.InlineWidget.execute,this._apiStrategies.InlineWidget)},this._client=this._clientFactory.fabricate("Platform",this._handlers);for(var e in this._apiStrategies)this._apiStrategies[e].setMessageClient(this._client);return this._client.start()}).then(function(){return this._client.ready()}).then(function(){var t=this;this._apiStrategies.Platform.registerOnPlatformDataChangeHandler(r.bind(this._platformDataChangeHandler,this)),this._apiStrategies.Platform.registerNotificationEventHandler(r.bind(this._desktopNotificationEventHandler,this)),this._runtime.onRuntimeEvent(function(r){t._platformEventDispatcher(r).catch(function(t){e.logger.error("start","Failed to publish the event: "+t.message)})})})},e.prototype._platformEventDispatcher=function(t){var r=this;return n.bind(this).then(function(){if(e.logger.debug("_platformEventDispatcher","Got an event: "+JSON.stringify(t)),!t.name||!t.eventArgs){var n=new Error("message does not abide by the IEventNotification interface");throw e.logger.error("_platformEventDispatcher",n.toString()),n}return t.eventArgs.data&&"UBPMessage"===t.eventArgs.data.UBPMessageType?"function"==typeof r._handlers.handleLegacyExternalMessage?(t.header={name:"handleLegacyExternalMessage"},r._handlers.handleLegacyExternalMessage(t)):void 0:r._publishPlatformEvent(t.name,t.eventArgs)})},e.prototype._publishPlatformEvent=function(e,t){var r={header:{messageType:h.EVENT,name:"publish",namespace:"PlatformHub"},data:{args:{eventName:e,eventArgs:t}}};return this._client._sendAndReceive(r)},e.prototype._platformDataChangeHandler=function(t){return this._publishPlatformEvent(e.PLATFORM_DATA_UPDATE_EVENT,{changeSetting:t})},e.prototype._desktopNotificationEventHandler=function(t){return this._platformEventDispatcher(t).catch(function(t){e.logger.error("desktopNotificationEventHandler","Failed to publish the event: "+t.message)})},e.PLATFORM_DATA_UPDATE_EVENT="Platform.PlatformDataUpdate",e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/client/BaseMessageClient",["require","exports","lib/bluebird","lib/lodash","../Events/Events","../messaging/MessageExchange","../specification/message/MessageType","../error/Errors","../error/BaseError"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(e){function t(t,r,n){var o=e.call(this)||this;return o._isStarted=!1,o._handlers={},o._namespace=t,o._handlers=r,o._transport=n,o}return __extends(t,e),t.prototype.start=function(){var e=this;return r.bind(this).then(function(){return e._setupMessageInfrastructure()}).then(function(){e._isStarted=!0})},t.prototype.ready=function(e){var t=this;return r.bind(this).then(function(){var r={header:{messageType:a.HANDSHAKE,name:"handshake",namespace:t._namespace},data:{args:{namespace:t._namespace}}};return t._sendAndReceive(r,e)}).then(function(e){if(e.UBPHandshakeResponse.namespace!==t._namespace)throw new Error("Did not get correct handshake response")}).catch(function(e){return r.reject(new Error("Could not handshake with process manager: "+e.toString()))})},t.prototype._setupMessageInfrastructure=function(){var e=this;return r.bind(this).then(function(){return this._exchange=new i(1e4),this._transport.forward(this._exchange.egressBus())}).then(function(){return e._exchange.listen(e._transport.dispatchBus())}).then(function(){return n.bindAll(e,"_messageReceiver"),e._exchange.dispatchBus().subscribe(e._messageReceiver)})},t.prototype._send=function(e){return this._exchange.send(e)},t.prototype._sendAndReceive=function(e,n,o,i,a){var s=this;return void 0===n&&(n=t.DEFAULT_MESSAGE_TIMEOUT),void 0===o&&(o=t.DEFAULT_ATTEMPTS),void 0===i&&(i=t.DEFAULT_RETRY_DELAY),void 0===a&&(a=t.DEFAULT_BACKOFF_FACTOR),this._exchange.sendAndReceive(e,n).catch(function(t){if(o>0)return o--,r.delay(i).then(function(){return s._sendAndReceive(e,n,o,i*a)});throw t})},t.prototype._messageReceiver=function(e){var t=this;if(!e||!e.payload)return void console.log("BaseMessageClient received a malformed message");var n=e.payload,o=n.header,i=n.data;if(o)switch(o.messageType){case a.API:o.name&&"function"==typeof this._handlers[o.name]?r.bind(this).then(function(){return t._handlers[o.name](n)}).then(function(t){e.replyCallback(null,t)}).catch(function(t){t instanceof u||(t=s.Internal(t.message||t)),e&&e.replyCallback&&e.replyCallback({name:t.getName(),message:t.getMessage(),status:t.getStatus(),cause:t.getCause()},null)}):e.replyCallback(s.BadRequest());break;case a.EVENT:switch(o.name){case"publish":if(i){var c=i.args,l=c.eventName;this.notify(l,n)}break;default:e.replyCallback(s.BadRequest())}break;case a.HEALTHCHECK:if(i.args.namespace===this._namespace){var p={UBPHealthCheckResponse:{namespace:this._namespace}};e.replyCallback(null,p)}else{var f=new Error("Health Check did not have the expected namespace. My namespace is "+this._namespace);e.replyCallback(f,null)}break;default:e.replyCallback(s.BadRequest())}},t.DEFAULT_MESSAGE_TIMEOUT=1e3,t.DEFAULT_ATTEMPTS=3,t.DEFAULT_RETRY_DELAY=100,t.DEFAULT_BACKOFF_FACTOR=2,t}(o)}),define("ubp/extension/client/PseudoMessageClientFactory",["require","exports","../../commons/client/BaseMessageClient"],function(e,t,r){"use strict";return function(){function e(e){this._transport=e}return e.prototype.fabricate=function(e,t){return new r(e,t,this._transport)},e}()}),define("ubp/extension/platform/BasePseudoFrame",["require","exports","lib/bluebird","../client/PseudoMessageClientFactory","../messaging/PseudoTransportStrategy"],function(e,t,r,n,o){"use strict";return function(){function e(){var e={identity:"PseudoFrame",validOrigins:["*"],validSources:["PseudoProcess"]};this._transport=new o(e),this._clientFactory=new n(this._transport)}return e.prototype.start=function(){return r.resolve()},e.prototype.transport=function(){return this._transport},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/platform/PlatformPseudoFrame",["require","exports","lib/bluebird","./PlatformCore","../platform/BasePseudoFrame","../../commons/logging/Logger"],function(e,t,r,n,o,i){"use strict";return function(e){function t(r){var n=e.call(this)||this;return t.logger=t.logger||i.getLogger("PlatformPseudoFrame"),n._runtime=r,n}return __extends(t,e),t.prototype.start=function(){return r.bind(this).then(function(){if(this._isStarted){var e=new Error("PlatformPseudoFrame has already started");throw t.logger.error("start",e.toString()),e}return this._platformCore=new n(this._runtime,this._clientFactory),this._platformCore.start()}).then(function(){this._isStarted=!0})},t}(o)}),define("ubp/commons/Panel/messageSpecifications/PanelMessageName",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.GatewayURLResponse=1]="GatewayURLResponse",e[e.ClearPanelCache=2]="ClearPanelCache"}(r||(r={})),r});var factory=function(){"use strict";var e=function(){};return e.getGatewayConfiguration=function(){return{version:"07-07-15",refreshETagRate:36e5,configuration:{US:{gatewayURL:"https://horizonte.browserapps.amazon.com",gatewayURLV2:"https://horizonte.browserapps.amazon.com/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.com/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.com/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-us-prod.s3.amazonaws.com/logging/logging-config.js"}},CA:{gatewayURL:"https://horizonte.browserapps.amazon.ca",gatewayURLV2:"https://horizonte.browserapps.amazon.ca/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.ca/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.ca/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-ca-prod.s3.amazonaws.com/logging/logging-config.js"}},UK:{gatewayURL:"https://horizonte.browserapps.amazon.co.uk",gatewayURLV2:"https://horizonte.browserapps.amazon.co.uk/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.co.uk/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.co.uk/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-uk-prod.s3.amazonaws.com/logging/logging-config.js"}},DE:{gatewayURL:"https://horizonte.browserapps.amazon.de",gatewayURLV2:"https://horizonte.browserapps.amazon.de/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.de/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.de/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-de-prod.s3.amazonaws.com/logging/logging-config.js"}},FR:{gatewayURL:"https://horizonte.browserapps.amazon.fr",gatewayURLV2:"https://horizonte.browserapps.amazon.fr/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.fr/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.fr/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-fr-prod.s3.amazonaws.com/logging/logging-config.js"}},IT:{gatewayURL:"https://horizonte.browserapps.amazon.it",gatewayURLV2:"https://horizonte.browserapps.amazon.it/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.it/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.it/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-it-prod.s3.amazonaws.com/logging/logging-config.js"}},JP:{gatewayURL:"https://horizonte.browserapps.amazon.co.jp",gatewayURLV2:"https://horizonte.browserapps.amazon.co.jp/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.co.jp/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.co.jp/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-jp-prod.s3.amazonaws.com/logging/logging-config.js"}},ES:{gatewayURL:"https://horizonte.browserapps.amazon.es",gatewayURLV2:"https://horizonte.browserapps.amazon.es/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.es/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.es/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-es-prod.s3.amazonaws.com/logging/logging-config.js"}},IN:{gatewayURL:"https://horizonte.browserapps.amazon.in",gatewayURLV2:"https://horizonte.browserapps.amazon.in/gatewayProcess",gatewayTreatmentURL:"https://horizonte.browserapps.amazon.in/gatewayETag",termsOfUseURL:"https://horizonte.browserapps.amazon.in/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-in-prod.s3.amazonaws.com/logging/logging-config.js"}},MX:{gatewayURL:"https://horizonte-browserapps.amazon.com.mx",gatewayURLV2:"https://horizonte-browserapps.amazon.com.mx/gatewayProcess",gatewayTreatmentURL:"https://horizonte-browserapps.amazon.com.mx/gatewayETag",termsOfUseURL:"https://horizonte-browserapps.amazon.com.mx/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-mx-prod.s3.amazonaws.com/logging/logging-config.js"}},AE:{gatewayURL:"https://horizonte-browserapps.amazon.ae",gatewayURLV2:"https://horizonte-browserapps.amazon.ae/gatewayProcess",gatewayTreatmentURL:"https://horizonte-browserapps.amazon.ae/gatewayETag",termsOfUseURL:"https://horizonte-browserapps.amazon.ae/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-ae-prod.s3.amazonaws.com/logging/logging-config.js"}},TR:{gatewayURL:"https://horizonte-browserapps.amazon.com.tr",gatewayURLV2:"https://horizonte-browserapps.amazon.com.tr/gatewayProcess",gatewayTreatmentURL:"https://horizonte-browserapps.amazon.com.tr/gatewayETag",termsOfUseURL:"https://horizonte-browserapps.amazon.com.tr/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-tr-prod.s3.amazonaws.com/logging/logging-config.js"}},BR:{gatewayURL:"https://horizonte-browserapps.amazon.com.br",gatewayURLV2:"https://horizonte-browserapps.amazon.com.br/gatewayProcess",gatewayTreatmentURL:"https://horizonte-browserapps.amazon.com.br/gatewayETag",termsOfUseURL:"https://horizonte-browserapps.amazon.com.br/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-br-prod.s3.amazonaws.com/logging/logging-config.js"}},AU:{gatewayURL:"https://horizonte-browserapps.amazon.com.au",gatewayURLV2:"https://horizonte-browserapps.amazon.com.au/gatewayProcess",gatewayTreatmentURL:"https://horizonte-browserapps.amazon.com.au/gatewayETag",termsOfUseURL:"https://horizonte-browserapps.amazon.com.au/tou",loggingConfiguration:{remoteConfigurationEndpoint:"https://ubp-common-au-prod.s3.amazonaws.com/logging/logging-config.js"}}}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/GatewayConfiguration",[],factory),define("ubp/extension/gateway/LoadEventType",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.START=1]="START",e[e.END=2]="END",e[e.NORMAL=3]="NORMAL"}(r||(r={})),r}),define("ubp/extension/gateway/GatewayLoadEventConstants",["require","exports"],function(e,t){"use strict";return function(){function e(){}return e.PANEL_BOOTSTRAPPER="PanelBootstrapper",e.PANEL_BOOTSTRAPPER_SUCCESS="PanelBootstrapperSuccess",e.PANEL_BOOTSTRAPPER_FAILURE="PanelBootstrapperFailure",e.GATEWAY_URL="GatewayURL",e.CONNECT="Connect",e.DISCONNECT="Disconnect",e.YWAIN_INIT="YwainInit",e.YWAIN_ONE_PIXEL="YwainOnePixel",e.YWAIN_CALL_FEED="YwainCallFeed",e.YWAIN_SUCCESS="YwainSuccess",e.GATEWAY_LOAD_OPERATION="Gateway.ReportLoadEvent",e.GATEWAY_LOAD_FEATURE="Gateway",e.START_EVENT=e.CONNECT,e.END_EVENTS=[e.DISCONNECT,e.YWAIN_SUCCESS,"YwainFeedError","Panic_ext101","Panic_ext102","Panic_ext103","Panic_ext104"],e.MISSING_END_EVENT="MissingEndEvent",e.TIMEOUT_EVENT="Timeout",e.CANCEL_EVENTS=[e.DISCONNECT,e.MISSING_END_EVENT],e.SUCCESS_EVENTS=[e.YWAIN_SUCCESS],e.FAILURE_EVENTS=["YwainFeedError","Panic_ext101","Panic_ext102","Panic_ext103","Panic_ext104",e.TIMEOUT_EVENT],e.LATENCY_METRIC="Latency",e.INVALID_METRIC="Invalid",e.DELIMITER=".",e.SESSION_TIMEOUT=2e4,e.LOAD_SUCCESS="LoadSuccess",e.LOAD_FAILURE="LoadFailure",e.LOAD_CANCELLED="LoadCancelled",e.LOAD_INVALID="LoadInvalid",e}()}),define("ubp/extension/gateway/GatewayLoadEventManager",["require","exports","lib/bluebird","../../commons/logging/Logger","../../commons/utilities/UUID","../../metrics/sentry/SentryReport","configuration/GlobalParameters","./LoadEventType","./GatewayLoadEventConstants"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(){function e(){this._isSessionActive=!1,this._sessionEvents=[],e.logger=e.logger||n.getLogger("GatewayLoadEventManager")}return e.prototype.reportLoadEvent=function(e,t){var r={name:e,timestamp:t||Date.now(),type:this._getEventType(e)};switch(r.type){case s.START:this._startSession(r);break;case s.END:this._endSession(r);break;default:this._addEvent(r)}},e.prototype._addEvent=function(t){if(!this._isValidEvent(t))return void e.logger.error("addEvent","Invalid load event being created - "+(t&&t.name));this._sessionEvents.push(t)},e.prototype._isValidEvent=function(t){return t?"string"!=typeof t.name?(e.logger.error("isValidEvent","Invalid load event name: "+t.name),!1):"number"!=typeof t.timestamp?(e.logger.error("isValidEvent","Invalid load event timestamp: "+t.timestamp),!1):void 0!==t.type||(e.logger.error("isValidEvent","Invalid load event type: "+t.type),!1):(e.logger.error("isValidEvent","Invalid load event, event was undefined"),!1)},e.prototype._startSession=function(e){var t=this;if(this._isSessionActive){var r={name:u.MISSING_END_EVENT,timestamp:Date.now(),type:s.END};this._endSession(r)}this._isSessionActive=!0,delete this._sessionEvents,this._sessionEvents=[],this._addEvent(e),clearTimeout(this._sessionTimeoutId),this._sessionTimeoutId=setTimeout(function(){t._timeoutHandler()},u.SESSION_TIMEOUT)},e.prototype._endSession=function(t){this._isSessionActive?(this._isSessionActive=!1,this._addEvent(t),this._batchAndSendReport(),clearTimeout(this._sessionTimeoutId)):e.logger.error("endSession","End session was called without an active gateway load session")},e.prototype._timeoutHandler=function(){var e={name:u.TIMEOUT_EVENT,timestamp:Date.now(),type:s.END};this._endSession(e)},e.prototype._batchAndSendReport=function(){if(this._sessionEvents.length<2)return e.logger.error("batchAndSendReport","Invalid load events session length of "+this._sessionEvents.length),r.resolve();this._sessionEvents.sort(function(e,t){return e.timestamp>t.timestamp?1:-1});var t=this._sessionEvents[0],n=this._sessionEvents[this._sessionEvents.length-1];if(n.type!==s.END)return e.logger.error("batchAndSendReport","Gateway load sessions must end with an END event but instead it ended with "+n.name),r.resolve();for(var a=n.timestamp-t.timestamp,c=this._getSessionLengthBucket(a),l=new i(u.GATEWAY_LOAD_FEATURE,u.GATEWAY_LOAD_OPERATION,o.v4()),p=0,f=this._sessionEvents;p<f.length;p++){var _=f[p],d=_.timestamp-t.timestamp;this._addMetricWithSessionInfo(_.name,c,d,l)}var g=this._getSessionResult(n.name);return this._addMetricWithSessionInfo(g,c,a,l),this._publishReport(l)},e.prototype._publishReport=function(t){return t.publishAsync().catch(function(t){e.logger.error("batchAndSendReport","Error publishing load event report: "+t.toString())})},e.prototype._addMetricWithSessionInfo=function(t,r,n,o){o||e.logger.error("_addMetricWithSessionInfo","Error adding metric info for "+t+", SentryReport is undefined."),o.incrementRealTimeCounter(t),o.incrementRealTimeCounter(t+u.DELIMITER+a.getGlobalParameters().browser),o.incrementRealTimeCounter(t+u.DELIMITER+r),o.incrementRealTimeCounter(t+u.DELIMITER+r+u.DELIMITER+a.getGlobalParameters().browser),o.incrementRealTimeCounter(u.LATENCY_METRIC+u.DELIMITER+t,n),o.incrementRealTimeCounter(u.LATENCY_METRIC+u.DELIMITER+t+u.DELIMITER+a.getGlobalParameters().browser,n),o.incrementRealTimeCounter(u.LATENCY_METRIC+u.DELIMITER+t+u.DELIMITER+r,n),o.incrementRealTimeCounter(u.LATENCY_METRIC+u.DELIMITER+t+u.DELIMITER+r+u.DELIMITER+a.getGlobalParameters().browser,n)},e.prototype._getSessionLengthBucket=function(t){return void 0===t||t<0?(e.logger.error("getSessionLengthBucket","Session length is expected to be 0 or more, but was "+t),u.INVALID_METRIC):t<500?"0-500":t<1e3?"500-1000":t<1500?"1000-1500":t<2e3?"1500-2000":t<2500?"2000-2500":t<3e3?"2500-3000":t<4e3?"3000-4000":t<5e3?"4000-5000":t<6e3?"5000-6000":t<8e3?"6000-8000":t<1e4?"8000-10000":t<12e3?"10000-12000":"12000+"},e.prototype._getSessionResult=function(e){for(var t=0,r=u.SUCCESS_EVENTS;t<r.length;t++){if(r[t]===e)return u.LOAD_SUCCESS}for(var n=0,o=u.FAILURE_EVENTS;n<o.length;n++){if(o[n]===e)return u.LOAD_FAILURE}for(var i=0,a=u.CANCEL_EVENTS;i<a.length;i++){if(a[i]===e)return u.LOAD_CANCELLED}return u.LOAD_INVALID},e.prototype._getEventType=function(e){if(e===u.START_EVENT)return s.START;for(var t=0,r=u.END_EVENTS;t<r.length;t++){if(r[t]===e)return s.END}return s.NORMAL},e}()}),
define("ubp/extension/constant/Constant",["require","exports"],function(e,t){"use strict";return function(){function e(){}return e.GATEWAY_URL_LOCAL_STORAGE_KEY="UBPv2GatewayURL",e}()}),define("ubp/extension/gateway/GatewayCore",["require","exports","lib/lodash","lib/bluebird","../../commons/logging/Logger","../../commons/utilities/URI","../../commons/utilities/UUID","../../metrics/sentry/SentryReport","../../commons/error/BadRequestError","../../commons/messaging/MessageExchange","./api/GatewayApiStrategy","../../commons/Panel/messageSpecifications/PanelMessageName","../../commons/localization/Locale","../../commons/i18n/LanguageTag","../../commons/i18n/CurrencyCode","../../commons/i18n/I18NPreferences","configuration/GatewayConfiguration","configuration/GlobalParameters","../../commons/specification/message/MessageType","./GatewayLoadEventManager","./GatewayLoadEventConstants","../constant/Constant"],function(e,t,r,n,o,i,a,s,u,c,l,p,f,_,d,g,h,m,v,y,b,E){"use strict";return function(){function e(t,r){this._isStarted=!1,this._isTOURequired=!1,this._prevPanelUrl="",this._runtime=t,this._clientFactory=r,this._apiStrategies={Gateway:new l(this._runtime)},this._loadEventManager=new y,e.logger=e.logger||o.getLogger("GatewayCore")}return e.prototype.start=function(){var t=this;if(this._isStarted){var o=new Error("GatewayCore already started");return e.logger.error("start",o.message),n.reject(o)}return this._isStarted=!0,n.bind(this).then(function(){this._handlers={instrumentGateway:r.bind(this._apiStrategies.Gateway.execute,this._apiStrategies.Gateway)},this._client=this._clientFactory.fabricate("Gateway",this._handlers);for(var e in this._apiStrategies)this._apiStrategies[e].setMessageClient(this._client);return this._client.start()}).then(function(){var e={header:{messageType:v.API,name:"getPlatformInfo",namespace:"Platform"}};return t._client._sendAndReceive(e)}).then(function(n){return t._platformData=n,t._platformData&&t._platformData.supportedFeatureList&&t._platformData.supportedFeatureList.registerWhitelist&&t._sendBluelistToRuntime().catch(function(t){e.logger.error("start","Failed to send the bluelist to the runtime: "+t.toString())}),t._runtime.panelRuntime.registerPanelConnect(r.bind(t._panelConnectHandler,t))}).then(function(){return t._runtime.panelRuntime.registerPanelDisconnect(r.bind(t._panelDisconnectHandler,t))}).then(function(){return t._runtime.getFromExtensionStorage(e.TOU_REQUIRED_KEY)}).then(function(e){return"true"===e&&(t._isTOURequired=!0),t._client.ready()}).catch(function(r){throw t._isStarted=!1,e.logger.error("start","Failed to start GatewayCore "+r),r})},e.prototype._panelConnectHandler=function(t){var r=this;e.logger.info("_panelConnectHandler","Connection from Panel initiated ..."),this._loadEventManager.reportLoadEvent(b.CONNECT,Date.now());var o=new s("Gateway","GatewayCore.Panel.Connect",a.v4());o.incrementRealTimeCounter("RequestCount"),o.incrementRealTimeCounter("RequestCount."+m.getGlobalParameters().browser);try{o.publish()}catch(t){e.logger.error("_panelConnectHandler","Error publishing panel connect metrics: "+t.toString())}return n.bind(this).then(function(){if(this._panelConnectTime=Date.now(),!this._platformData||!this._platformData.locale)throw e.logger.error("_panelConnectHandler","Platform info is invalid or no locale present"),new u("Platform info is invalid or no locale present");return this._getPanelURL()}).then(function(e){return r._sendPanelURL(e)}).then(function(){if(!t)throw e.logger.error("_panelConnectHandler","No transport strategy in the connect callback handler"),new u("No transport strategy in the connect callback handler");if(r._transport!==t)return r._transport=t,r._setupMessagingInfrastructure(t)}).then(function(){return r._publishEvent(e.PANEL_CONNECT_EVENT_NAME,{connectTime:r._panelConnectTime})}).then(function(){var e=(new Date).getTime().toString();return r._runtime.putInExtensionStorage("ubpv2.Gateway.panelLoadTime",e)}).catch(function(t){throw e.logger.error("Panel Connect","Failed to handle panel connect event "+t),t})},e.prototype._panelDisconnectHandler=function(){var t=this;return n.bind(this).then(function(){var r=Date.now(),n=r-t._panelConnectTime;t._publishEvent(e.PANEL_DISCONNECT_EVENT_NAME,{timePanelWasOpen:n}),t._loadEventManager.reportLoadEvent(b.DISCONNECT,r);var o=new s("Gateway","GatewayCore.Panel.Disconnect",a.v4());o.incrementRealTimeCounter("RequestCount"),o.incrementRealTimeCounter("RequestCount."+m.getGlobalParameters().browser),o.incrementRealTimeCounter("RequestTimeSuccess",n),o.incrementRealTimeCounter("RequestTimeSuccess."+m.getGlobalParameters().browser,n),n<=250?o.incrementRealTimeCounter("Session250",n):n<=500?o.incrementRealTimeCounter("Session500",n):n<=1e3?o.incrementRealTimeCounter("Session1000",n):n<=2e3?o.incrementRealTimeCounter("Session2000",n):o.incrementRealTimeCounter("NormalSession",n);try{o.publish()}catch(t){e.logger.error("_panelDisconnectHandler","Error sending panel disconnect metrics: "+t.toString())}})},e.prototype._publishEvent=function(e,t){var r={header:{messageType:v.EVENT,name:"publish",namespace:"PlatformHub"},data:{args:{eventName:e,eventArgs:t}}};return this._client._sendAndReceive(r)},e.prototype._sendPanelURL=function(t){var r=this;if(!this._isStarted){var o=new Error("GatewayCore has not been started started");return e.logger.error("_sendPanelURL",o.message),n.reject(o)}if(!t){var o=new Error("You must provide a panel URL to send");return e.logger.error("_sendPanelURL",o.message),n.reject(o)}return this._prevPanelUrl===t?n.resolve():n.bind(this).then(function(){var e={panelHeader:{messageName:p.GatewayURLResponse},panelResponseData:{messageData:{gatewayURL:t}}};return r._runtime.panelRuntime.sendMessageToPanelPort(e)}).then(function(){r._prevPanelUrl=t})},e.prototype._getPanelURL=function(t){var r=this;if(void 0===t&&(t=!0),!this._isStarted){var o=new Error("GatewayCore has not been started started");return e.logger.error("_getPanelURL",o.message),n.reject(o)}var a;return n.bind(this).then(function(){return n.all([r._runtime.getFromExtensionStorage(e.TOU_STORAGE_KEY),r._runtime.getFromExtensionStorage(e.PRELOAD_PARAMS_STORAGE_KEY),r._runtime.getFromExtensionStorage(e.LANGUAGE_PARAM_STORAGE_KEY)])}).spread(function(e,n,o){var a=r._platformData.locale.toUpperCase();if(r._isTOURequired&&"true"!==e)return r._addPartnerInfoToURL(h.getGatewayConfiguration().configuration[a].termsOfUseURL);var s;return s=i.getURLComponents(h.getGatewayConfiguration().configuration[a].gatewayURLV2),s.path||(s.path="/"),t&&(s.queryString=i.appendInURLParameter(s.queryString,"language",o||r._platformData.languageTag)),n&&(s.queryString=i.appendInURLParameter(s.queryString,"preloadParams",n)),i.getURL(s,!0)}).then(function(t){return a=t,t===r._prevPanelUrl?n.resolve():r._runtime.setValueInLocalStorage(E.GATEWAY_URL_LOCAL_STORAGE_KEY,t).catch(function(t){e.logger.error("_getPanelURL","Unable to set gateway URL to localStorage: "+t.toString())})}).then(function(){return a}).catch(function(t){throw e.logger.error("_getPanelURL","Unable to get panel URL: "+t.toString()),t})},e.prototype._addPartnerInfoToURL=function(t){if(!this._isStarted)throw new Error("_addPartnerInfoToURL: GatewayCore is not yet started");return i.appendInURLParameter(t,e.TOU_PARTNER_PARAM_KEY,this._platformData.partner)},e.prototype._setupMessagingInfrastructure=function(t){var r=this;return n.bind(this).then(function(){return r._exchange=new c(e.DEFAULT_TIMEOUT),t.forward(r._exchange.egressBus())}).then(function(){return r._exchange.listen(t.dispatchBus())}).then(function(){return r._exchange.dispatchBus().subscribe(function(e){r._messageReceiver(e)})}).then(function(){for(var e in r._apiStrategies)"function"==typeof r._apiStrategies[e].setMessageExchange&&r._apiStrategies[e].setMessageExchange(r._exchange)})},e.prototype.sendMessageToPanel=function(e){this._runtime.panelRuntime.sendMessageToPanelPort(e)},e.prototype._messageReceiver=function(t){var r=this;return n.bind(this).then(function(){var n;return e.logger.debug("_messageReceiver","Forwarding message from Panel to PlatformHub: "+JSON.stringify(t)),"setLocale"===t.payload.header.name&&(n=m.getGlobalParameters().setLocaleTimeout||e.DEFAULT_SET_LOCALE_TIMEOUT),"reportLoadEvent"===t.payload.header.name?r._reportLoadEvent(t):r._client._sendAndReceive(t.payload,n||e.DEFAULT_MESSAGE_TIMEOUT)}).then(function(n){if(e.logger.debug("_messageReceiver","Forwarding response from PlatformHub back to Panel: "+JSON.stringify(n)),t&&"function"==typeof t.replyCallback&&t.replyCallback(null,n),t.payload&&t.payload.header&&"Platform"===t.payload.header.namespace&&("acceptTermsOfUse"===t.payload.header.name||"setLocale"===t.payload.header.name)){if(t.payload&&t.payload.data&&t.payload.data.args&&t.payload.data.args.locale){var o=new g;r._platformData.locale=f[t.payload.data.args.locale],r._platformData.languageTag=_[o.getDefaultLanguageTag(t.payload.data.args.locale)],r._platformData.currencyCode=d[o.getDefaultCurrencyCode(t.payload.data.args.locale)]}return r._updatePanelURL(t)}}).catch(function(e){t.replyCallback(e)})},e.prototype._updatePanelURL=function(t){var r=this;if(!this._isStarted){var o=new Error("GatewayCore has not been started");return e.logger.error("_updatePanelURLIfNeeded",o.message),n.reject(o)}return this._getPanelURL(!1).then(function(e){return"setLocale"===t.payload.header.name&&(e+="#setLocale"),r._sendPanelURL(e)})},e.prototype._reportLoadEvent=function(t){if(t&&t.payload&&t.payload.data&&t.payload.data.args){this._loadEventManager.reportLoadEvent(t.payload.data.args.name,t.payload.data.args.timestamp);var r=new s("Gateway","GatewayCore.ReportLoadEvent."+t.payload.data.args.name,a.v4());r.incrementRealTimeCounter("RequestCount"),r.incrementRealTimeCounter("RequestCount."+m.getGlobalParameters().browser);try{r.publish()}catch(t){e.logger.error("_panelConnectHandler","Error publishing report load event metrics: "+t.toString())}}return n.resolve(t)},e.prototype._sendBluelistToRuntime=function(){var t=this;return n.bind(this).then(function(){return t._runtime.getFromExtensionStorage(e.WISHLIST_BLUELIST_STORAGE_KEY)}).then(function(e){var r;return e?(r=JSON.parse(e),t._runtime.registerWhitelist(Object.keys(r))):n.reject("Couldn't fetch the bluelist - the response was empty.")}).catch(function(t){e.logger.error("_sendBluelistToRuntime",t.toString())})},e.DEFAULT_TIMEOUT=1e4,e.DEFAULT_MESSAGE_TIMEOUT=1e4,e.DEFAULT_SET_LOCALE_TIMEOUT=2e4,e.TOU_STORAGE_KEY="ubpv2.extension.tou.acceptedTermsOfUse",e.WISHLIST_BLUELIST_STORAGE_KEY="ubpv2.Gateway.AddToList.localBlueList",e.GATEWAY_PANEL_WEBLAB_KEY="ubpv2.gateway.panel.weblab",e.PRELOAD_PARAMS_STORAGE_KEY="ubpv2.Gateway.PreloadParams",e.LANGUAGE_PARAM_STORAGE_KEY="ubpv2.Identity.installation.languageTag",e.TOU_REQUIRED_KEY="ubpv2.extension.tou.isTOURequired",e.TOU_PARTNER_PARAM_KEY="partner",e._DEFAULT_LOCALE=f.US,e.PANEL_CONNECT_EVENT_NAME="Gateway.panel.connect",e.PANEL_DISCONNECT_EVENT_NAME="Gateway.panel.disconnect",e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/gateway/GatewayPseudoFrame",["require","exports","lib/bluebird","./GatewayCore","../platform/BasePseudoFrame","../../commons/logging/Logger"],function(e,t,r,n,o,i){"use strict";return function(e){function t(r){var n=e.call(this)||this;return n._isStarted=!1,n._runtime=r,t._logger=t._logger||i.getLogger("GatewayPseudoFrame"),n}return __extends(t,e),t.prototype.start=function(){var e=this;if(this._isStarted){var o=new Error("GatewayPseudoFrame has already started");return t._logger.error("start",o.toString()),r.reject(o)}return this._isStarted=!0,r.bind(this).then(function(){return this._gatewayCore=new n(this._runtime,this._clientFactory),this._gatewayCore.start()}).catch(function(r){throw e._isStarted=!1,t._logger.error("start","Failed to start GatewayPseudoFrame "+r),r})},t.prototype.sendMessageToGatewayPanel=function(e){this._gatewayCore.sendMessageToPanel(e)},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/firstRun/api/FirstRunApiStrategy",["require","exports","lib/bluebird","../../platform/api/BaseApiStrategy","../../../commons/logging/Logger","../../../commons/error/BadRequestError"],function(e,t,r,n,o,i){"use strict";return function(e){function t(r){var n=e.call(this,r)||this;return n._firstRunExposedAPIs={},t.firstRunApiLogger=t.firstRunApiLogger||o.getLogger("FirstRunApiStrategy"),n}return __extends(t,e),t.prototype.execute=function(e){if(!e||!e.header||!e.header.name)return t.firstRunApiLogger.error("execute","message is malformed"),r.reject(new i("message is malformed"));if(!this._firstRunExposedAPIs[e.header.name]){var n=new i("InitialRunActivities: Unable to process message, "+e.header.name+" API not supported");return t.firstRunApiLogger.error("execute","InitialRunActivities: Unable to process message, "+e.header.name+" API not supported"),r.reject(n)}return this._firstRunExposedAPIs[e.header.name].call(this,e)},t}(n)});var factory=function(){"use strict";var e=function(){};return e.getConfiguration=function(){return{version:"11-10-14",firstRunURLPath:"/aa/firstrun"}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/FirstRunConfiguration",[],factory),define("ubp/commons/platform/FallbackURLBuilder",["require","exports","lib/bluebird","../utilities/URI"],function(e,t,r,n){"use strict";return function(){function e(){}return e.buildUrls=function(t,n){return n.then(function(n){for(var o=[],i=0;i<t.length;i++)o.push(e._buildUrl(t[i].url,n));return r.resolve(o)}).catch(function(e){return r.reject(e)})},e._buildUrl=function(t,r){var o=n.getURLComponents(t),i=n.getQueryParamsObject(o.queryString);i[e.ASSOCIATE_TAG_QUERYPARAM_KEY]=r.fallbackTag;var a=e.FALLBACK_SUBTAG_FORMAT.replace(e.FALLBACK_SUBTAG_LOCALE,r.locale.toLowerCase()).replace(e.FALLBACK_SUBTAG_PARTNER,r.partner);return i[e.SUBTAG_QUERYPARAM_KEY]=a,o.origin=r.fallbackSite,o.queryString=n.getQueryParameterString(i),n.getURL(o)},e.SUBTAG_QUERYPARAM_KEY="ascsubtag",e.ASSOCIATE_TAG_QUERYPARAM_KEY="tag",e.FALLBACK_SUBTAG_LOCALE="%LOCALE%",e.FALLBACK_SUBTAG_PARTNER="%PARTNER%",e.FALLBACK_SUBTAG_FORMAT="0-0-0-0-0-0-%LOCALE%-0-partn-%PARTNER%",e}()}),define("ubp/extension/firstRun/FirstRunCore",["require","exports","lib/lodash","lib/bluebird","../../commons/logging/Logger","./api/FirstRunApiStrategy","configuration/FirstRunConfiguration","../../commons/utilities/URI","../../commons/specification/message/MessageType","../../commons/platform/FallbackURLBuilder"],function(e,t,r,n,o,i,a,s,u,c){"use strict";return function(){function e(t,r,n){this._isStarted=!1,this._firstRunPageAlreadyShown=!1,this._runtime=t,this._clientFactory=r,this._firstRunConfiguration=n||a.getConfiguration(),this._apiStrategies={FirstRun:new i(this._runtime)},e.logger=e.logger||o.getLogger("FirstRunCore")}return e.prototype.start=function(){var t=this;if(this._isStarted){var o=new Error("FirstRunCore already started");return e.logger.error("start",o.message),n.reject(o)}return this._isStarted=!0,n.bind(this).then(function(){this._handlers={},this._client=this._clientFactory.fabricate("FirstRun",this._handlers);for(var e in this._apiStrategies)this._apiStrategies[e].setMessageClient(this._client);return this._client.start()}).then(function(){return n.all([t._runtime.getFromExtensionStorage(e.FIRST_RUN_PAGE_SHOWN_STORAGE_KEY),t._runtime.getFromExtensionStorage(e.INSTALL_REASON_STORAGE_KEY),t._runtime.getFromExtensionStorage(e.UWL_EXPERIENCE_STORAGE_KEY)])}).spread(function(r,o,i){if("true"===r||o!==e.INSTALL_STRING)return e.logger.debug("start","First run page already shown, no need to show the page again "),t._firstRunPageAlreadyShown=!0,n.resolve([]);var a=e.DEFAULT_FIRST_RUN_PAGE_PATH;return t._firstRunConfiguration&&!t._firstRunConfiguration.firstRunURLPath||(a=t._firstRunConfiguration.firstRunURLPath),"true"===i&&(a=s.appendInURLParameter(a,e.UWL_EXPERIENCE_QUERY_PARAM,"true")),t._retrieveURLsFromDossierProcess(a)}).then(function(o){if(!0===t._firstRunPageAlreadyShown)return e.logger.info("start","First run page already shown, no need to show the page again"),n.resolve("");if(!o||!r.isArray(o)||o.length<=0)throw e.logger.error("start","Dossier process did not return tagged URL"),new Error("Dossier process did not return tagged first run page URL");var i=o[0];return t._openFirstRunPageInANewTab(i)}).then(function(r){return t._runtime.putInExtensionStorage(e.FIRST_RUN_PAGE_SHOWN_STORAGE_KEY,"true")}).then(function(){return t._client.ready()}).catch(function(r){throw t._isStarted=!1,e.logger.error("start","Failed to start FirstRunCore "+r),r})},e.prototype._retrieveURLsFromDossierProcess=function(e){var t=this;return n.bind(this).then(function(){var t={header:{messageType:u.API,name:"buildURLs",namespace:"Dossier"},data:{args:{requestSpec:[{url:e}]}}};return this._client._sendAndReceive(t)}).catch(function(r){return t._retrieveURLsFromDossierProcessFallback(e,r)})},e.prototype._retrieveURLsFromDossierProcessFallback=function(t,o){if(!r.isFunction(o.getName)||"RequestTimeoutError"!==o.getName())return n.reject(o);var i={header:{messageType:u.API,name:"getPlatformInfo",namespace:"Platform"},data:{args:null}},a=this._client._sendAndReceive(i);return c.buildUrls([{url:t}],a).catch(function(t){return e.logger.fatal("_retrieveURLsFromDossierProcessFallback","Error in fallback: "+t),n.reject(o)})},e.prototype._openFirstRunPageInANewTab=function(e){return e?n.bind(this).then(function(){var t={header:{messageType:u.API,name:"openNewTab",namespace:"Platform"},data:{args:{url:e}}};return this._client._sendAndReceive(t)}):n.resolve("")},e.DEFAULT_TIMEOUT=1e4,e.FIRST_RUN_PAGE_SHOWN_STORAGE_KEY="ubpv2.extension.first.run.shown",e.INSTALL_REASON_STORAGE_KEY="ubpv2.installation.reason",e.INSTALL_STRING="install",e.DEFAULT_FIRST_RUN_PAGE_PATH="/aa/firstrun",e.UWL_EXPERIENCE_STORAGE_KEY="ubpv2.Gateway.uwlUpgraded",e.UWL_EXPERIENCE_QUERY_PARAM="defaultUWLExperience",e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/firstRun/FirstRunPseudoFrame",["require","exports","lib/bluebird","./FirstRunCore","../platform/BasePseudoFrame","../../commons/logging/Logger"],function(e,t,r,n,o,i){"use strict";return function(e){function t(r){var n=e.call(this)||this;return n._isStarted=!1,n._runtime=r,t._logger=t._logger||i.getLogger("FirstRunPseudoFrame"),n}return __extends(t,e),t.prototype.start=function(){var e=this;if(this._isStarted){var o=new Error("FirstRunPseudoFrame has already started");return t._logger.error("start",o.toString()),r.reject(o)}return this._isStarted=!0,r.bind(this).then(function(){return this._firstRunCore=new n(this._runtime,this._clientFactory),this._firstRunCore.start()}).catch(function(r){throw e._isStarted=!1,t._logger.error("start","Failed to start FirstRunPseudoFrame "+r),r})},t}(o)}),define("ubp/extension/platform/PseudoFrameFactory",["require","exports","./PlatformPseudoFrame","../gateway/GatewayPseudoFrame","../firstRun/FirstRunPseudoFrame","../../commons/logging/Logger"],function(e,t,r,n,o,i){"use strict";return function(){function e(t){this._runtime=t,e.logger=e.logger||i.getLogger("PseudoFrameFactory")}return e.prototype.fabricate=function(t){switch(t){case"Platform":return new r(this._runtime);case"Gateway":return new n(this._runtime);case"FirstRun":return new o(this._runtime);default:var i=new Error("Cannot fabricate a pseudo frame for "+t);throw e.logger.error("fabricate",i.toString()),i}},e}()}),define("ubp/extension/process/ProcessFactory",["require","exports","../../commons/logging/Logger","./ProcessType","./PseudoProcess","../platform/PseudoFrameFactory"],function(e,t,r,n,o,i){"use strict";return function(){function e(e){this._runtime=e,this._pseudoFrameFactory=new i(e)}return e.prototype.fabricate=function(t,r,i){switch(t.processType){case n.Pseudo:e.logger.info("fabricate","Starting Pseudo process '"+t.name);var a=this._pseudoFrameFactory.fabricate(t.name);return new o(t,r,a,i);case n.Remote:return e.logger.info("fabricate","Starting Remote process '"+t.name+"' from URL: "+t.configuration.url),this._runtime.createProcessInstance(t,r,i);default:var s=new Error("The processType in the given manifest is not supported: "+t.processType);throw e.logger.error("fabricate",s.toString()),s}},e.logger=r.getLogger("ProcessFactory"),e}()});var factory=function(){"use strict";var e=function(){};return e.getManifestConfiguration=function(){return{version:"03-30-15",refreshRate:18e5,refreshRateRange:[18e5,216e5],configuration:{US:{endPointType:"remote",bucketName:"ubp-ubpextension-us-prod",endPoint:"https://ubp-ubpextension-us-prod.s3-us-west-2.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},CA:{endPointType:"remote",bucketName:"ubp-ubpextension-ca-prod",endPoint:"https://ubp-ubpextension-ca-prod.s3-us-west-2.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},UK:{endPointType:"remote",bucketName:"ubp-ubpextension-uk-prod",endPoint:"https://ubp-ubpextension-uk-prod.s3-eu-west-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},DE:{endPointType:"remote",bucketName:"ubp-ubpextension-de-prod",endPoint:"https://ubp-ubpextension-de-prod.s3.eu-central-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},FR:{endPointType:"remote",bucketName:"ubp-ubpextension-fr-prod",endPoint:"https://ubp-ubpextension-fr-prod.s3.eu-central-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},IT:{endPointType:"remote",bucketName:"ubp-ubpextension-it-prod",endPoint:"https://ubp-ubpextension-it-prod.s3.eu-central-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},JP:{endPointType:"remote",bucketName:"ubp-ubpextension-jp-prod",endPoint:"https://ubp-ubpextension-jp-prod.s3-ap-northeast-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},CN:{endPointType:"remote",bucketName:"ubp-ubpextension-cn-prod",endPoint:"https://ubp-ubpextension-cn-prod.s3.cn-north-1.amazonaws.com.cn/FeatureManifests/all/FeatureManifest.js"},ES:{endPointType:"remote",bucketName:"ubp-ubpextension-es-prod",endPoint:"https://ubp-ubpextension-es-prod.s3-sa-east-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},IN:{endPointType:"remote",bucketName:"ubp-ubpextension-in-prod",endPoint:"https://ubp-ubpextension-in-prod.s3-ap-southeast-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},MX:{endPointType:"remote",bucketName:"ubp-ubpextension-mx-prod",endPoint:"https://ubp-ubpextension-mx-prod.s3-us-west-2.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},AE:{endPointType:"remote",bucketName:"ubp-ubpextension-ae-prod",endPoint:"https://ubp-ubpextension-ae-prod.s3-eu-west-2.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},TR:{endPointType:"remote",bucketName:"ubp-ubpextension-tr-prod",endPoint:"https://ubp-ubpextension-tr-prod.s3-eu-west-2.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},BR:{endPointType:"remote",bucketName:"ubp-ubpextension-br-prod",endPoint:"https://ubp-ubpextension-br-prod.s3-sa-east-1.amazonaws.com/FeatureManifests/all/FeatureManifest.js"},AU:{endPointType:"remote",bucketName:"ubp-ubpextension-au-prod",endPoint:"https://ubp-ubpextension-au-prod.s3-us-west-2.amazonaws.com/FeatureManifests/all/FeatureManifest.js"}}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/FeatureManifestConfiguration",[],factory);var factory=function(){"use strict";var e=function(){};return e.getLoggingConfiguration=function(){return{version:"6-20-15",configuration:{US:{remoteConfigurationEndpoint:"https://ubp-common-us-prod.s3.amazonaws.com/logging/logging-config.js"},CA:{remoteConfigurationEndpoint:"https://ubp-common-ca-prod.s3.amazonaws.com/logging/logging-config.js"},UK:{remoteConfigurationEndpoint:"https://ubp-common-uk-prod.s3.amazonaws.com/logging/logging-config.js"},DE:{remoteConfigurationEndpoint:"https://ubp-common-de-prod.s3.amazonaws.com/logging/logging-config.js"},FR:{remoteConfigurationEndpoint:"https://ubp-common-fr-prod.s3.amazonaws.com/logging/logging-config.js"},IT:{remoteConfigurationEndpoint:"https://ubp-common-it-prod.s3.amazonaws.com/logging/logging-config.js"},JP:{remoteConfigurationEndpoint:"https://ubp-common-jp-prod.s3.amazonaws.com/logging/logging-config.js"},CN:{remoteConfigurationEndpoint:"https://ubp-common-cn-prod.s3.cn-north-1.amazonaws.com.cn/logging/logging-config.js"},ES:{remoteConfigurationEndpoint:"https://ubp-common-es-prod.s3.amazonaws.com/logging/logging-config.js"},IN:{remoteConfigurationEndpoint:"https://ubp-common-in-prod.s3.amazonaws.com/logging/logging-config.js"},MX:{remoteConfigurationEndpoint:"https://ubp-common-mx-prod.s3.amazonaws.com/logging/logging-config.js"},AE:{remoteConfigurationEndpoint:"https://ubp-common-ae-prod.s3.amazonaws.com/logging/logging-config.js"},TR:{remoteConfigurationEndpoint:"https://ubp-common-tr-prod.s3.amazonaws.com/logging/logging-config.js"},BR:{remoteConfigurationEndpoint:"https://ubp-common-br-prod.s3.amazonaws.com/logging/logging-config.js"},AU:{remoteConfigurationEndpoint:"https://ubp-common-au-prod.s3.amazonaws.com/logging/logging-config.js"}},extensionLogIdConfiguration:{rotate_interval:2592e6,failure_refresh_interval:108e5}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/LoggingConfiguration",[],factory);var factory=function(){"use strict";var e=function(){};return e.getInstallConfiguration=function(){return{version:"6-20-16",configuration:{US:{site:"https://www.amazon.com",serviceUrl:"https://cookie.browserapps.amazon.com/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-us-west-2.amazonaws.com/ubp-common-us-prod/cookiesync/cookiesync-config.json"},CA:{site:"https://www.amazon.ca",serviceUrl:"https://cookie.browserapps.amazon.ca/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-us-west-2.amazonaws.com/ubp-common-ca-prod/cookiesync/cookiesync-config.json"},UK:{site:"https://www.amazon.co.uk",serviceUrl:"https://cookie.browserapps.amazon.co.uk/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-eu-west-1.amazonaws.com/ubp-common-uk-prod/cookiesync/cookiesync-config.json"},DE:{site:"https://www.amazon.de",serviceUrl:"https://cookie.browserapps.amazon.de/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3.eu-central-1.amazonaws.com/ubp-common-de-prod/cookiesync/cookiesync-config.json"},FR:{site:"https://www.amazon.fr",serviceUrl:"https://cookie.browserapps.amazon.fr/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3.eu-central-1.amazonaws.com/ubp-common-fr-prod/cookiesync/cookiesync-config.json"},IT:{site:"https://www.amazon.it",serviceUrl:"https://cookie.browserapps.amazon.it/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3.eu-central-1.amazonaws.com/ubp-common-it-prod/cookiesync/cookiesync-config.json"},JP:{site:"https://www.amazon.co.jp",serviceUrl:"https://cookie.browserapps.amazon.co.jp/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-ap-northeast-1.amazonaws.com/ubp-common-jp-prod/cookiesync/cookiesync-config.json"},CN:{site:"https://www.amazon.cn",serviceUrl:"https://cookie.browserapps.amazon.cn/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3.cn-north-1.amazonaws.com.cn/ubp-common-cn-prod/cookiesync/cookiesync-config.json"},ES:{site:"https://www.amazon.es",serviceUrl:"https://cookie.browserapps.amazon.es/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-sa-east-1.amazonaws.com/ubp-common-es-prod/cookiesync/cookiesync-config.json"},IN:{site:"https://www.amazon.in",serviceUrl:"https://cookie.browserapps.amazon.in/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-ap-southeast-1.amazonaws.com/ubp-common-in-prod/cookiesync/cookiesync-config.json"},MX:{site:"https://www.amazon.com.mx",serviceUrl:"https://cookie.browserapps.amazon.com.mx/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-us-west-2.amazonaws.com/ubp-common-mx-prod/cookiesync/cookiesync-config.json"},AE:{site:"https://www.amazon.ae",serviceUrl:"https://cookie.browserapps.amazon.ae/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-eu-west-2.amazonaws.com/ubp-common-ae-prod/cookiesync/cookiesync-config.json"},TR:{site:"https://www.amazon.com.tr",serviceUrl:"https://cookie.browserapps.amazon.com.tr/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-eu-west-2.amazonaws.com/ubp-common-tr-prod/cookiesync/cookiesync-config.json"},BR:{site:"https://www.amazon.com.br",serviceUrl:"https://cookie.browserapps.amazon.com.br/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-sa-east-1.amazonaws.com/ubp-common-br-prod/cookiesync/cookiesync-config.json"},AU:{site:"https://www.amazon.com.au",serviceUrl:"https://cookie.browserapps.amazon.com.au/",isEnabled:!0,syncInterval:2e3,remoteConfigurationEndpoint:"https://s3-us-west-2.amazonaws.com/ubp-common-au-prod/cookiesync/cookiesync-config.json"}}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/CookieInstallConfiguration",[],factory),define("ubp/commons/logging/ForesterAppender",["require","exports","lib/lodash","lib/bluebird","./LogLevel","../messaging/clients/network/HTTPMethod"],function(e,t,r,n,o,i){"use strict";return function(){function e(e,t,n,o){this._backoffInterval=3e4,this._shouldBackoff=!1,this._timer=null,this._client=e,this._endpoint=t,this._timer=n,r.isNumber(o)&&(this._backoffInterval=o)}return e.prototype.log=function(e,t,o,i,a,s){var u=this;return this._timer.setTimeout(r.bind(function(){u.logAsync(e,t,o,i,a,s)},this),0),n.resolve()},e.prototype.logAsync=function(t,o,i,a,s,u){var c=this;return n.bind(this).then(function(){if(c._shouldBackoff)return n.reject(new Error("ForesterAppender is in back-off mode."));var l=c._formatLogData(t,o,i,a,s,u);return c._client.request(c._endpoint,r.extend(e.NETWORK_REQUEST_CONFIGURATION,{data:l})).then(function(){return n.resolve()}).catch(function(e){return c._shouldBackoff=!0,c._timer.setTimeout(r.bind(function(){c._shouldBackoff=!1},c),c._backoffInterval),n.reject(new Error("ForesterAppender is in back-off mode."))})})},e.prototype._formatLogData=function(e,t,r,n,i,a){return(new Date).toUTCString()+" ["+o[e]+"] "+t+"."+r+" : "+n+", "+i+", "+a+"\n"},e.HEADERS={"Content-Type":"text/plain"},e.NETWORK_REQUEST_CONFIGURATION={httpMethod:i.POST,headers:e.HEADERS,maxAttempts:2,backoffFactor:2,timeout:3e4,initialRetryInterval:1e3},e}()}),define("ubp/commons/logging/ConsoleAppender",["require","exports","lib/bluebird","./LogLevel"],function(e,t,r,n){"use strict";return function(){function e(){}return e.prototype.log=function(e,t,o,i,a,s){switch(e){case n.DEBUG:console.debug(n[e],t,o,i,a,s);break;case n.INFO:console.info(n[e],t,o,i,a,s);break;case n.WARN:console.warn(n[e],t,o,i,a,s);break;case n.ERROR:case n.FATAL:console.error(n[e],t,o,i,a,s);break;default:console.log(n[e],t,o,i,a,s)}return r.resolve()},e}()}),
define("ubp/commons/logging/LoggingManager",["require","exports","lib/lodash","lib/bluebird","./Logger","./LogLevel","./ForesterAppender","./ConsoleAppender","../messaging/clients/network/HTTPMethod"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(){function e(){if(this._configuration=null,this._networkClient=null,this._timer=null,this._refreshTimerId=null,this._refreshInterval=null,e._instance)throw new Error("Error: Instantiation failed: Use LoggingManager.getInstance() instead of new.");e._instance=this}return e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.init=function(e,t){this._networkClient=e,this._timer=t},e.prototype.configure=function(t,n){return this._configuration=t,this._refreshInterval=n||e.DEFAULT_CONFIGURATION_REFRESH_INTERVAL,this._refreshTimerId&&this._timer.clearTimeout(this._refreshTimerId),r.isEmpty(this._configuration.remoteConfigurationEndpoint)?this._configureLocal():this._configureRemote()},e.prototype._configureRemote=function(){var t=this;return n.bind(this).then(function(){return t._networkClient.request(t._configuration.remoteConfigurationEndpoint,e.NETWORK_REQUEST_CONFIGURATION)}).then(function(e){var o=r.extend({merged:!0},t._configuration,e.data);return r.isEqual(o,t._configuration)?n.resolve():(t._configuration=o,t._configureLocal())}).finally(function(){t._refreshTimerId=t._timer.setTimeout(r.bind(function(){t._configureRemote()},t),t._refreshInterval)})},e.prototype._configureLocal=function(){return o.root.setLogLevel(i[this._configuration.rootLogLevel]),o.root.removeAppender(e.CONSOLE_LOG_APPENDER_ALIAS),o.root.addAppender(e.CONSOLE_LOG_APPENDER_ALIAS,new s),o.root.removeAppender(e.FORESTER_APPENDER_ALIAS),r.isEmpty(this._configuration.foresterEndpoint)||o.root.addAppender(e.FORESTER_APPENDER_ALIAS,new a(this._networkClient,this._configuration.foresterEndpoint,this._timer,this._configuration.foresterBackoffInterval)),n.resolve()},e.DEFAULT_CONFIGURATION_REFRESH_INTERVAL=6e5,e.CONSOLE_LOG_APPENDER_ALIAS="Console",e.FORESTER_APPENDER_ALIAS="Forester",e.RESPONSE_TYPE="json",e.MAX_ATTEMPTS=2,e.BACKOFF_FACTOR=2,e.NETWORK_TIMEOUT=3e4,e.INITIAL_RETRY_INTERVAL=1e3,e.NETWORK_REQUEST_CONFIGURATION={httpMethod:u.GET,maxAttempts:e.MAX_ATTEMPTS,responseType:e.RESPONSE_TYPE,backoffFactor:e.BACKOFF_FACTOR,timeout:e.NETWORK_TIMEOUT,initialRetryInterval:e.INITIAL_RETRY_INTERVAL},e._instance=null,e}()});var factory=function(){"use strict";var e=function(){};return e.getConfiguration=function(){return{version:"07-13-15",configuration:[{localeRetrieverURL:"https://www.amazon.com/gp/ubp/json/config/liteBootstrap"},{localeRetrieverURL:"https://www.amazon.fr/gp/ubp/json/config/liteBootstrap"}]}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/LocalizationConfiguration",[],factory),define("ubp/extension/locale/LocaleManager",["require","exports","lib/lodash","lib/bluebird","../../commons/logging/Logger","../../commons/error/BadRequestError","../../commons/error/ConflictError","../../commons/localization/Locale","../../commons/messaging/clients/network/HTTPMethod","../storage/StorageManager","../storage/StorageType","configuration/LocalizationConfiguration"],function(e,t,r,n,o,i,a,s,u,c,l,p){"use strict";return function(){function e(t,r,n){this._isStarted=!1,this._networkClient=t,this._storageManager=r||c.getInstance(),this._localizationConfiguration=n||p.getConfiguration(),e.logger=e.logger||o.getLogger("LocaleManager")}return e.prototype.start=function(){var t=this;if(this._isStarted){var r=new a("LocaleManager already started");return e.logger.error("start",r.toString()),n.reject(r)}this._isStarted=!0;var o=!1;return n.bind(this).then(function(){return t._storageManager.get(l.EXTENSION_STORAGE,e._STORAGE_LOCALE_KEY)}).then(function(r){if(e.logger.debug("start","Locale retrieved from storage => ["+r+"]"),r){var i=s[r];return i?(o=!0,n.cast(i)):(e.logger.error("start",'Locale got from storage "'+r+'" which is not supported, getting it from Geo locator'),t.getGeoLocale())}return e.logger.error("start","No valid locale found in storage, retrieving it from remote server"),t.getGeoLocale()}).then(function(r){if(e.logger.debug("start","Locale retrieved from storage/geo locator => ["+s[r]+"]"),!o)return t.setLocale(r);t._locale=r}).catch(function(r){e.logger.error("start",r.toString()),t._locale=e._DEFAULT_LOCALE,t._storageManager.set(l.EXTENSION_STORAGE,e._STORAGE_LOCALE_KEY,s[t._locale]).then(function(){})})},e.prototype.stop=function(){this._locale=void 0,this._geoLocale=void 0,this._isStarted=!1},e.prototype._retrieveGeoLocatorFromConfig=function(){var t=[];this._localizationConfiguration&&this._localizationConfiguration.configuration&&r.isArray(this._localizationConfiguration.configuration)||(e.logger.error("_retrieveGeoLocatorFromConfig","Returning default geo locator URL as configuration is not correct"),t=[e.DEFAULT_GEO_LOCATOR]);for(var n in this._localizationConfiguration.configuration)t.push(this._localizationConfiguration.configuration[n].localeRetrieverURL);return e.logger.debug("_retrieveGeoLocatorFromConfig","URLs retrieved from config ("+t.join()+")"),t},e.prototype._check=function(){if(!this._isStarted){var t=new a("LocaleManager has not been started yet");throw e.logger.error("check",t.toString()),t}},e.prototype.getLocale=function(){var t=this;return this._check(),n.bind(this).then(function(){return e.logger.debug("getLocale","returning Locale ["+s[t._locale]+"]"),t._locale})},e.prototype.setLocale=function(t){var r=this;return this._check(),t&&s[t]?(this._locale===t&&n.resolve(),n.bind(this).then(function(){return r._storageManager.set(l.EXTENSION_STORAGE,e._STORAGE_LOCALE_KEY,s[t])}).then(function(n){e.logger.debug("setLocale","locale is getting changed from ["+s[r._locale]+"] to ["+s[t]+"]"),r._locale=t})):(e.logger.error("setLocale","Invalid locale, can not set the locale"),n.reject(new i("Invalid locale, can not set the locale")))},e.prototype.getGeoLocale=function(){var t=this;if(this._geoLocale)return n.resolve(this._geoLocale);var o=this._retrieveGeoLocatorFromConfig();return n.any(r.map(o,r.bind(function(t){return this._networkClient.request(t,e.NetworkRequestConfiguration)},this))).then(function(r){var n=r&&r.data&&r.data.country_code;return n?(t._geoLocale=s[n.toUpperCase()],t._geoLocale||e.logger.error("getGeoLocale",'Geo locator returns "'+n+'" which is not supported, setting it to default locale')):e.logger.error("getGeoLocale","Network response is not valid, or locale is missing from the response. Response: "+JSON.stringify(r)),t._geoLocale||e._DEFAULT_LOCALE}).catch(function(t){return e.logger.error("getGeoLocale","Failed to retrieve locale: "+JSON.stringify(t)),e._DEFAULT_LOCALE})},e._DEFAULT_LOCALE=s.US,e._STORAGE_LOCALE_KEY="ubpv2.extension.installation.locale",e.DEFAULT_GEO_LOCATOR="https://www.amazon.com/gp/ubp/json/config/liteBootstrap",e.NETWORK_TIMEOUT=3e4,e.MAX_ATTEMPTS=10,e.BACKOFF_FACTOR=2,e.INITIAL_RETRY_INTERVAL=1e3,e.NetworkRequestConfiguration={httpMethod:u.GET,responseType:"json",timeout:e.NETWORK_TIMEOUT,maxAttempts:e.MAX_ATTEMPTS,backoffFactor:e.BACKOFF_FACTOR,initialRetryInterval:e.INITIAL_RETRY_INTERVAL},e}()});var factory=function(){"use strict";var e=function(){};return e.getConfiguration=function(){return{version:"11-10-14",data:{FirstTimeSetupExistenceCheck:[{key:"ubpv2.extension.firstTimeSetupCompleted",value:"true"}],FirstTimeSetupKeyConfig:[{key:"ubpv2.extension.partnerId",defaultValue:"amazon1",storageKeyConfig:[{retrievalType:"GlobalParameters",keys:["partner"]},{retrievalType:"EXTENSION_STORAGE",keys:["params.partnerId"]},{retrievalType:"LOCAL_STORAGE",keys:["com.amazon.ubp.partnerid","com.amazon.ubp.oemId"]},{retrievalType:"PREFERENCES_STORAGE",keys:["com.amazon.ubp.partnerid","extensions.AMAZONNEW_NS_PH.associateid.oem","com.amazon.ubp.oemId"]},{retrievalType:"AMAZON_COM_LOCAL_STORAGE",keys:["com.amazon.bit.tagbase"],mapping:"tagBaseToPartnerIdMap"}]},{key:"ubpv2.extension.thirdPartyId",storageKeyConfig:[{retrievalType:"EXTENSION_STORAGE",keys:["params.thirdPartyId"]},{retrievalType:"LOCAL_STORAGE",keys:["com.amazon.ubp.thirdpartyid"]},{retrievalType:"PREFERENCES_STORAGE",keys:["extensions.AMAZONNEW_NS_PH.thirdpartyid","com.amazon.ubp.thirdpartyid"]}]},{key:"ubpv2.extension.tou.isTOURequired",defaultValue:"false",storageKeyConfig:[{retrievalType:"GlobalParameters",keys:["partner"],mapping:"partnerRequiringTOUMap"},{retrievalType:"LOCAL_STORAGE",keys:["com.amazon.ubp.partnerid","com.amazon.ubp.oemId"],mapping:"partnerRequiringTOUMap"},{retrievalType:"PREFERENCES_STORAGE",keys:["com.amazon.ubp.partnerid","extensions.AMAZONNEW_NS_PH.associateid.oem","com.amazon.ubp.oemId"],mapping:"partnerRequiringTOUMap"},{retrievalType:"AMAZON_COM_LOCAL_STORAGE",keys:["com.amazon.bit.tagbase"],overrideValue:"false"}]},{key:"ubpv2.extension.browser",storageKeyConfig:[{retrievalType:"GlobalParameters",keys:["browser"]}]},{key:"ubpv2.extension.smile.mode",defaultValue:"false",storageKeyConfig:[{retrievalType:"AMAZON_COM_LOCAL_STORAGE",keys:["com.amazon.bit.bitMode"],constraints:{matches:"smile"}}]},{key:"ubpv2.extension.programCode",defaultValue:"org",storageKeyConfig:[{retrievalType:"GlobalParameters",keys:["programCode"]},{retrievalType:"AMAZON_COM_LOCAL_STORAGE",keys:["com.amazon.bit.campaignCode","com.amazon.bit.programCode"],mapping:"campaignCodeToProgramCodeMap"}]},{key:"ubpv2.Gateway.uwlUpgraded",defaultValue:"false",storageKeyConfig:[{retrievalType:"AMAZON_COM_LOCAL_STORAGE",keys:["com.amazon.bit.defaultUWLExperience"]}]},{key:"ubpv2.extension.app",value:"AmazonAssistant"}],campaignCodeToProgramCodeMap:{v0_d130610_ad_spk_cmp:"p001",v0_d130610_ad_spk_nvm:"p002",v0_d130610_ad_spk_ss:"p003",v0_d131006_ad_r4_cmp:"p004",v0_d131006_ad_r4_nvm:"p005",v0_d131006_ad_r4_ss:"p006",v1_uk_d131020_ad_spk_cmp:"p008",v1_uk_d131020_ad_spk_nvm:"p009",v1_uk_d131020_ad_spk_ss:"p010",v1_uk_d131020_ad_r4_cmp:"p011",v1_uk_d131020_ad_r4_nvm:"p012",v1_uk_d131020_ad_r4_ss:"p013",v1_ca_d131020_ad_spk_cmp:"p014",v1_ca_d131020_ad_spk_nvm:"p015",v1_ca_d131020_ad_spk_ss:"p016",v1_ca_d131020_ad_r4_cmp:"p017",v1_ca_d131020_ad_r4_nvm:"p018",v1_ca_d131020_ad_r4_ss:"p019",v1_fr_d131020_ad_spk_cmp:"p020",v1_fr_d131020_ad_spk_nvm:"p021",v1_fr_d131020_ad_spk_ss:"p022",v1_fr_d131020_ad_r4_cmp:"p023",v1_fr_d131020_ad_r4_nvm:"p024",v1_fr_d131020_ad_r4_ss:"p025",v1_de_d131020_ad_spk_cmp:"p026",v1_de_d131020_ad_spk_nvm:"p027",v1_de_d131020_ad_spk_ss:"p028",v1_de_d131020_ad_r4_cmp:"p029",v1_de_d131020_ad_r4_nvm:"p030",v1_de_d131020_ad_r4_ss:"p031",v1_it_d131020_ad_spk_cmp:"p032",v1_it_d131020_ad_spk_nvm:"p033",v1_it_d131020_ad_spk_ss:"p034",v1_it_d131020_ad_r4_cmp:"p035",v1_it_d131020_ad_r4_nvm:"p036",v1_it_d131020_ad_r4_ss:"p037",v1_es_d131020_ad_spk_cmp:"p038",v1_es_d131020_ad_spk_nvm:"p039",v1_es_d131020_ad_spk_ss:"p040",v1_es_d131020_ad_r4_cmp:"p041",v1_es_d131020_ad_r4_nvm:"p042",v1_es_d131020_ad_r4_ss:"p043",v1_cn_d131020_ad_spk_cmp:"p044",v1_cn_d131020_ad_spk_nvm:"p045",v1_cn_d131020_ad_spk_ss:"p046",v1_cn_d131020_ad_r4_cmp:"p047",v1_cn_d131020_ad_r4_nvm:"p048",v1_cn_d131020_ad_r4_ss:"p049",v1_jp_d131020_ad_spk_cmp:"p050",v1_jp_d131020_ad_spk_nvm:"p051",v1_jp_d131020_ad_spk_ss:"p052",v1_jp_d131020_ad_r4_cmp:"p053",v1_jp_d131020_ad_r4_nvm:"p054",v1_jp_d131020_ad_r4_ss:"p055",v1_us_d131101_ad_l7_hbf:"p057",v1_us_d131101_ad_l7_hcm:"p058",v1_us_d131101_ad_l7_hg:"p059",v1_us_d131101_eml_mm_h13:"p060",v1_us_b000001_eml_bry_nc:"p061",v1_us_b000001_eml_bry_nc5:"p062",v1_us_b000001_eml_bry_wl:"p063",v1_us_b000001_eml_bry_wl5:"p064",v1_us_b000001_eml_bry_dla:"p065",v1_us_b000001_eml_bry_dl5:"p066",v1_us_b000004_ad_spk_na5:"p067",v1_us_b000004_ad_r4_na5:"p068",v1_us_b000005_wgt_lpo_ad1:"p069",v1_us_b000005_wgt_lpo_ad2:"p070",v1_us_b000006_wgt_chk_dl1:"p071",v1_us_b000006_wgt_chk_dl2:"p072",v1_us_b000007_wgt_chk_wl1:"p073",v1_us_b000007_wgt_chk_wl2:"p074",v1_xt_b000008_xt1_xt2_xt3:"p075",v1_xt_b000009_xt1_xt2_xt3:"p076",v1_xt_b000010_xt1_xt2_xt3:"p077",v1_xt_b000011_xt1_xt2_xt3:"p078",v1_xt_b000012_xt1_xt2_xt3:"p079",v1_xt_b000013_xt1_xt2_xt3:"p080",v1_us_d140205_ad_spk_loc:"p081",v1_us_d140205_ad_spk_wl:"p082",v1_us_d140205_ad_spk_ext1:"p083",v1_us_d140205_ad_r4_loc:"p084",v1_us_d140205_ad_r4_wl:"p085",v1_us_d140205_ad_r4_ext1:"p086",v1_uk_d140205_ad_spk_loc:"p087",v1_uk_d140205_ad_spk_wl:"p088",v1_uk_d140205_ad_spk_ext1:"p089",v1_uk_d140205_ad_r4_loc:"p090",v1_uk_d140205_ad_r4_wl:"p091",v1_uk_d140205_ad_r4_ext1:"p092",v1_ca_d140205_ad_spk_loc:"p093",v1_ca_d140205_ad_spk_wl:"p094",v1_ca_d140205_ad_spk_ext1:"p095",v1_ca_d140205_ad_r4_loc:"p096",v1_ca_d140205_ad_r4_wl:"p097",v1_ca_d140205_ad_r4_ext1:"p098",v1_de_d140205_ad_spk_loc:"p099",v1_de_d140205_ad_spk_wl:"p100",v1_de_d140205_ad_spk_ext1:"p101",v1_de_d140205_ad_r4_loc:"p102",v1_de_d140205_ad_r4_wl:"p103",v1_de_d140205_ad_r4_ext1:"p104",v1_cn_d140205_ad_spk_loc:"p105",v1_cn_d140205_ad_spk_wl:"p106",v1_cn_d140205_ad_spk_ext1:"p107",v1_cn_d140205_ad_r4_loc:"p108",v1_cn_d140205_ad_r4_wl:"p109",v1_cn_d140205_ad_r4_ext1:"p110",v1_jp_d140205_ad_spk_loc:"p111",v1_jp_d140205_ad_spk_wl:"p112",v1_jp_d140205_ad_spk_ext1:"p113",v1_jp_d140205_ad_r4_loc:"p114",v1_jp_d140205_ad_r4_wl:"p115",v1_jp_d140205_ad_r4_ext1:"p116",v1_und_d140205_ad_spk_ext1:"p117",v1_und_d140205_ad_spk_ext2:"p118",v1_und_d140205_ad_spk_ext3:"p119",v1_und_d140205_ad_spk_ext4:"p120",v1_und_d140205_ad_spk_ext5:"p121",v1_und_d140205_ad_spk_ext6:"p122",v1_und_d140205_ad_spk_ext7:"p123",v1_und_d140205_ad_spk_ext8:"p124",v1_und_d140205_ad_spk_ext9:"p125",v1_und_d140205_ad_r4_ext1:"p126",v1_und_d140205_ad_r4_ext2:"p127",v1_und_d140205_ad_r4_ext3:"p128",v1_und_d140205_ad_r4_ext4:"p129",v1_und_d140205_ad_r4_ext5:"p130",v1_und_d140205_ad_r4_ext6:"p131",v1_und_d140205_ad_r4_ext7:"p132",v1_und_d140205_ad_r4_ext8:"p133",v1_und_d140205_ad_r4_ext9:"p134",v1_us_d140205_ad_swms_win8:"p135",v1_us_d140205_ad_swms_1ba:"p136",v1_uk_d140205_ad_swms_opt1:"p137",v1_uk_d140205_ad_swms_opt2:"p138",v1_ca_d140205_ad_swms_opt1:"p139",v1_ca_d140205_ad_swms_opt2:"p140",v1_de_d140205_ad_swms_opt1:"p141",v1_de_d140205_ad_swms_opt2:"p142",v1_cn_d140205_ad_swms_opt1:"p143",v1_cn_d140205_ad_swms_opt2:"p144",v1_jp_d140205_ad_swms_opt1:"p145",v1_jp_d140205_ad_swms_opt2:"p146",v1_us_d140205_em_tr_opt1:"p147",v1_us_d140205_em_tr_opt2:"p148",v1_us_d140205_em_tr_opt3:"p149",v1_us_d140205_em_mm_bdc1:"p150",v1_us_d140205_em_mm_bdc2:"p151",v1_us_d140205_em_mm_bnc1:"p152",v1_us_d140205_em_mm_bnc2:"p153",v1_us_d140205_em_mm_pl1:"p154",v1_us_d140205_em_mm_pl2:"p155",v1_us_d140205_em_dl_opt1:"p156",v1_us_d140205_em_dl_opt2:"p157",v1_us_d140205_em_dl_opt3:"p158",v1_us_d140205_soc_fb_opt1:"p159",v1_us_d140205_soc_fb_opt2:"p160",v1_us_d140205_soc_tw_opt1:"p161",v1_us_d140205_soc_tw_opt2:"p162",v1_ext_d140205_ad_house_mb:"p163",v1_ext_d140205_ad_house_try:"p164",v1_ext_d140205_ext3_ext3_ext3:"p165",v1_ext_d140205_ext4_ext4_ext4:"p166",v1_ext_d140205_ext5_ext5_ext5:"p167",v1_ext_d140205_ext6_ext6_ext6:"p168",v1_ext_d140205_ext7_ext7_ext7:"p169","v1_ext_d140205_ext8_ext8_ext8 ":"p170",v1_ext_d140205_ext9_ext9_ext9:"p171",v1_ext_d140205_ext10_ext10_ext10:"p172",v1_ext_d140205_ext11_ext11_ext11:"p173",v1_ext_d140205_ext12_ext12_ext12:"p174","v1_ext_d140205_ext13_ext13_ext13 ":"p175",v1_ext_d140205_ext14_ext14_ext14:"p176",v1_ext_d140205_ext15_ext15_ext15:"p177",v1_ext_d140205_ext16_ext16_ext16:"p178",v1_ext_d140205_ext17_ext17_ext17:"p179",v1_us_d140205_ad_spk_5pr1:"p180",v1_us_d140205_ad_spk_5pr2:"p181",v1_us_d140205_ad_spk_5pr3:"p182",v1_us_d140205_ad_spk_5pr4:"p183",v1_us_d140205_ad_spk_5pr5:"p184",v1_us_d140205_ad_spk_5pr6:"p185",v1_us_d140205_ad_spk_5pr7:"p186",v1_us_d140205_ad_spk_5pr8:"p187",v1_us_d140205_ad_spk_5pr9:"p188",v1_us_d140205_ad_r4_5pr1:"p189",v1_us_d140205_ad_r4_5pr2:"p190",v1_us_d140205_ad_r4_5pr3:"p191",v1_us_d140205_ad_r4_5pr4:"p192",v1_us_d140205_ad_r4_5pr5:"p193",v1_us_d140205_ad_r4_5pr6:"p194",v1_us_d140205_ad_r4_5pr7:"p195",v1_us_d140205_ad_r4_5pr8:"p196",v1_us_d140205_ad_r4_5pr9:"p197",v1_us_d140205_ad_dl_5pr1:"p198",v1_us_d140205_ad_dl_5pr2:"p199",v1_us_d140205_ad_dl_5pr3:"p200",v1_us_d140205_em_tr_5pr1:"p201",v1_us_d140205_em_tr_5pr2:"p202",v1_us_d140205_em_tr_5pr3:"p203",v1_us_d140205_em_tr_5pr4:"p204",v1_us_d140205_em_nwECG_5pr:"p205",v1_us_d140205_em_nwECG_pco:"p206",v1_us_d140205_em_nw_5pr:"p207",v1_us_d140205_em_nw_pco:"p208",v1_us_d140205_em_lng_5pr:"p209",v1_us_d140205_em_36nc_5pr:"p210",v1_us_d140205_em_12nc_5pr:"p211",v1_us_d140205_em_ds990_5pr:"p212",v1_us_d140205_em_ds980_5pr:"p213",v1_us_d140205_em_ds970_5pr:"p214",v1_us_d140205_ad_fb_5prA:"p215",v1_us_d140205_ad_fb_pcoA:"p216",v1_us_d140205_ad_fb_5prB:"p217",v1_us_d140205_ad_fb_pcoB:"p218",v1_us_d140205_ad_fb_5prC:"p219",v1_us_d140205_ad_tw_5prA:"p220",v1_us_d140205_ad_tw_pcoA:"p221",v1_us_d140205_ad_tw_5prB:"p222",v1_us_d140205_ad_tw_pcoB:"p223",v1_us_d140205_ad_tw_5prC:"p224",v1_us_d140205_ad_dl_5prA:"p225",v1_us_d140205_ad_dl_5prB:"p226",v1_us_d140205_ad_dl_5prC:"p227",v1_us_d140205_ad_dl_5prD:"p228",v1_us_d140205_em_now1_5pr:"p229",v1_us_d140205_em_am990_5pr:"p230",v1_us_d140205_em_am980_5pr:"p231",v1_us_d140205_em_am970_5pr:"p232",v1_us_d140205_em_ec995_5pr:"p233",v1_us_d140205_em_ec990_5pr:"p234",v1_us_d140205_em_prECG_5pr:"p235",v1_us_d140205_em_prECG_pco:"p236",v1_us_d140205_em_pr_5pr:"p237",v1_us_d140205_em_pr_pco:"p238",v1_us_d140205_ext11_ext11_5pr:"p239",v1_us_d140205_ext12_ext12_5pr:"p240",v1_us_d140205_ext13_ext13_5pr:"p241",v1_us_d140205_ext14_ext14_5pr:"p242",v1_us_d140205_em_khg995_5pr:"p243",v1_us_d140205_em_khg990_5pr:"p244",v1_us_d140205_em_kmg995_5pr:"p245",v1_us_d140205_em_kmg990_5pr:"p246",v1_us_d140205_em_phg995_5pr:"p247",v1_us_d140205_em_phg990_5pr:"p248",v1_us_d140205_em_tbd_5pr:"p249",v1_cn_d140205_ext22_ext22_5pr:"p250",v1_cn_d140205_ex23_ext23_5pr:"p251",v1_cn_d140205_ext24_ext24_5pr:"p252",v1_cn_d140205_ext25_ext25_5pr:"p253",v1_cn_d140205_ext26_ext26_5pr:"p254",v1_cn_d140205_ext27_ext27_5pr:"p255",v1_cn_d140205_ext28_ext28_5pr:"p256",v1_cn_d140205_ext29_ext29_5pr:"p257",v1_cn_d140205_ext30_ext30_5pr:"p258",v1_cn_d140205_ext31_ext31_5pr:"p259",v1_cn_d140205_ext32_ext32_5pr:"p260",v1_cn_d140205_ext33_ext33_5pr:"p261",v1_cn_d140205_ext34_ext34_5pr:"p262",v1_cn_d140205_ext35_ext35_5pr:"p263",v1_cn_d140205_ext36_ext36_5pr:"p264",v1_cn_d140205_ext37_ext37_5pr:"p265",v1_cn_d140205_ext38_ext38_5pr:"p266",v1_cn_d140205_ext39_ext39_5pr:"p267",v1_ext_d140205_ad_house_5pr:"p268",v1_us_d140205_ext41_ext41_5pr:"p269",v1_us_d140205_ext42_ext42_5pr:"p270",v1_us_d140205_ext43_ext43_5pr:"p271",v1_us_d140205_ext44_ext44_5pr:"p272",v1_us_d140205_ext45_ext45_5pr:"p273",v1_us_d140205_ext46_ext46_5pr:"p274",v1_us_d140205_ext47_ext47_5pr:"p275",v1_us_d140205_ext48_ext48_5pr:"p276",v1_us_d140205_ext49_ext49_5pr:"p277",v1_us_d140205_ext50_ext50_5pr:"p278",v1_us_d150101_ad_p279:"p279",v1_us_d150101_ad_p280:"p280",v1_us_d150101_ad_p281:"p281",v1_us_d150101_ad_p282:"p282",v1_us_d150101_ad_p283:"p283",v1_us_d150101_ad_p284:"p284",v1_us_d150101_ad_p285:"p285",v1_us_d150101_ad_p286:"p286",v1_us_d150101_ad_p287:"p287",v1_us_d150101_ad_p288:"p288",v1_us_d150101_ad_p289:"p289",v1_us_d150101_ad_p290:"p290",v1_us_d150101_ad_p291:"p291",v1_us_d150101_ad_p292:"p292",v1_us_d150101_ad_p293:"p293",v1_us_d150101_ad_p294:"p294",v1_us_d150101_ad_p295:"p295",v1_us_d150101_ad_p296:"p296",v1_us_d150101_ad_p297:"p297",v1_us_d150101_ad_p298:"p298",v1_us_d150101_ad_p299:"p299",v1_us_d150101_ad_p300:"p300",v1_us_d150101_ad_p301:"p301",v1_us_d150101_ad_p302:"p302",v1_us_d150101_ad_p303:"p303",v1_us_d150101_ad_p304:"p304",v1_us_d150101_ad_p305:"p305",v1_us_d150101_ad_p306:"p306",v1_us_d150101_ad_p307:"p307",v1_us_d150101_ad_p308:"p308",v1_us_d150101_ad_p309:"p309",v1_us_d150101_ad_p310:"p310",v1_us_d150101_ad_p311:"p311",v1_us_d150101_ad_p312:"p312",v1_us_d150101_ad_p313:"p313",v1_us_d150101_ad_p314:"p314",v1_us_d150101_ad_p315:"p315",v1_us_d150101_ad_p316:"p316",v1_us_d150101_ad_p317:"p317",v1_us_d150101_ad_p318:"p318",v1_us_d150101_ad_p319:"p319",v1_us_d150101_ad_p320:"p320",v1_us_d150101_ad_p321:"p321",v1_us_d150101_ad_p322:"p322",v1_us_d150101_ad_p323:"p323",v1_us_d150101_ad_p324:"p324",v1_us_d150101_ad_p325:"p325",v1_us_d150101_ad_p326:"p326",v1_us_d150101_ad_p327:"p327",v1_us_d150101_ad_p328:"p328",v1_us_d150101_em_p329:"p329",v1_us_d150101_em_p330:"p330",v1_us_d150101_em_p331:"p331",v1_us_d150101_em_p332:"p332",v1_us_d150101_em_p333:"p333",v1_us_d150101_em_p334:"p334",v1_us_d150101_em_p335:"p335",v1_us_d150101_em_p336:"p336",v1_us_d150101_em_p337:"p337",v1_us_d150101_em_p338:"p338",v1_us_d150101_em_p339:"p339",v1_us_d150101_em_p340:"p340",v1_us_d150101_em_p341:"p341",v1_us_d150101_em_p342:"p342",v1_us_d150101_em_p343:"p343",v1_us_d150101_em_p344:"p344",v1_us_d150101_em_p345:"p345",v1_us_d150101_em_p346:"p346",v1_us_d150101_em_p347:"p347",v1_us_d150101_em_p348:"p348",v1_us_d150101_em_p349:"p349",v1_us_d150101_em_p350:"p350",v1_us_d150101_em_p351:"p351",v1_us_d150101_em_p352:"p352",v1_us_d150101_em_p353:"p353",v1_us_d150101_em_p354:"p354",v1_us_d150101_em_p355:"p355",v1_us_d150101_em_p356:"p356",v1_us_d150101_em_p357:"p357",v1_us_d150101_em_p358:"p358",v1_us_d150101_em_p359:"p359",v1_us_d150101_em_p360:"p360",v1_us_d150101_em_p361:"p361",v1_us_d150101_em_p362:"p362",v1_us_d150101_em_p363:"p363",v1_us_d150101_em_p364:"p364",v1_us_d150101_em_p365:"p365",v1_us_d150101_em_p366:"p366",v1_us_d150101_em_p367:"p367",v1_us_d150101_em_p368:"p368",v1_us_d150101_em_p369:"p369",v1_us_d150101_em_p370:"p370",v1_us_d150101_em_p371:"p371",v1_us_d150101_em_p372:"p372",v1_us_d150101_em_p373:"p373",v1_us_d150101_em_p374:"p374",v1_us_d150101_em_p375:"p375",v1_us_d150101_em_p376:"p376",v1_us_d150101_em_p377:"p377",v1_us_d150101_em_p378:"p378",v1_us_d141001_s100:"s100",v1_us_d141001_s101:"s101",v1_us_d141001_s102:"s102",v1_us_d141001_s103:"s103",v1_us_d141001_s104:"s104",v1_us_d141001_s105:"s105",v1_us_d141001_s106:"s106",v1_us_d141001_s107:"s107",v1_us_d141001_s108:"s108",v1_us_d141001_s109:"s109",v1_us_d141001_s110:"s110",v1_us_d141001_s111:"s111",v1_us_d141001_s112:"s112",v1_us_d141001_s113:"s113",v1_us_d141001_s114:"s114",v1_us_d141001_s115:"s115",v1_us_d141001_s116:"s116",v1_us_d141001_s117:"s117",v1_us_d141001_s118:"s118",v1_us_d141001_s119:"s119",v1_us_d141001_s120:"s120",v1_us_d141001_s121:"s121",v1_us_d141001_s122:"s122",v1_us_d141001_s123:"s123",v1_us_d141001_s124:"s124",v1_us_d141001_s125:"s125",v1_us_d141001_s126:"s126",v1_us_d141001_s127:"s127",v1_us_d141001_s128:"s128",v1_us_d141001_s129:"s129",v1_us_d141001_s130:"s130",v1_us_d141001_s131:"s131",v1_us_d141001_s132:"s132",v1_us_d141001_s133:"s133",v1_us_d141001_s134:"s134",v1_us_d141001_s135:"s135",v1_us_d141001_s136:"s136",v1_us_d141001_s137:"s137",v1_us_d141001_s138:"s138",v1_us_d141001_s139:"s139",v1_us_d141001_s140:"s140",v1_us_d141001_s141:"s141",v1_us_d141001_s142:"s142",v1_us_d141001_s143:"s143",v1_us_d141001_s144:"s144",v1_us_d141001_s145:"s145",v1_us_d141001_s146:"s146",v1_us_d141001_s147:"s147",v1_us_d141001_s148:"s148",v1_us_d141001_s149:"s149",v1_us_d141001_s150:"s150",v1_us_d141001_s151:"s151",v1_us_d141001_s152:"s152",v1_us_d141001_s153:"s153",v1_us_d141001_s154:"s154",v1_us_d141001_s155:"s155",v1_us_d141001_s156:"s156",v1_us_d141001_s157:"s157",v1_us_d141001_s158:"s158",v1_us_d141001_s159:"s159",v1_us_d141001_s160:"s160",v1_us_d141001_s161:"s161",v1_us_d141001_s162:"s162",v1_us_d141001_s163:"s163",v1_us_d141001_s164:"s164",v1_us_d141001_s165:"s165",v1_us_d141001_s166:"s166",v1_us_d141001_s167:"s167",v1_us_d141001_s168:"s168",v1_us_d141001_s169:"s169",v1_us_d141001_s170:"s170",v1_us_d141001_s171:"s171",v1_us_d141001_s172:"s172",v1_us_d141001_s173:"s173",v1_us_d141001_s174:"s174",v1_us_d141001_s175:"s175",v1_us_d141001_s176:"s176",v1_us_d141001_s177:"s177",v1_us_d141001_s178:"s178",v1_us_d141001_s179:"s179",v1_us_d141001_s180:"s180",v1_us_d141001_s181:"s181",v1_us_d141001_s182:"s182",v1_us_d141001_s183:"s183",v1_us_d141001_s184:"s184",v1_us_d141001_s185:"s185",v1_us_d141001_s186:"s186",v1_us_d141001_s187:"s187",v1_us_d141001_s188:"s188",v1_us_d141001_s189:"s189",v1_us_d141001_s190:"s190",v1_us_d141001_s191:"s191",v1_us_d141001_s192:"s192",v1_us_d141001_s193:"s193",v1_us_d141001_s194:"s194",v1_us_d141001_s195:"s195",v1_us_d141001_s196:"s196",v1_us_d141001_s197:"s197",v1_us_d141001_s198:"s198",v1_us_d141001_s199:"s199"},tagBaseToPartnerIdMap:{"abba-chrome":"amazon1","abba-ubp":"amazon1","abba-smile-ubp":"amazon1","abba-smile-chrome":"amazon1","acer-ubp":"acer1","dell-ubpm":"dell1","msi-ubp":"msi1","pokki-ubpm":"pokki1","toshiba-ubpm":"toshiba1","opera-preload":"opera1","bds-p10":"bds10","bds-p12":"bds12","bds-p14":"bds14","bds-p16":"bds16","bds-p17":"bds17","bds-p18":"bds18","bds-p32":"bds32","bds-p33":"bds33","bds-p06":"bds6","bds-p07":"bds7","bds-p08":"bds8","bds-p6":"bds6","bds-p7":"bds7","bds-p8":"bds8","bds-p":"bdsamzn","bds-y":"bdsamzn","bds-p9":"bdsamzn","bds-p09":"bdsamzn","bds-p11":"bdsamzn","bds-p13":"bdsamzn","bds-p15":"bdsamzn","bds-p19":"bdsamzn","bds-p20":"bdsamzn","bds-p21":"bdsamzn","bds-p22":"bdsamzn","bds-p23":"bdsamzn","bds-p24":"bdsamzn","bds-p25":"bdsamzn","bds-p26":"bdsamzn","bds-p27":"bdsamzn","bds-p28":"bdsamzn","bds-p29":"bdsamzn","bds-p30":"bdsamzn","bds-p31":"bdsamzn","bds-p34":"bdsamzn","bds-p35":"bdsamzn","bds-p36":"bdsamzn","bds-p37":"bdsamzn","bds-p38":"bdsamzn","bds-p39":"bdsamzn","bds-p40":"bdsamzn","bds-p41":"bdsamzn","bds-p42":"bdsamzn","bds-p43":"bdsamzn","bds-p44":"bdsamzn","bds-p45":"bdsamzn","bds-p46":"bdsamzn","bds-p47":"bdsamzn","bds-p48":"bdsamzn","bds-p49":"bdsamzn","bds-p50":"bdsamzn","bds-y06":"bdsamzn","bds-y07":"bdsamzn","bds-y08":"bdsamzn","bds-y09":"bdsamzn","bds-y10":"bdsamzn","bds-y11":"bdsamzn","bds-y12":"bdsamzn","bds-y13":"bdsamzn","bds-y14":"bdsamzn","bds-y15":"bdsamzn","bds-y16":"bdsamzn","bds-y17":"bdsamzn","bds-y18":"bdsamzn","bds-y19":"bdsamzn","bds-y20":"bdsamzn","bds-y21":"bdsamzn","bds-y22":"bdsamzn","bds-y23":"bdsamzn","bds-y24":"bdsamzn","bds-y25":"bdsamzn","bds-y26":"bdsamzn","bds-y27":"bdsamzn","bds-y28":"bdsamzn","bds-y29":"bdsamzn","bds-y30":"bdsamzn","bds-y31":"bdsamzn","bds-y32":"bdsamzn","bds-y33":"bdsamzn","bds-y34":"bdsamzn","bds-y35":"bdsamzn","bds-y36":"bdsamzn","bds-y37":"bdsamzn","bds-y38":"bdsamzn","bds-y39":"bdsamzn","bds-y40":"bdsamzn","bds-y41":"bdsamzn","bds-y42":"bdsamzn","bds-y43":"bdsamzn","bds-y44":"bdsamzn","bds-y45":"bdsamzn","bds-y46":"bdsamzn","bds-y47":"bdsamzn","bds-y48":"bdsamzn","bds-y49":"bdsamzn","bds-y50":"bdsamzn","bds-amzn":"bdsamzn","abba-swp":"amazon1","abba-smile":"amazon1","abba-opera":"amazon1","ubp-sg":"amazon1","ubp-wl":"amazon1","abba-ie":"amazon1",abba:"amazon1","abba-metro":"amazon1","lenovo-abb":"lenovo1","acer-abb":"acer1",taisus:"toshiba1",taisla:"toshiba1",taiseu:"toshiba1","dell-abb":"dell1","dell-ubp":"dell1","gateway-abb":"acer1","packardbell-abb":"acer1","lenovo-ubp":"lenovo1","lenovo-metro":"lenovometro1","lenovo-ubpm":"lenovo1","toshiba-ubp":"toshiba1","pokki-ubpl":"pokki1","pokki-ubp":"pokki1","realnetworks-abb":"realnet","downloads-com-abb":"downloads1","hp-ubp":"hp1","ubuntu-ubp":"ubuntu1","abba-ubuntu":"ubuntu1","tsh02-ubp":"toshiba1","tsh02-ubpm":"toshiba1","slp-ubp":"sleipnir1","baid-ubp":"baid1","bitc-catch":"amazon1","moz-ubp":"mozilla1","moz-lt":"mozilla1","hp-metro":"hpmetro1","hp2-metro":"hpmetro1","nokia-metro":"nokia1","acer-metro":"acermetro1","acer-ubpm":"acer1","asus-metro":"asusmetro1","toshiba-metro10":"toshibametro1","toshiba-ubp3":"toshiba1","toshiba-metro":"toshiba1","dell-metro":"dellmetro1","fujitsu-metro":"fujitsumetro1","fujitsu-ubp":"fujitsumetro1","fujitsu-ubpm":"fujitsumetro1","sony-metro":"sonymetro1","sony-abb":"sony1"},partnerRequiringTOUMap:{amazon1:"false",avast1:"true",acer1:"true",dell1:"true",lenovo1:"true",mozilla1:"true",msi1:"true",opera1:"false",pokki1:"true",toshiba1:"true",sleipnir1:"true",samsung1:"true"},PostSetupConfig:[{key:"ubpv2.extension.firstTimeSetupCompleted",value:"true"}]}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/FirstTimeSetupConfiguration",[],factory),define("ubp/extension/firstTimeSetup/FirstTimeSetup",["require","exports","lib/lodash","lib/bluebird","../../commons/logging/Logger","../../commons/error/InternalError","../../commons/error/ConflictError","../storage/StorageManager","../storage/StorageType","configuration/FirstTimeSetupConfiguration","configuration/GlobalParameters"],function(e,t,r,n,o,i,a,s,u,c,l){"use strict";return function(){function e(t,r){this._isStarted=!1,this._alreadySetup=!1,this._storageTypeToKeysQueryMap={},this._storageManager=t||s.getInstance(),this._firstTimeSetupConfiguration=r||c.getConfiguration(),this._initStorageTypeToKeyValueMap(),this._initStorageTypeToKeysQueryMap(),e.logger=e.logger||o.getLogger("FirstTimeSetup")}return e.prototype._initStorageTypeToKeyValueMap=function(){this._storageTypeToKeyValueMap={},this._storageTypeToKeyValueMap[u[u.EXTENSION_STORAGE]]={},this._storageTypeToKeyValueMap[u[u.LOCAL_STORAGE]]={},this._storageTypeToKeyValueMap[u[u.PREFERENCES_STORAGE]]={},this._storageTypeToKeyValueMap[u[u.AMAZON_COM_LOCAL_STORAGE]]={}},e.prototype._initStorageTypeToKeysQueryMap=function(){this._storageTypeToKeysQueryMap={},this._storageTypeToKeysQueryMap[u[u.EXTENSION_STORAGE]]=[],this._storageTypeToKeysQueryMap[u[u.LOCAL_STORAGE]]=[],this._storageTypeToKeysQueryMap[u[u.PREFERENCES_STORAGE]]=[],this._storageTypeToKeysQueryMap[u[u.AMAZON_COM_LOCAL_STORAGE]]=[]},e.prototype.start=function(){var t=this;if(this._isStarted){var r=new a("FirstTimeSetup module has already started");return e.logger.error("start",r.toString()),n.reject(r)}return n.bind(this).then(function(){if(!t._firstTimeSetupConfiguration||!t._firstTimeSetupConfiguration.data||!t._firstTimeSetupConfiguration.data.FirstTimeSetupExistenceCheck){var r=new i("FirstTimeSetup module could not find configuration for existence check");throw e.logger.error("start",r.toString()),r}return t._isFirstTimeSetupComplete(t._firstTimeSetupConfiguration.data.FirstTimeSetupExistenceCheck)}).then(function(r){t._alreadySetup=r,r||e.logger.debug("start","First time setup is needed, proceeding with the fist time setup"),t._isStarted=!0})},e.prototype.stop=function(){this._initStorageTypeToKeyValueMap(),this._initStorageTypeToKeysQueryMap(),this._alreadySetup=!1,this._isStarted=!1},e.prototype.firstTimeSetup=function(){var t=this;if(!this._isStarted){var r=new a("FirstTimeSetup module has not yet started");return e.logger.error("firstTimeSetup",r.toString()),n.reject(r)}return this._alreadySetup?(e.logger.debug("firstTimeSetup","First time setup is not required, already done"),n.resolve()):n.bind(this).then(function(){if(!t._firstTimeSetupConfiguration||!t._firstTimeSetupConfiguration.data||!t._firstTimeSetupConfiguration.data.FirstTimeSetupKeyConfig){var r=new i("FirstTimeSetup module could not find configuration for setup");throw e.logger.error("firstTimeSetup",r.toString()),r}return t._doFirstTimeSetup(t._firstTimeSetupConfiguration.data.FirstTimeSetupKeyConfig)}).then(function(){return t._firstTimeSetupConfiguration&&t._firstTimeSetupConfiguration.data&&t._firstTimeSetupConfiguration.data.PostSetupConfig?t._doPostSetupActivities(t._firstTimeSetupConfiguration.data.PostSetupConfig):n.resolve()}).then(function(){e.logger.debug("firstTimeSetup","First time setup completed")})},e.prototype._doPostSetupActivities=function(t){var r=this,o=[];return n.bind(this).then(function(){for(var i in t)o.push(r._storageManager.set(e._DEFAULT_STORAGE_TYPE,t[i].key,t[i].value));return n.all(o)}).then(function(e){})},e.prototype._getAllMainKeyValuesFromExtensionStorage=function(t){var o=this,i=u[u.EXTENSION_STORAGE],a=[];return n.bind(this).then(function(){return r.each(t,function(e){a.push(e.key)}),e.logger.debug("_getAllMainKeyValuesFromExtensionStorage"," Keys to retrieve =>"+JSON.stringify(a)),o._storageManager.bulkGet(u.EXTENSION_STORAGE,a)}).then(function(e){if(e)for(var t in a){var r=a[t];o._storageTypeToKeyValueMap[i][r]=e[r]}})},
e.prototype._retrieveKeysForAllStorageTypes=function(e){var t=this,o=u[u.EXTENSION_STORAGE],i={LOCAL_STORAGE:u[u.LOCAL_STORAGE],PREFERENCES_STORAGE:u[u.PREFERENCES_STORAGE],AMAZON_COM_LOCAL_STORAGE:u[u.AMAZON_COM_LOCAL_STORAGE],EXTENSION_STORAGE:u[u.EXTENSION_STORAGE]};return n.bind(this).then(function(){for(var n in e){var a=e[n].key,s=t._storageTypeToKeyValueMap[o][a];e[n].value;if(!s){var u=e[n].storageKeyConfig;for(var n in u){var c=u[n].retrievalType,l=u[n].keys,p=i[c];p&&(t._storageTypeToKeysQueryMap[p]=r.union(t._storageTypeToKeysQueryMap[p],l))}}}return t._retrieveValuesForAllStorageTypes()})},e.prototype._retrieveValuesForAllStorageTypes=function(){var e=this,t=(u[u.AMAZON_COM_LOCAL_STORAGE],u[u.PREFERENCES_STORAGE]),o=u[u.LOCAL_STORAGE],i=u[u.EXTENSION_STORAGE];return n.bind(this).then(function(){return e._storageTypeToKeysQueryMap[o].length>0?e._storageManager.bulkGet(u.LOCAL_STORAGE,e._storageTypeToKeysQueryMap[o]):n.cast({})}).then(function(i){return i&&r.forEach(i,function(t,r){e._storageTypeToKeyValueMap[o][r]=t}),e._storageTypeToKeysQueryMap[t].length>0?e._storageManager.bulkGet(u.PREFERENCES_STORAGE,e._storageTypeToKeysQueryMap[t]):n.cast({})}).then(function(o){return o&&r.forEach(o,function(r,n){e._storageTypeToKeyValueMap[t][n]=r}),e._storageTypeToKeysQueryMap[i].length>0?e._storageManager.bulkGet(u.EXTENSION_STORAGE,e._storageTypeToKeysQueryMap[i]):n.cast({})}).then(function(t){return t&&r.forEach(t,function(t,r){e._storageTypeToKeyValueMap[i][r]=t}),e._retrieveNonExpiredValuesFromAmazonComLocalStorage()})},e.prototype._retrieveNonExpiredValuesFromAmazonComLocalStorage=function(){var t=this,o=u[u.AMAZON_COM_LOCAL_STORAGE];return n.bind(this).then(function(){return t._storageTypeToKeysQueryMap[o].length>0?t._storageManager.bulkGet(u.AMAZON_COM_LOCAL_STORAGE,t._storageTypeToKeysQueryMap[o]):n.cast({})}).then(function(n){n&&r.forEach(n,function(n,i){var a;try{a=JSON.parse(n)}catch(t){e.logger.error("_retrieveNonExpiredValuesFromAmazonComLocalStorage","Unable to parse the value ["+n+"] for key ["+i+"] error => "+t)}a&&r.isArray(a)&&a[0]&&a[1]&&r.isNumber(a[1])&&a[1]-Date.now()>=0&&(t._storageTypeToKeyValueMap[o][i]=a[0])})}).catch(function(t){e.logger.error("_retrieveNonExpiredValuesFromAmazonComLocalStorage","There was an error while reading from amazon.com local storage values,first time setup will continue, but this failure needs to be addressed "+JSON.stringify(t))})},e.prototype._doFirstTimeSetup=function(t){var r=this,o=[];return n.bind(this).then(function(){return r._getAllMainKeyValuesFromExtensionStorage(t)}).then(function(){return r._retrieveKeysForAllStorageTypes(t)}).then(function(){e.logger.debug("_doFirstTimeSetup"," storage specific map _storageTypeToKeyValueMap =>"+JSON.stringify(r._storageTypeToKeyValueMap));for(var i in t)o.push(r._handleFirstTimeSetupForKey(t[i].key,t[i].value,t[i].defaultValue,t[i].storageKeyConfig));return n.all(o)}).then(function(e){})},e.prototype._handleFirstTimeSetupForKey=function(t,r,o,i){var a=this,s=!1;return n.bind(this).then(function(){var c=a._storageTypeToKeyValueMap[u[u.EXTENSION_STORAGE]][t],l=[];if(c)s=!0;else if(s=!1,r)l.push(r);else for(var p in i){var f=i[p].retrievalType,_=i[p].keys,d=i[p].overrideValue,g=i[p].mapping,h=i[p].constraints;l.push(a._retrieveValueForKey(f,_,d,g,h))}var c=a._retrieveFirstValidValueFromArray(l)||o;return c&&!1===s?(e.logger.debug("_handleFirstTimeSetupForKey","Storing key after getting the mapping ["+t+"] = "+c),a._storageManager.set(e._DEFAULT_STORAGE_TYPE,t,c)):n.cast("")}).then(function(e){})},e.prototype._retrieveValueForKey=function(t,r,n,o,i){var a=[];switch(e.logger.debug("_retrieveValueForKey","retrieving keys => "+JSON.stringify(r)),t){case"LOCAL_STORAGE":for(var s in r)a.push(this._storageTypeToKeyValueMap[u[u.LOCAL_STORAGE]][r[s]]);break;case"PREFERENCES_STORAGE":for(var s in r)a.push(this._storageTypeToKeyValueMap[u[u.PREFERENCES_STORAGE]][r[s]]);break;case"GlobalParameters":for(var s in r)a.push(l.getGlobalParameters()[r[s]]);break;case"AMAZON_COM_LOCAL_STORAGE":for(var s in r)a.push(this._storageTypeToKeyValueMap[u[u.AMAZON_COM_LOCAL_STORAGE]][r[s]]);break;case"EXTENSION_STORAGE":for(var s in r)a.push(this._storageTypeToKeyValueMap[u[u.EXTENSION_STORAGE]][r[s]]);break;default:e.logger.debug("_retrieveValueForKey","Unsupported storage type ["+t+"], ignoring")}var c=this._retrieveFirstValidValueFromArray(a);return c&&n?n:(c&&i&&i.matches&&(c=c===i.matches?"true":"false"),c&&o&&this._firstTimeSetupConfiguration&&this._firstTimeSetupConfiguration.data&&this._firstTimeSetupConfiguration.data[o]&&(c=this._firstTimeSetupConfiguration.data[o][c]||c),c)},e.prototype._isFirstTimeSetupComplete=function(t){var o=this,a=[];return n.bind(this).then(function(){for(var e in t){var r=t[e];a.push(o._matchesStorageValueForKey(r.key,r.value))}return n.all(a)}).then(function(e){return r.every(e)}).then(function(e){return e}).catch(function(t){var r=new i("Unable to check for existence ["+t+"]");return e.logger.error("_isFirstTimeSetupComplete",r.toString()),n.reject(r)})},e.prototype._matchesStorageValueForKey=function(e,t){var r=this;return n.bind(this).then(function(){return r._readComplexStorageValue(e)}).then(function(e){return t===e})},e.prototype._readComplexStorageValue=function(t){var r,o=this;return n.bind(this).then(function(){return r=t.split("/"),o._storageManager.get(e._DEFAULT_STORAGE_TYPE,r[0])}).then(function(e){if(!e)return e;var t=e;if(r.length>1){t=JSON.parse(e);for(var n=1;n<r.length;n++){if(!t[r[n]]){t=void 0;break}t=t[r[n]]}}return"string"!=typeof t?JSON.stringify(t):t})},e.prototype._retrieveFirstValidValueFromArray=function(e){for(var t in e)if(e[t]&&"string"==typeof e[t])return e[t];return""},e._DEFAULT_STORAGE_TYPE=u.EXTENSION_STORAGE,e}()});var factory=function(){"use strict";var e=function(){};return e.getSentryConfiguration=function(){return{version:"6-20-15",configuration:{US:{remoteConfigurationEndpoint:"https://ubp-common-us-prod.s3.amazonaws.com/sentry/sentry-config.json"},CA:{remoteConfigurationEndpoint:"https://ubp-common-ca-prod.s3.amazonaws.com/sentry/sentry-config.json"},UK:{remoteConfigurationEndpoint:"https://ubp-common-uk-prod.s3.amazonaws.com/sentry/sentry-config.json"},DE:{remoteConfigurationEndpoint:"https://ubp-common-de-prod.s3.amazonaws.com/sentry/sentry-config.json"},FR:{remoteConfigurationEndpoint:"https://ubp-common-fr-prod.s3.amazonaws.com/sentry/sentry-config.json"},IT:{remoteConfigurationEndpoint:"https://ubp-common-it-prod.s3.amazonaws.com/sentry/sentry-config.json"},JP:{remoteConfigurationEndpoint:"https://ubp-common-jp-prod.s3.amazonaws.com/sentry/sentry-config.json"},CN:{remoteConfigurationEndpoint:"https://ubp-common-cn-prod.s3.cn-north-1.amazonaws.com.cn/sentry/sentry-config.json"},ES:{remoteConfigurationEndpoint:"https://ubp-common-es-prod.s3.amazonaws.com/sentry/sentry-config.json"},IN:{remoteConfigurationEndpoint:"https://ubp-common-in-prod.s3.amazonaws.com/sentry/sentry-config.json"},MX:{remoteConfigurationEndpoint:"https://ubp-common-mx-prod.s3.amazonaws.com/sentry/sentry-config.json"},AE:{remoteConfigurationEndpoint:"https://ubp-common-ae-prod.s3.amazonaws.com/sentry/sentry-config.json"},TR:{remoteConfigurationEndpoint:"https://ubp-common-tr-prod.s3.amazonaws.com/sentry/sentry-config.json"},BR:{remoteConfigurationEndpoint:"https://ubp-common-br-prod.s3.amazonaws.com/sentry/sentry-config.json"},AU:{remoteConfigurationEndpoint:"https://ubp-common-au-prod.s3.amazonaws.com/sentry/sentry-config.json"}}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/SentryConfiguration",[],factory),define("ubp/extension/bootstrapper/ExtensionState",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.NEW=1]="NEW",e[e.STARTING=2]="STARTING",e[e.STARTED=3]="STARTED",e[e.CAN_RESTART=4]="CAN_RESTART",e[e.RESTARTING=5]="RESTARTING",e[e.INITIALIZING=6]="INITIALIZING",e[e.FAILED=7]="FAILED"}(r||(r={})),r}),define("ubp/extension/configuration/RemoteConfigurationPuller",["require","exports","lib/bluebird","lib/lodash","../../commons/messaging/clients/network/HTTPMethod","../../commons/error/ConflictError","../../commons/logging/Logger"],function(e,t,r,n,o,i,a){"use strict";return function(){function e(t,r){this._isStarted=!1,this._currentETag=null,this._looperResolver=null,this._looperPromise=null,this._remoteConfigurationData=null,e.logger=e.logger||a.getLogger("ConfigurationPuller"),this._networkClient=t,this._runtime=r}return e.prototype.start=function(t){var n=this;return r.bind(this).then(function(){if(n._isStarted){var o=new i("This RemoteConfigurationPuller has already been started and can only be started once.");throw e.logger.error("start",o.toString()),o}return t&&t.configName&&t.endPoint?n.pullRemoteConfig(t):r.resolve({})}).then(function(){return n._isStarted=!0,e.logger.info("start","RemoteConfigurationPuller started"),n.getRemoteConfiguration()})},e.prototype.stop=function(){var e=this;return r.bind(this).then(function(){return e.stopPullRemoteConfigLooper()}).catch(function(e){}).then(function(){e._currentETag=null,e._looperPromise=null,e._looperResolver=null,e._looperTimeoutId=void 0,e._remoteConfigurationData=null,e._isStarted=!1})},e.prototype.getRemoteConfiguration=function(){if(null===this._remoteConfigurationData){var t=new i("Must call RemoteConfigurationPuller once successfully before using this method");throw e.logger.error("getRemoteConfiguration",t.toString()),t}return n.cloneDeep(this._remoteConfigurationData)},e.prototype.startPullRemoteConfigLooper=function(t,n){var o=this;return r.bind(this).then(function(){if(!o._looperResolver||o._looperResolver.promise.isResolved())return e.logger.debug("startPullRemoteConfigLooper","Starting remote config data looper"),o._looperResolver=r.defer(),o._scheduleLooper(t,n),o._looperResolver.promise;var i=new Error("Remote configuration data looper is already started or looper has stopped");throw e.logger.error("startPullRemoteConfigLooper",i.toString()),i})},e.prototype.stopPullRemoteConfigLooper=function(){var t=this;return r.bind(this).then(function(){if(!t._looperResolver||!t._looperResolver.promise.isPending()){var r=new Error("Attempting to stop looper which is already stopped, never started, or not cancellable.");throw e.logger.error("stopPullRemoteConfigLooper",r.toString()),r}if(t._looperPromise&&t._looperPromise.isPending()&&t._looperPromise.isCancellable())return e.logger.debug("stopPullRemoteConfigLooper","Attempting to cancel looper"),t._looperPromise.cancel()}).then(function(){return t._runtime.clearTimeout(t._looperTimeoutId),t._looperResolver.resolve(),t._looperResolver.promise})},e.prototype.pullRemoteConfig=function(t){var n=this;return r.bind(this).then(function(){var e=n._buildNetworkConfiguration(t);return n._networkClient.request(t.endPoint,e)}).then(function(r){var o=n._getValueFromResponseHeader(r.headers,e.ETAG_KEY);if(void 0===o){var i=new Error("No ETag was found for the request");throw e.logger.error("pullPlatformAPIConfig",i.toString(),"Response headers: "+JSON.stringify(r.headers)),i}o!==n._currentETag&&(e.logger.debug("pullPlatformAPIConfig","Feature Manifest List has been Updated"),n._currentETag=o,n._remoteConfigurationData=r.data,n._runtime.setRemoteConfigurationRawData(t.configName,n._remoteConfigurationData),n._runtime.processRemoteConfigurationData(t.configName))})},e.prototype._pullRemoteConfigLooper=function(t,n){this._looperPromise=r.bind(this).cancellable().then(function(){return this.pullRemoteConfig(t)}).then(function(){this._scheduleLooper(t,n)}).catch(function(r){"CancellationError"===r.name?this._looperResolver.resolve():(e.logger.error("_pullRemoteConfigLooper","pullRemoteConfig threw an error, rescheduling: "+r.message),this._scheduleLooper(t,n))})},e.prototype._scheduleLooper=function(e,t){this._runtime.clearTimeout(this._looperTimeoutId),this._looperTimeoutId=this._runtime.setTimeout(n.bind(function(){this._pullRemoteConfigLooper(e,t)},this),t)},e.prototype._getValueFromResponseHeader=function(e,t){var r;return n.forEach(e,function(e,n){if(n&&t&&n.toLowerCase()===t.toLowerCase())return r=e,!1}),r},e.prototype._buildNetworkConfiguration=function(t){return{httpMethod:o.GET,responseType:t&&t.responseType?t.responseType:e.DEFAULT_NETWORK_RESPONSE_TYPE,timeout:e.NETWORK_TIMEOUT_MILLIS,maxAttempts:e.MAX_ATTEMPTS,backoffFactor:e.BACKOFF_FACTOR,initialRetryInterval:e.INITIAL_RETRY_INTERVAL}},e.ETAG_KEY="etag",e.NETWORK_TIMEOUT_MILLIS=3e4,e.MAX_ATTEMPTS=10,e.BACKOFF_FACTOR=2,e.INITIAL_RETRY_INTERVAL=1e3,e.DEFAULT_NETWORK_RESPONSE_TYPE="json",e}()}),define("ubp/extension/configuration/RemoteConfigurationManager",["require","exports","lib/bluebird","lib/lodash","../../commons/logging/Logger","../../commons/localization/Locale","../../commons/error/ConflictError","../../commons/error/BadRequestError","./RemoteConfigurationPuller","configuration/GlobalParameters"],function(e,t,r,n,o,i,a,s,u,c){"use strict";return function(){function e(t,r,n,o,a,s){void 0===a&&(a={}),void 0===s&&(s=c.getGlobalParameters().browser),this.runtime=n,this.remoteConfigurationPullerError=null,this._isStarted=!1,this._remoteConfiguration=t,this._localeManager=r,this._locale=i.US,this._networkClient=o,this._refreshRate=e.REMOTE_CONFIGURATION_REFRESH_INTERVAL,this._remoteConfigurationPullerMap=a,this._browserName=s}return e.prototype.start=function(){var t=this;if(this._isStarted){var o=new a("This RemoteConfigurationManager has already been started and can only be started once.");return e.logger.error("start",o.toString()),r.reject(o)}return this._remoteConfiguration[this._browserName]?r.bind(this).then(function(){return t._localeManager.getLocale()}).then(function(e){t._locale=e,t._configFilter=t._getRemotePullerConfig();var o=[];return n.each(t._configFilter,function(e){t._remoteConfigurationPullerMap[e.configName]||(t._remoteConfigurationPullerMap[e.configName]=new u(t._networkClient,t.runtime)),o.push(t._remoteConfigurationPullerMap[e.configName].start(e))}),r.all(o)}).then(function(r){n.each(t._configFilter,function(e){t._startRemoteConfigurationPullerLooper(e,t._refreshRate)}),t._isStarted=!0,e.logger.info("start","RemoteConfigurationManager started")}):(e.logger.debug("start","This runtime: "+this.runtime+"does not have anything to pull from remote"),r.resolve())},e.prototype.stop=function(){var e=this;return r.bind(this).then(function(){var t=[];return n.each(e._remoteConfigurationPullerMap,function(r,n){t.push(e._remoteConfigurationPullerMap[n].stop())}),r.all(t)}).then(function(){e._locale=i.US,e._isStarted=!1})},e.prototype._startRemoteConfigurationPullerLooper=function(t,n){var o=this;return void 0===n&&(n=e.REMOTE_CONFIGURATION_REFRESH_INTERVAL),this.remoteConfigurationPullerError=null,r.bind(this).then(function(){return o._remoteConfigurationPullerMap[t.configName].startPullRemoteConfigLooper(t,n)}).catch(function(t){e.logger.error("_startRemoteConfigurationPullerLooper","Remote Configuration Puller failed with error: "+t.message),o.remoteConfigurationPullerError=t})},e.prototype._getRemotePullerConfig=function(){if(this._remoteConfiguration[this._browserName]&&this._remoteConfiguration[this._browserName].configuration&&this._remoteConfiguration[this._browserName].version){this._refreshRate=this._remoteConfiguration[this._browserName].refreshRate||this._refreshRate;var t=i[this._locale];e.logger.debug("_getRemotePullerConfig","Using locale: "+t);var r;if(r=this._remoteConfiguration[this._browserName].configuration[t],e.logger.debug("_getRemotePullerConfig","Using locale specific config: "+JSON.stringify(r)),!r){var n=new a("Remote configuration does not have configuration for "+t+" locale");throw e.logger.error("_getRemotePullerConfig",n.toString()),n}return r}var o=new s("The remote configuration is not correct, check the remote configuration!");throw e.logger.error("_getRemotePullerConfig",o.toString()),o},e.prototype.getLocale=function(){var t=this;if(!this._isStarted){var n=new Error("You must start this RemoteConfigurationManager before making any method calls.");return e.logger.error("getLocale",n.toString()),r.reject(n)}return r.bind(this).then(function(){return t._locale})},e.prototype.setLocale=function(t){var o=this;if(!this._isStarted){var i=new Error("You must start this RemoteConfigurationManager before making any method calls.");return e.logger.error("setLocale",i.toString()),r.reject(i)}return this._locale===t?r.resolve():r.bind(this).then(function(){o._locale=t;var e=[];return n.each(o._remoteConfigurationPullerMap,function(t,r){e.push(o._remoteConfigurationPullerMap[r].stopPullRemoteConfigLooper())}),e}).catch(function(t){e.logger.debug("setLocale",JSON.stringify(t))}).then(function(){if(o._configFilter=o._getRemotePullerConfig(),o._configFilter){e.logger.debug("setLocale","Restarting remote configuration puller with new endpoint");var t=[];return n.each(o._configFilter,function(e){t.push(o._startRemoteConfigurationPullerLooper(e)),t.push(o._remoteConfigurationPullerMap[e.configName].pullRemoteConfig(e))}),r.all(t)}}).then(function(){return r.resolve()})},e.logger=o.getLogger("RemoteConfigurationManager"),e.REMOTE_CONFIGURATION_REFRESH_INTERVAL=108e5,e}()});var factory=function(){"use strict";var e=function(){};return e.getRemoteConfiguration=function(){return{chrome:{version:"05-16-16",refreshRate:144e5,configuration:{US:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-us-west-2.amazonaws.com/ubp-ubpextension-us-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],UK:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-eu-west-1.amazonaws.com/ubp-ubpextension-uk-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],JP:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-ap-northeast-1.amazonaws.com/ubp-ubpextension-jp-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],IT:[{configName:"PlatformApiConfiguration",endPoint:"https://s3.eu-central-1.amazonaws.com/ubp-ubpextension-it-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],FR:[{configName:"PlatformApiConfiguration",endPoint:"https://s3.eu-central-1.amazonaws.com/ubp-ubpextension-fr-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],ES:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-sa-east-1.amazonaws.com/ubp-ubpextension-es-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],DE:[{configName:"PlatformApiConfiguration",endPoint:"https://s3.eu-central-1.amazonaws.com/ubp-ubpextension-de-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],CA:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-us-west-2.amazonaws.com/ubp-ubpextension-ca-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],IN:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-ap-southeast-1.amazonaws.com/ubp-ubpextension-in-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],CN:[{configName:"PlatformApiConfiguration",endPoint:"https://s3.cn-north-1.amazonaws.com.cn/ubp-ubpextension-cn-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],MX:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-us-west-2.amazonaws.com/ubp-ubpextension-mx-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],AE:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-eu-west-2.amazonaws.com/ubp-ubpextension-ae-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],TR:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-eu-west-2.amazonaws.com/ubp-ubpextension-tr-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],BR:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-sa-east-1.amazonaws.com/ubp-ubpextension-br-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}],AU:[{configName:"PlatformApiConfiguration",endPoint:"https://s3-us-west-2.amazonaws.com/ubp-ubpextension-au-prod/configuration/chrome/PlatformApiConfiguration.json",responseType:"json"}]}}}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/RemoteConfiguration",[],factory),define("ubp/extension/platform/cookie/SyncCookieRequestConfig",["require","exports","../../../commons/messaging/clients/network/HTTPMethod"],function(e,t,r){"use strict";return function(){function e(t){this.timeout=e.NETWORK_TIMEOUT,this.maxAttempts=e.MAX_ATTEMPTS,this.httpMethod=r.POST,this.headers={"Content-Encoding":"amz-1.0","Content-Type":"application/json; charset=UTF-8","X-Amz-Date":e._GetHTTPHeaderDateString(),"X-Amz-Target":e.X_AMZ_TARGT},this.data=t?JSON.stringify(t):void 0}return e.MAX_ATTEMPTS=1,e.NETWORK_TIMEOUT=1e3,e.X_AMZ_TARGT="com.amazon.model.cookie.service.CookieInstallService.InstallCookie",e._GetHTTPHeaderDateString="function"==typeof Date.prototype.toISOString?function(){return(new Date).toISOString()}:function(){return(new Date).toUTCString()},e}()}),define("ubp/commons/cookie/SessionCookieNameProvider",["require","exports"],function(e,t){"use strict";return function(){function e(t){if(!t)throw new Error("Caller must a valid value for locale.");this._locale=t.toLowerCase();var r;r=this._locale===e._UsLocale?e._UsCookieSuffix:e._NonUsCookieSuffix.concat(this._locale),this._customerIdCookieName=e._CustomerIdCookiePrefix.concat(r),this._ubidCookieName=e._UbidCookiePrefix.concat(r)}return e.prototype.sessionIdCookieName=function(){return e._SessionIdCookie},e.prototype.customerIdCookieName=function(){return this._customerIdCookieName},e.prototype.ubidCookieName=function(){return this._ubidCookieName},e._CustomerIdCookiePrefix="x",e._UbidCookiePrefix="ubid",e._UsLocale="us",e._UsCookieSuffix="-main",e._NonUsCookieSuffix="-acb",e._SessionIdCookie="session-id",e}()}),define("ubp/extension/platform/cookie/SyncCookieConfigurationManager",["require","exports","lib/lodash","lib/bluebird","../../../commons/messaging/clients/network/HTTPMethod"],function(e,t,r,n,o){"use strict";return function(){function e(){if(this._networkClient=null,this._timer=null,this._refreshTimerId=null,this._refreshInterval=null,e._instance)throw new Error("Error: Instantiation failed: Use SyncCookieConfigurationManager.getInstance() instead of new.");e._instance=this}return e.prototype.init=function(e,t){this._networkClient=e,this._timer=t},e.getInstance=function(){return null==e._instance&&(e._instance=new e),e._instance},e.prototype.getConfiguration=function(){return this._configuration},e.prototype.configure=function(t){if(this._configuration=t,this._refreshInterval=e.DEFAULT_CONFIGURATION_REFRESH_INTERVAL,this._refreshTimerId&&this._timer.clearTimeout(this._refreshTimerId),!r.isEmpty(this._configuration.remoteConfigurationEndpoint))return this._configureRemote()},e.prototype._configureRemote=function(){var t=this;return n.bind(this).then(function(){return t._networkClient.request(t._configuration.remoteConfigurationEndpoint,e.NETWORK_REQUEST_CONFIGURATION)}).then(function(e){if(e.data){var o=r.extend({merged:!0},t._configuration,e.data);r.isEqual(o,t._configuration)||(t._configuration=o)}return n.resolve()}).finally(function(){t._refreshTimerId=t._timer.setTimeout(r.bind(function(){t._configureRemote()},t),t._refreshInterval)})},e.DEFAULT_CONFIGURATION_REFRESH_INTERVAL=216e5,e.RESPONSE_TYPE="json",e.MAX_ATTEMPTS=2,e.BACKOFF_FACTOR=2,e.NETWORK_TIMEOUT=1e4,e.INITIAL_RETRY_INTERVAL=1e3,e.NETWORK_REQUEST_CONFIGURATION={httpMethod:o.GET,maxAttempts:e.MAX_ATTEMPTS,responseType:e.RESPONSE_TYPE,backoffFactor:e.BACKOFF_FACTOR,timeout:e.NETWORK_TIMEOUT,initialRetryInterval:e.INITIAL_RETRY_INTERVAL},e}()}),define("ubp/extension/platform/cookie/SyncCookie",["require","exports","lib/bluebird","./SyncCookieRequestConfig","../../../commons/logging/Logger","lib/lodash","../../../commons/cookie/SessionCookieNameProvider","configuration/CookieInstallConfiguration","./SyncCookieConfigurationManager"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(){function e(){if(this._lastSyncSuccess=!1,this._isImportantSync=!1,e._instance)throw new Error("Error: Instantiation failed: Use SyncCookie.getInstance() instead of new.");e._instance=this}return e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.init=function(t,r,n,i){this._runtime=t,this._networkClient=r,this._cookieManager=n,this._locale=i,this._updateConfig(),this._lastSyncSuccess=!1,this._isImportantSync=!1,this._logger=this._logger||o.getLogger("SyncCookie"),e._instance=this,this._logger.debug("SyncCookie","Initialized")},e.prototype.isLastTimeSyncSucceed=function(){return this._lastSyncSuccess},e.prototype.isLastSyncImportantSync=function(){return this._isImportantSync},e.prototype.shouldPanic=function(){return!this._lastSyncSuccess&&this._isImportantSync},e.prototype.getRequestConfiguration=function(e){return new n(e)},e.prototype.getCheckList=function(){return this._cookieCheckList},e.isLocked=function(){return e.LOCK},e.prototype.forceSync=function(){var t=this;return u.getInstance().getConfiguration().isEnabled?e.isLocked()?r.resolve():(e.LOCK=!0,r.bind(this).then(function(){return t._updateLocaleAndGetConfig().then(function(n){if(void 0==n)return r.resolve();var o=n.site,i=n.serviceUrl;return t._cookieManager.refreshCookieRepo(o).then(function(n){if(n&&n.length>0){var o={cookieList:n};return t._logger.debug("SyncCookie","Call CookieInstall service to sync"),t._callCookieInstall(o,i)}return t._logger.debug("SyncCookie","No cookie needs to sync"),e.LOCK=!1,r.resolve()})}).catch(function(n){return t._cookieManager.clearRepo(),t._lastSyncSuccess=!1,t._logger.debug("SyncCookie","Sync falied, called clearRepo()"),t._logger.error("SyncCookie","Error during forceSync"),e.LOCK=!1,r.resolve()})})):r.resolve()},e.prototype._updateLocaleAndGetConfig=function(){var e=this;return this._runtime.getFromExtensionStorage("ubpv2.extension.installation.locale").bind(this).then(function(t){var n;return i.isUndefined(t)&&"US"!=e._locale?(e._locale="US",n=!0):i.isUndefined(t)&&"US"==e._locale?n=!1:(n=t!=e._locale,e._locale=t),n&&e._updateConfig(),r.resolve(u.getInstance().getConfiguration())})},e.prototype._updateConfig=function(){this._populateCookieCheckList();var e=s.getInstallConfiguration().configuration[this._locale];u.getInstance().configure(e)},e.prototype._checkIsImportantSync=function(e){var t=this;this._isImportantSync=!1,i.each(e,function(e){if(t._cookieCheckList[e.name])return t._isImportantSync=!0,!1})},e.prototype._populateCookieCheckList=function(){var e=new a(this._locale);this._cookieCheckList={},this._cookieCheckList[e.customerIdCookieName()]=!0,this._cookieCheckList[e.sessionIdCookieName()]=!0},e.prototype._callCookieInstall=function(t,n){var o=this;return r.bind(this).then(function(){return o._networkClient.request(n,o.getRequestConfiguration(t))}).then(function(t){if(t.data)return o._logger.debug("SyncCookie","Get response code:"+t.status+" totalInstalled:"+t.data.totalInstalled),o._lastSyncSuccess=!0,e.LOCK=!1,r.resolve();throw new Error("throw new Error: get No valid response")})},e._instance=null,e.LOCK=!1,e}()}),define("ubp/extension/platform/cookie/AmazonCookieRepoManager",["require","exports","lib/bluebird","../../../commons/logging/Logger"],function(e,t,r,n){"use strict";return function(){function e(){if(e._instance)throw new Error("Error: Instantiation failed: Use AmazonCookieRepoManager.getInstance() instead of new.");e._instance=this}return e.prototype.init=function(t){this._runtime=t,this._logger=this._logger||n.getLogger("AmazonCookieRepoManager"),this._cookieRepo={},e._instance=this,this._logger.debug("AmazonCookieRepoManager","Initialized")},e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.clearRepo=function(){this._cookieRepo={}},e.prototype.refreshCookieRepo=function(e){var t=this;return this._runtime.getCookies(e).bind(this).then(function(e){if(e&&e.length>0){var n={},o={};e.forEach(function(e){t._isValid(e)&&(t._isChanged(e)&&(o[e.name]=e),t._cookieRepo[e.name]=void 0,n[e.name]=e)});var i=t._buildCookieToSync(t._cookieRepo,!0);i.length>0&&t._logger.debug("AmazonCookieRepoManager","Cookie To Delete:"+i.length),t._cookieRepo={},t._cookieRepo=n,t._logger.debug("AmazonCookieRepoManager","repo is updated");var a=t._buildCookieToSync(o,!1);return a.length>0&&t._logger.debug("AmazonCookieRepoManager","Cookie To Update/Add:"+a.length),r.resolve(a.concat(i))}var s=t._runtime.getTotalTabsByQuery({url:"<all_urls>"}),u=t._runtime.getTotalTabsByQuery({url:"*://www.msn.com/spartan/*"});return r.all([u,s]).then(function(e){if(2==e.length&&e[0]!=e[1]){var n=t._buildCookieToSync(t._cookieRepo,!0);return t.clearRepo(),t._logger.debug("AmazonCookieRepoManager","Tabs that disable browser.cookie api are NOT the only tabs open, perform deletion"),r.resolve(n)}return t._logger.debug("AmazonCookieRepoManager","Tabs that disable browser.cookie api are the only tabs open, not perform deletion"),r.resolve([])})})},e.prototype._isValid=function(e){return void 0!=e.name&&""!=e.name.trim()},e.prototype._isChanged=function(e){return void 0==this._cookieRepo[e.name]||this._cookieRepo[e.name]&&e.value!=this._cookieRepo[e.name].value||this._isExpirationDateChanged(e)||e.domain!=this._cookieRepo[e.name].domain||e.path!=this._cookieRepo[e.name].path||e.httpOnly!=this._cookieRepo[e.name].httpOnly||e.secure!=this._cookieRepo[e.name].secure},e.prototype._isExpirationDateChanged=function(e){return!!(e.expirationDate&&!this._cookieRepo[e.name].expirationDate||!e.expirationDate&&this._cookieRepo[e.name].expirationDate)||!(!e.expirationDate&&!this._cookieRepo[e.name].expirationDate)&&Math.floor(e.expirationDate)!=Math.floor(this._cookieRepo[e.name].expirationDate)},e.prototype._buildCookieToSync=function(e,t){var r=[];for(var n in e)if(void 0!=e[n]){var o=t?0:e[n].expirationDate,i={name:n,value:e[n].value,isSession:e[n].session,expires:o,domain:e[n].domain,path:e[n].path,httpOnly:e[n].httpOnly,secure:e[n].secure};r.push(i)}return r},e._instance=null,e}()}),define("ubp/extension/platform/cookie/SyncCookieScheduler",["require","exports","lib/bluebird","../../../commons/logging/Logger","lib/lodash","./SyncCookieConfigurationManager"],function(e,t,r,n,o,i){"use strict";return function(){function e(){if(this._isRunning=!1,e._instance)throw new Error("Error: Instantiation failed: Use SyncCookieScheduler.getInstance() instead of new.");e._instance=this}return e.prototype.init=function(t){this._syncCookie=t,e.SyncInterval=i.getInstance().getConfiguration().syncInterval||e.SyncInterval,e.logger=e.logger||n.getLogger("CookieSync"),o.bindAll(this,"_timeoutPromise"),e._instance=this},e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.getLastRunTime=function(){return this._lastRunTime},e.prototype.isRunning=function(){return this._isRunning},e.prototype.start=function(){return r.bind(this).then(function(){if(this.isRunning()){var t="Can't call start while CookieSync is already running!";return e.logger.error("start",t),r.reject(t)}return this._timeoutPromise(),r.resolve()})},e.prototype._timeoutPromise=function(){var t=this;return this._isRunning=!0,this._syncCookie.forceSync().finally(function(){t._lastRunTime=(new Date).getTime();var r=i.getInstance().getConfiguration().syncInterval||e.SyncInterval;t._timeoutId=setTimeout(t._timeoutPromise,r)})},e.prototype.stop=function(){var t=this;return r.bind(this).then(function(){if(!t.isRunning()){var n="Can't call stop when the CookieSync isn't running.";throw e.logger.error("stop",n),new Error(n)}return t._isRunning=!1,clearTimeout(t._timeoutId),t._timeoutId=void 0,r.resolve()})},e.SyncInterval=2e3,e._instance=null,e}()}),
define("ubp/extension/extensionLogId/ExtensionLogIdManager",["require","exports","lib/lodash","lib/bluebird","../../commons/utilities/UUID","../../commons/logging/Logger"],function(e,t,r,n,o,i){"use strict";return function(){function e(t,r,n){this._NumRotationRetry=0;var o=t&&t>0&&t<e.MAX_EXTENSION_LOG_ID_ROTATE_INTERVAL,i=r&&r>0&&r<e.MAX_LOGGING_FAILURE_REFRESH_INTERVAL;this._extensionLogIdRotateInterval=o?t:e.MAX_EXTENSION_LOG_ID_ROTATE_INTERVAL,this._loggingFailureRefreshInterval=i?r:e.MAX_LOGGING_FAILURE_REFRESH_INTERVAL,this._runtime=n}return e.prototype.getCurExtensionLogId=function(){return this._curExtensionLogId},e.prototype.getCurExtensionLogIdTimestamp=function(){return this._curExtensionLogIdTimestamp},e.prototype.rotateExtensionLogId=function(){var t=this,r={userAgent:"Error retrieving userAgent.",extensionLogId:""};return n.bind(this).then(function(){return t._runtime.getFromExtensionStorage(e.extensionLogIdTimestampKey)}).then(function(e){if(!e||t._isExtensionLogIdExpired(e))return t._generateAndStoreExtensionLogId();t._curExtensionLogIdTimestamp=e}).then(function(){return t._getExistingExtensionLogId()}).then(function(e){r.extensionLogId=e,r.userAgent=t._runtime.getUserAgent(),i.root.setUniversalContext(r),t._rotationSuccess=!0,t._NumRotationRetry=0}).catch(function(r){e.logger.error("rotate",r.toString()),t._rotationSuccess=!1,t._NumRotationRetry+=1}).finally(function(){t._rotationSuccess?t._scheduleNextRotation(Math.min(e.DEFAULT_EXTENSION_LOG_ID_TIMEOUT_INTERVAL,t._getTimeoutInterval())):1===t._NumRotationRetry?t._scheduleNextRotation(0):t._scheduleNextRotation(t._loggingFailureRefreshInterval)})},e.prototype._getTimeoutInterval=function(){if(r.isNaN(parseInt(this._curExtensionLogIdTimestamp)))return e.DEFAULT_EXTENSION_LOG_ID_TIMEOUT_INTERVAL;var t=this._extensionLogIdRotateInterval+parseInt(this._curExtensionLogIdTimestamp)-this._toEpoch();return t>0?t:0},e.prototype._generateAndStoreExtensionLogId=function(){var t=this,r=o.v4(),i=""+this._toEpoch();return n.all([this._runtime.putInExtensionStorage(e.extensionLogIdKey,r),this._runtime.putInExtensionStorage(e.extensionLogIdTimestampKey,i)]).then(function(){t._curExtensionLogId=r,t._curExtensionLogIdTimestamp=i})},e.prototype._getExistingExtensionLogId=function(){var t=this;return this._curExtensionLogId?n.resolve(this._curExtensionLogId):this._runtime.getFromExtensionStorage(e.extensionLogIdKey).then(function(e){return t._curExtensionLogId=e,e})},e.prototype._scheduleNextRotation=function(t){var n=this;(!t||t<0||r.isNaN(t)||t>e.DEFAULT_EXTENSION_LOG_ID_TIMEOUT_INTERVAL)&&(t=e.DEFAULT_EXTENSION_LOG_ID_TIMEOUT_INTERVAL),this._runtime.setTimeout(r.bind(function(){n.rotateExtensionLogId()},this),t)},e.prototype._isExtensionLogIdExpired=function(t){try{if(r.isNaN(parseInt(t)))throw new Error("invalid timestamp");return this._toEpoch()-parseInt(t)>=this._extensionLogIdRotateInterval}catch(t){return e.logger.error("rotate","invalid extension log ID timestamp"),!0}},e.prototype._toEpoch=function(){return(new Date).getTime()},e.MAX_EXTENSION_LOG_ID_ROTATE_INTERVAL=2592e6,e.MAX_LOGGING_FAILURE_REFRESH_INTERVAL=108e5,e.DEFAULT_EXTENSION_LOG_ID_TIMEOUT_INTERVAL=864e5,e.extensionLogIdKey="ubpv2.extension.extensionLogId",e.extensionLogIdTimestampKey="ubpv2.extension.extensionLogIdTimeStamp",e.logger=i.getLogger("ExtensionLogIdManager"),e}()}),define("ubp/extension/bootstrapper/ExtensionBootstrapper",["require","exports","lib/lodash","lib/bluebird","../../commons/utilities/UUID","../../commons/logging/Logger","../../commons/localization/Locale","../configuration/ConfigurationManager","../configuration/ConfigurationPuller","configuration/GlobalParameters","../process/ProcessManager","../hub/PlatformHub","../process/ProcessFactory","configuration/FeatureManifestConfiguration","configuration/LoggingConfiguration","configuration/CookieInstallConfiguration","../../commons/logging/LoggingManager","../storage/StorageManager","../locale/LocaleManager","../firstTimeSetup/FirstTimeSetup","../../metrics/sentry/Sentry","configuration/SentryConfiguration","../../metrics/sentry/SentryReport","../../commons/error/NoNetworkConnectivityError","./ExtensionState","../configuration/RemoteConfigurationManager","configuration/RemoteConfiguration","../platform/cookie/SyncCookie","../platform/cookie/AmazonCookieRepoManager","../platform/cookie/SyncCookieScheduler","../platform/cookie/SyncCookieConfigurationManager","../extensionLogId/ExtensionLogIdManager","../storage/StorageType"],function(e,t,r,n,o,i,a,s,u,c,l,p,f,_,d,g,h,m,v,y,b,E,S,T,x,w,R,A,C,P,I,L,O){"use strict";return function(){function e(t,r){var n=this;this._isStarted=!1,this._retryCounter=e.RETRY_COUNTER_UNAVAIL,this._extensionState=x.NEW,this._extensionState=x.NEW,this._runtime=t,this._networkClient=r,e.logger=e.logger||i.getLogger("ExtensionBootstrapper"),this._changeExtensionState(x.INITIALIZING),this._runtime.onExtensionReload(function(){e.logger.error("start","(Not an error) Got reload message from Extension."),n._changeExtensionState(x.RESTARTING)})}return e.prototype._init=function(){this._loggingConfiguration=d.getLoggingConfiguration().configuration[a[e.DEFAULT_LOCALE]],h.getInstance().init(this._networkClient,this._runtime),this._sentryConfiguration=E.getSentryConfiguration().configuration[a[e.DEFAULT_LOCALE]],b.getInstance().init(this._networkClient,this._runtime),this._storageManager=m.getInstance(),this._firstTimeSetup=new y,this._localeManager=new v(this._networkClient,this._storageManager),this._configurationManager=new s(new u(this._networkClient,this._runtime),_.getManifestConfiguration(),this._localeManager),this._processFactory=new f(this._runtime),this._processManager=new l(this._configurationManager,this._processFactory,this._runtime),this._restartTimeoutId=null,this._remoteConfigurationManager=new w(R.getRemoteConfiguration(),this._localeManager,this._runtime,this._networkClient),this._platformHub=new p(this._configurationManager,this._processManager,this._remoteConfigurationManager,this._runtime),this._syncCookieConfiguration=g.getInstallConfiguration()[a[e.DEFAULT_LOCALE]],I.getInstance().init(this._networkClient,this._runtime),this._extensionLogIdManager=new L(d.getLoggingConfiguration().extensionLogIdConfiguration.rotate_interval,d.getLoggingConfiguration().extensionLogIdConfiguration.failure_refresh_interval,this._runtime)},e.prototype.start=function(){var e=this;return n.bind(this).then(function(){e._changeExtensionState(x.STARTING)})},e.prototype._start=function(){var t=this;return this._extensionState!==x.STARTING?n.reject(new Error("Extension is not in STARTING state before start() is called, current state "+x[this._extensionState])):(this._sentryReport=new S("Extension","ExtensionBootstrapper",o.v4()),this._sentryReportV2=new S("Extension","ExtensionBootstrapperV2",o.v4()),this._sentryReport.startRealTimeTimer("RequestTimeSuccess"),this._sentryReportV2.startRealTimeTimer("RequestTimeSuccess"),this._sentryReportV2.startRealTimeTimer("RequestTimeFailure"),n.bind(this).then(function(){return t._runtime.isOnline()}).then(function(e){return e?n.resolve():n.reject(new T("No network connection."))}).then(function(){return t._runtime.getFromExtensionStorage(e.STORAGE_LOCALE_KEY)}).then(function(e){return e&&a[e]?n.cast(a[e]):t._localeManager.getGeoLocale()}).then(function(r){if(t._geoLocale=r,t._isStarted){throw new Error("This ExtensionBootstrapper has already been started and can only be started once.")}return t._loggingConfiguration=d.getLoggingConfiguration().configuration[a[r]],t._sentryConfiguration=E.getSentryConfiguration().configuration[a[r]],t._syncCookieConfiguration=g.getInstallConfiguration().configuration[a[r]],C.getInstance().init(t._runtime),A.getInstance().init(t._runtime,t._networkClient,C.getInstance(),a[r]),n.settle([h.getInstance().configure(t._loggingConfiguration),t._extensionLogIdManager.rotateExtensionLogId(),b.getInstance().configure(t._sentryConfiguration,r),I.getInstance().configure(t._syncCookieConfiguration)]).timeout(e.DEFAULT_LOGGER_SENTRY_TIMEOUT).catch(function(e){if("TimeoutError"!==e.name)throw e})}).then(function(){try{window.localStorage}catch(t){e.logger.fatal("start","We've detected that localStorage is disabled: "+t.toString())}t._syncCookieConfiguration.isEnabled&&t._runtime.supportAutoCookieSync().then(function(e){e||(P.getInstance().init(A.getInstance()),P.getInstance().start())})}).then(function(){return t._storageManager.init(t._runtime),t._storageManager.start()}).then(function(){t._loadRetryCounterFromStorage()}).then(function(){return n.all([t._firstTimeSetup.start(),t._localeManager.start()])}).then(function(){return n.all([t._localeManager.getLocale(),t._firstTimeSetup.firstTimeSetup()])}).spread(function(r){return r&&r!==t._geoLocale&&(t._loggingConfiguration=d.getLoggingConfiguration().configuration[a[r]],h.getInstance().configure(t._loggingConfiguration),t._sentryConfiguration=E.getSentryConfiguration().configuration[a[r]],b.getInstance().configure(t._sentryConfiguration,r)),t._configurationManager.on("ExtensionLocaleUpdated",function(r){e.logger.debug("start","Got an 'ExtensionLocaleUpdated' event with new locale: "+a[r]),t._loggingConfiguration=d.getLoggingConfiguration().configuration[a[r]],h.getInstance().configure(t._loggingConfiguration),t._sentryConfiguration=E.getSentryConfiguration().configuration[a[r]],b.getInstance().configure(t._sentryConfiguration,r),t._remoteConfigurationManager.setLocale(r)}),e.logger.debug("start","Starting Configuration Manager"),t._configurationManager.start()}).then(function(){return e.logger.debug("start","Starting Platform Hub"),t._platformHub.start()}).then(function(){return t._changeExtensionState(x.CAN_RESTART),e.logger.debug("start","Starting RemoteConfigurationManager"),t._remoteConfigurationManager.start()}).then(function(){return e.logger.debug("start","Starting Process Manager"),t._processManager.start()}).then(function(){t._sentryReport.stopRealTimeTimer("RequestTimeSuccess"),t._sentryReport.incrementRealTimeCounter("Success"),t._sentryReportV2.stopRealTimeTimer("RequestTimeSuccess"),t._sentryReportV2.incrementRealTimeCounter("Success"),t._sentryReportV2.incrementRealTimeCounter("Success."+c.getGlobalParameters().browser),t._retryCounter===e.RETRY_COUNTER_UNAVAIL?t._sentryReportV2.incrementRealTimeCounter("RetryCounterUnavail.Success"):(t._sentryReportV2.incrementRealTimeCounter("RetryCounterRaw.Success",t._retryCounter),t._sentryReportV2.incrementRealTimeCounter("RetryCounter.Success."+t._retryCounter)),t._changeExtensionState(x.STARTED),e.logger.info("start","ExtensionBootstrapper started")}).catch(function(r){t._changeExtensionState(x.FAILED),t._logBootstrapFailMetrics(),t._runtime.onBrowserOnline(function(){t._restart()}),t._runtime.isOnline().then(function(n){var o=t._retryCounter!==e.RETRY_COUNTER_UNAVAIL?(t._retryCounter+1).toString():"unknown";n?(t._sentryReportV2.incrementRealTimeCounter("NetOnlineFailure"),e.logger.fatal("start","Failed to start due to network but we are online. Retrying for "+o+" time. "+r.toString()),t._restart()):(e.logger.fatal("start","Failed to start due to network and we are offline. Retrying for "+o+" time. "+r.toString()),t._sentryReportV2.incrementRealTimeCounter("NetOfflineFailure"))})}).catch(function(r){e.logger.fatal("start","Unable to start ExtensionBootstrapper. "+r.toString()+". Will try to restart extension for "+t._retryCounter+" time."),t._changeExtensionState(x.FAILED),t._logBootstrapFailMetrics(),t._restart()}).finally(function(){t._sentryReport.publish(),t._sentryReportV2.publish()}))},e.prototype._restart=function(){var t=this;this._isStarted?e.logger.info("restart","ExtensionBootstrapper already started!"):this._increaseRetryCounter().then(function(){return t._getRetryIntervalFromCount()}).then(function(n){t._restartTimeoutId=t._runtime.setTimeout(r.bind(function(){e.logger.info("restart","Trying to start ExtensionBootstrapper after "+n+"."),this._runtime.reloadExtension()},t),n)})},e.prototype._resetExtension=function(){var e=this;return n.bind(this).then(function(){return e._runtime.isOnline()}).then(function(t){if(t)return n.bind(e).then(function(){return e._processManager.stop()}).then(function(){return e._platformHub.stop(),e._localeManager.stop(),e._firstTimeSetup.stop(),e._storageManager.stop(),e._restartTimeoutId&&(e._runtime.clearTimeout(e._restartTimeoutId),e._restartTimeoutId=null),e._remoteConfigurationManager.stop(),P.getInstance().stop(),e._configurationManager.stop()}).then(function(){e._changeExtensionState(x.INITIALIZING),e._changeExtensionState(x.STARTING)})}).catch(function(t){e._changeExtensionState(x.FAILED)})},e.prototype._changeExtensionState=function(t){switch(e.logger.error("changeExtensionState","(NOT AN ERROR) Received request to change state from "+x[this._extensionState]+" to "+x[t]),t){case x.INITIALIZING:this._extensionState===x.NEW||this._extensionState===x.RESTARTING?(this._extensionState=x.INITIALIZING,this._init()):e.logger.error("changeExtensionState","Can't change state from "+x[this._extensionState]+" to "+x[x.INITIALIZING]);break;case x.STARTING:this._extensionState===x.INITIALIZING?(this._extensionState=x.STARTING,this._start()):e.logger.error("changeExtensionState","Can't change state from "+x[this._extensionState]+" to "+x[x.STARTING]);break;case x.RESTARTING:this._extensionState!==x.NEW&&this._extensionState!==x.STARTING&&this._extensionState!==x.RESTARTING?(this._extensionState=x.RESTARTING,this._resetExtension()):e.logger.error("changeExtensionState","Can't change state from "+x[this._extensionState]+" to "+x[x.RESTARTING]);break;case x.STARTED:this._extensionState===x.STARTING||this._extensionState===x.CAN_RESTART?(this._extensionState=x.STARTED,this._resetRetryCounterInStorage()):e.logger.error("changeExtensionState","Can't change state from "+x[this._extensionState]+" to "+x[x.STARTED]);break;case x.CAN_RESTART:this._extensionState===x.STARTING?this._extensionState=x.CAN_RESTART:e.logger.error("changeExtensionState","Can't change state from "+x[this._extensionState]+" to "+x[x.CAN_RESTART]);break;case x.FAILED:this._extensionState=x.FAILED;break;default:e.logger.error("changeExtensionState","Invalid state has been passed to extension "+t)}},e.prototype._logBootstrapFailMetrics=function(){this._sentryReportV2.stopRealTimeTimer("RequestTimeFailure"),this._sentryReportV2.incrementRealTimeCounter("Failure"),this._sentryReportV2.incrementRealTimeCounter("Failure."+c.getGlobalParameters().browser),this._retryCounter===e.RETRY_COUNTER_UNAVAIL?this._sentryReportV2.incrementRealTimeCounter("RetryCounterUnavail.Failure"):(this._sentryReportV2.incrementRealTimeCounter("RetryCounterRaw.Failure",this._retryCounter),this._sentryReportV2.incrementRealTimeCounter("RetryCounter.Failure."+this._retryCounter))},e.prototype._getRetryIntervalFromCount=function(){if(this._retryCounter===e.RETRY_COUNTER_UNAVAIL)return n.resolve(e.DEFAULT_RETRY_INTERVAL+this._getRetryIntervalJittering(e.DEFAULT_RETRY_INTERVAL));if(this._retryCounter>e.RETRY_MAX_COUNTER_POWER)return n.resolve(e.RETRY_MAX_INTERVAL+this._getRetryIntervalJittering(e.RETRY_MAX_INTERVAL));var t=e.START_RETRY_INTERVAL*Math.pow(2,this._retryCounter-1);return t=t>e.RETRY_MAX_INTERVAL?e.RETRY_MAX_INTERVAL:t,n.resolve(t+this._getRetryIntervalJittering(t))},e.prototype._getRetryIntervalJittering=function(e){var t=e/5;return Math.floor(Math.random()*(t+1))},e.prototype._loadRetryCounterFromStorage=function(){var t=this;return this._storageManager.get(O.EXTENSION_STORAGE,e.RETRY_COUNTER_STORAGE_KEY).then(function(r){if(r){var n=parseInt(r);t._retryCounter=isNaN(n)||n<0?e.RETRY_COUNTER_UNAVAIL:n}else t._retryCounter=0}).catch(function(r){e.logger.error("Could not load bootstrap retry counter from extension storage",r),t._retryCounter=e.RETRY_COUNTER_UNAVAIL})},e.prototype._increaseRetryCounter=function(){var t=this;return this._retryCounter===e.RETRY_COUNTER_UNAVAIL?n.resolve():this._storageManager.set(O.EXTENSION_STORAGE,e.RETRY_COUNTER_STORAGE_KEY,(this._retryCounter+1).toString()).then(function(){return t._retryCounter++,n.resolve()}).catch(function(r){e.logger.error("Could not write bootstrap retry counter to extension storage",r),t._retryCounter=e.RETRY_COUNTER_UNAVAIL})},e.prototype._resetRetryCounterInStorage=function(){this._storageManager.set(O.EXTENSION_STORAGE,e.RETRY_COUNTER_STORAGE_KEY,"0")},e.START_RETRY_INTERVAL=15e3,e.RETRY_MAX_INTERVAL=18e5,e.RETRY_MAX_COUNTER_POWER=16,e.DEFAULT_RETRY_INTERVAL=6e5,e.RETRY_COUNTER_UNAVAIL=-1,e.DEFAULT_LOGGER_SENTRY_TIMEOUT=4e3,e.RETRY_COUNTER_STORAGE_KEY="bootstrapRetryCounter",e.STORAGE_LOCALE_KEY="ubpv2.extension.installation.locale",e.DEFAULT_LOCALE=a.US,e}()});var factory=function(){"use strict";var e=function(){};return e.getLocalStorageConfiguration=function(){return[{url:"https://horizonte.browserapps.amazon.com/crossdomainlocalstoragereader"}]},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/LocalStorageConfiguration",[],factory);var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/BaseRuntime",["require","exports","lib/lodash","lib/bluebird","../../commons/Events/Events","../../commons/logging/Logger","configuration/LocalStorageConfiguration","../../commons/error/Errors"],function(e,t,r,n,o,i,a,s){"use strict";return function(e){function t(){var r=e.call(this)||this;return r.MESSAGE_TIMEOUT=6e4,r.NEW_TAB_TIMEOUT=1e3,r.BADGE_COLOR="#FF5252",r.RUNTIME_EVENT="RuntimeEvent",r.BROWSER_ONLINE_EVENT="onBrowserOnline",r.EXTERNAL_MESSAGE="UBPExternalMessage",r.remoteConfigurationRawDataMap={},t.logger=t.logger||i.getLogger("BaseRuntime"),r}return __extends(t,e),t.prototype.onRuntimeEvent=function(e){this.on(this.RUNTIME_EVENT,e)},t.prototype.unsubscribeRuntimeEvents=function(){this.off(this.RUNTIME_EVENT)},t.prototype.unsubscribeBrowserOnlineEvents=function(){this.off(this.BROWSER_ONLINE_EVENT)},t.prototype._onPageTurn=function(e,r,n,o){t.logger.debug("_onPageTurn","PageTurn event for tabId: "+e+" at url: "+r+" with status: "+n+" with title: "+o),this._isValidUrl(r)&&this.notify(this.RUNTIME_EVENT,{name:"Tabs.PageTurn",eventArgs:{tabId:e,url:r,status:n,title:o}})},t.prototype._onContextMenuClick=function(e){if(this._isValidUrl(e.tabUrl)){var r=e.menuItemId?e.menuItemId.split(".")[0]:"";this.notify(this.RUNTIME_EVENT,{name:t.CONTEXT_MENU_CLICK_RESPONSE_NAME+r,eventArgs:e})}},t.prototype._onTabRemoved=function(e){t.logger.debug("_onTabRemoved","OnTabRemoved event for tabId: "+e),this.notify(this.RUNTIME_EVENT,{name:"Tabs.onRemoved",eventArgs:{tabId:e}})},t.prototype._onExternalMessage=function(e,t){switch(this._determineMessageType(e)){case"Sandbox":e=e.payload,this.notify(this.RUNTIME_EVENT,{name:"Sandbox.Message.".concat(e.mType),eventArgs:r.extend(e,{tabId:t}),tabId:t});break;case"Action":e=e.payload,this.notify(this.RUNTIME_EVENT,{name:"Action.Message",eventArgs:r.extend(e,{tabId:t})})}},t.prototype._determineMessageType=function(e){return e&&e.type&&r.startsWith(e.type,this.EXTERNAL_MESSAGE)&&e.type.replace(this.EXTERNAL_MESSAGE.concat("."),"")},t.prototype._isValidUrl=function(e){return new RegExp("^https?://").test(e)},t.prototype.sendMessageToIFrame=function(e,r){return n.bind(this).then(function(){if(!e)return t.logger.error("sendMessageToIFrame","frame Id is null or empty"),n.reject("child frame Id is null or empty");var o=document.getElementById(e);if(!o)return t.logger.error("sendMessageToIFrame","iFrame with id "+e+" not found"),n.reject("iFrame with id "+e+" not found");var i="*";o.src&&(i=o.src),o.contentWindow.postMessage(r,i)})},t.prototype.setURLForIframe=function(e,r){return n.bind(this).then(function(){if(!e)return t.logger.error("setURLForIframe","frame Id is null or empty"),n.reject("frame Id is null or empty");var o=document.getElementById(e);if(!o)return t.logger.error("setURLForIframe","iFrame with id "+e+" not found"),n.reject("iFrame with id "+e+" not found");o.src=r})},t.prototype.getFromAmazonLocalStorage=function(e){var t,o=this,i=[];return n.bind(this).then(function(){var s=a.getLocalStorageConfiguration(),u=[];return r.each(s,r.bind(function(r){var o=this,a={name:"AmazonLocalStorage",configuration:{url:r.url+"?keys="+e.join(",")}};u.push(new n(function(e){var r=o.createProcessInstance(a,function(r){t=r.payload,e()},{});i.push(r),r.start()}))},o)),n.race(u).timeout(o.MESSAGE_TIMEOUT,"Did not receive local storage message in time")}).finally(function(){r.each(i,r.bind(function(e){this.destroyProcessInstance(e)},o))}).then(function(){return t})},t.prototype.createProcessInstance=function(e,t,r){throw new Error("Not implemented!")},t.prototype.destroyProcessInstance=function(e){throw new Error("Not implemented!")},t.prototype.getExtensionVersion=function(){throw new Error("Not implemented!")},t.prototype.getExtensionResourceURL=function(e){return void 0===e&&(e=""),""},t.prototype.getIFrameAttributes=function(e){return n.bind(this).then(function(){var t={source:""},r=document.getElementById(e);return r&&r.src&&(t.source=r.src),n.resolve(t)})},t.prototype.createDesktopNotification=function(e,t){return n.reject(s.Conflict("createDesktopNotification is not supported for this browser"))},t.prototype.getCookieInfo=function(e,t){return n.reject(s.Conflict("getCookieInfo operation is not supported for this browser"))},t.prototype.bulkGetCookieInfo=function(e,t){return n.reject(s.Conflict("bulkGetCookieInfo operation is not supported for this browser"))},t.prototype.createContextMenuItem=function(e){var t=s.FeatureUnavailable("createContextMenuItem : Operation is not supported for this browser");return n.reject(t)},t.prototype.deleteAllContextMenuItems=function(){var e=s.FeatureUnavailable("deleteAllContextMenuItems : Operation is not supported for this browser");return n.reject(e)},t.prototype.removeTab=function(e){var t=s.FeatureUnavailable("removeTab : Operation is not supported for this browser");return n.reject(t)},t.prototype.isContextMenuApiSupported=function(){return!1},t.prototype.deleteContextMenuItemById=function(e){var t=s.FeatureUnavailable("deleteContextMenuItemById : Operation is not supported for this browser");return n.reject(t)},t.prototype.registerNotificationHandler=function(e){t.logger.info("registerNotificationHandler","Notifications are not supported in this browser")},t.prototype.setRemoteConfigurationRawData=function(e,t){return this.remoteConfigurationRawDataMap[e]=t,n.resolve()},t.prototype.getRemoteConfigurationRawData=function(e){return this.remoteConfigurationRawDataMap[e]},t.prototype.getUAParser=function(){throw new Error("Not implemented!")},t.prototype.getUserAgent=function(){throw new Error("Not implemented!")},t.prototype.getBrowserVersion=function(){return this.getUAParser().parse(this.getUserAgent()).then(function(e){return e.browserVersion})},t.prototype.enableExtensionFeature=function(){return n.resolve(!0)},t.prototype.getBrowserRecSettings=function(e){return t.logger.error("getBrowserRecSettings","This browser does not support getBrowserRecSettings"),n.reject(s.Conflict("This browser does not support getBrowserRecSettings"))},t.prototype.updateBrowserRecSettings=function(e,r){return t.logger.error("updateBrowserRecSettings","This browser does not support updateBrowserRecSettings"),n.reject(s.Conflict("This browser does not support updateBrowserRecSettings"))},t.prototype.registerWhitelist=function(e){return n.resolve()},t.prototype.closePanel=function(){try{window.top.close()}catch(e){t.logger.error("closePanel","Failed to close the panel due to "+e.toString())}},t.prototype.supportAutoCookieSync=function(){return n.resolve(!0)},t.CONTEXT_MENU_CLICK_RESPONSE_NAME="Contextmenu.ItemClicked.",t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/process/BaseProcess",["require","exports","lib/lodash","lib/bluebird","./ProcessState","../../commons/Events/Events","../../commons/logging/Logger","../../commons/localization/Locale","../../commons/messaging/MessageExchange"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(e){function t(r,n,i){var s=e.call(this)||this;return s._state=o.NEW,t.logger=t.logger||a.getLogger("BaseProcess"),s._manifest=r,s._messageReceiver=n,s._options=i,s}return __extends(t,e),t.prototype.start=function(){var e=this;return n.bind(this).then(function(){return e.getState()}).then(function(r){if(r!==o.NEW){var i=new Error("This Process has already been started and can only be started once.");return t.logger.error("start",i.toString()),n.reject(i)}return e.setState(o.STARTING)})},t.prototype.terminate=function(){var e=this;return n.bind(this).then(function(){return e._exchange&&e._exchange.dispose()}).then(function(){return e.setState(o.TERMINATED)}).then(function(){e._transport=null,e._exchange=null,e._messageReceiver=null,e._manifest=null})},t.prototype._setupMessageExchange=function(){var e=this;return this._exchange=new u(t.MESSAGE_TIMEOUT),this._transport.forward(this._exchange.egressBus()).then(function(){return e._exchange.listen(e._transport.dispatchBus())}).then(function(){return e._exchange.dispatchBus().subscribe(function(t){e._messageReceiver(t,e)})})},t.prototype.getState=function(){return n.cast(this._state)},t.prototype.setState=function(e){var t=this;return n.bind(this).then(function(){t._state!==e&&(t._state=e,t.notify("StateChange",t._state,t))})},t.prototype.send=function(e){var r=this;return this.getState().then(function(e){if(e!==o.STABLE){var r=new Error("This Process must be stable before making any method calls.");return t.logger.info("send",r.toString()),n.reject(r)}}).then(function(){return r._exchange.send(e)})},t.prototype.sendAndReceive=function(e,r){var i=this;return this.getState().then(function(e){if(e!==o.STABLE){var r=new Error("This Process must be stable before making any method calls.");return t.logger.info("send",r.toString()),n.reject(r)}}).then(function(){return i._exchange.sendAndReceive(e,r)})},t.prototype.getManifest=function(){var e=this;return n.bind(this).then(function(){return e._manifest})},t._extractOrigin=function(e){return e.replace(/(https?:\/\/).*/,"$1")+e.split(/https?:\/\//)[1].split("/")[0]},t._getProcessUrl=function(e,n){var o=e.configuration.url,i=s[t.DEFAULT_LOCALE];if(r.isUndefined(n)||r.isUndefined(s[n.locale])||(i=s[n.locale]),o=t._appendQueryParams(o,{locale:i}),e.configuration.assetTag){if(e.configuration.url.match(/[&\?]assetTag=/)){var a=new Error("URL already has an assetTag; can't append assetTag");throw t.logger.info("send",a.toString()),a}o=t._appendQueryParams(o,{assetTag:e.configuration.assetTag})}return o},t._appendQueryParams=function(e,t){var n="";return r.each(t,function(e,t){n+="&"+encodeURIComponent(t)+"="+encodeURIComponent(e)}),e.indexOf("?")>-1?"&"!==e.charAt(e.length-1)&&"?"!==e.charAt(e.length-1)||(n=n.slice(1)):n="?"+n.slice(1),e+n},t.MESSAGE_TIMEOUT=1e4,t.DEFAULT_LOCALE=s.US,t}(i)}),define("ubp/commons/messaging/primitives/TransportStrategyType",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.PostMessage=0]="PostMessage",e[e.PanelMessage=1]="PanelMessage",e[e.Port=2]="Port",e[e.Pseudo=3]="Pseudo"}(r||(r={})),r});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/messaging/PostMessageTransportStrategy",["require","exports","lib/lodash","lib/bluebird","./BaseTransportStrategy","./primitives/TransportStrategyType"],function(e,t,r,n,o,i){"use strict";return function(e){function t(t){var n=e.call(this,t)||this;return r.bindAll(n,"_onMessage","_send"),n._egressBus.subscribe(n._send),n.bind(t.inboundPort,t.outboundPort),n}return __extends(t,e),t.prototype.dispatchBus=function(){return e.prototype.dispatchBus.call(this)},t.prototype.forward=function(t){return e.prototype.forward.call(this,t)},t.prototype.bind=function(e,t){var r=this;return n.bind(this).then(function(){r._outboundPort=t,r._inboundPort=e,r._inboundPort.addEventListener("message",r._onMessage,!1)})},t.prototype.unbind=function(){var e=this;return n.bind(this).then(function(){r.isObject(e._inboundPort)&&e._inboundPort.removeEventListener("message",e._onMessage),e._inboundPort=null,e._outboundPort=null})},t.prototype._send=function(e){var t={mType:i.PostMessage,source:this._identity,payload:e};r.isObject(this._outboundPort)&&this._outboundPort.postMessage(t,"*")},t.prototype._onMessage=function(e){if(r.contains(this._validOrigins,"*")||r.contains(this._validOrigins,e.origin)){var t=e.data;(r.contains(this._validSources,"*")||r.contains(this._validSources,t.source))&&t.source!==this._identity&&this._dispatchBus.publish(this,t.payload)}},t}(o)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/process/IFrameProcess",["require","exports","lib/bluebird","./BaseProcess","./ProcessState","../../commons/messaging/PostMessageTransportStrategy"],function(e,t,r,n,o,i){"use strict";return function(e){function t(t,r,n,o,i){var a=e.call(this,t,r,n)||this;return a._frameAttributes=i,a._frame=o||a._createFrame(),a}return __extends(t,e),t.prototype.start=function(i){var a=this;return void 0===i&&(i=t.DEFAULT_TIMEOUT),r.bind(this).then(function(){return e.prototype.start.call(a)}).then(function(){return a._frame.src=n._getProcessUrl(a._manifest,a._options),a._setupMessagingInfrastructure()}).then(function(){return new r(function(e){a._state===o.STABLE&&e(),a.on("StateChange",function(t){t===o.STABLE&&e()},a)}).timeout(i,"Did not receive handshake in time")}).catch(function(e){var t=new Error("Could not start process: "+e.message);return n.logger.error("IFrameProcess.start",t.message),r.reject(t)})},t.prototype.terminate=function(){var t=this;return r.bind(this).then(function(){return e.prototype.terminate.call(t)}).then(function(){return t._exchange&&t._exchange.dispose()}).then(function(){return t._transport=null,t._exchange=null,t._messageReceiver=null,t._manifest=null,t._frame.src="about:blank",t._frame.contentWindow.close(),t._frame})},t.prototype._setupMessagingInfrastructure=function(){return this._transportStrategyOptions={identity:"PlatformHub",inboundPort:window,outboundPort:this._frame.contentWindow,validOrigins:[t._extractOrigin(this._manifest.configuration.url.toString())],validSources:[this._manifest.name]},this._transport=new i(this._transportStrategyOptions),e.prototype._setupMessageExchange.call(this)},t.prototype._createFrame=function(){var e=document.createElement("iframe");return e.src="about:blank",_.each(this._frameAttributes,function(t,r){t&&r&&e.setAttribute(r,t)},this),document.body.appendChild(e),e},t.DEFAULT_TIMEOUT=3e4,t}(n)}),define("ubp/extension/runtime/BaseContentScripts",["require","exports","../../commons/logging/Logger"],function(e,t,r){"use strict";return function(){function e(){this._contentScriptsHash={}}
return e.prototype.get=function(t){if(this._contentScriptsHash[t])return this._contentScriptsHash[t];var r=new Error("feature not supported");throw e.logger.error("get",r.message),r},e.logger=r.getLogger("BaseContentScripts"),e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/chrome/ChromelikeContentScripts",["require","exports","../BaseContentScripts","../../contextual/ContextualFeature"],function(e,t,r,n){"use strict";return function(e){function t(){var t=e.call(this)||this;return t._contentScriptsHash[n.Scrape]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/Xpath2Library.js","/js/ubp/extension/contextual/peer-scripts/libraries/ScrapeLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/ScrapeDriver.js"],t._contentScriptsHash[n.Sandbox]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/SandboxLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/SandboxDriver.js"],t._contentScriptsHash[n.Action]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/ActionLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/ActionDriver.js"],t._contentScriptsHash[n.Style]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/StyleLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/StyleDriver.js"],t._contentScriptsHash[n.MetaData]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/MetaDataLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/MetaDataDriver.js"],t._contentScriptsHash[n.GetUWLItem]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/GetUWLItemLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/GetUWLItemDriver.js"],t._contentScriptsHash[n.Webpage]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/WebpageInstrumentLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/WebpageDriver.js"],t._contentScriptsHash[n.InlineWidget]=["/js/ubp/extension/contextual/peer-scripts/libraries/GlobalDeclarations.js","/js/ubp/extension/contextual/peer-scripts/libraries/InlineWidgetLibrary.js","/js/ubp/extension/contextual/peer-scripts/drivers/chrome/InlineWidgetDriver.js"],t}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/messaging/ChromePanelMessageTransportStrategy",["require","exports","lib/lodash","lib/bluebird","./BaseTransportStrategy","./primitives/TransportStrategyType"],function(e,t,r,n,o,i){"use strict";return function(e){function t(t){var n=e.call(this,t)||this;return r.bindAll(n,"_onMessage","_send"),n._egressBus.subscribe(n._send),n.bind(t.inboundPort,t.outboundPort),n}return __extends(t,e),t.prototype.dispatchBus=function(){return e.prototype.dispatchBus.call(this)},t.prototype.forward=function(t){return e.prototype.forward.call(this,t)},t.prototype.bind=function(e,t){var r=this;return n.bind(this).then(function(){r._outboundPort=t,r._inboundPort=e,r._inboundPort.onMessage.addListener(r._onMessage)})},t.prototype.unbind=function(){var e=this;return n.bind(this).then(function(){r.isObject(e._inboundPort)&&e._inboundPort.onMessage.removeListener(e._onMessage),e._inboundPort=null,e._outboundPort=null})},t.prototype._send=function(e){var t={mType:i.PanelMessage,source:this._identity,payload:e};r.isObject(this._outboundPort)&&this._outboundPort.postMessage(t)},t.prototype._onMessage=function(e,t){var n=e.data?e.data:e;(r.contains(this._validSources,"*")||r.contains(this._validSources,n.source))&&n.source!==this._identity&&this._dispatchBus.publish(this,n.payload)},t}(o)}),define("ubp/extension/runtime/chrome/ChromeLikePanelRuntime",["require","exports","lib/lodash","lib/bluebird","../../../commons/logging/Logger","../../../commons/error/BadRequestError","../../../commons/messaging/ChromePanelMessageTransportStrategy"],function(e,t,r,n,o,i,a){"use strict";return function(){function e(e){this.namespace=e||chrome,this.createLogger(),this.namespace&&this.namespace.runtime&&this.namespace.runtime.onConnect&&this.namespace.runtime.onConnect.addListener(r.bind(this._panelConnectHandler,this))}return e.prototype.getNamespace=function(){return this.namespace},e.prototype.createLogger=function(){e._logger=e._logger||o.getLogger("ChromelikeRuntime")},e.prototype.registerPanelConnect=function(t){var r=this;return this._panelMessageHandler=t,n.bind(this).then(function(){r._panelPort&&r._panelMessageHandler&&(r._setGatewayTransportStrategy(),e._logger.info("_panelConnectHandler","Calling GatewayCore callback that was registered"),r._panelMessageHandler.call(r,r._transport))})},e.prototype.registerPanelDisconnect=function(e){var t=this;return n.bind(this).then(function(){t._registeredPanelDisconnectHandler=e})},e.prototype._panelConnectHandler=function(t){var o=this;return n.bind(this).then(function(){if(!t)throw e._logger.error("_panelConnectHandler","Not a valid panel port"),new i("Not a valid port");if(e._logger.info("_panelConnectHandler","Connected extension from Panel with name => "+t.name),t.name!=e.UBP_PANEL_NAME){var n="Received connection from unrecognized port "+t.name;throw e._logger.error("_panelConnectHandler",n),new i(n)}o._panelPort=t,o._panelPort.onDisconnect.addListener(r.bind(o._panelDisconnectHandler,o)),o._panelMessageHandler&&(o._setGatewayTransportStrategy(),e._logger.info("_panelConnectHandler","Calling GatewayCore callback that was registered"),o._panelMessageHandler.call(o,o._transport))})},e.prototype._setGatewayTransportStrategy=function(){this._panelPort&&this._panelMessageHandler&&(this._transportStrategyOptions={identity:"PlatformHub",inboundPort:this._panelPort,outboundPort:this._panelPort,validOrigins:["*"],validSources:["*"]},this._transport=new a(this._transportStrategyOptions))},e.prototype._panelDisconnectHandler=function(){return this.destroyPanel()},e.prototype.destroyPanel=function(){var e=this;return n.bind(this).then(function(){e._panelPort=null,"function"==typeof e._registeredPanelDisconnectHandler&&e._registeredPanelDisconnectHandler()})},e.prototype.registerPanelMessageHandler=function(e){var t=this;return n.bind(this).then(function(){t._panelPort.onMessage.addListener(e)})},e.prototype.createConnectionToExtension=function(t){var r=this;if(!t||!t.name)return e._logger.error("createConnectionToExtension","Wrong request panel connection request"),n.reject(new i("Wrong request panel connection request"));var o=t.name;return e.UBP_PANEL_NAME!==o?(e._logger.error("createConnectionToExtension","Wrong port name ["+o+"] in the request"),n.reject(new i("Wrong port name ["+o+"] in the request"))):n.bind(this).then(function(){r._panelPort=r.namespace.runtime.connect(t)})},e.prototype.registerExtensionMessageHandler=function(e){var t=this;return n.bind(this).then(function(){t._panelPort.onMessage.addListener(e)})},e.prototype.sendMessageToExtensionPort=function(e){return e.data?this._sendMessageToExternalPort(e.data):this._sendMessageToExternalPort(e)},e.prototype.sendMessageToPanelPort=function(e){return this._sendMessageToExternalPort(e)},e.prototype.addMessageListener=function(e,t){return n.bind(this).then(function(){window.addEventListener(e,t,!1)})},e.prototype._sendMessageToExternalPort=function(e){var t=this;return n.bind(this).then(function(){t._panelPort.postMessage(e)})},e.prototype.sendPostConnectionMessageToExtension=function(){return n.resolve()},e.UBP_PANEL_NAME="UBPv2Panel",e}()}),define("ubp/extension/runtime/platformInfo/userAgent/regexElements/RegexElement",["require","exports"],function(e,t){"use strict";return function(){function e(e,t){this.regex=e,this.replacement=t||""}return e.prototype.getRegex=function(){return this.regex},e.prototype.getReplacement=function(){return this.replacement},e.prototype.classify=function(e){var t=e.match(new RegExp(this.getRegex()));if(t)return this._getParseData(t)},e.prototype._getParseData=function(e){var t=this.getReplacement()?this.getReplacement():e[1]||"other",r=isNaN(parseInt(e[2]))?null:parseInt(e[2]),n=isNaN(parseInt(e[3]))?null:parseInt(e[3]),o=isNaN(parseInt(e[4]))?null:parseInt(e[4]),i=null!==r?r+"":"";return i+=null!==n?"."+n:"",i+=null!==o?"."+o:"",{getName:function(){return t},getVersion:function(){return i}}},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/os/OSRegexElement",["require","exports","../RegexElement"],function(e,t,r){"use strict";return function(e){function t(t,r){return e.call(this,t,r)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/device/DeviceRegexElement",["require","exports","../RegexElement"],function(e,t,r){"use strict";return function(e){function t(t,r,n){var o=e.call(this,t,r)||this;return o._tablet=n||!1,o}return __extends(t,e),t.prototype.isTablet=function(){return this._tablet},t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/browsers/BrowserRegexElement",["require","exports","../RegexElement"],function(e,t,r){"use strict";return function(e){function t(t,r){return e.call(this,t,r)||this}return __extends(t,e),t}(r)}),define("ubp/extension/runtime/platformInfo/UserAgentRegexVisitor",["require","exports","./userAgent/regexElements/os/OSRegexElement","./userAgent/regexElements/device/DeviceRegexElement","./userAgent/regexElements/browsers/BrowserRegexElement","lib/lodash"],function(e,t,r,n,o,i){"use strict";return function(){function e(e){this.userAgentString=e,this.deviceResult=null,this.osResult=null,this.browserResult=null,this.isTablet=!1}return e.prototype.visit=function(e){e instanceof r&&!this.osResult?this.osResult=e.classify(this.userAgentString):e instanceof n&&!this.deviceResult?(this.deviceResult=e.classify(this.userAgentString),this.isTablet=e.isTablet()):e instanceof o&&!this.browserResult&&(this.browserResult=e.classify(this.userAgentString))},e.prototype.getBrowserName=function(){return this.browserResult?this.browserResult.getName():""},e.prototype.getBrowserVersion=function(){return this.browserResult?this.browserResult.getVersion():""},e.prototype.getOSName=function(){return this.osResult?this.osResult.getName():""},e.prototype.getOSVersion=function(){return this.osResult?this.osResult.getVersion():""},e.prototype.getDeviceName=function(){return this.deviceResult?this.deviceResult.getName():this.getDeviceType()},e.prototype.getDeviceType=function(){return this.deviceResult&&!0===this.isTablet?"Tablet":this.deviceResult&&i.contains(e.mobileFamily,this.deviceResult.getName())?"Mobile":"Desktop"},e.prototype.getDeviceVersion=function(){return this.deviceResult?this.deviceResult.getVersion():""},e.prototype.getUserAgentString=function(){return this.userAgentString},e.mobileFamily=["Android","FireFox Mobile","Opera Mobile","Opera Mini","Jasmine","UP.Browser","Bolt","Dolfin","Tizen Browser","Polaris","BREW"],e}()}),define("ubp/extension/runtime/platformInfo/userAgent/parsers/UserAgentParser",["require","exports","../../UserAgentRegexVisitor","lib/bluebird"],function(e,t,r,n){"use strict";return function(){function e(e){this._uaRegexElements=e}return e.prototype.parse=function(e){for(var t=this,o=new r(e),i=0,a=this._uaRegexElements.length;i<a;i++)this._uaRegexElements[i].accept(o);return n.bind(this).then(function(){return t._extractRuntimeInfo(o,e)})},e.prototype._extractRuntimeInfo=function(e,t){return{browserVersion:e.getBrowserVersion(),operatingSystem:e.getOSName(),device:e.getDeviceName(),browser:e.getBrowserName(),userAgent:t}},e}()}),define("ubp/extension/runtime/platformInfo/userAgent/regexElements/RegexElementCollection",["require","exports"],function(e,t){"use strict";return function(){function e(e){this._regexElements=e}return e.prototype.accept=function(e){for(var t=0,r=this._regexElements.length;t<r;t++)e.visit(this._regexElements[t])},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/os/AndroidOSUARegexElementCollection",["require","exports","../RegexElementCollection","./OSRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(Android) (\\d+)\\.(\\d+)(?:[.\\-]([a-z0-9]+))?"),new n("(Android)\\-(\\d+)\\.(\\d+)(?:[.\\-]([a-z0-9]+))?"),new n("(Android) Donut"),new n("(Android) Eclair"),new n("(Android) Froyo"),new n("(Android) Gingerbread"),new n("(Android) Honeycomb"),new n("(Silk-Accelerated=[a-z]{4,5})","Android")];return e.call(this,t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/os/MacOSUARegexElementCollection",["require","exports","../RegexElementCollection","./OSRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(Mac OS X) (\\d+)[_.](\\d+)(?:[_.](\\d+))?","Mac"),new n("(?:PPC|Intel) (Mac OS X)","Mac")];return e.call(this,t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/os/IosOSUARegexElementCollection",["require","exports","../RegexElementCollection","./OSRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(CPU OS|iPhone OS) (\\d+)_(\\d+)(?:_(\\d+))?","IOS"),new n("(iPhone|iPad|iPod); Opera","IOS"),new n("(iPhone|iPad|iPod).*Mac OS X.*Version/(\\d+)\\.(\\d+)","IOS")];return e.call(this,t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/os/WindowOSUARegexElementCollection",["require","exports","../RegexElementCollection","./OSRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(Windows (?:NT 5\\.2|NT 5\\.1))","Windows XP"),new n("(Windows NT 6\\.1)","Windows 7"),new n("(Windows NT 6\\.0)","Windows Vista"),new n("(Windows 98|Windows XP|Windows ME|Windows 95|Windows CE|Windows 7|Windows NT 4\\.0|Windows Vista|Windows 2000)"),new n("(Windows NT 6\\.2)","Windows 8"),new n("(Windows NT 6\\.3)","Windows 8.1"),new n("(Windows NT 10\\.0)","Windows 10"),new n("(Windows NT 5\\.0)","Windows 2000"),new n("(WinNT4.0)","Windows NT 4.0"),new n("(Win98)","Windows 98"),new n("(Windows NT \\d\\.\\d)","Windows"),new n("(Windows \\d\\.\\d)")];return e.call(this,t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/os/LinuxOSUARegexElementCollection",["require","exports","../RegexElementCollection","./OSRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(SUSE|Fedora|Red Hat|Puppy|PCLinuxOS|CentOS)/(\\d+)\\.(\\d+)\\.(\\d+)","Linux"),new n("(Ubuntu|Kindle|Bada|Lubuntu|BackTrack|Red Hat|Slackware)/(\\d+)\\.(\\d+)","Linux"),new n("OpenBSD|FreeBSD|NetBSD|Ubuntu|Kubuntu|Android|Arch Linux|CentOS|WeTab|Slackware","Linux"),new n("(Linux|BSD)","Linux")];return e.call(this,t)||this}return __extends(t,e),t}(r)}),define("ubp/extension/runtime/platformInfo/userAgent/regexElements/os/OSRegexElementCollection",["require","exports","./AndroidOSUARegexElementCollection","./MacOSUARegexElementCollection","./IosOSUARegexElementCollection","./WindowOSUARegexElementCollection","./LinuxOSUARegexElementCollection"],function(e,t,r,n,o,i,a){"use strict";return function(){function e(){this._uaRegexElementArray=[new r,new n,new o,new i,new a]}return e.prototype.accept=function(e){for(var t=0,r=this._uaRegexElementArray.length;t<r;t++)this._uaRegexElementArray[t].accept(e)},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/device/TabletDeviceUARegexElementCollection",["require","exports","../RegexElementCollection","./DeviceRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(iPad).*Version/(\\d+)\\.(\\d+)\\.(\\d+)","iPad",!0),new n("(iPad).*Version/(\\d+)\\.(\\d+)","iPad",!0),new n("(iPad)","iPad",!0),new n("(PlayBook).+RIM Tablet OS (\\d+)\\.(\\d+)\\.(\\d+)","Blackberry WebKit",!0),new n("(Silk)/(\\d+)\\.(\\d+)(?:\\.([0-9\\-]+))?","Kindle Fire",!0)];return e.call(this,t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/device/MobileDeviceUARegexElementCollection",["require","exports","../RegexElementCollection","./DeviceRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(Fennec)/(\\d+)\\.(\\d+)\\.?([ab]?\\d+[a-z]*)","FireFox Mobile"),new n("(Fennec)/(\\d+)\\.(\\d+)(pre)","FireFox Mobile"),new n("(Fennec)/(\\d+)\\.(\\d+)","FireFox Mobile"),new n("Mobile.*(Firefox)/(\\d+)\\.(\\d+)","FireFox Mobile"),new n("(Opera)/.+Opera Mobi.+Version/(\\d+)\\.(\\d+)","Opera Mobile"),new n("Opera Mobi","Opera Mobile"),new n("(Opera Mini)/(\\d+)\\.(\\d+)","Opera Mini"),new n("(Opera Mini)/att/(\\d+)\\.(\\d+)","Opera Mini"),new n("(Jasmine|Opera Mini||UP\\.Browser|)/(\\d+)\\.(\\d+)\\.(\\d+)"),new n("(Bolt|BOLT|Jasmine|Opera Mini|Opera|Dolfin|Tizen Browser|Polaris)/(\\d+)\\.(\\d+)"),new n("(Jasmine|Polaris|Android|BREW) (\\d+)\\.(\\d+)\\.?(\\d+)?")];return e.call(this,t)||this}return __extends(t,e),t}(r)}),define("ubp/extension/runtime/platformInfo/userAgent/regexElements/device/DeviceRegexElementCollection",["require","exports","./TabletDeviceUARegexElementCollection","./MobileDeviceUARegexElementCollection"],function(e,t,r,n){"use strict";return function(){function e(){this._uaRegexElementArray=[new r,new n]}return e.prototype.accept=function(e){for(var t=0,r=this._uaRegexElementArray.length;t<r;t++)this._uaRegexElementArray[t].accept(e)},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/regexElements/browsers/ChromeLikeBrowserRegexElementCollection",["require","exports","../RegexElementCollection","./BrowserRegexElement"],function(e,t,r,n){"use strict";return function(e){function t(){var t=[new n("(Chrome)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+) Mobile","Chrome Mobile"),new n("(Chromium|Maxthon|Chrome|Vienna)/(\\d+)\\.(\\d+)\\.(\\d+)"),new n("(Maxthon|Chrome)/(\\d+)\\.(\\d+)"),new n("(MetaSr) (\\d+)\\.(\\d+)"),new n("(Fennec)/(\\d+)\\.(\\d+)\\.?([ab]?\\d+[a-z]*)","Firefox mobile"),new n("(Fennec)/(\\d+)\\.(\\d+)(pre)","Firefox mobile"),new n("(Fennec)/(\\d+)\\.(\\d+)","Firefox mobile"),new n("Mobile.*(Firefox)/(\\d+)\\.(\\d+)","Firefox mobile"),new n("(Firefox)/(\\d+)\\.(\\d+)(a\\d+[a-z]*)","Firefox alpha"),new n("(Firefox)/(\\d+)\\.(\\d+)(b\\d+[a-z]*)","Firefox beta"),new n("(Firefox)-(?:\\d+\\.\\d+)?/(\\d+)\\.(\\d+)(a\\d+[a-z]*)","Firefox alpha"),new n("(Firefox)-(?:\\d+\\.\\d+)?/(\\d+)\\.(\\d+)(b\\d+[a-z]*)","Firefox beta"),new n("(Firefox)/(\\d+)\\.(\\d+)\\.(\\d+)"),new n("(Firefox)/(\\d+)\\.(\\d+)(pre|[ab]\\d+[a-z]*)?")];return e.call(this,t)||this}return __extends(t,e),t}(r)});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/platformInfo/userAgent/parsers/ChromelikeUAParser",["require","exports","./UserAgentParser","../regexElements/os/OSRegexElementCollection","../regexElements/device/DeviceRegexElementCollection","../regexElements/browsers/ChromeLikeBrowserRegexElementCollection"],function(e,t,r,n,o,i){"use strict";return function(e){function t(){var t=[new n,new o,new i];return e.call(this,t)||this}return __extends(t,e),t}(r)});var factory=function(){"use strict";var e=function(){};return e.getWebRequestConfiguration=function(){return{enabled:!1,trackingURLPatterns:[]}},e};"undefined"!=typeof module&&module.exports?module.exports=factory():void 0!==define&&define("configuration/IntegrationTestConfiguration",[],factory),define("ubp/extension/runtime/chrome/WebRequestAccessor",["require","exports","../../../commons/logging/Logger","configuration/IntegrationTestConfiguration"],function(e,t,r,n){"use strict";return function(){function e(t,o){this._namespace=t,this._runtime=o,e._logger=e._logger||r.getLogger("WebRequestAccessor");try{this._webrequestConfiguration=n.getWebRequestConfiguration(),this._webrequestConfiguration&&this._webrequestConfiguration.enabled&&Array.isArray(this._webrequestConfiguration.trackingURLPatterns)&&this._webrequestConfiguration.trackingURLPatterns.length>0&&this._setupHandlers()}catch(t){e._logger.error("WebRequestAccessor","Error while setting up handlers"+t)}}return e.prototype._setupHandlers=function(){this._namespace.webRequest.onBeforeRequest.addListener(_.bind(this.onWebRequestBeforeRequest,this),{urls:this._webrequestConfiguration.trackingURLPatterns},["requestBody"]),this._namespace.webRequest.onBeforeSendHeaders.addListener(_.bind(this.onWebRequestBeforeSendHeaders,this),{urls:this._webrequestConfiguration.trackingURLPatterns},["requestHeaders"]),this._namespace.webRequest.onCompleted.addListener(_.bind(this.onWebRequestCompleted,this),{urls:this._webrequestConfiguration.trackingURLPatterns},["responseHeaders"])},e.prototype.onWebRequestBeforeRequest=function(t){try{this._runtime.notify(this._runtime.RUNTIME_EVENT,{name:e._ON_BEFORE_REQUEST_EVENT,eventArgs:{tabId:t.tabId,requestId:t.requestId,url:t.url,method:t.method,frameId:t.frameId,parentFrameId:t.parentFrameId,timeStamp:t.timeStamp,requestBody:t.requestBody,type:t.type},tabId:t.tabId})}catch(t){e._logger.error("onWebRequestBeforeRequest","Error while notifying"+t)}},e.prototype.onWebRequestBeforeSendHeaders=function(t){try{this._runtime.notify(this._runtime.RUNTIME_EVENT,{name:e._ON_BEFORE_SEND_HEADERS_EVENT,eventArgs:{tabId:t.tabId,requestId:t.requestId,url:t.url,method:t.method,frameId:t.frameId,parentFrameId:t.parentFrameId,timeStamp:t.timeStamp,type:t.type,initiator:t.initiator,requestHeaders:t.requestHeaders},tabId:t.tabId})}catch(t){e._logger.error("onWebRequestBeforeSendHeaders","Error while notifying"+t)}},e.prototype.onWebRequestCompleted=function(t){try{this._runtime.notify(this._runtime.RUNTIME_EVENT,{name:e._ON_COMPLETED_EVENT,eventArgs:{tabId:t.tabId,requestId:t.requestId,url:t.url,method:t.method,frameId:t.frameId,parentFrameId:t.parentFrameId,timeStamp:t.timeStamp,type:t.type,ip:t.ip,fromCache:t.fromCache,statusCode:t.statusCode,responseHeaders:t.responseHeaders,statusLine:t.statusLine},tabId:t.tabId})}catch(t){e._logger.error("onWebRequestCompleted","Error while notifying"+t)}},e._ON_BEFORE_REQUEST_EVENT="WebRequest.onBeforeRequest",e._ON_BEFORE_SEND_HEADERS_EVENT="WebRequest.onBeforeSendHeaders",e._ON_COMPLETED_EVENT="WebRequest.onCompleted",e}()}),define("ubp/commons/specification/arguments/Platform/Sandbox/StaticSandboxProxy",["require","exports"],function(e,t){"use strict";return{LocalProxy:"LocalProxy",CookieProxy:"CookieProxy"}});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/extension/runtime/chrome/ChromelikeRuntime",["require","exports","lib/bluebird","lib/lodash","../BaseRuntime","../../process/IFrameProcess","./ChromelikeContentScripts","../../../commons/logging/Logger","../../../commons/error/Errors","./ChromeLikePanelRuntime","../platformInfo/userAgent/parsers/ChromelikeUAParser","../../../commons/error/FeatureUnavailableError","../../../commons/error/InternalError","./WebRequestAccessor","../../../commons/specification/arguments/Platform/Sandbox/StaticSandboxProxy"],function(e,t,r,n,o,i,a,s,u,c,l,p,f,_,d){"use strict";var g;return function(e){function t(r){var o=e.call(this)||this;return o.DESKTOP_NOTIFICATION_EVENT="DesktopNotificationEvent",o._templateTypeMap={1:"basic",2:"image"},o._availableFramePool=[],o.name="Chromelike",o._namespace=r||chrome,o.createLogger(),o._namespace.tabs.onUpdated.addListener(n.bind(o._onChromelikePageTurn,o)),o._namespace.runtime.onMessage.addListener(n.bind(o._onChromelikeExternalMessage,o)),o._namespace.tabs.onRemoved.addListener(n.bind(o._onChromelikeTabRemoved,o)),o._namespace&&o._namespace.contextMenus&&o._namespace.contextMenus.onClicked.addListener(n.bind(o._onChromelikeContextMenuClick,o)),o._redirectURLMap={},o._contentTypeMap={},o.panelRuntime=o.createPanelRuntime(),t._logger.info("constructor","ChromelikeRuntime constructed"),o.webRequestAccessor=new _(o._namespace,o),o}return __extends(t,e),t.prototype._onChromelikeContextMenuClick=function(e,t){var r={menuItemId:e.menuItemId,tabId:t.id?t.id.toString():null,tabUrl:t.url,srcUrl:e.srcUrl,selectionText:e.selectionText,parentMenuItemId:e.parentMenuItemId,mediaType:e.mediaType,linkUrl:e.linkUrl,pageUrl:e.pageUrl,frameUrl:e.frameUrl,frameId:e.frameId};this._onContextMenuClick(r)},t.prototype.isContextMenuApiSupported=function(){return!0},t.prototype.createContextMenuItem=function(e){var n=this;return new r(function(r,o){n._namespace&&n._namespace.contextMenus?r(n._namespace.contextMenus.create(e,function(){if(void 0!==chrome.runtime.lastError){var e=new f(chrome.runtime.lastError.message);t._logger.error("createContextMenuItem",e.toString()),o(e)}})):o(new p("chrome.contextMenus.create API unavailable"))})},t.prototype.deleteAllContextMenuItems=function(){var e=this;return new r(function(t,r){e._namespace&&e._namespace.contextMenus&&e._namespace.contextMenus.removeAll?e._namespace.contextMenus.removeAll(function(){t()}):r(new p("chrome.contextMenus.removeAll API is unavailable"))})},t.prototype.deleteContextMenuItemById=function(e){var t=this;return new r(function(r,n){t._namespace&&t._namespace.contextMenus&&t._namespace.contextMenus.remove?t._namespace.contextMenus.remove(e,function(){r()}):n(new p("chrome.contextMenus.remove API is unavailable"))})},t.prototype.getNamespace=function(){return this._namespace},t.prototype.createLogger=function(){t._logger=t._logger||s.getLogger("ChromelikeRuntime")},t.prototype._onChromelikeExternalMessage=function(e,t){e&&"number"==typeof e.performanceType||this._onExternalMessage(e,t.tab.id.toString())},t.prototype.createPanelRuntime=function(){return new c(chrome)},t.prototype.createProcessInstance=function(e,t,r){return new i(e,t,r,this._availableFramePool.pop())},t.prototype.destroyProcessInstance=function(e){var t=this;return e.terminate().then(function(e){t._availableFramePool.push(e)})},t.prototype.sendMessage=function(e,n,o){var i=this;return t._logger.debug("sendMessage","sendMessage called for tab: "+e),new r(function(r,n){i._namespace.tabs.sendMessage(parseInt(e),o,function(e){if(arguments.length)r(e);else{var o=new Error(this._namespace.runtime.lastError.toString());t._logger.error("sendMessage",o.toString()),n(o)}})}).timeout(this.MESSAGE_TIMEOUT)},t.prototype.executeScript=function(e,n){return t._logger.debug("executeScript","ExecuteScript called for file: "+n),new r(function(r,o){var i=this;this._namespace.tabs.executeScript(parseInt(e),{file:n,allFrames:!1,runAt:"document_idle"
},function(e){if(i._checkLastError()){var n=new Error(i._namespace.runtime.lastError.toString());t._logger.error("executeScript",n.toString()),o(n)}r(null)})}.bind(this))},t.prototype.setTimeout=function(e,t){return window.setTimeout(e,t)},t.prototype.clearTimeout=function(e){window.clearTimeout(e)},t.prototype.delay=function(e){var t=this;return new r(function(r){t.setTimeout(r,e)})},t.prototype.executeScripts=function(e,n){return t._logger.debug("executeScripts","ExecuteScripts called for files: "+n),r.bind(this).then(function(){return n}).reduce(function(t,r){return t++,this.executeScript(e,r)},0).then(function(){return"chromelike"})},t.prototype.openNewTab=function(e){var n=this;return new r(function(r,o){n._namespace&&n._namespace.tabs&&n._namespace.tabs.create?n._namespace.tabs.create({url:e},function(e){if(e&&void 0!==e.id)r(e.id.toString());else{var n=new Error(this._namespace.runtime.lastError.toString());t._logger.error("openNewTab",n.toString()),o(n)}}):o(new Error("_namespace.tabs.create API unavailable"))}).timeout(this.NEW_TAB_TIMEOUT)},t.prototype.removeTab=function(e){var t=this;return new r(function(r,n){t._namespace&&t._namespace.tabs&&t._namespace.tabs.remove?t._namespace.tabs.remove(e,function(){r()}):n(new Error("_namespace.tabs.remove API unavailable"))})},t.prototype.createDesktopNotification=function(e,o){var i=this;return r.bind(this).then(function(){var r=i._prepareNotificationOptions(e,o);i._checkNotificationSupport(),i._registerClickHandler(),i._registerCloseHandler(),i._namespace.notifications.create(o.id,r,function(){});try{n.has(o,"redirectURL")&&(i._redirectURLMap[o.id]=o.redirectURL),n.has(o,"contentType")&&(i._contentTypeMap[o.id]=o.contentType),i._timeoutHandle=i.setTimeout(function(){delete i._redirectURLMap[o.id],delete i._contentTypeMap[o.id],i._namespace.notifications.clear(o.id),i._publishNotificationEvent("DesktopNotification.Closed",o.id,"Closed")},t.NOTIFICATION_TIMEOUT)}catch(e){t._logger.error("createDesktopNotification","Error during notification creation for notificationID ["+o.id+"] "+e)}})},t.prototype.getCookieInfo=function(e,n){var o=this;return new r(function(r,i){try{o._namespace&&o._namespace.cookies&&o._namespace.cookies.get?o._namespace.cookies.get({name:e,url:n},function(e){if(e&&void 0!==e.name){var t={name:e.name,domain:e.domain,value:e.value,path:e.path,session:e.session,expirationDate:e.expirationDate},n={cookieFound:!0,cookieInfo:t};r(n)}else{var n={cookieFound:!1};r(n)}}):i(new Error("_namespace.cookies.get API unavailable"))}catch(e){var a=new Error(o._namespace.runtime.lastError.toString());t._logger.error("getCookieInfo",a.toString()),i(a)}})},t.prototype.bulkGetCookieInfo=function(e,n){var o=this;return new r(function(r,i){try{o._namespace&&o._namespace.cookies&&o._namespace.cookies.getAll?o._namespace.cookies.getAll({url:n},function(t){var n={};t.forEach(function(t){if(-1!==e.indexOf(t.name)){var r={name:t.name,domain:t.domain,value:t.value,path:t.path,session:t.session,expirationDate:t.expirationDate};n[t.name]=r}}),r({cookieInfoMap:n})}):i(new Error("_namespace.cookies.getAll API unavailable"))}catch(e){var a=new Error(o._namespace.runtime.lastError.toString());t._logger.error("bulkGetCookieInfo",a.toString()),i(a)}})},t.prototype.getActiveTabInfo=function(){var e=this;return new r(function(t,r){e._namespace.tabs.query({active:!0,lastFocusedWindow:!0},function(e){e.length>0?t({activeTab:e[0].id.toString(),title:e[0].title,url:e[0].url}):r(u.NotFound("No active tab found."))})})},t.prototype.renderButtonText=function(e){var t=this;return new r(function(r,o){if(!(t._namespace&&t._namespace.browserAction&&t._namespace.browserAction.setIcon))return void o(new Error("_namespace.browserAction.setIcon API unavailable"));t._namespace.browserAction.setIcon({path:{16:chrome.extension.getURL("static/images/asmile_16.png"),48:chrome.extension.getURL("static/images/asmile_48.png"),128:chrome.extension.getURL("static/images/asmile_128.png")}},function(){if(!t._namespace.browserAction.setBadgeBackgroundColor||!t._namespace.browserAction.setBadgeText)return void o(new Error("_namespace.browserAction.setBadgeBackgroundColor or _namespace.browserAction.setBadgeText API unavailable"));if(t._namespace.browserAction.setBadgeBackgroundColor({color:t.BADGE_COLOR}),null===e||n.isUndefined(e)||""===e.trim())t._namespace.browserAction.setBadgeText({text:""});else{var i=e||"";t._namespace.browserAction.setBadgeText({text:i})}r()})})},t.prototype._onChromelikePageTurn=function(e,t,r){r.incognito||(t.title?this._onPageTurn(e.toString(),r.url,"title",r.title):this._onPageTurn(e.toString(),r.url,t.status,r.title))},t.prototype._onChromelikeTabRemoved=function(e,t){this._onTabRemoved(e.toString())},t.prototype.getExtensionVersion=function(){return this._namespace.runtime.getManifest().version},t.prototype.getExtensionResourceURL=function(e){void 0===e&&(e="");try{return this._namespace.runtime.getURL(e)}catch(e){return""}},t.prototype.getUserAgent=function(){var e;try{e=window.navigator.userAgent}catch(e){throw u.NotFound("Not able to get userAgent from winow object, Error: "+e.message)}return e},t.prototype.getCookies=function(e){return r.resolve()},t.prototype.getTotalTabsByQuery=function(e){var t=this;return new r(function(r){t._namespace.tabs.query(e,function(e){r(void 0!=e?e.length:0)})})},t.prototype.onCookieChangeAction=function(){return r.resolve()},t.prototype.getRuntimeName=function(){return this.name},t.prototype.getContentScripts=function(){return t.CONTENT_SCRIPTS},t.prototype.getLocalProxyUrl=function(){return this._namespace.runtime.getURL(t.LOCAL_PROXY_PATH)},t.prototype.getStaticAssetProxy=function(e){return this._namespace.runtime.getURL(t._staticProxyTypeToUrl[e])},t.prototype.getFromExtensionStorage=function(e){return new r(function(r,n){var o=[];o.push(e),this._bulkGetFromChromeExtensionStorage(o,function(o,i){o?(t._logger.error("getFromExtensionStorage","Error during extension storage get for key ["+e+"] "+o),n(o)):(t._logger.debug("getFromExtensionStorage","extension storage value for key ["+e+"] = ["+i+"]"),r(i[e]))})}.bind(this))},t.prototype.bulkGetFromExtensionStorage=function(e){return new r(function(r,n){this._bulkGetFromChromeExtensionStorage(e,function(e,o){e?(t._logger.error("bulkGetFromExtensionStorage","Error during extension storage get "+e),n(e)):(t._logger.debug("bulkGetFromExtensionStorage","extension storage values retrieved = ["+JSON.stringify(o)+"]"),r(o))})}.bind(this))},t.prototype._bulkGetFromChromeExtensionStorage=function(e,r){this._namespace&&this._namespace.storage&&this._namespace.storage.local&&this._namespace.storage.local.get(e,function(e){if(this._checkLastError())t._logger.error("_bulkGetFromChromeExtensionStorage","Error during retrieving values from storage "),r(new Error("Error during retrieving values from storage"),null);else{var o={};e&&n.forEach(e,function(r,n){o[n]=t._stringifyIfNotString(e[n])}),r(null,o)}}.bind(this))},t.prototype.putInExtensionStorage=function(e,n){var o=this;return r.bind(this).then(function(){o._putInExtensionStorage(e,n,function(r){if(r)throw t._logger.error("putInExtensionStorage","Error during extension storage set for key ["+e+"] "+r),r;t._logger.debug("putInExtensionStorage","extension storage stored key/value pair ["+e+"] = ["+n+"]")})})},t.prototype._putInExtensionStorage=function(e,r,n){var o={};o[e]=r,this._namespace&&this._namespace.storage&&this._namespace.storage.local&&this._namespace.storage.local.set(o,function(){this._checkLastError()?(t._logger.error("putInExtensionStorage","Error during storing value in storage "),n(new Error("Error in storing data in storage"))):n(null)}.bind(this))},t.prototype.removeFromExtensionStorage=function(e){return new r(function(r,n){this._removeFromExtensionStorage(e,function(o){o?(t._logger.error("removeFromExtensionStorage","Error during extension storage remove for key ["+e+"] "+o),n(o)):(t._logger.debug("removeFromExtensionStorage","extension storage successfully deleted key ["+e+"]"),r())})}.bind(this))},t.prototype._removeFromExtensionStorage=function(e,r){this._namespace&&this._namespace.storage&&this._namespace.storage.local&&this._namespace.storage.local.remove(e,function(){this._checkLastError()?(t._logger.error("removeFromExtensionStorage","Error during deleting key from storage "),r(new Error("Error in deleting data from storage"))):r(null)}.bind(this))},t.prototype.bulkGetFromPreferencesStorage=function(e){return r.resolve({})},t.prototype.getFromPreferencesStorage=function(e){return r.resolve("")},t.prototype.putInPreferencesStorage=function(e,t){return r.resolve()},t.prototype.removeFromPreferencesStorage=function(e){return r.resolve()},t.prototype.getValueFromLocalStorage=function(e){return r.bind(this).then(function(){var r=localStorage.getItem(e);return t._stringifyIfNotString(r)}).catch(function(e){return e.message+=" (this may be a localStorage failure due to cookies being disabled)",t._logger.error("getValueFromLocalStorage",e.toString()),r.reject(e)})},t.prototype.bulkGetFromLocalStorage=function(e){var o={};return r.bind(this).then(function(){return n.forEach(e,function(e){var r=localStorage.getItem(e);o[e]=t._stringifyIfNotString(r)}),o}).catch(function(e){return e.message+=" (this may be a localStorage failure due to cookies being disabled)",t._logger.error("bulkGetFromLocalStorage",e.toString()),r.reject(e)})},t.prototype.setValueInLocalStorage=function(e,n){return r.bind(this).then(function(){localStorage.setItem(e,n)}).catch(function(e){return e.message+=" (this may be a localStorage failure due to cookies being disabled)",t._logger.error("setValueInLocalStorage",e.toString()),r.reject(e)})},t.prototype.removeValueFromLocalStorage=function(e){return r.bind(this).then(function(){localStorage.removeItem(e)}).catch(function(e){return e.message+=" (this may be a localStorage failure due to cookies being disabled)",t._logger.error("removeValueFromLocalStorage",e.toString()),r.reject(e)})},t.prototype.reloadExtension=function(){var e=this;return r.bind(this).then(function(){e._namespace&&e._namespace.runtime&&e._namespace.runtime.reload&&e._namespace.runtime.reload()})},t.prototype.onExtensionReload=function(e){this.on("onExtensionReload",function(){e()})},t.prototype.isOnline=function(){return r.bind(this).then(function(){return!(window&&window.navigator&&!window.navigator.onLine)})},t.prototype.onBrowserOnline=function(e){window&&window.addEventListener&&window.addEventListener("online",function(t){"function"==typeof e&&e()})},t.prototype._logLastRuntimeError=function(){this._namespace&&this._namespace.runtime&&this._namespace.runtime.lastError&&t._logger.error("_checkLastError","Last error in ChromelikeRuntime: "+JSON.stringify(this._namespace.runtime.lastError))},t.prototype._checkLastError=function(){return this._logLastRuntimeError(),!!this._namespace.runtime.lastError},t._stringifyIfNotString=function(e){return e&&"string"!=typeof e?JSON.stringify(e):e},t.prototype.processRemoteConfigurationData=function(e){return r.resolve()},t.prototype.getUAParser=function(){return new l},t.prototype.enableExtensionFeature=function(){return r.resolve(!0)},t.prototype.registerNotificationHandler=function(e){this.on(this.DESKTOP_NOTIFICATION_EVENT,e)},t.prototype._notificationClickHandler=function(e){if(this._redirectURLMap[e]){if(this._namespace.notifications.clear(e),this.openNewTab(this._redirectURLMap[e]),delete this._redirectURLMap[e],n.isUndefined(this._timeoutHandle))throw u.NotFound("Timeout handle not found");this.clearTimeout(this._timeoutHandle),this.notify(this.RUNTIME_EVENT,{name:"DesktopNotification.Clicked",eventArgs:{notificationId:e,status:"Clicked",contentType:void 0!==this._contentTypeMap[e]?this._contentTypeMap[e]:"Default"}}),delete this._contentTypeMap[e],this._publishNotificationEvent("DesktopNotification.Closed",e,"Closed")}},t.prototype._notificationCloseHandler=function(e){this._publishNotificationEvent("DesktopNotification.Closed",e,"Closed")},t.prototype._publishNotificationEvent=function(e,t,r){this.notify(this.DESKTOP_NOTIFICATION_EVENT,{name:e,eventArgs:{notificationId:t,status:r}})},t.prototype._registerClickHandler=function(){this._namespace.notifications&&!t.NOTIFICATION_ONCLICK_REGISTERED&&(this._namespace.notifications.onClicked.addListener(n.bind(this._notificationClickHandler,this)),t.NOTIFICATION_ONCLICK_REGISTERED=!0)},t.prototype._registerCloseHandler=function(){this._namespace.notifications&&!t.NOTIFICATION_ONCLOSE_REGISTERED&&(this._namespace.notifications.onClosed.addListener(n.bind(this._notificationCloseHandler,this)),t.NOTIFICATION_ONCLOSE_REGISTERED=!0)},t.prototype._checkNotificationSupport=function(){if(!(this._namespace&&this._namespace.notifications&&this._namespace.notifications.create))throw u.FeatureUnavailable("Chrome.Notifications API is unavailable")},t.prototype._prepareNotificationOptions=function(e,t){var r={type:this._templateTypeMap[e],title:t.title,message:t.text,iconUrl:chrome.extension.getURL("static/images/notif-icon.png")};return t.iconURL&&(r.iconUrl=t.iconURL),r},t.prototype.uninstallSelf=function(e){var n=this;return new r(function(r,o){n._namespace&&n._namespace.management&&n._namespace.management.uninstallSelf?n._namespace.management.uninstallSelf({showConfirmDialog:e},function(){this._checkLastError()?(t._logger.error("uninstallSelf","Error while uninstalling the extension "),o(this._namespace.runtime.lastError.message)):r()}.bind(n)):o(new p("chrome.management.uninstallSelf API is unavailable"))})},t.prototype.getExtensionDetails=function(){var e=this;return new r(function(r,n){e._namespace&&e._namespace.management&&e._namespace.management.getSelf?e._namespace.management.getSelf(function(e){this._checkLastError()?(t._logger.error("getExtensionDetails","Error while retrieving extension details"),n(this._namespace.runtime.lastError.message)):r(e)}.bind(e)):n(new p("chrome.management.getSelf API is unavailable"))})},t.CONTENT_SCRIPTS=new a,t.LOCAL_PROXY_PATH="static/html/localProxy.html",t._staticProxyTypeToUrl=(g={},g[d.LocalProxy]="static/html/localProxy.html",g[d.CookieProxy]="static/html/cookieProxy.html",g),t.NOTIFICATION_TIMEOUT=8e3,t.NOTIFICATION_ONCLICK_REGISTERED=!1,t.NOTIFICATION_ONCLOSE_REGISTERED=!1,t.RED_DOT_BADGE=".",t}(o)}),define("ubp/commons/messaging/clients/network/XHRState",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.UNSENT=0]="UNSENT",e[e.OPENED=1]="OPENED",e[e.HEADERS_RECEIVED=2]="HEADERS_RECEIVED",e[e.LOADING=3]="LOADING",e[e.DONE=4]="DONE"}(r||(r={})),r}),define("ubp/commons/messaging/clients/network/NetworkRequestError",["require","exports"],function(e,t){"use strict";return function(){function e(e,t,r,n,o){this.error=e||new Error("Network Error"),this.status=t,this.statusText=r,this.didTimeout=n||!1,this.responseText=o||""}return e}()}),define("ubp/commons/messaging/clients/network/NetworkClientError",["require","exports","lib/lodash"],function(e,t,r){"use strict";return function(){function e(e,t,n,o){var i=r.isUndefined(o)?"":"URL: "+o+", ",a=r.isUndefined(t)?"":t+", ",s=r.isUndefined(n)?"":"response: "+n;this.status=t,this.responseText=n,this.message=e+": "+a+i+s}return Object.defineProperty(e.prototype,"name",{get:function(){return e.Name},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return this.name+": "+this.message},e.Name="NetworkClientError",e}()}),define("ubp/commons/messaging/clients/network/BaseNetworkClient",["require","exports","lib/bluebird","lib/lodash","./HTTPStatus","./HTTPMethod","./NetworkRequestError","./NetworkClientError"],function(e,t,r,n,o,i,a,s){"use strict";return function(){function e(e){this._defaultConfig={headers:{},timeout:0,httpMethod:i.GET,maxAttempts:1,backoffFactor:2,initialRetryInterval:1e3,withCredentials:!1},this.delay=e||n.bind(r.delay,r)}return e.prototype.request=function(e,t,o){var a=this;return r.bind(this).then(function(){if(t||(t={}),n.defaults(t,a._defaultConfig),!e||"string"!=typeof e)throw new Error("Must provide a string URL: "+e);if(!i[t.httpMethod])throw new Error("Unrecognized HTTPMethod: "+t.httpMethod);if((t.httpMethod===i.GET||t.httpMethod===i.HEAD)&&t.data)throw new Error("Cannot send data in a GET or HEAD request");var r=t.maxAttempts;return a._buildAndSendRequestWithRetries(e,t,r,o)})},e.prototype._buildAndSendRequest=function(e,t){throw new Error("Implement me! I'm abstract and stuff!")},e.prototype._buildAndSendRequestWithRetries=function(t,o,i,u){var c=this;return r.bind(this).then(function(){if(n.isFunction(u))return u()}).then(function(){return c._buildAndSendRequest(t,o)}).catch(function(n){if(!(n instanceof a))throw n;if(i--,e.isHTTPStatus5xx(n.status)){if(i<=0)throw new s("Network request failed with 5xx error",n.status,n.responseText);return r.bind(c).then(function(){return c.delay(Math.pow(o.backoffFactor,o.maxAttempts-i-1)*o.initialRetryInterval,"_BuildAndSendRequestWithRetries.DelayBetweenAttempts")}).then(function(){return c._buildAndSendRequestWithRetries(t,o,i,u)})}throw e.isHTTPStatus2xx(n.status)?new s("Non-approved 2xx Success",n.status,n.responseText,t):e.isHTTPStatus3xx(n.status)?new s("3xx Redirection",n.status,n.responseText,t):e.isHTTPStatus4xx(n.status)?new s("4xx Client Error",n.status,n.responseText,t):new s("non-2xx/3xx/4xx/5xx status: URL: "+t+" Error: "+JSON.stringify(n))})},e.isHTTPStatusSuccessful=function(e){return e===o.OK||e===o.CREATED||e===o.ACCEPTED||e===o.NO_CONTENT},e.isHTTPStatus2xx=function(e){return 2===Math.floor(e/100)},e.isHTTPStatus3xx=function(e){return 3===Math.floor(e/100)},e.isHTTPStatus4xx=function(e){return 4===Math.floor(e/100)},e.isHTTPStatus5xx=function(e){return 5===Math.floor(e/100)},e}()});var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("ubp/commons/messaging/clients/network/XHRNetworkClient",["require","exports","lib/bluebird","lib/lodash","./HTTPMethod","./XHRState","./BaseNetworkClient","./NetworkRequestError","../../../logging/Logger"],function(e,t,r,n,o,i,a,s,u){"use strict";return function(e){function t(t){var r=e.call(this)||this;if(r.xhr=t||XMLHttpRequest,!r.xhr)throw new Error("Needs a native XHR constructor");return r}return __extends(t,e),t.prototype._buildAndSendRequest=function(e,t){var a=this;return new r(function(r,u){var c=new a.xhr;t.withCredentials&&(c.withCredentials=!0),c.open(o[t.httpMethod],e,!0),n.each(t.headers,function(e,t){c.setRequestHeader(t,e)}),t.responseType&&"responseType"in c&&(c.responseType=t.responseType),c.timeout=t.timeout,c.ontimeout=function(){u(new s(new Error("Request timed out"),void 0,void 0,!0))},c.onreadystatechange=function(){switch(c.readyState){case i.DONE:a.onRequestCompleted(c,t,r,u)}};try{c.send(t.data)}catch(e){u(e)}})},t.prototype.onRequestCompleted=function(e,t,r,o){if(a.isHTTPStatusSuccessful(e.status)){var i=null;try{i=e.response||e.responseText||e.responseXML}catch(e){}if("string"==typeof i&&"json"===t.responseType)try{i=JSON.parse(i)}catch(e){}r({data:i,headers:this.parseResponseHeaders(e.getAllResponseHeaders()),status:e.status,statusText:e.statusText})}else{var u="";try{"json"===e.responseType?n.isObject(e.response)?u=JSON.stringify(e.response):n.isString(e.response)&&(u=e.response):""!==e.responseType&&"text"!==e.responseType||(u=e.responseText)}catch(e){}o(new s(new Error("HTTP status code: "+e.status+" "+e.statusText),e.status,e.statusText,!1,u))}},t.prototype.parseResponseHeaders=function(e){var t={};if(!e)return t;var r=e.split("\r\n");return n.each(r,function(e){var r=e.indexOf(": "),n=e.slice(0,r);t[n]=e.slice(r+2)}),t},t.logger=u.getLogger("XHRNetworkClient"),t}(a)}),define("ubp/extension/bootstrapper/Chromelike_ExtensionEntrypoint",["require","exports","./ExtensionBootstrapper","../runtime/chrome/ChromelikeRuntime","../../commons/messaging/clients/network/XHRNetworkClient"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),new r(new n(chrome),new o(XMLHttpRequest)).start()}),require(["ubp/extension/bootstrapper/Chromelike_ExtensionEntrypoint"]);