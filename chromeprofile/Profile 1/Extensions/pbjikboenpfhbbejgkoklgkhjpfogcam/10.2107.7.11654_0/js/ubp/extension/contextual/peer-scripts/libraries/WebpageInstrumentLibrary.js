var Instrumentor;
(function (Instrumentor) {
    var WebpageLibrary = (function () {
        function WebpageLibrary(_htmlDocument) {
            this._htmlDocument = _htmlDocument;
            this._apiMap = {
                "UBPWebpageInstrumentWebpage": this.handleInstrumentWebpage.bind(this)
            };
            this._instrumentors = {
                query: this.query.bind(this),
                getText: this.getText.bind(this),
                click: this.click.bind(this),
                isVisible: this.isVisible.bind(this),
                getAttributes: this.getAttributes.bind(this),
                scrollIntoView: this.scrollIntoView.bind(this),
                containsClass: this.containsClass.bind(this),
                input: this.input.bind(this),
                keydown: this.keydown.bind(this)
            };
        }
        WebpageLibrary.prototype.handle = function (requestType, payload) {
            if (!this.canHandle(requestType)) {
                throw new Error("WebpageLibrary: Cannot handle " + requestType + ".");
            }
            return this._apiMap[requestType](payload);
        };
        WebpageLibrary.prototype.canHandle = function (requestType) {
            return typeof this._apiMap[requestType] === "function";
        };
        WebpageLibrary.prototype.handleInstrumentWebpage = function (payload) {
            var _this = this;
            return Promise.resolve().then(function () {
                if (!payload ||
                    !payload.action ||
                    !payload.action.type ||
                    typeof _this._instrumentors[payload.action.type] !== "function") {
                    throw new Error("Invalid action to instrument.");
                }
                return _this._instrumentors[payload.action.type](payload.action);
            });
        };
        WebpageLibrary.prototype.query = function (action) {
            return this._querySelectorAll(action.selector).map(function (element) {
                return {
                    id: element.id,
                    class: element.className
                };
            });
        };
        WebpageLibrary.prototype.getText = function (action) {
            return this._querySelectorAll(action.selector).map(function (element) {
                return {
                    id: element.id,
                    class: element.className,
                    text: element.innerText
                };
            });
        };
        WebpageLibrary.prototype.click = function (action) {
            return this._htmlDocument.querySelector(action.selector).click();
        };
        WebpageLibrary.prototype.isVisible = function (action) {
            var elm = this._htmlDocument.querySelector(action.selector);
            if (!elm) {
                return false;
            }
            var rect = elm.getBoundingClientRect();
            return (rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || this._htmlDocument.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || this._htmlDocument.documentElement.clientWidth));
        };
        WebpageLibrary.prototype.getAttributes = function (action) {
            return Array.prototype.map.call(this._htmlDocument.querySelectorAll(action.selector), function (element) {
                return element.getAttribute(action.attributeName);
            });
        };
        WebpageLibrary.prototype.scrollIntoView = function (action) {
            var element = this._getElement(action.selector);
            return element.scrollIntoView();
        };
        WebpageLibrary.prototype.containsClass = function (action) {
            var element = this._getElement(action.selector);
            return element.classList.contains(action.className);
        };
        WebpageLibrary.prototype.input = function (action) {
            var element = this._getElement(action.selector);
            var EventConstruct = Event;
            var event = new EventConstruct('input', {
                'bubbles': true,
                'cancelable': true
            });
            element.value = action.value;
            element.dispatchEvent(event);
        };
        WebpageLibrary.prototype.keydown = function (action) {
            var element = this._getElement(action.selector);
            var KeyboardEventConstruct = KeyboardEvent;
            element.dispatchEvent(new KeyboardEventConstruct('keydown', { 'keyCode': action.keyCode }));
        };
        WebpageLibrary.prototype._getElement = function (selector) {
            var element = this._htmlDocument.querySelector(selector);
            if (!element) {
                throw 'ElementNotFound with selector ' + selector;
            }
            return element;
        };
        WebpageLibrary.prototype._querySelectorAll = function (selector) {
            return Array.prototype.slice.call(this._htmlDocument.querySelectorAll(selector));
        };
        return WebpageLibrary;
    }());
    Instrumentor.WebpageLibrary = WebpageLibrary;
})(Instrumentor || (Instrumentor = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2VicGFnZUluc3RydW1lbnRMaWJyYXJ5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL3VicC9leHRlbnNpb24vY29udGV4dHVhbC9wZWVyLXNjcmlwdHMvbGlicmFyaWVzL1dlYnBhZ2VJbnN0cnVtZW50TGlicmFyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFZQSxJQUFVLFlBQVksQ0FpT3JCO0FBak9ELFdBQVUsWUFBWTtJQU10QjtRQXVCSSx3QkFBb0IsYUFBc0I7WUFBdEIsa0JBQWEsR0FBYixhQUFhLENBQVM7WUFDdEMsSUFBSSxDQUFDLE9BQU8sR0FBRztnQkFDWCw2QkFBNkIsRUFBRSxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzthQUN6RSxDQUFDO1lBQ0YsSUFBSSxDQUFDLGNBQWMsR0FBRztnQkFDbEIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDNUIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDaEMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDNUIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDcEMsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDNUMsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDOUMsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDNUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDNUIsT0FBTyxFQUFFLElBQUks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QyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakMsQ0FBQztRQVFELGdDQUFPLEdBQVAsVUFBUSxNQUFXO1lBQ2YsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEQsSUFBSSxzQkFBc0IsR0FBUSxhQUFhLENBQUM7WUFDaEQsT0FBTyxDQUFDLGFBQWEsQ0FBQyxJQUFJLHNCQUFzQixDQUFDLFNBQVMsRUFBRSxFQUFDLFNBQVMsRUFBQyxNQUFNLENBQUMsT0FBTyxFQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzdGLENBQUM7UUFNRCxvQ0FBVyxHQUFYLFVBQVksUUFBZ0I7WUFDeEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDekQsSUFBRyxDQUFDLE9BQU8sRUFBQztnQkFDUixNQUFNLGdDQUFnQyxHQUFHLFFBQVEsQ0FBQzthQUNyRDtZQUNELE9BQU8sT0FBTyxDQUFDO1FBQ25CLENBQUM7UUFNRCwwQ0FBaUIsR0FBakIsVUFBa0IsUUFBZ0I7WUFDOUIsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLENBQUM7UUFDSCxxQkFBQztJQUFELENBQUMsQUExTkgsSUEwTkc7SUExTlUsMkJBQWMsaUJBME54QixDQUFBO0FBQ0gsQ0FBQyxFQWpPUyxZQUFZLEtBQVosWUFBWSxRQWlPckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbnRlcmZhY2UgQXJyYXlDb25zdHJ1Y3RvciB7XG4gICAgZnJvbShhcnJheUxpa2U6IGFueSwgbWFwRm4/LCB0aGlzQXJnPyk6IEFycmF5PGFueT47XG59XG5cbmludGVyZmFjZSBFbGVtZW50IHtcbiAgICBzY3JvbGxJbnRvVmlldyhhcmc/KTogdm9pZDtcbiAgICBnZXRBdHRyaWJ1dGUobmFtZTogc3RyaW5nKTogYW55O1xuICAgIGdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOiBhbnk7XG4gICAgZGlzcGF0Y2hFdmVudChldmVudDogRXZlbnQpOiBib29sZWFuO1xuICAgIHJlYWRvbmx5IGNsYXNzTGlzdDogRE9NVG9rZW5MaXN0O1xufVxuXG5uYW1lc3BhY2UgSW5zdHJ1bWVudG9yIHtcblxuLyoqXG4gKiBUaGlzIGNvbnRlbnQgc2NyaXB0cyBob3N0cyBsb2dpYyB0byBpbnN0cnVtZW50IGEgd2VicGFnZS4gVGhpcyBpcyBuZWVkZWQgYXMgdGhlIGltcGxlbWVudGF0aW9uXG4gKiBvZiBQbGF0Zm9ybS5pbnN0cnVtZW50V2VicGFnZSBBUEkgYnVpbHQgZm9yIGludGVncmF0aW9uIHRlc3QgYXV0b21hdGlvbi5cbiAqL1xuZXhwb3J0IGNsYXNzIFdlYnBhZ2VMaWJyYXJ5IGltcGxlbWVudHMgSUNvbnRleHR1YWxQZWVyTGlicmFyeSB7XG5cbiAgICAvKipcbiAgICAgKiBTdG9yZXMgYSBtYXBwaW5nIG9mIHJlcXVlc3RUeXBlIChmb3IgZXhhbXBsZSwgVUJQV2VicGFnZSkgdG9cbiAgICAgKiB0aGUgV2VicGFnZUxpYnJhcnkgQVBJIChmb3IgZXhhbXBsZSwgaW5zdHJ1bWVudFdlYnBhZ2UpLlxuICAgICAqL1xuICAgIHByaXZhdGUgX2FwaU1hcDp7XG4gICAgICAgIFtyZXF1ZXN0VHlwZTpzdHJpbmddOkZ1bmN0aW9uXG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIFN0b3JlcyBhIG1hcHBpbmcgb2YgSUFjdGlvbiN0eXBlIGFuZCByZXNwZWN0aXZlIGhhbmRsZXJzXG4gICAgICovXG4gICAgcHJpdmF0ZSBfaW5zdHJ1bWVudG9yczp7XG4gICAgICAgIFthY3Rpb25UeXBlOnN0cmluZ106RnVuY3Rpb25cbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB3aXRoIHRoZSBnaXZlbiBodG1sRG9jdW1lbnQuIEFsc28sIHBvcHVsYXRlcyB0aGUgV2VicGFnZUxpYnJhcnkuX2FwaU1hcCBhbmQgXG4gICAgICogV2VicGFnZUxpYnJhcnkuX2luc3RydW1lbnRvcnMgbWFwXG4gICAgICpcbiAgICAgKiBAcGFyYW0gaHRtbERvY3VtZW50IC0gRG9jdW1lbnQgb2JqZWN0IG9mIHRoZSBjdXJyZW50IHdlYnBhZ2UuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfaHRtbERvY3VtZW50OkRvY3VtZW50KSB7XG4gICAgICAgIHRoaXMuX2FwaU1hcCA9IHtcbiAgICAgICAgICAgIFwiVUJQV2VicGFnZUluc3RydW1lbnRXZWJwYWdlXCI6IHRoaXMuaGFuZGxlSW5zdHJ1bWVudFdlYnBhZ2UuYmluZCh0aGlzKVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9pbnN0cnVtZW50b3JzID0ge1xuICAgICAgICAgICAgcXVlcnk6IHRoaXMucXVlcnkuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIGdldFRleHQ6IHRoaXMuZ2V0VGV4dC5iaW5kKHRoaXMpLFxuICAgICAgICAgICAgY2xpY2s6IHRoaXMuY2xpY2suYmluZCh0aGlzKSxcbiAgICAgICAgICAgIGlzVmlzaWJsZTogdGhpcy5pc1Zpc2libGUuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIGdldEF0dHJpYnV0ZXM6IHRoaXMuZ2V0QXR0cmlidXRlcy5iaW5kKHRoaXMpLFxuICAgICAgICAgICAgc2Nyb2xsSW50b1ZpZXc6IHRoaXMuc2Nyb2xsSW50b1ZpZXcuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIGNvbnRhaW5zQ2xhc3M6IHRoaXMuY29udGFpbnNDbGFzcy5iaW5kKHRoaXMpLFxuICAgICAgICAgICAgaW5wdXQ6IHRoaXMuaW5wdXQuYmluZCh0aGlzKSxcbiAgICAgICAgICAgIGtleWRvd246IHRoaXMua2V5ZG93bi5iaW5kKHRoaXMpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFyc2VzIHRoZSBtZXNzYWdlIGZyb20gdGhlIGV4dGVuc2lvbiBhbmQgaW52b2tlcyB0aGUgYXBwcm9wcmlhdGUgbWV0aG9kLFxuICAgICAqIGFuZCByZXR1cm5zIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIG1ldGhvZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVxdWVzdFR5cGVcbiAgICAgKiBAcGFyYW0gcGF5bG9hZFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIGhhbmRsZShyZXF1ZXN0VHlwZTpzdHJpbmcsIHBheWxvYWQ6YW55KTphbnkge1xuICAgICAgICBpZiAoIXRoaXMuY2FuSGFuZGxlKHJlcXVlc3RUeXBlKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiV2VicGFnZUxpYnJhcnk6IENhbm5vdCBoYW5kbGUgXCIgKyByZXF1ZXN0VHlwZSArIFwiLlwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5fYXBpTWFwW3JlcXVlc3RUeXBlXShwYXlsb2FkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiB7QGxpbmsgSUNvbnRleHR1YWxQZWVyTGlicmFyeSNjYW5IYW5kbGV9XG4gICAgICovXG4gICAgY2FuSGFuZGxlKHJlcXVlc3RUeXBlOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHR5cGVvZiB0aGlzLl9hcGlNYXBbcmVxdWVzdFR5cGVdID09PSBcImZ1bmN0aW9uXCI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbHMgcmVzcGVjdGl2ZSBpbnN0cnVtZW50YXRpb24gYWN0aW9uIGhhbmRsZXJzIGJhc2VkIG9uIGdpdmVuIGFjdGlvbiB0eXBlXG4gICAgICogQHBhcmFtIHBheWxvYWQgLSBpbmNvbWluZyBwYXlsb2FkIHdoaWNoIGNvbnRhaW5zIGFjdG9uICYgdHlwZSBpbmZvXG4gICAgICovXG4gICAgaGFuZGxlSW5zdHJ1bWVudFdlYnBhZ2UocGF5bG9hZDphbnkpOlByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT57XG4gICAgICAgICAgICBpZiAoIXBheWxvYWQgfHxcbiAgICAgICAgICAgICAgICAhcGF5bG9hZC5hY3Rpb24gfHxcbiAgICAgICAgICAgICAgICAhcGF5bG9hZC5hY3Rpb24udHlwZSB8fFxuICAgICAgICAgICAgICAgIHR5cGVvZiB0aGlzLl9pbnN0cnVtZW50b3JzW3BheWxvYWQuYWN0aW9uLnR5cGVdICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGFjdGlvbiB0byBpbnN0cnVtZW50LlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vVE9ETzogaGFuZGxlIGluc3RydW1lbnRhdGlvbiB0YXJnZXR0ZWQgaW5uZXIgZnJhbWVzIHVzaW5nICdwYXlsb2FkLnRhcmdldEZyYW1lJ1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luc3RydW1lbnRvcnNbcGF5bG9hZC5hY3Rpb24udHlwZV0ocGF5bG9hZC5hY3Rpb24pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBhbGwgdGhlIGVsZW1lbnRzIG1hdGNoaW5nIHRoZSBnaXZlbiBzZWxlY3RvciBpbiB0aGUgRE9NIG9mIGN1cnJlbnQgZnJhbWUuXG4gICAgICogQHBhcmFtIHNlbGVjdG9yIC0gd2lsbCBiZSB1c2VkIHdpdGggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbFxuICAgICAqIEByZXR1cm5zIC0gUHJvbWlzZSByZXNvbHZlcyB3aXRoIGFycmF5IG9mIG9iamVjdHMgZm91bmQgd2l0aCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsLlxuICAgICAqIE9iamVjdHMgYXJlIG5vdCBET00gb2JqZWN0cywgdGhleVxuICAgICAqIGFyZSBjdXN0b20gb2JqZWN0cyBoYXZpbmcgaWQsIGNsYXNzIGFuZCBuYW1lIHByb3BlcnRpZXMuXG4gICAgICovXG4gICAgcXVlcnkoYWN0aW9uOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3F1ZXJ5U2VsZWN0b3JBbGwoYWN0aW9uLnNlbGVjdG9yKS5tYXAoKGVsZW1lbnQ6IEhUTUxFbGVtZW50KT0+e1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBpZDogZWxlbWVudC5pZCxcbiAgICAgICAgICAgICAgICBjbGFzczogZWxlbWVudC5jbGFzc05hbWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIGlubmVyVGV4dCBvZiBhbGwgdGhlIGVsZW1lbnRzIG1hdGNoaW5nIHRoZSBnaXZlbiBzZWxlY3RvciBpbiB0aGUgRE9NIG9mIGN1cnJlbnQgZnJhbWUuXG4gICAgICogQHBhcmFtIHNlbGVjdG9yIC0gd2lsbCBiZSB1c2VkIHdpdGggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbFxuICAgICAqIEByZXR1cm5zIC0gYXJyYXkgb2Ygb2JqZWN0cyBmb3VuZCB3aXRoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwuIE9iamVjdHMgYXJlIG5vdCBET00gb2JqZWN0cywgdGhleVxuICAgICAqIGFyZSBjdXN0b20gb2JqZWN0cyBoYXZpbmcgaWQsIGNsYXNzLCBuYW1lIGFuZCB0ZXh0IHByb3BlcnRpZXMuXG4gICAgICovXG4gICAgZ2V0VGV4dChhY3Rpb246YW55KSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9xdWVyeVNlbGVjdG9yQWxsKGFjdGlvbi5zZWxlY3RvcikubWFwKChlbGVtZW50OiBIVE1MRWxlbWVudCk9PntcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaWQ6IGVsZW1lbnQuaWQsXG4gICAgICAgICAgICAgICAgY2xhc3M6IGVsZW1lbnQuY2xhc3NOYW1lLFxuICAgICAgICAgICAgICAgIHRleHQ6IGVsZW1lbnQuaW5uZXJUZXh0XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyaWdnZXJzIGNsaWNrIGV2ZW50IG9uIHRoZSBlbGVtZW50IG1hdGNoaW5nIHRoZSBnaXZlbiBzZWxlY3RvciBpbiB0aGUgRE9NIG9mIGN1cnJlbnQgZnJhbWUuXG4gICAgICogQHBhcmFtIHNlbGVjdG9yIC0gd2lsbCBiZSB1c2VkIHdpdGggZG9jdW1lbnQucXVlcnlTZWxlY3RvclxuICAgICAqIEByZXR1cm5zIG51bGxcbiAgICAgKi9cbiAgICBjbGljayhhY3Rpb246IGFueSkge1xuICAgICAgICByZXR1cm4gKDxIVE1MRWxlbWVudD50aGlzLl9odG1sRG9jdW1lbnQucXVlcnlTZWxlY3RvcihhY3Rpb24uc2VsZWN0b3IpKS5jbGljaygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrcyB3aGV0aGVyIHRoZSBlbGVtZW50IHdpdGggZ2l2ZW4gc2VsZWN0b3IgaXMgcHJlc2VudCBpbiBET00gb3Igbm90XG4gICAgICogQHBhcmFtIHNlbGVjdG9yIC0gd2lsbCBiZSB1c2VkIHdpdGggZG9jdW1lbnQucXVlcnlTZWxlY3RvclxuICAgICAqIEByZXR1cm5zIGJvb2xlYW5cbiAgICAgKi9cbiAgICBpc1Zpc2libGUoYWN0aW9uOiBhbnkpIHtcbiAgICAgICAgdmFyIGVsbTogRWxlbWVudCA9IHRoaXMuX2h0bWxEb2N1bWVudC5xdWVyeVNlbGVjdG9yKGFjdGlvbi5zZWxlY3Rvcik7XG4gICAgICAgIGlmKCFlbG0pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmVjdCA9IGVsbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgcmVjdC50b3AgPj0gMCAmJlxuICAgICAgICAgICAgcmVjdC5sZWZ0ID49IDAgJiZcbiAgICAgICAgICAgIHJlY3QuYm90dG9tIDw9ICh3aW5kb3cuaW5uZXJIZWlnaHQgfHwgdGhpcy5faHRtbERvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQpICYmIC8qb3IgJCh3aW5kb3cpLmhlaWdodCgpICovXG4gICAgICAgICAgICByZWN0LnJpZ2h0IDw9ICh3aW5kb3cuaW5uZXJXaWR0aCB8fCB0aGlzLl9odG1sRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKSAvKm9yICQod2luZG93KS53aWR0aCgpICovXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyBsaXN0IG9mIGF0dHJpYnV0ZXMgb2YgYWxsIHRoZSBlbGVtZW50cyBtYXRjaGluZyBnaXZlbiBzZWxlY3RvclxuICAgICAqIEBwYXJhbSBzZWxlY3RvciAtIHdpbGwgYmUgdXNlZCB3aXRoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGxcbiAgICAgKiBAcGFyYW0gYXR0cmlidXRlTmFtZSAtIG5hbWUgb2YgdGhlIGF0dHJpYnV0ZSB0byBxdWVyeVxuICAgICAqIEByZXR1cm5zIGxpc3Qgb2YgZ2l2ZW4gYXR0cmlidXRlIHZhbHVlcyBtYXRjaGluZyBnaXZlbiBzZWxlY3RvclxuICAgICAqL1xuICAgIGdldEF0dHJpYnV0ZXMoYWN0aW9uOiBhbnkpOkFycmF5PGFueT4ge1xuICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLm1hcC5jYWxsKHRoaXMuX2h0bWxEb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGFjdGlvbi5zZWxlY3RvciksIChlbGVtZW50OiBFbGVtZW50KT0+e1xuICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuZ2V0QXR0cmlidXRlKGFjdGlvbi5hdHRyaWJ1dGVOYW1lKVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTY3JvbGxzIHRvIHRoZSBwb3N0aW9uIGluIHdoaWNoIHRoZSBlbGVtZW50KG1hdGNoZWQgYnkgZ2l2ZW4gc2VsZWN0b3IpIHdpbGwgYXBwZWFyIGluIHRoZSB2aWV3XG4gICAgICogUmVmOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvRWxlbWVudC9zY3JvbGxJbnRvVmlld1xuICAgICAqIEBwYXJhbSBzZWxlY3RvciAtIFNlbGVjdG9yIG9mIHRoZSBET00gZWxlbWVudFxuICAgICAqL1xuICAgIHNjcm9sbEludG9WaWV3KGFjdGlvbjogYW55KSB7XG4gICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fZ2V0RWxlbWVudChhY3Rpb24uc2VsZWN0b3IpO1xuICAgICAgICByZXR1cm4gZWxlbWVudC5zY3JvbGxJbnRvVmlldygpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIHNwZWNpZmllZCBjbGFzcyB2YWx1ZSBleGlzdHMgaW4gY2xhc3MgYXR0cmlidXRlIG9mIHRoZSBlbGVtZW50LlxuICAgICAqIEBwYXJhbSBzZWxlY3RvciAtIFNlbGVjdG9yIG9mIHRoZSBET00gZWxlbWVudCBpbiBjaGVja1xuICAgICAqIEBwYXJhbSBjbGFzc05hbWUgLSBOYW1lIG9mIHRoZSBjbGFzcyB0byBjaGVjayBmb3JcbiAgICAgKi9cbiAgICBjb250YWluc0NsYXNzKGFjdGlvbjogYW55KSB7XG4gICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fZ2V0RWxlbWVudChhY3Rpb24uc2VsZWN0b3IpO1xuICAgICAgICByZXR1cm4gZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoYWN0aW9uLmNsYXNzTmFtZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW5wdXRzIGdpdmVuIHZhbHVlIHRvIHRoZSBlbGVtZW50IG1hdGNoaW5nIGdpdmVuIHNlbGVjdG9yLiBUaGlzIGFsc28gdHJpZ2dlcnMgJ2lucHV0JyBET00gZXZlbnRcbiAgICAgKiBAcGFyYW0gc2VsZWN0b3IgLSBTZWxlY3RvciBvZiB0aGUgdGFyZ2V0IERPTSBlbGVtZW50XG4gICAgICogQHBhcmFtIHZhbHVlIC0gdmFsdWUgd2hpY2ggbmVlZHMgdG8gYmUgaW5wdXRcbiAgICAgKi9cbiAgICBpbnB1dChhY3Rpb246IGFueSkge1xuICAgICAgICB2YXIgZWxlbWVudDogSFRNTElucHV0RWxlbWVudCA9IDxIVE1MSW5wdXRFbGVtZW50PnRoaXMuX2dldEVsZW1lbnQoYWN0aW9uLnNlbGVjdG9yKTtcbiAgICAgICAgdmFyIEV2ZW50Q29uc3RydWN0OmFueSA9IEV2ZW50O1xuICAgICAgICB2YXIgZXZlbnQgPSBuZXcgRXZlbnRDb25zdHJ1Y3QoJ2lucHV0Jywge1xuICAgICAgICAgICAgJ2J1YmJsZXMnOiB0cnVlLFxuICAgICAgICAgICAgJ2NhbmNlbGFibGUnOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICBlbGVtZW50LnZhbHVlID0gYWN0aW9uLnZhbHVlO1xuICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpO1xuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICogVGlyZ2dlcnMgS2V5ZG93biBldmVudCB3aXRoIGdpdmVuIGtleUNvZGUgb24gZWxlbWVudCBtYXRjaGluZyBnaXZlbiBzZWxlY3RvclxuICAgICAqIEBwYXJhbSBzZWxlY3RvciAtIFNlbGVjdG9yIG9mIHRoZSB0YXJnZXQgRE9NIGVsZW1lbnRcbiAgICAgKiBAcGFyYW0ga2V5Q29kZSAtIGtleUNvZGUgd2hpY2ggbmVlZHMgdG8gYmUgdHJpZ2dlcmVkXG4gICAgICovXG4gICAga2V5ZG93bihhY3Rpb246IGFueSkge1xuICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuX2dldEVsZW1lbnQoYWN0aW9uLnNlbGVjdG9yKTtcbiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRDb25zdHJ1Y3Q6IGFueSA9IEtleWJvYXJkRXZlbnQ7XG4gICAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgS2V5Ym9hcmRFdmVudENvbnN0cnVjdCgna2V5ZG93bicsIHsna2V5Q29kZSc6YWN0aW9uLmtleUNvZGV9KSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyBFbGVtZW50IG1hdGNoZWQgZ2l2ZW4gc2VsZWN0b3IgYW5kIHRocm93cyBlcnJvciBpZiBpdCBpcyBub3QgcHJlc2VudFxuICAgICAqIEBwYXJhbSBzZWxlY3RvclxuICAgICAqL1xuICAgIF9nZXRFbGVtZW50KHNlbGVjdG9yOiBzdHJpbmcpOiBFbGVtZW50IHtcbiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLl9odG1sRG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XG4gICAgICAgIGlmKCFlbGVtZW50KXtcbiAgICAgICAgICAgIHRocm93ICdFbGVtZW50Tm90Rm91bmQgd2l0aCBzZWxlY3RvciAnICsgc2VsZWN0b3I7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyBBcnJheS1saWtlIERPTSBlbGVtZW50cyBsaXN0IGZvdW5kIHVzaW5nIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwgaW4gQXJyYXkgZm9ybWF0XG4gICAgICogQHBhcmFtIHNlbGVjdG9yXG4gICAgICovXG4gICAgX3F1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3I6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5faHRtbERvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==