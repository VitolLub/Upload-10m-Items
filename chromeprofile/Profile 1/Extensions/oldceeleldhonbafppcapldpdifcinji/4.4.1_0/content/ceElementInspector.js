/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
var __decorate=this&&this.__decorate||function(e,t,n,s){var r,i=arguments.length,a=i<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,s);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(a=(i<3?r(a):i>3?r(t,n,a):r(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a};class CEElementInspector{constructor(e,t,n=!0){if(this._ceElement=e,this._parsingDetector=t,this._enableCache=n,this._nodePropertiesCache={isTextNode:new WeakMap,isElementNode:new WeakMap,computedStyle:new WeakMap,isSkippingElement:new WeakMap,replacementText:new WeakMap,isBr:new WeakMap,isBlock:new WeakMap,parsingOptions:new WeakMap,parsedText:new WeakMap,blockParent:new WeakMap,paragraphLastValuableNode:new WeakMap,isBRElementRelevant:new WeakMap,isBlockElementRelevant:new WeakMap,isTextEndsWithLineBreak:new WeakMap,isParagraphNonEmpty:new WeakMap},this._enableCache){this._onCEElementChange=this._onCEElementChange.bind(this),this._ceElementObserver=this._parsingDetector.createMutationObserver(this._onCEElementChange);const e={attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!1,childList:!0,subtree:!0};this._ceElementObserver.observe(this._ceElement,e)}}static _replaceLineBreaks(e){return e.replace(CEElementInspector.LINE_BREAKS_REGEXP," ")}static _joinWhitespaces(e){return e.replace(CEElementInspector.WHITESPACE_REGEXP," ")}static _isBlankString(e){return!e.trim()}static cached(e){return CEElementInspector._cacheInvalidationRules.push(e),function(t,n,s){const r=s.value;return s.value=function(t){if(this._enableCache){const n=this._nodePropertiesCache[e.key];let s=n.get(t);return void 0===s&&(s=r.call(this,t),n.set(t,s)),s}return r.call(this,t)},s}}_deleteCacheForNode(e,t=!0){const n=this.isTextNode(e),s=Object.values(this._nodePropertiesCache);if(s.forEach((t=>t.delete(e))),t&&!n){const t=DOMWalker.create(e);for(;t.next();)s.forEach((e=>e.delete(t.currentNode)))}}isWhiteSpace(e){return this._parsingDetector.isWhiteSpace(e)}_normalizeMutations(e){const t={};e.forEach((e=>{"attributes"===e.type&&e.attributeName&&(t[e.attributeName]=t[e.attributeName]||[],t[e.attributeName].push(e))}));for(const n in t)if(t.hasOwnProperty(n)){const s=t[n];if(s.length<2)continue;const r=s[0];r.oldValue===r.target.getAttribute(n)&&s.forEach((t=>{e.splice(e.indexOf(t),1)}))}}_checkRuleConditions(e,t){if(!e)return!1;switch(t.type){case"attributes":return!!e.attributes&&(0===e.attributes.length||e.attributes.includes(t.attributeName));case"characterData":return!!e.characterData;case"childList":return!!e.childList}return!1}_onCEElementChange(e){this._normalizeMutations(e);for(const t of e){const e=t.target;if(!this._ceElement.contains(e))continue;"childList"===t.type&&t.removedNodes.forEach((e=>this._deleteCacheForNode(e)));const n=this.getBlockParent(e),s=e!==n;for(const r of CEElementInspector._cacheInvalidationRules){if(this._checkRuleConditions(r.any,t)){this._nodePropertiesCache[r.key]=new WeakMap;continue}const i=this._nodePropertiesCache[r.key];if(this._checkRuleConditions(r.self,t)&&i.delete(e),this._checkRuleConditions(r.parent,t)){const t=DOMWalker.create(e);for(;t.next();)i.delete(t.currentNode)}if(s&&this._checkRuleConditions(r.blockChild,t)&&i.delete(n),this._checkRuleConditions(r.blockSibling,t)){const e=DOMWalker.create(n);for(;e.next();)i.delete(e.currentNode)}}}}getComputedStyle(e){return window.getComputedStyle(e)}isTextNode(e){return isTextNode(e)}isElementNode(e){return isElementNode(e)}isSkippingElement(e){return this._ceElement!==e&&(this._parsingDetector.isIgnored(e,this.getComputedStyle(e))||this._parsingDetector.isQuote(e)||this._parsingDetector.isSignature(e))}getReplacementText(e){const t=this.getComputedStyle(e),n=this._parsingDetector.isIgnored(e,t);return this._parsingDetector.getReplacementText(e,n,t)}isBr(e){return"BR"===e.tagName}isBlock(e){return this._parsingDetector.isBlock(e,this.getComputedStyle(e))}getParsingOptions(e){const t=this.isElementNode(e)?e:e.parentNode;if(this._parsingDetector.getParsingOptions)return this._parsingDetector.getParsingOptions(t);const n=this.getComputedStyle(t).whiteSpace||"";return{element:t,preserveLineBreaks:CEElementInspector.PRESERVE_LINEBREAKS_VALUES.includes(n),preserveWhitespaces:CEElementInspector.PRESERVE_WHITESPACES_VALUES.includes(n)}}getParsedText(e){const t=this.getParsingOptions(e);let n=e.nodeValue;return t.preserveLineBreaks||(n=CEElementInspector._replaceLineBreaks(n)),n=this._parsingDetector.replaceText(n,e,t.element),t.preserveWhitespaces||(n=CEElementInspector._joinWhitespaces(n)),n}getBlockParent(e){let t=this.isElementNode(e)?e:e.parentElement;for(;t!==this._ceElement&&!this.isBlock(t);)t=t.parentElement;return t}getParagraphLastValuableNode(e){const t=this.getBlockParent(e),n=DOMWalker.create(t,e);let s=!1,r=null;do{const e=n.currentNode;if(s=!1,this.isElementNode(e))if(this.getReplacementText(e)&&(r=e),this.isSkippingElement(e))s=!0;else{if(this.isBlock(e))return r;if(this.isBr(e))return r}else if(this.isTextNode(e)){const t=this.getParsingOptions(e),n=this.getParsedText(e);(t.preserveWhitespaces&&n||!CEElementInspector.BLANK_STRING_REGEXP.test(n))&&(r=e)}}while(n.next(s));return r}isBRElementRelevant(e){const t=this.getBlockParent(e);let n=DOMWalker.create(t),s=!1,r=!1;for(;n.next(s);){const t=n.currentNode;if(s=!1,this.isElementNode(t)){if(t===e)break;this.getReplacementText(t)&&(r=!0),this.isSkippingElement(t)?s=!0:this.isBlock(t)&&(r=!1,s=!0)}else if(this.isTextNode(t)){const e=this.getParsingOptions(t),n=this.getParsedText(t);(e.preserveWhitespaces&&n||!CEElementInspector._isBlankString(n))&&(r=!0)}}for(n=DOMWalker.create(t,e),s=!1;n.next(s);){const e=n.currentNode;if(s=!1,this.isElementNode(e)){if(this.getReplacementText(e))return!0;if(this.isSkippingElement(e))s=!0;else{if(this.isBr(e))return!0;if(r&&this.isBlock(e))return!1}}else if(this.isTextNode(e)){const t=this.getParsingOptions(e),n=this.getParsedText(e);if(t.preserveWhitespaces&&n||!CEElementInspector._isBlankString(n))return!0}}return!r}isBlockElementRelevant(e){return!!this._parsingDetector.isBlockElementRelevant&&this._parsingDetector.isBlockElementRelevant(e)}isTextEndsWithLineBreak(e){const t=DOMWalker.create(this._ceElement,e);let n=!!isElementNode(e)&&this.isSkippingElement(e),s=!1;for(;t.next(n);){const r=t.currentNode;if(n=!1,this.isElementNode(r)){if(this.getReplacementText(r)){const t=this.getBlockParent(e);return!contains(t,r)}if(this.isSkippingElement(r))n=!0;else if(this.isBlock(r)){if(this.isParagraphNonEmpty(r))return!0;s=!0}}else if(this.isTextNode(r)){const t=this.getParsingOptions(r),n=this.getParsedText(r);if(t.preserveWhitespaces&&n||!CEElementInspector._isBlankString(n)){if(s)return!0;{const t=this.getBlockParent(e);return!contains(t,r)}}}}return!1}isParagraphNonEmpty(e){const t=DOMWalker.create(e);let n=!1;for(;t.next(n);){const e=t.currentNode;if(n=!1,this.isElementNode(e)){if(this.getReplacementText(e))return!0;if(this.isSkippingElement(e))n=!0;else if(this.isBlock(e))return!1}else if(this.isTextNode(e)){const t=this.getParsingOptions(e),n=this.getParsedText(e);if(t.preserveWhitespaces&&n||!CEElementInspector._isBlankString(n))return!0}}return!1}destroy(){this._ceElementObserver&&this._ceElementObserver.disconnect()}}CEElementInspector.DISPLAY_BLOCK_VALUES=["block","list-item","table","table-caption","table-row","table-cell","flex","grid"],CEElementInspector.SKIPPING_TAGS=["CODE","NOSCRIPT","OBJECT","SCRIPT","STYLE","TEMPLATE","VAR","CANVAS","IMG","SVG","SELECT"],CEElementInspector.SUP_REGEXP=/^[\[\(]?\d+[\]\)]?/,CEElementInspector.PRESERVE_LINEBREAKS_VALUES=["pre","pre-wrap","pre-line"],CEElementInspector.PRESERVE_WHITESPACES_VALUES=["pre","pre-wrap"],CEElementInspector._cacheInvalidationRules=[],CEElementInspector.LINE_BREAKS_REGEXP=/\n/g,CEElementInspector.BLANK_STRING_REGEXP=/^[ \uFEFF]*$/,CEElementInspector.WHITESPACE_REGEXP=/  +/g,__decorate([CEElementInspector.cached({key:"computedStyle"})],CEElementInspector.prototype,"getComputedStyle",null),__decorate([CEElementInspector.cached({key:"isTextNode"})],CEElementInspector.prototype,"isTextNode",null),__decorate([CEElementInspector.cached({key:"isElementNode"})],CEElementInspector.prototype,"isElementNode",null),__decorate([CEElementInspector.cached({key:"isSkippingElement",any:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isSkippingElement",null),__decorate([CEElementInspector.cached({key:"replacementText",self:{attributes:[],characterData:!0,childList:!0},parent:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"getReplacementText",null),__decorate([CEElementInspector.cached({key:"isBr"})],CEElementInspector.prototype,"isBr",null),__decorate([CEElementInspector.cached({key:"isBlock",self:{attributes:["id","class","style"]},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"isBlock",null),__decorate([CEElementInspector.cached({key:"parsingOptions",self:{attributes:["id","class","style"]},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"getParsingOptions",null),__decorate([CEElementInspector.cached({key:"parsedText",self:{characterData:!0},parent:{attributes:["id","class","style"]},any:{childList:!0}})],CEElementInspector.prototype,"getParsedText",null),__decorate([CEElementInspector.cached({key:"blockParent",self:{attributes:["id","class","style"]},parent:{attributes:["id","class","style"]}})],CEElementInspector.prototype,"getBlockParent",null),__decorate([CEElementInspector.cached({key:"paragraphLastValuableNode",parent:{attributes:["id","class","style"]},blockSibling:{attributes:["id","class","style"],characterData:!0,childList:!0}})],CEElementInspector.prototype,"getParagraphLastValuableNode",null),__decorate([CEElementInspector.cached({key:"isBRElementRelevant",any:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isBRElementRelevant",null),__decorate([CEElementInspector.cached({key:"isBlockElementRelevant",any:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isBlockElementRelevant",null),__decorate([CEElementInspector.cached({key:"isTextEndsWithLineBreak",any:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isTextEndsWithLineBreak",null),__decorate([CEElementInspector.cached({key:"isParagraphNonEmpty",parent:{attributes:["id","class","style"]},blockChild:{attributes:[],characterData:!0,childList:!0}})],CEElementInspector.prototype,"isParagraphNonEmpty",null);