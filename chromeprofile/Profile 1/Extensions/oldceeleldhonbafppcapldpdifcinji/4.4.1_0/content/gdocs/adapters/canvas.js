class GoogleDocsCanvas{static isElementCompatible(t){return t.classList.contains(this.PAGE_CLASS_NAME)}static getUnhandledPages(){const t=document.querySelectorAll(".kix-page-paginated");return Array.from(t,(t=>{let e=Array.from(t.querySelectorAll(".kix-canvas-tile-content:not(.kix-canvas-tile-selection):not([data-lt-tweaks])"));return e=e.filter((t=>!!t.querySelector("svg")&&!t.querySelector("clipPath, image"))),e[e.length-1]})).filter(Boolean)}static isPage(t){return t.classList.contains(this.PAGE_CLASS_NAME)}static initPage(t){}static destroyPage(t){}static hasPreviousPage(t){return!t.closest(".canvas-first-page")}static getNextPage(t){let e=t.nextElementSibling;for(;e;){if(this.isPage(e))return e;e=e.nextElementSibling}return null}static getCanvases(t){const e=t.closest(".kix-page-paginated");return e?Array.from(e.querySelectorAll("canvas.kix-canvas-tile-content")):[]}static triggerRedraw(){try{const t=new Event("visibilitychange");document.dispatchEvent(t);const e=new Event("webkitvisibilitychange");document.dispatchEvent(e)}catch(t){}}static isMutationIgnored(t,e){return!1}static isIgnoredElement(t){return!1}static isBlockElement(t,e){return"g"===t.tagName||"svg"===t.tagName}static replaceText(t,e,o){const n=t.trim();return!this.WHITE_SPACE_REG_EXP.test(n)&&this.URL_FRAGMENT_REG_EXP.test(n)?"\ufeff".repeat(t.length):t}static getReplacementText(t){return""}static _lockMousemove(){this._mousemoveCapture||(this._mousemoveCapture=addUseCaptureEvent(document,"mousemove",(t=>t.stopImmediatePropagation())))}static _unlockMousemove(){this._mousemoveCapture&&(this._mousemoveCapture.destroy(),this._mousemoveCapture=null)}static applyFix(t){const{offset:e,length:o,replacementText:n,editor:r}=t,s=r.inputAreaWrapper.getTextRanges(e,o),a=document.querySelector(".kix-appview-editor");if(!a)return Tracker.trackError("other","google_docs:apply_fix1"),Promise.reject();const i=GoogleDocs.getIframeWin();if(!i)return Tracker.trackError("other","google_docs:apply_fix3"),Promise.reject();const l=i.document.querySelector("[contenteditable=true]");if(!l)return Tracker.trackError("other","google_docs:apply_fix4"),Promise.reject();const c=new DomMeasurement(document).getBorderBox(a,!1);let{firstTextBox:u,lastTextBox:g}=this._updateTextBoxes(r.inputArea,s);u.top<c.top?a.scrollTop-=c.top-u.top:g.bottom>c.bottom&&(a.scrollTop+=g.bottom-c.bottom);const d=this._updateTextBoxes(r.inputArea,s);u=d.firstTextBox,g=d.lastTextBox;const f=s[0].textNode.parentElement;if(!f)return Tracker.trackError("other","google_docs:apply_fix5"),Promise.reject();const m=s[s.length-1].textNode.parentElement;if(!m)return Tracker.trackError("other","google_docs:apply_fix6"),Promise.reject();const p={clientX:Math.round(u.left+2),clientY:Math.round(u.top+u.height/2),bubbles:!0,shftKey:!1,detail:GoogleDocs.MOUSE_EVENT_DETAIL};return this._lockMousemove(),wait(20).then((()=>(f.dispatchEvent(new MouseEvent("mousedown",Object.assign({},p))),wait(20)))).then((()=>(f.dispatchEvent(new MouseEvent("mouseup",Object.assign({},p))),f.dispatchEvent(new MouseEvent("click",Object.assign({},p))),wait(20)))).then((()=>{this._unlockMousemove();const t={clientX:Math.ceil(u.left+.5),clientY:Math.round(u.top+u.height/2),bubbles:!0,shftKey:!1,detail:GoogleDocs.MOUSE_EVENT_DETAIL},e={clientX:Math.floor(g.right-.5),clientY:Math.round(g.top+g.height/2),bubbles:!0,shftKey:!0,detail:GoogleDocs.MOUSE_EVENT_DETAIL},o={shiftKey:!0,key:"Shift",code:"ShiftLeft",keyCode:16,charCode:0,which:16,location:1};f.dispatchEvent(new MouseEvent("mousedown",t)),m.dispatchEvent(new MouseEvent("mousemove",e)),l.dispatchEvent(new i.KeyboardEvent("keydown",o)),m.dispatchEvent(new MouseEvent("mouseup",e)),l.dispatchEvent(new i.KeyboardEvent("keyup",o));const r=i,s=n.replace(/^\s/," ").replace(/\s$/," ");let a;try{a=new r.ClipboardEvent("paste",{clipboardData:new r.DataTransfer,bubbles:!0}),a.clipboardData.setData("text/plain",s)}catch(t){a=new r.ClipboardEvent("paste",{bubbles:!0})}return l.dispatchEvent(a),l.textContent=s,Promise.resolve()})).finally((()=>this._unlockMousemove()))}static _updateTextBoxes(t,e){const o=new DomMeasurement(document).getTextBoundingBoxes(e,t,!1);return{textBoxes:o,firstTextBox:o[0],lastTextBox:o[o.length-1]}}static _getBoundingRectangleForFirefox(t,e,o){var n,r;const s=null===(n=e.startContainer.parentElement)||void 0===n?void 0:n.closest("text");if(!s)return null;const a=null===(r=e.endContainer.parentElement)||void 0===r?void 0:r.closest("text");if(!a)return null;const i=s.getBoundingClientRect(),l=a.getBoundingClientRect(),c=parseFloat(s.getAttribute("x")||"0"),u=parseFloat(s.getAttribute("x")||"0");let g=i.top,d=l.bottom,f=tryThese((()=>i.left+(s.getStartPositionOfChar(e.startOffset).x-c)*t),(()=>i.left+(s.getStartPositionOfChar(e.startOffset-1).x-c)*t));void 0===f&&(f=i.left);let m=tryThese((()=>l.left+(a.getStartPositionOfChar(o.endOffset).x-u)*t),(()=>l.left+(a.getStartPositionOfChar(o.endOffset-1).x-u)*t),(()=>l.left));return void 0===m&&(m=i.right),{top:g,right:m,bottom:d,left:f}}static _getBoundingRectangle(t,e){var o;if(BrowserDetector.isFirefox()){const n=null===(o=t.startContainer.parentElement)||void 0===o?void 0:o.closest("svg");let r=1;if(n&&(r=this._getScaleX(n)),1!==r)return this._getBoundingRectangleForFirefox(r,t,e)}const n=new Range;n.setStart(t.startContainer,t.startOffset),n.setEnd(e.endContainer,e.endOffset);const r=n.getBoundingClientRect();return{top:r.top,left:r.left,bottom:r.bottom,right:r.right}}static getSelection(t){if(!t||!t.rects.length)return;const e=t.rects.map((e=>{const o=t.canvas.getBoundingClientRect();return{top:e.top+o.top,left:e.left+o.left,bottom:e.bottom+o.top,right:e.right+o.left}})),o=e[0],n=e[e.length-1],r=o.bottom-o.top,s=n.bottom-n.top,a=Array.from(document.querySelectorAll(GoogleDocsCanvasMirror.TAG_NAME));a.forEach((t=>t.classList.add("lt-mirror-enable-range-measurement")));let i=getRangeAtPoint({x:o.left+1,y:Math.round(o.bottom-.3*r)}),l=getRangeAtPoint({x:n.right-.5,y:Math.round(n.bottom-.3*s)});if(a.forEach((t=>t.classList.remove("lt-mirror-enable-range-measurement"))),!i||!l)return null;let c=i.startContainer===l.startContainer&&i.startOffset===l.startOffset;if(!c&&BrowserDetector.isFirefox()){const t=this._getBoundingRectangle(i,l);c=!!t&&!isRectsIntersect(t,o)&&!isRectsIntersect(t,n)}return!c||(a.forEach((t=>t.classList.add("lt-mirror-enable-range-measurement"))),i=getRangeAtPoint({x:o.left+1,y:Math.round(o.top+.3*r)}),l=getRangeAtPoint({x:n.right-.5,y:Math.round(n.top+.3*s)}),a.forEach((t=>t.classList.remove("lt-mirror-enable-range-measurement"))),i&&l)?{startNode:i.startContainer,startOffset:i.startOffset,endNode:l.endContainer,endOffset:l.endOffset,isCollapsed:!1}:null}static getSelectedText(t){if(!t)return;const e=this.getSelection(t);if(!e)return"";const o=new Range;return o.setStart(e.startNode,e.startOffset),o.setEnd(e.endNode,e.endOffset),o.toString()}static _getScaleX(t){let e=1;const o=t.querySelector("text[transform]");if(o){const t=(o.getAttribute("transform")||"").match(DomMeasurement.TRANSFORM_MATRIX_REG_EXP);t&&(e=parseFloat(t[1])||e)}return e}}GoogleDocsCanvas.PAGE_CLASS_NAME="kix-canvas-tile-content",GoogleDocsCanvas.WHITE_SPACE_REG_EXP=/\s/,GoogleDocsCanvas.URL_FRAGMENT_REG_EXP=/[&\?#][a-z0-9]+|%[A-Z0-9]{2}|[a-z0-9]=\!?[a-z0-9]|[a-z0-9\.]{2,}\![a-z0-9\.]{2,}|[\-_][a-z0-9]{5,}[\-_][a-z0-9]{5,}[\-_][a-z0-9]{5,}|\/.+?\/.+|^\-[a-z\-\/]+\/$/i,GoogleDocsCanvas._mousemoveCapture=null,"undefined"!=typeof module&&(module.exports=GoogleDocsCanvas);