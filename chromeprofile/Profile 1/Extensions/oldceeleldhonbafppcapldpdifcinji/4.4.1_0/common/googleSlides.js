/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
var __awaiter=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(i,r){function a(t){try{l(o.next(t))}catch(t){r(t)}}function s(t){try{l(o.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}l((o=o.apply(t,e||[])).next())}))};class GoogleSlides{static _getMode(){return document.querySelector("#docs-access-level-indicator div.docs-access-level-indicator-icon-container div.docs-icon-acl-comment-only-on-brand-color-background")?"comment":document.querySelector("#docs-access-level-indicator")?"view":"edit"}static _isInView(t){const e=t.closest("svg");return!!e&&"none"!==this._domMeasurement.getStyle(e,"display")}static _checkMode(){const t=this._getMode();this._currentMode?t!==this._currentMode&&(this._currentMode=t,this._onModeChangedCallbacks.forEach((e=>e(t)))):this._currentMode=t}static _checkForNewSlides(){if("view"===this._currentMode)return;document.querySelectorAll(this.UNHANDLED_SLIDE_SELECTOR).forEach((t=>{this._isInView(t)&&this._onNewSlideCallbacks.forEach((e=>e(t)))}))}static _checkOutOfViewSlides(){this._onSlideOutOfViewCallbacks.forEach(((t,e)=>{this._isInView(e)||t(e)}))}static _addMenuBarButton(){if(this._menuBarButton)return;const t=document.querySelector("#insertCommentButton");t&&t.parentNode&&(this._menuBarButton=document.createElement("div"),this._menuBarButton.className="lt-gdocs-menubar-button goog-toolbar-button goog-toolbar-toggle-button goog-inline-block",this._menuBarButton.setAttribute("role","button"),this._menuBarButton.setAttribute("aria-disabled","false"),this._menuBarButton.setAttribute("aria-hidden","false"),this._menuBarButton.id="enableLTButton",this._menuBarButton.style.userSelect="none",this._menuBarButton.addEventListener("click",(()=>{if(!this._storageController)return;const t=this.getSlideId(location.href);t&&(this._menuBarButton.classList.contains("goog-toolbar-button-checked")?(this._storageController.disableEditorGroup(getMainPageDomain(),t),EnvironmentAdapter.ltAssistantStatusChanged({enabled:!1})):(this._storageController.enableDomainAndEditorGroup(getMainPageDomain(),t),EnvironmentAdapter.ltAssistantStatusChanged({enabled:!0})))}),!0),this._menuBarSeparator=document.createElement("div"),this._menuBarSeparator.className="docs-toolbar-small-separator goog-toolbar-separator goog-inline-block",this._menuBarSeparator.setAttribute("role","separator"),this._menuBarSeparator.setAttribute("aria-disabled","true"),this._menuBarSeparator.setAttribute("aria-hidden","false"),this._menuBarSeparator.id="enableLTSeparator",this._menuBarSeparator.style.userSelect="none",t.parentNode.insertBefore(this._menuBarButton,t.nextSibling),t.parentNode.insertBefore(this._menuBarSeparator,t.nextSibling),this._toggleMenuBarButton())}static _removeMenuBarButton(){this._menuBarButton&&(this._menuBarButton.remove(),this._menuBarButton=null),this._menuBarSeparator&&(this._menuBarSeparator.remove(),this._menuBarSeparator=null)}static _toggleMenuBarButton(t=!1){if(!this._storageController)return;const e=this.getSlideId(location.href);if(!e)return;const n=getMainPageDomain(),o=this._storageController.getValidationSettings(n,e);o.isEditorGroupDisabled||o.isDomainDisabled?this._setMenuBarButtonUnactive(t):this._setMenuBarButtonActive()}static _setMenuBarButtonActive(){this._menuBarButton&&(this._menuBarButton.classList.add("goog-toolbar-button-checked"),this._menuBarButton.setAttribute("aria-label",i18nManager.getMessage("googleSlideDisableButton")),this._menuBarButton.setAttribute("data-tooltip",i18nManager.getMessage("googleSlideDisableButton")))}static _setMenuBarButtonUnactive(t=!1){this._menuBarButton&&(this._menuBarButton.classList.remove("goog-toolbar-button-checked"),this._menuBarButton.setAttribute("aria-label",i18nManager.getMessage("googleSlideEnableButton")),this._menuBarButton.setAttribute("data-tooltip",i18nManager.getMessage("googleSlideEnableButton")),t&&this._showMenuBarHint())}static _showMenuBarHint(){if(this._menuBarHint||!this._menuBarButton||!this._storageController)return;const{hasSeenGoogleDocsMenuBarHint:t}=this._storageController.getUIState();if(t)return;const e=this._menuBarButton.offsetHeight?this._menuBarButton:document.querySelector("#moreButton");if(!e)return;const n=e.getBoundingClientRect();this._menuBarHint=document.createElement("div"),this._menuBarHint.classList.add("lt-gdocs-hint"),this._menuBarHint.style.top=n.bottom+"px",this._menuBarHint.style.right=window.innerWidth-n.right+"px",this._menuBarHint.textContent=i18nManager.getMessage("googleSlidesEnableHint");const o=document.createElement("span");o.classList.add("lt-gdocs-hint__close"),o.addEventListener("click",(t=>{t.stopImmediatePropagation(),this._removeMenuBarHint(!0)}),!0),this._menuBarHint.appendChild(o),document.body.appendChild(this._menuBarHint),this._onInput((()=>this._removeMenuBarHint(!0)),!0)}static _removeMenuBarHint(t=!1){this._menuBarHint&&(t?fadeOutAndRemove(this._menuBarHint):this._menuBarHint.remove(),this._menuBarHint=null,t&&this._storageController&&this._storageController.updateUIState({hasSeenGoogleDocsMenuBarHint:!0}))}static _showTeaser(){const t=Array.from(document.querySelectorAll(`.${this.TOOLBAR_CLASS_NAME}`));if(!t.length)return;const e=t.find((t=>{const e=t.getBoundingClientRect();return e.top>=0&&e.top<window.innerHeight&&e.width>0}));if(!e)return;const n=new Hint("","google-slides",i18nManager.getMessage("googleSlidesNewTeaserHeadline"),i18nManager.getMessage("googleSlidesNewTeaserText"),"bottom-left",e),o=()=>{n.getElement().remove(),n&&n.getElement().classList.remove("lt-toolbar--hint-opened"),this._storageController&&this._storageController.updateUIState({hasSeenNewGoogleSlidesTeaser:!0})};n.getClose().addEventListener("click",(t=>{t.stopImmediatePropagation(),t.preventDefault(),o()}),!0),e.classList.add("lt-toolbar--hint-opened"),e.addEventListener("mouseup",(t=>{t.target instanceof HTMLElement&&n.getElement().contains(t.target)||o()}),{capture:!0,once:!0}),this._onInput((()=>o()),!0)}static _onInput(t,e=!1){const n=this._getIframeWin();n&&n.document&&n.document.addEventListener("keydown",(e=>{["Control","Shift","Meta","Alt"].includes(e.key)||t()}),{capture:!0,once:e})}static _getIframeWin(){const t=document.querySelector(this.PASTE_IFRAME_SELECTOR);return t&&t.contentWindow||null}static _isCursor(t){if(!(t instanceof HTMLElement||t instanceof SVGElement))return!1;const e=parseFloat(t.getAttribute("width")||"");return"RECT"===t.tagName.toUpperCase()&&0===t.childElementCount&&"crispEdges"===t.getAttribute("shape-rendering")&&e<=5}static _getTrailingBoxes(t,e){function n(t,e,o){const i=t.start===t.end,r=t.textNode.textContent.length||0,a=0!==t.start||t.end!==r;return i?function(t,e,o){var i;if(0===((null===(i=t.textNode.textContent)||void 0===i?void 0:i.length)||0))return[];const r=0===t.start,a=0,s=r?1:t.end,l=n({textNode:t.textNode,start:a,end:s},e,o);if(0===l.length)return[];const u=l[r?0:l.length-1];return[{top:u.top,right:r?u.left:u.right,bottom:u.bottom,left:r?u.left:u.right,width:0,height:u.height}]}(t,e,o):a?function(t,e,n){if(!BrowserDetector.isFirefox())return n.getTextBoundingBoxes(t,e,!1);const o=t.textNode.textContent||"";o.length;let i=t.textNode.parentElement;if(!(i&&i instanceof SVGTextElement))return[];if(!i.parentElement)return[];const r={textNode:t.textNode,start:0,end:o.length},a=n.getTextBoundingBoxes(r,e,!1);if(0===a.length)return[];let s=document.createElementNS("http://www.w3.org/2000/svg","text");for(let t=0;t<i.attributes.length;t++){const e=i.attributes[t];s.setAttribute(e.name,e.value)}i.parentElement.appendChild(s);let l=0;if(0!==t.start){s.textContent=o.substring(0,t.start);const i={textNode:s.firstChild,start:0,end:t.start},r=n.getTextBoundingBoxes(i,e,!1);r.length>0&&(l=r[0].width)}let u=0;if(t.end!==o.length){s.textContent=o.substring(t.end);const i={textNode:s.firstChild,start:0,end:o.length-t.end},r=n.getTextBoundingBoxes(i,e,!1);r.length>0&&(u=r[0].width)}s.remove();const d=a[0];return[{top:d.top,right:d.right-u,bottom:d.bottom,left:d.left+l,width:d.width-l-u,height:d.height}]}(t,e,o):o.getTextBoundingBoxes(t,e,!1)}this._domMeasurement.clearCache();let o=null,i=null,r=0;do{const i=n(t[r],e,this._domMeasurement);0!==i.length&&(o=i[0])}while(!o&&++r<t.length);if(!o)return[null,null];r=t.length-1;do{const o=n(t[r],e,this._domMeasurement);0!==o.length&&(i=o[o.length-1])}while(!i&&--r>=0);return[o,i]}static init(){this._storageController=StorageController.create(),this._domMeasurement=new DomMeasurement(document),this._interval=window.setInterval((()=>{this._checkMode(),this._checkForNewSlides(),this._checkOutOfViewSlides()}),750),this._storageController.addEventListener(StorageControllerClass.eventNames.settingsChanged,(t=>{(t.disabledEditorGroups||t.disabledDomains)&&this._toggleMenuBarButton(!!t.disabledEditorGroups)})),this._storageController.onReady((()=>{this._addMenuBarButton()}))}static destroy(){null!==this._interval&&(window.clearInterval(this._interval),this._interval=null),this._removeMenuBarButton(),this._removeMenuBarHint(),this._onModeChangedCallbacks.clear(),this._onNewSlideCallbacks=[],this._onSlideOutOfViewCallbacks.clear()}static isSlide(t){return t.matches(this.SLIDE_SELECTOR)}static OnNewSlide(t){this._onNewSlideCallbacks.push((e=>t(e,!1)))}static OnSlideDestroy(t,e){this._onModeChangedCallbacks.set(t,(n=>{"view"===n&&e(t)})),this._onSlideOutOfViewCallbacks.set(t,e),onElementRemoved(t,e)}static isElementCompatible(t){return t.matches(this.SLIDE_SELECTOR)}static initSlide(t){t.setAttribute("data-lt-tweaks","slides");let e=null;e=window.setTimeout((()=>{if(!this._storageController||!this._storageController.isReady())return;const{hasSeenNewGoogleSlidesTeaser:t}=this._storageController.getUIState();t||this._showTeaser()}),800)}static destroySlide(t){t.removeAttribute("data-lt-tweaks"),this._onModeChangedCallbacks.delete(t),this._onSlideOutOfViewCallbacks.delete(t)}static createMutationObserver(t){return new FilteringMutationObserver(t,(t=>"attributes"===t.type&&"class"===t.attributeName&&GoogleSlides._isCursor(t.target)))}static isIgnored(t){return!t.parentElement||"TEXT"===t.tagName.toUpperCase()&&!t.parentElement.matches("g.sketchy-text-content-text")}static getReplacementText(){return""}static isBlock(t,e){return"TEXT"!==t.tagName.toUpperCase()&&(!!t.matches(this.BLOCK_SELECTOR)||CEElementInspector.DISPLAY_BLOCK_VALUES.includes(e.display||""))}static replaceText(t,e){const n=e.parentElement;if(!n||"TEXT"!==n.tagName.toUpperCase())return t;const o=closestElement(n,this.BLOCK_SELECTOR);if(!o)return t;const i=Array.from(o.querySelectorAll(this.TEXT_SELECTOR)),r=i.indexOf(n);if(-1===r||r===i.length-1)return t;const a=n.getBoundingClientRect(),s=i[r+1].getBoundingClientRect(),l=a.top+a.height/2,u=a.left+a.width/2;return s.top>=l||s.left<=u||a.right<s.left?t+" ":t}static getTargetElement(t){return t.closest("svg")||t}static getVisibleBox(t,e){const n=e.getScaleFactor(t);let{top:o,left:i,width:r,height:a}=t.getBoundingClientRect();return r/=n.x,a/=n.y,{top:o,right:i+r,bottom:o+a,left:i,width:r,height:a}}static getScrollableElementSize(t,e){const n=e.getScaleFactor(t);let{width:o,height:i}=t.getBoundingClientRect();return o/=n.x,i/=n.y,{width:o,height:i}}static getTextBoxes(t,e,n,o){const i=t.getRelativeTextBoundingBoxes(e,n,o);for(let t=0;t<i.length-1;t++){const e=i[t],n=i[t+1];e.bottom===n.bottom&&e.top===n.top&&(e.right=n.right,i.splice(t+1,1),t--)}return i}static getToolbarPosition(t,e){const n=e.getBorderBox(t);if(this._workspaceContainer=this._workspaceContainer||document.getElementById("workspace-container"),!this._workspaceContainer)return null;const o=e.getBorderBox(this._workspaceContainer),i=o.top+10,r=Math.round(Math.max(n.top+30,i));if(r+50>n.bottom)return null;const a=o.left+32,s=Math.round(Math.max(n.left,a));return s+32>n.right?null:{top:r+"px",left:s+"px",fixed:!0}}static getSlideId(t){const e=t.match(this.SLIDE_ID_REGEXP);return e?e[1]:null}static getSelectedText(){const t=this.getSelection();if(!t)return"";const e=getCommonParent(t.startNode,t.endNode);if(!e)return"";const n=[],o=DOMWalker.create(e,t.startNode);do{if(isTextNode(o.currentNode)){let e=o.currentNode.nodeValue||"";if(o.currentNode===t.endNode&&(e=e.substring(0,t.endOffset)),o.currentNode===t.startNode&&(e=e.substring(t.startOffset)),e){const t=this.replaceText(e,o.currentNode);n.push(t)}}}while(o.currentNode!==t.endNode&&o.next());return n.join("")}static getSelection(){let t=Array.from(document.body.querySelectorAll("g.sketchy-text-background + g > g > rect"));if(!t.length)return null;if(t=t.filter((t=>{const e=t.getBoundingClientRect();return e.top>-20&&e.bottom<window.innerHeight+20})),!t.length)return null;const e=t[0].getBoundingClientRect(),n=1===t.length?e:t[t.length-1].getBoundingClientRect(),o=Array.from(document.querySelectorAll("div#pages svg text"));this._domMeasurement.setStyles(o,{"pointer-events":"all"},!0);const i=Array.from(document.querySelectorAll("div#pages > svg path[pointer-events=visiblePainted], div#pages > svg g[pointer-events=none] + rect[shape-rendering=crispEdges], div#pages > svg g[pointer-events=none] + rect[shape-rendering=crispEdges] + rect"));this._domMeasurement.setStyles(i,{"pointer-events":"none"},!0);let r=getRangeAtPoint({x:e.left+1,y:Math.round(e.bottom-.3*e.height)}),a=getRangeAtPoint({x:n.right-.5,y:Math.round(n.bottom-.3*n.height)});return this._domMeasurement.removeStyle(o,"pointer-events"),this._domMeasurement.removeStyle(i,"pointer-events"),r&&a&&(r.startContainer!==a.startContainer||r.startOffset!==a.startOffset||(r=getRangeAtPoint({x:e.left,y:Math.round(e.top+.3*e.height)}),a=getRangeAtPoint({x:n.right,y:Math.round(n.top+.3*n.height)}),r&&a))?{startNode:r.startContainer,startOffset:r.startOffset,endNode:a.endContainer,endOffset:a.endOffset,isCollapsed:!1}:null}static getReplacedParts(t){const e=[];for(const n of this.DEFAULT_TEXTS){const o=new RegExp(`^${n}(\n\n|$)`,"gm"),i=matchAll(t,o);for(const t of i)e.push({offset:t.index,length:t[0].length})}return e}static applyFix(t){return __awaiter(this,void 0,void 0,(function*(){const{offset:e,length:n,replacementText:o,editor:i}=t,r=i.inputAreaWrapper.getText().substr(e,n),a=r.startsWith(" "),s=r.endsWith(" "),l=a||s;let u=i.inputAreaWrapper.getTextRanges(e,n,!l);if(l&&(u=u.filter(((t,e)=>t.start!==t.end||a&&0===e||s&&e===u.length-1))),0===u.length||!u[0].textNode.parentElement)return;const d=u[0].textNode.parentElement.closest(this.EDITOR_SELECTOR);if(!d)return;let c=d.querySelector("g > path[pointer-events='visiblePainted']:last-child");if(!c)return;const g=document.querySelector(this.PASTE_IFRAME_SELECTOR);if(!g)return;const h=g.contentWindow;if(!h)return;const m=h.document.querySelector("[contenteditable=true]");if(!m)return;this._domMeasurement.clearCache();const[_,p]=this._getTrailingBoxes(u,i.inputArea);if(!_||!p)return;const B={bubbles:!0,clientX:Math.floor(_.left),clientY:Math.round(_.top+_.height/2)},S={bubbles:!0,clientX:Math.floor(p.right),clientY:Math.round(p.top+p.height/2)};c.dispatchEvent(new MouseEvent("mousedown",B)),c=document.querySelector("g > path[pointer-events='visiblePainted']:last-child")||d,c.dispatchEvent(new MouseEvent("mousemove",S)),c.dispatchEvent(new MouseEvent("mouseup",S));const f=h;let b;try{b=new f.ClipboardEvent("paste",{clipboardData:new f.DataTransfer,bubbles:!0}),b.clipboardData.setData("text/plain",o)}catch(t){b=new f.ClipboardEvent("paste",{bubbles:!0})}m.dispatchEvent(b),m.textContent=o}))}}GoogleSlides.SLIDES_URL_REGEXP=/docs\.google\.com\/presentation/,GoogleSlides.SLIDE_SELECTOR="div#pages > svg > g",GoogleSlides.UNHANDLED_SLIDE_SELECTOR="div#pages > svg > g:not([data-lt-tweaks])",GoogleSlides.BLOCK_SELECTOR="g[id^='editor']:not([id*='paragraph']) g[direction]",GoogleSlides.TEXT_SELECTOR="text",GoogleSlides.EDITOR_SELECTOR="g[id^='editor']:not([id*='paragraph']) g[direction]",GoogleSlides.PASTE_IFRAME_SELECTOR="iframe.docs-texteventtarget-iframe",GoogleSlides.TOOLBAR_CLASS_NAME="lt-slides-toolbar",GoogleSlides.SLIDE_ID_REGEXP=/presentation\/d\/([^\/]+)/i,GoogleSlides.DEFAULT_TEXTS=["Click to add title","Click to add text","Click to add subtitle","Klicken und Titel hinzufügen","Klicken und Text hinzufügen","Klicken und Untertitel hinzufügen","Haz clic para añadir un título","Haz clic para añadir un texto","Haz clic para añadir un subtítulo","Clique para adicionar um título","Clique para adicionar texto","Clique para adicionar um subtítulo","Clique para adicionar um título","Clique para adicionar texto","Clique para adicionar uma legenda","Fai clic per aggiungere un titolo","Fai clic per aggiungere testo","Fai clic per aggiungere un sottotitolo","Klik om een titel toe te voegen","Klik om tekst toe te voegen","Klik om een ondertitel toe te voegen","Cliquez ici pour ajouter un titre","Cliquez ici pour ajouter du texte","Cliquez ici pour ajouter un sous-titre","Введите заголовок","Введите текст","Введите подзаголовок","Kliknij, aby dodać tytuł","Kliknij, aby dodać tekst","Kliknij, aby dodać podtytuł","Натисніть, щоб додати заголовок","Натисніть, щоб додати текст","Натисніть, щоб додати підзаголовок"],GoogleSlides._storageController=null,GoogleSlides._interval=null,GoogleSlides._currentMode=null,GoogleSlides._onModeChangedCallbacks=new Map,GoogleSlides._onNewSlideCallbacks=[],GoogleSlides._onSlideOutOfViewCallbacks=new Map,GoogleSlides._menuBarButton=null,GoogleSlides._menuBarSeparator=null,GoogleSlides._menuBarHint=null,"undefined"!=typeof module&&(module.exports=GoogleSlides);